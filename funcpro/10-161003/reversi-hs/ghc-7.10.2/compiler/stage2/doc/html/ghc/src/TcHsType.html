<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcHsType.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-4"></a>
<a name="line-5"></a>\section[TcMonoType]{Typechecking user-specified @MonoTypes@}
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcHsType</span> <span class='hs-layout'>(</span>
<a name="line-11"></a>        <span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsVectInst</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>tcHsInstHead</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>                <span class='hs-comment'>-- Type checking type and class decls</span>
<a name="line-16"></a>        <span class='hs-varid'>kcLookupKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>kcTyClTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTyClTyVars</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>tcHsConArgType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDataKindSig</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>tcClassSigType</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>                <span class='hs-comment'>-- Kind-checking types</span>
<a name="line-21"></a>                <span class='hs-comment'>-- No kind generalisation, no checkValidType</span>
<a name="line-22"></a>        <span class='hs-varid'>kcHsTyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsOpenType</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>tcLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcCheckLHsType</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>tcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsArgTys</span><span class='hs-layout'>,</span>
<a name="line-26"></a>
<a name="line-27"></a>        <span class='hs-varid'>kindGeneralize</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkKind</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>                <span class='hs-comment'>-- Sort-checking kinds</span>
<a name="line-30"></a>        <span class='hs-varid'>tcLHsKind</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>                <span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-33"></a>        <span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcPatSig</span>
<a name="line-34"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span><span class='hs-layout'>(</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEnv</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcValidity</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcUnify</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcIface</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span><span class='hs-layout'>(</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- For the mkNakedXXX stuff</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>(</span> <span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span> <span class='hs-layout'>(</span> <span class='hs-varid'>liftedTypeKindTyConName</span><span class='hs-layout'>,</span> <span class='hs-varid'>constraintKindTyConName</span> <span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ExtensionFlag</span><span class='hs-layout'>(</span> <span class='hs-conid'>Opt_DataKinds</span> <span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span> <span class='hs-layout'>)</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span><span class='hs-layout'>(</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span> <span class='hs-varid'>ipClassName</span><span class='hs-layout'>,</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>allNameStrings</span> <span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><span class='hs-comment'>{-
<a name="line-75"></a>        ----------------------------
<a name="line-76"></a>                General notes
<a name="line-77"></a>        ----------------------------
<a name="line-78"></a>
<a name="line-79"></a>Generally speaking we now type-check types in three phases
<a name="line-80"></a>
<a name="line-81"></a>  1.  kcHsType: kind check the HsType
<a name="line-82"></a>        *includes* performing any TH type splices;
<a name="line-83"></a>        so it returns a translated, and kind-annotated, type
<a name="line-84"></a>
<a name="line-85"></a>  2.  dsHsType: convert from HsType to Type:
<a name="line-86"></a>        perform zonking
<a name="line-87"></a>        expand type synonyms [mkGenTyApps]
<a name="line-88"></a>        hoist the foralls [tcHsType]
<a name="line-89"></a>
<a name="line-90"></a>  3.  checkValidType: check the validity of the resulting type
<a name="line-91"></a>
<a name="line-92"></a>Often these steps are done one after the other (tcHsSigType).
<a name="line-93"></a>But in mutually recursive groups of type and class decls we do
<a name="line-94"></a>        1 kind-check the whole group
<a name="line-95"></a>        2 build TyCons/Classes in a knot-tied way
<a name="line-96"></a>        3 check the validity of types in the now-unknotted TyCons/Classes
<a name="line-97"></a>
<a name="line-98"></a>For example, when we find
<a name="line-99"></a>        (forall a m. m a -&gt; m a)
<a name="line-100"></a>we bind a,m to kind varibles and kind-check (m a -&gt; m a).  This makes
<a name="line-101"></a>a get kind *, and m get kind *-&gt;*.  Now we typecheck (m a -&gt; m a) in
<a name="line-102"></a>an environment that binds a and m suitably.
<a name="line-103"></a>
<a name="line-104"></a>The kind checker passed to tcHsTyVars needs to look at enough to
<a name="line-105"></a>establish the kind of the tyvar:
<a name="line-106"></a>  * For a group of type and class decls, it's just the group, not
<a name="line-107"></a>        the rest of the program
<a name="line-108"></a>  * For a tyvar bound in a pattern type signature, its the types
<a name="line-109"></a>        mentioned in the other type signatures in that bunch of patterns
<a name="line-110"></a>  * For a tyvar bound in a RULE, it's the type signatures on other
<a name="line-111"></a>        universally quantified variables in the rule
<a name="line-112"></a>
<a name="line-113"></a>Note that this may occasionally give surprising results.  For example:
<a name="line-114"></a>
<a name="line-115"></a>        data T a b = MkT (a b)
<a name="line-116"></a>
<a name="line-117"></a>Here we deduce                  a::*-&gt;*,       b::*
<a name="line-118"></a>But equally valid would be      a::(*-&gt;*)-&gt; *, b::*-&gt;*
<a name="line-119"></a>
<a name="line-120"></a>
<a name="line-121"></a>Validity checking
<a name="line-122"></a>~~~~~~~~~~~~~~~~~
<a name="line-123"></a>Some of the validity check could in principle be done by the kind checker,
<a name="line-124"></a>but not all:
<a name="line-125"></a>
<a name="line-126"></a>- During desugaring, we normalise by expanding type synonyms.  Only
<a name="line-127"></a>  after this step can we check things like type-synonym saturation
<a name="line-128"></a>  e.g.  type T k = k Int
<a name="line-129"></a>        type S a = a
<a name="line-130"></a>  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
<a name="line-131"></a>  and then S is saturated.  This is a GHC extension.
<a name="line-132"></a>
<a name="line-133"></a>- Similarly, also a GHC extension, we look through synonyms before complaining
<a name="line-134"></a>  about the form of a class or instance declaration
<a name="line-135"></a>
<a name="line-136"></a>- Ambiguity checks involve functional dependencies, and it's easier to wait
<a name="line-137"></a>  until knots have been resolved before poking into them
<a name="line-138"></a>
<a name="line-139"></a>Also, in a mutually recursive group of types, we can't look at the TyCon until we've
<a name="line-140"></a>finished building the loop.  So to keep things simple, we postpone most validity
<a name="line-141"></a>checking until step (3).
<a name="line-142"></a>
<a name="line-143"></a>Knot tying
<a name="line-144"></a>~~~~~~~~~~
<a name="line-145"></a>During step (1) we might fault in a TyCon defined in another module, and it might
<a name="line-146"></a>(via a loop) refer back to a TyCon defined in this module. So when we tie a big
<a name="line-147"></a>knot around type declarations with ARecThing, so that the fault-in code can get
<a name="line-148"></a>the TyCon being defined.
<a name="line-149"></a>
<a name="line-150"></a>
<a name="line-151"></a>************************************************************************
<a name="line-152"></a>*                                                                      *
<a name="line-153"></a>              Check types AND do validity checking
<a name="line-154"></a>*                                                                      *
<a name="line-155"></a>************************************************************************
<a name="line-156"></a>-}</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-159"></a>  <span class='hs-comment'>-- NB: it's important that the foralls that come from the top-level</span>
<a name="line-160"></a>  <span class='hs-comment'>--     HsForAllTy in hs_ty occur *first* in the returned type.</span>
<a name="line-161"></a>  <span class='hs-comment'>--     See Note [Scoped] with TcSigInfo</span>
<a name="line-162"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-164"></a>    <span class='hs-varid'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-165"></a>
<a name="line-166"></a><a name="tcHsSigTypeNC"></a><span class='hs-definition'>tcHsSigTypeNC</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>    <span class='hs-comment'>-- The "In the type..." context</span>
<a name="line-168"></a>                        <span class='hs-comment'>-- comes from the caller; hence "NC"</span>
<a name="line-169"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-170"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-171"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>k</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-172"></a>          <span class='hs-comment'>-- The kind is checked by checkValidType, and isn't necessarily</span>
<a name="line-173"></a>          <span class='hs-comment'>-- of kind * in a Template Haskell quote eg [t| Maybe |]</span>
<a name="line-174"></a>
<a name="line-175"></a>          <span class='hs-comment'>-- Generalise here: see Note [Kind generalisation]</span>
<a name="line-176"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-177"></a>
<a name="line-178"></a>          <span class='hs-comment'>-- Zonk to expose kind information to checkValidType</span>
<a name="line-179"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-180"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-181"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="tcHsInstHead"></a><span class='hs-comment'>-----------------</span>
<a name="line-184"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-185"></a><span class='hs-comment'>-- Like tcHsSigTypeNC, but for an instance head.</span>
<a name="line-186"></a><span class='hs-definition'>tcHsInstHead</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>    <span class='hs-comment'>-- The "In the type..." context comes from the caller</span>
<a name="line-188"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_inst_head</span> <span class='hs-varid'>hs_ty</span>
<a name="line-189"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeAndFV</span> <span class='hs-varid'>inst_ty</span>
<a name="line-190"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>kvs</span>
<a name="line-191"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>inst_ty</span><span class='hs-layout'>)</span>
<a name="line-192"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varid'>inst_ty</span> <span class='hs-layout'>}</span>
<a name="line-193"></a>
<a name="line-194"></a><a name="tc_inst_head"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-195"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>hs_ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsTyVarBndrs</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-197"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>hs_ctxt</span>
<a name="line-198"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ekConstraint</span>    <span class='hs-comment'>-- Body for forall has kind Constraint</span>
<a name="line-199"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-200"></a>
<a name="line-201"></a><span class='hs-definition'>tc_inst_head</span> <span class='hs-varid'>hs_ty</span>
<a name="line-202"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-----------------</span>
<a name="line-205"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-206"></a><span class='hs-comment'>-- Like tcHsSigTypeNC, but for the ...deriving( C t1 ty2 ) clause</span>
<a name="line-207"></a><span class='hs-comment'>-- Returns the C, [ty1, ty2, and the kind of C's *next* argument</span>
<a name="line-208"></a><span class='hs-comment'>-- E.g.    class C (a::*) (b::k-&gt;k)</span>
<a name="line-209"></a><span class='hs-comment'>--         data T a b = ... deriving( C Int )</span>
<a name="line-210"></a><span class='hs-comment'>--    returns ([k], C, [k, Int],  k-&gt;k)</span>
<a name="line-211"></a><span class='hs-comment'>-- Also checks that (C ty1 ty2 arg) :: Constraint</span>
<a name="line-212"></a><span class='hs-comment'>-- if arg has a suitable kind</span>
<a name="line-213"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-varid'>hs_ty</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-215"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-217"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>arg_kind</span>
<a name="line-218"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>ty</span>
<a name="line-219"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-220"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span>
<a name="line-221"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal deriving item"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="tcHsVectInst"></a><span class='hs-comment'>-- Used for 'VECTORISE [SCALAR] instance' declarations</span>
<a name="line-224"></a><span class='hs-comment'>--</span>
<a name="line-225"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-226"></a><span class='hs-definition'>tcHsVectInst</span> <span class='hs-varid'>ty</span>
<a name="line-227"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsClassTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcClass</span> <span class='hs-varid'>cls_name</span>
<a name="line-229"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>cls_name</span> <span class='hs-varid'>cls_kind</span> <span class='hs-varid'>tys</span>
<a name="line-230"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance type"</span><span class='hs-layout'>)</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-comment'>{-
<a name="line-235"></a>        These functions are used during knot-tying in
<a name="line-236"></a>        type and class declarations, when we have to
<a name="line-237"></a>        separate kind-checking, desugaring, and validity checking
<a name="line-238"></a>
<a name="line-239"></a>
<a name="line-240"></a>************************************************************************
<a name="line-241"></a>*                                                                      *
<a name="line-242"></a>            The main kind checker: no validity checks here
<a name="line-243"></a>*                                                                      *
<a name="line-244"></a>************************************************************************
<a name="line-245"></a>
<a name="line-246"></a>        First a couple of simple wrappers for kcHsType
<a name="line-247"></a>-}</span>
<a name="line-248"></a>
<a name="line-249"></a><a name="tcClassSigType"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-250"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-251"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varop'>$</span>
<a name="line-252"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-253"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-254"></a>
<a name="line-255"></a><a name="tcHsConArgType"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NewOrData</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-256"></a><span class='hs-comment'>-- Permit a bang, but discard it</span>
<a name="line-257"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-conid'>NewType</span>  <span class='hs-varid'>bty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBangType</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-258"></a>  <span class='hs-comment'>-- Newtypes can't have bangs, but we don't check that</span>
<a name="line-259"></a>  <span class='hs-comment'>-- until checkValidDataCon, so do not want to crash here</span>
<a name="line-260"></a>
<a name="line-261"></a><span class='hs-definition'>tcHsConArgType</span> <span class='hs-conid'>DataType</span> <span class='hs-varid'>bty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsOpenType</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBangType</span> <span class='hs-varid'>bty</span><span class='hs-layout'>)</span>
<a name="line-262"></a>  <span class='hs-comment'>-- Can't allow an unlifted type for newtypes, because we're effectively</span>
<a name="line-263"></a>  <span class='hs-comment'>-- going to remove the constructor while coercing it to a lifted type.</span>
<a name="line-264"></a>  <span class='hs-comment'>-- And newtypes can't be bang'd</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="tcHsArgTys"></a><span class='hs-comment'>---------------------------</span>
<a name="line-267"></a><span class='hs-definition'>tcHsArgTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-268"></a><span class='hs-definition'>tcHsArgTys</span> <span class='hs-varid'>what</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span>
<a name="line-269"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span>
<a name="line-270"></a>               <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-varid'>what</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-271"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="tc_hs_arg_tys"></a><span class='hs-definition'>tc_hs_arg_tys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-274"></a><span class='hs-comment'>-- Just like tcHsArgTys but without the addTypeCtxt</span>
<a name="line-275"></a><span class='hs-definition'>tc_hs_arg_tys</span> <span class='hs-varid'>what</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-varid'>what</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-277"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="tcHsOpenType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-280"></a><span class='hs-definition'>tcHsOpenType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-281"></a><span class='hs-comment'>-- Used for type signatures</span>
<a name="line-282"></a><span class='hs-comment'>-- Do not do validity checking</span>
<a name="line-283"></a><span class='hs-definition'>tcHsOpenType</span> <span class='hs-varid'>ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekOpen</span>
<a name="line-284"></a><a name="tcHsLiftedType"></a><span class='hs-definition'>tcHsLiftedType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="tcCheckLHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-287"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-288"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-290"></a>    <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="tcLHsType"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-293"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-294"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-295"></a>
<a name="line-296"></a><a name="tcCheckHsTypeAndGen"></a><span class='hs-comment'>---------------------------</span>
<a name="line-297"></a><span class='hs-definition'>tcCheckHsTypeAndGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-298"></a><span class='hs-comment'>-- Input type is HsType, not LhsType; the caller adds the context</span>
<a name="line-299"></a><span class='hs-comment'>-- Typecheck a type signature, and kind-generalise it</span>
<a name="line-300"></a><span class='hs-comment'>-- The result is not necessarily zonked, and has not been checked for validity</span>
<a name="line-301"></a><span class='hs-definition'>tcCheckHsTypeAndGen</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-303"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcCheckHsTypeAndGen"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-304"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeAndFV</span> <span class='hs-varid'>ty</span>
<a name="line-305"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralize</span> <span class='hs-varid'>kvs</span>
<a name="line-306"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-307"></a>
<a name="line-308"></a><span class='hs-comment'>{-
<a name="line-309"></a>Like tcExpr, tc_hs_type takes an expected kind which it unifies with
<a name="line-310"></a>the kind it figures out. When we don't know what kind to expect, we use
<a name="line-311"></a>tc_lhs_type_fresh, to first create a new meta kind variable and use that as
<a name="line-312"></a>the expected kind.
<a name="line-313"></a>-}</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="tc_infer_lhs_type"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-316"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-317"></a>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-318"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kv</span> <span class='hs-varid'>expectedKindMsg</span><span class='hs-layout'>)</span>
<a name="line-319"></a>     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="tc_lhs_type"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-322"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-323"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-324"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_lhs_type:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-325"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="tc_lhs_types"></a><span class='hs-definition'>tc_lhs_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-328"></a><span class='hs-definition'>tc_lhs_types</span> <span class='hs-varid'>tys_w_kinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>tc_lhs_type</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys_w_kinds</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="tc_fun_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-331"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-332"></a><span class='hs-comment'>-- We need to recognise (-&gt;) so that we can construct a FunTy,</span>
<a name="line-333"></a><span class='hs-comment'>-- *and* we need to do by looking at the Name, not the TyCon</span>
<a name="line-334"></a><span class='hs-comment'>-- (see Note [Zonking inside the knot]).  For example,</span>
<a name="line-335"></a><span class='hs-comment'>-- consider  f :: (-&gt;) Int Int  (Trac #7312)</span>
<a name="line-336"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-337"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-338"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-339"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-340"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-341"></a>
<a name="line-342"></a><a name="tc_hs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-343"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-344"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-345"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-346"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type: qq"</span>       <span class='hs-comment'>-- Eliminated by renamer</span>
<a name="line-347"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>_</span>
<a name="line-348"></a>    <span class='hs-comment'>-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span>
<a name="line-349"></a>    <span class='hs-comment'>-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span>
<a name="line-350"></a>    <span class='hs-comment'>-- bangs are invalid, so fail. (#7210)</span>
<a name="line-351"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected strictness annotation:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-352"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type: record"</span> <span class='hs-comment'>-- Unwrapped by con decls</span>
<a name="line-353"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor</span>
<a name="line-354"></a>      <span class='hs-comment'>-- signatures) should have been removed by now</span>
<a name="line-355"></a>
<a name="line-356"></a><span class='hs-comment'>---------- Functions and applications</span>
<a name="line-357"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>name</span>
<a name="line-359"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-360"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-361"></a>
<a name="line-362"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-363"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-364"></a>
<a name="line-365"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-366"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-367"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-368"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-369"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>op'</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>op</span>
<a name="line-370"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>l_op</span> <span class='hs-varid'>op_kind</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>exp_kind</span>
<a name="line-371"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTys</span> <span class='hs-varid'>op'</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-372"></a>         <span class='hs-comment'>-- mkNakedAppTys: see Note [Zonking inside the knot]</span>
<a name="line-373"></a>
<a name="line-374"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-375"></a><span class='hs-comment'>--  | L _ (HsTyVar fun) &lt;- fun_ty</span>
<a name="line-376"></a><span class='hs-comment'>--  , fun `hasKey` funTyConKey</span>
<a name="line-377"></a><span class='hs-comment'>--  , [fty1,fty2] &lt;- arg_tys</span>
<a name="line-378"></a><span class='hs-comment'>--  = tc_fun_type hs_ty fty1 fty2 exp_kind</span>
<a name="line-379"></a><span class='hs-comment'>--  | otherwise</span>
<a name="line-380"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>fun_ty</span>
<a name="line-381"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>arg_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-382"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedAppTys</span> <span class='hs-varid'>fun_ty'</span> <span class='hs-varid'>arg_tys'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-383"></a>         <span class='hs-comment'>-- mkNakedAppTys: see Note [Zonking inside the knot]</span>
<a name="line-384"></a>         <span class='hs-comment'>-- This looks fragile; how do we *know* that fun_ty isn't</span>
<a name="line-385"></a>         <span class='hs-comment'>-- a TyConApp, say (which is never supposed to appear in the</span>
<a name="line-386"></a>         <span class='hs-comment'>-- function position of an AppTy)?</span>
<a name="line-387"></a>  <span class='hs-keyword'>where</span>
<a name="line-388"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-389"></a>
<a name="line-390"></a><span class='hs-comment'>--------- Foralls</span>
<a name="line-391"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>context</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_k</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-392"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>exp_k</span>
<a name="line-393"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal constraint:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-394"></a>
<a name="line-395"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-396"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsTyVarBndrs</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tvs'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-397"></a>    <span class='hs-comment'>-- Do not kind-generalise here!  See Note [Kind generalisation]</span>
<a name="line-398"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsContext</span> <span class='hs-varid'>context</span>
<a name="line-399"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>context</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>  <span class='hs-comment'>-- Plain forall, no context</span>
<a name="line-400"></a>                   <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>    <span class='hs-comment'>-- Why exp_kind?  See Note [Body kind of forall]</span>
<a name="line-401"></a>                <span class='hs-keyword'>else</span>
<a name="line-402"></a>                   <span class='hs-comment'>-- If there is a context, then this forall is really a</span>
<a name="line-403"></a>                   <span class='hs-comment'>-- _function_, so the kind of the result really is *</span>
<a name="line-404"></a>                   <span class='hs-comment'>-- The body kind (result of the function can be * or #, hence ekOpen</span>
<a name="line-405"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-406"></a>                      <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekOpen</span> <span class='hs-layout'>}</span>
<a name="line-407"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSigmaTy</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-408"></a>
<a name="line-409"></a><span class='hs-comment'>--------- Lists, arrays, and tuples</span>
<a name="line-410"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-411"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-412"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-413"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-414"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-415"></a>
<a name="line-416"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-417"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-418"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-419"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>parrTyCon</span>
<a name="line-420"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPArrTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-421"></a>
<a name="line-422"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in HsTypes</span>
<a name="line-423"></a><span class='hs-comment'>-- See Note [Inferring tuple kinds]</span>
<a name="line-424"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_k</span> <span class='hs-sel'>_ctxt</span><span class='hs-layout'>)</span>
<a name="line-425"></a>     <span class='hs-comment'>-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span>
<a name="line-426"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>exp_k</span>
<a name="line-427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-428"></a>    <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-429"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-430"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span>
<a name="line-431"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>hs_tys</span>
<a name="line-432"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>kinds</span>
<a name="line-433"></a>           <span class='hs-comment'>-- Infer each arg type separately, because errors can be</span>
<a name="line-434"></a>           <span class='hs-comment'>-- confusing if we give them a shared kind.  Eg Trac #7410</span>
<a name="line-435"></a>           <span class='hs-comment'>-- (Either Int, Int), we do not want to get an error saying</span>
<a name="line-436"></a>           <span class='hs-comment'>-- "the second argument of a tuple should have kind *-&gt;*"</span>
<a name="line-437"></a>
<a name="line-438"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_sort</span><span class='hs-layout'>)</span>
<a name="line-439"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span>
<a name="line-440"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-441"></a>                    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-442"></a>                    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>BoxedTuple</span><span class='hs-layout'>)</span>
<a name="line-443"></a>         <span class='hs-comment'>-- In the [] case, it's not clear what the kind is, so guess *</span>
<a name="line-444"></a>
<a name="line-445"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-446"></a>                     <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>
<a name="line-447"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kind</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-448"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-449"></a>
<a name="line-450"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-451"></a>
<a name="line-452"></a>
<a name="line-453"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-454"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-455"></a>  <span class='hs-keyword'>where</span>
<a name="line-456"></a>    <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tup_sort</span> <span class='hs-keyword'>of</span>  <span class='hs-comment'>-- Fourth case dealt with above</span>
<a name="line-457"></a>                  <span class='hs-conid'>HsUnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnboxedTuple</span>
<a name="line-458"></a>                  <span class='hs-conid'>HsBoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-459"></a>                  <span class='hs-conid'>HsConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-460"></a>                  <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsTupleTy"</span>
<a name="line-461"></a>
<a name="line-462"></a>
<a name="line-463"></a><span class='hs-comment'>--------- Promoted lists and tuples</span>
<a name="line-464"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-sel'>_k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-465"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>tys</span>
<a name="line-466"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>taus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tks</span>
<a name="line-467"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In a promoted list"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tks</span>
<a name="line-468"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPromotedListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-469"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_cons</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_nil</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-470"></a>  <span class='hs-keyword'>where</span>
<a name="line-471"></a>    <span class='hs-varid'>mk_cons</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-472"></a>    <span class='hs-varid'>mk_nil</span>  <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-473"></a>
<a name="line-474"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-475"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>tys</span>
<a name="line-476"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-477"></a>             <span class='hs-varid'>kind_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleTyCon</span>   <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span>
<a name="line-478"></a>             <span class='hs-varid'>ty_con</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleDataCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-varid'>n</span>
<a name="line-479"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>taus</span><span class='hs-layout'>,</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unzip</span> <span class='hs-varid'>tks</span>
<a name="line-480"></a>             <span class='hs-varid'>tup_k</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>kind_con</span> <span class='hs-varid'>ks</span>
<a name="line-481"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-482"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ty_con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-483"></a>
<a name="line-484"></a><span class='hs-comment'>--------- Constraint types</span>
<a name="line-485"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ipTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-486"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ekLifted</span>
<a name="line-487"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ipTy</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-488"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-489"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>n</span>
<a name="line-490"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-491"></a>       <span class='hs-layout'>}</span>
<a name="line-492"></a>
<a name="line-493"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-494"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty1</span>
<a name="line-495"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>ty2</span>
<a name="line-496"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>kind2</span>
<a name="line-497"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>kind1</span> <span class='hs-varid'>msg_fn</span><span class='hs-layout'>)</span>
<a name="line-498"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-499"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>eqTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>kind1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-500"></a>  <span class='hs-keyword'>where</span>
<a name="line-501"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The left argument of the equality had kind"</span><span class='hs-layout'>)</span>
<a name="line-502"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-503"></a>
<a name="line-504"></a><span class='hs-comment'>--------- Misc</span>
<a name="line-505"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-506"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_k'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>sig_k</span>
<a name="line-507"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig_k'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-508"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>sig_k'</span> <span class='hs-varid'>msg_fn</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-509"></a>  <span class='hs-keyword'>where</span>
<a name="line-510"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The signature specified kind"</span><span class='hs-layout'>)</span>
<a name="line-511"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-512"></a>
<a name="line-513"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-514"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-515"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-516"></a>
<a name="line-517"></a>
<a name="line-518"></a><span class='hs-comment'>-- This should never happen; type splices are expanded by the renamer</span>
<a name="line-519"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-520"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected type splice:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-521"></a>
<a name="line-522"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsWrapTy"</span>  <span class='hs-comment'>-- We kind checked something twice</span>
<a name="line-524"></a>
<a name="line-525"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-526"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>typeNatKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-527"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeNatKindCon</span>
<a name="line-528"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNumLitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-529"></a>
<a name="line-530"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-531"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-532"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeSymbolKindCon</span>
<a name="line-533"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-534"></a>
<a name="line-535"></a>
<a name="line-536"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-conid'>HsWildcardTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_hs_type HsWildcardTy"</span>
<a name="line-537"></a><span class='hs-comment'>-- unnamed wildcards should have been replaced by named wildcards</span>
<a name="line-538"></a>
<a name="line-539"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>hs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-540"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>name</span>
<a name="line-541"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_kind</span>
<a name="line-542"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-543"></a>
<a name="line-544"></a><a name="tupKindSort_maybe"></a><span class='hs-comment'>---------------------------</span>
<a name="line-545"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TupleSort</span>
<a name="line-546"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-varid'>k</span>
<a name="line-547"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-548"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-549"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-550"></a>
<a name="line-551"></a><a name="tc_tuple"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-552"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-553"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_arg_tys</span> <span class='hs-varid'>cxt_doc</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span>
<a name="line-554"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-555"></a>  <span class='hs-keyword'>where</span>
<a name="line-556"></a>    <span class='hs-varid'>arg_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-557"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-558"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>openTypeKind</span>
<a name="line-559"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-560"></a>    <span class='hs-varid'>cxt_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-561"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span>
<a name="line-562"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an unboxed tuple"</span><span class='hs-layout'>)</span>
<a name="line-563"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a constraint tuple"</span><span class='hs-layout'>)</span>
<a name="line-564"></a>
<a name="line-565"></a><a name="finish_tuple"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-566"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-567"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"finish_tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-568"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-569"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-570"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-571"></a>  <span class='hs-keyword'>where</span>
<a name="line-572"></a>    <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-varid'>tup_sort</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span>
<a name="line-573"></a>    <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-574"></a>                 <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unliftedTypeKind</span>
<a name="line-575"></a>                 <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-576"></a>                 <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>constraintKind</span>
<a name="line-577"></a>
<a name="line-578"></a><a name="tcInferApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-579"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-580"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span>
<a name="line-581"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>                        <span class='hs-comment'>-- Function kind</span>
<a name="line-582"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>                <span class='hs-comment'>-- Arg types</span>
<a name="line-583"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- Kind-checked args</span>
<a name="line-584"></a><span class='hs-definition'>tcInferApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-585"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>args_w_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-586"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_types</span> <span class='hs-varid'>args_w_kinds</span>
<a name="line-587"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-588"></a>
<a name="line-589"></a><a name="tcCheckApps"></a><span class='hs-definition'>tcCheckApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span>
<a name="line-590"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span>     <span class='hs-comment'>-- The type being checked (for err messages only)</span>
<a name="line-591"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>               <span class='hs-comment'>-- The function</span>
<a name="line-592"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Fun kind and arg types</span>
<a name="line-593"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span>                    <span class='hs-comment'>-- Expected kind</span>
<a name="line-594"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-595"></a><span class='hs-definition'>tcCheckApps</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span> <span class='hs-varid'>exp_kind</span>
<a name="line-596"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferApps</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-597"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-598"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>arg_tys</span> <span class='hs-layout'>}</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="splitFunKind"></a><span class='hs-comment'>---------------------------</span>
<a name="line-601"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span><span class='hs-conid'>ExpKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-602"></a><span class='hs-definition'>splitFunKind</span> <span class='hs-varid'>the_fun</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-603"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-num'>1</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>args</span>
<a name="line-604"></a>  <span class='hs-keyword'>where</span>
<a name="line-605"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span>      <span class='hs-varid'>fk</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>fk</span><span class='hs-layout'>)</span>
<a name="line-606"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>arg_no</span> <span class='hs-varid'>fk</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-607"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>fk</span>
<a name="line-608"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_fk</span> <span class='hs-keyword'>of</span>
<a name="line-609"></a>                 <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>too_many_args</span>
<a name="line-610"></a>                 <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ak</span><span class='hs-layout'>,</span><span class='hs-varid'>fk'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>aks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fk'</span> <span class='hs-varid'>args</span>
<a name="line-611"></a>                                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>ak</span> <span class='hs-varid'>arg_no</span>
<a name="line-612"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>aks</span><span class='hs-layout'>,</span> <span class='hs-varid'>rk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-613"></a>
<a name="line-614"></a>    <span class='hs-varid'>too_many_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>the_fun</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-615"></a>                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is applied to too many type arguments"</span><span class='hs-layout'>)</span>
<a name="line-616"></a>
<a name="line-617"></a>
<a name="line-618"></a><a name="tcHsContext"></a><span class='hs-comment'>---------------------------</span>
<a name="line-619"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-620"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcHsLPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-621"></a>
<a name="line-622"></a><a name="tcHsLPredType"></a><span class='hs-definition'>tcHsLPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-623"></a><span class='hs-definition'>tcHsLPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ekConstraint</span>
<a name="line-624"></a>
<a name="line-625"></a><a name="tcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-626"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-627"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-628"></a><span class='hs-comment'>-- in TcTyClsDecls</span>
<a name="line-629"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-630"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-631"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-632"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-633"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span>
<a name="line-634"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tv</span>
<a name="line-635"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-636"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used as a type"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-637"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-638"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-639"></a>
<a name="line-640"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span>
<a name="line-641"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-642"></a>                             <span class='hs-comment'>-- mkNakedTyConApp: see Note [Zonking inside the knot]</span>
<a name="line-643"></a>
<a name="line-644"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-645"></a>
<a name="line-646"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-647"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteDataCon_maybe</span> <span class='hs-varid'>dc</span>
<a name="line-648"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-649"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKinds</span>
<a name="line-650"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>inst_tycon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-651"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-652"></a>                                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"comes from an un-promotable type"</span><span class='hs-layout'>)</span>
<a name="line-653"></a>                                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-654"></a>
<a name="line-655"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-656"></a>
<a name="line-657"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-658"></a>  <span class='hs-keyword'>where</span>
<a name="line-659"></a>    <span class='hs-varid'>get_loopy_tc</span> <span class='hs-varid'>name</span>
<a name="line-660"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getGblEnv</span>
<a name="line-661"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_type_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-662"></a>                <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span>
<a name="line-663"></a>                <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aThingErr</span> <span class='hs-str'>"tcTyVar"</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-664"></a>
<a name="line-665"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-666"></a>    <span class='hs-comment'>-- Instantiate the polymorphic kind</span>
<a name="line-667"></a>    <span class='hs-comment'>-- Lazy in the TyCon</span>
<a name="line-668"></a>    <span class='hs-varid'>inst_tycon</span> <span class='hs-varid'>mk_tc_app</span> <span class='hs-varid'>kind</span>
<a name="line-669"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>kvs</span>
<a name="line-670"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_tc_app</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span>
<a name="line-671"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-672"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk4"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-673"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>newMetaKindVar</span><span class='hs-layout'>)</span> <span class='hs-varid'>kvs</span>
<a name="line-674"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_tc_app</span> <span class='hs-varid'>ks</span><span class='hs-layout'>,</span> <span class='hs-varid'>substKiWith</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ks</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-675"></a>      <span class='hs-keyword'>where</span>
<a name="line-676"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki_body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-677"></a>
<a name="line-678"></a><a name="tcClass"></a><span class='hs-definition'>tcClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-679"></a><span class='hs-definition'>tcClass</span> <span class='hs-varid'>cls</span>     <span class='hs-comment'>-- Must be a class</span>
<a name="line-680"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>cls</span>
<a name="line-681"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-682"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>aThingErr</span> <span class='hs-str'>"tcClass"</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-683"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-684"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConClass_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-685"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-686"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"class"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span>
<a name="line-687"></a>
<a name="line-688"></a>
<a name="line-689"></a><a name="aThingErr"></a><span class='hs-definition'>aThingErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-690"></a><span class='hs-comment'>-- The type checker for types is sometimes called simply to</span>
<a name="line-691"></a><span class='hs-comment'>-- do *kind* checking; and in that case it ignores the type</span>
<a name="line-692"></a><span class='hs-comment'>-- returned. Which is a good thing since it may not be available yet!</span>
<a name="line-693"></a><span class='hs-definition'>aThingErr</span> <span class='hs-varid'>str</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"AThing evaluated unexpectedly"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-694"></a>
<a name="line-695"></a><span class='hs-comment'>{-
<a name="line-696"></a>Note [Zonking inside the knot]
<a name="line-697"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-698"></a>Suppose we are checking the argument types of a data constructor.  We
<a name="line-699"></a>must zonk the types before making the DataCon, because once built we
<a name="line-700"></a>can't change it.  So we must traverse the type.
<a name="line-701"></a>
<a name="line-702"></a>BUT the parent TyCon is knot-tied, so we can't look at it yet.
<a name="line-703"></a>
<a name="line-704"></a>So we must be careful not to use "smart constructors" for types that
<a name="line-705"></a>look at the TyCon or Class involved.
<a name="line-706"></a>
<a name="line-707"></a>  * Hence the use of mkNakedXXX functions. These do *not* enforce
<a name="line-708"></a>    the invariants (for example that we use (FunTy s t) rather
<a name="line-709"></a>    than (TyConApp (-&gt;) [s,t])).
<a name="line-710"></a>
<a name="line-711"></a>  * Ditto in zonkTcType (which may be applied more than once, eg to
<a name="line-712"></a>    squeeze out kind meta-variables), we are careful not to look at
<a name="line-713"></a>    the TyCon.
<a name="line-714"></a>
<a name="line-715"></a>  * We arrange to call zonkSigType *once* right at the end, and it
<a name="line-716"></a>    does establish the invariants.  But in exchange we can't look
<a name="line-717"></a>    at the result (not even its structure) until we have emerged
<a name="line-718"></a>    from the "knot".
<a name="line-719"></a>
<a name="line-720"></a>  * TcHsSyn.zonkTcTypeToType also can safely check/establish
<a name="line-721"></a>    invariants.
<a name="line-722"></a>
<a name="line-723"></a>This is horribly delicate.  I hate it.  A good example of how
<a name="line-724"></a>delicate it is can be seen in Trac #7903.
<a name="line-725"></a>-}</span>
<a name="line-726"></a>
<a name="line-727"></a><a name="mkNakedTyConApp"></a><span class='hs-definition'>mkNakedTyConApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-728"></a><span class='hs-comment'>-- Builds a TyConApp</span>
<a name="line-729"></a><span class='hs-comment'>--   * without being strict in TyCon,</span>
<a name="line-730"></a><span class='hs-comment'>--   * without satisfying the invariants of TyConApp</span>
<a name="line-731"></a><span class='hs-comment'>-- A subsequent zonking will establish the invariants</span>
<a name="line-732"></a><span class='hs-definition'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="mkNakedAppTys"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-735"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-736"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNakedTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-737"></a><span class='hs-definition'>mkNakedAppTys</span> <span class='hs-varid'>ty1</span>                <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>tys2</span>
<a name="line-738"></a>
<a name="line-739"></a><a name="zonkSigType"></a><span class='hs-definition'>zonkSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-740"></a><span class='hs-comment'>-- Zonk the result of type-checking a user-written type signature</span>
<a name="line-741"></a><span class='hs-comment'>-- It may have kind variables in it, but no meta type variables</span>
<a name="line-742"></a><span class='hs-comment'>-- Because of knot-typing (see Note [Zonking inside the knot])</span>
<a name="line-743"></a><span class='hs-comment'>-- it may need to establish the Type invariants;</span>
<a name="line-744"></a><span class='hs-comment'>-- hence the use of mkTyConApp and mkAppTy</span>
<a name="line-745"></a><span class='hs-definition'>zonkSigType</span> <span class='hs-varid'>ty</span>
<a name="line-746"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-747"></a>  <span class='hs-keyword'>where</span>
<a name="line-748"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-749"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-750"></a>                <span class='hs-comment'>-- Key point: establish Type invariants!</span>
<a name="line-751"></a>                <span class='hs-comment'>-- See Note [Zonking inside the knot]</span>
<a name="line-752"></a>
<a name="line-753"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-754"></a>
<a name="line-755"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-756"></a>                              <span class='hs-varid'>res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-757"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg'</span> <span class='hs-varid'>res'</span><span class='hs-layout'>)</span>
<a name="line-758"></a>
<a name="line-759"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>fun</span>
<a name="line-760"></a>                              <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-761"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span>
<a name="line-762"></a>                <span class='hs-comment'>-- NB the mkAppTy; we might have instantiated a</span>
<a name="line-763"></a>                <span class='hs-comment'>-- type variable to a type constructor, so we need</span>
<a name="line-764"></a>                <span class='hs-comment'>-- to pull the TyConApp to the top.</span>
<a name="line-765"></a>
<a name="line-766"></a>        <span class='hs-comment'>-- The two interesting cases!</span>
<a name="line-767"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tyvar</span>
<a name="line-768"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>updateTyVarKindM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tyvar</span>
<a name="line-769"></a>                <span class='hs-comment'>-- Ordinary (non Tc) tyvars occur inside quantified types</span>
<a name="line-770"></a>
<a name="line-771"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVarBndr</span> <span class='hs-varid'>tv</span>
<a name="line-772"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-773"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-774"></a>
<a name="line-775"></a><span class='hs-comment'>{-
<a name="line-776"></a>Note [Body kind of a forall]
<a name="line-777"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-778"></a>The body of a forall is usually a type, but in principle
<a name="line-779"></a>there's no reason to prohibit *unlifted* types.
<a name="line-780"></a>In fact, GHC can itself construct a function with an
<a name="line-781"></a>unboxed tuple inside a for-all (via CPR analyis; see
<a name="line-782"></a>typecheck/should_compile/tc170).
<a name="line-783"></a>
<a name="line-784"></a>Moreover in instance heads we get forall-types with
<a name="line-785"></a>kind Constraint.
<a name="line-786"></a>
<a name="line-787"></a>Moreover if we have a signature
<a name="line-788"></a>   f :: Int#
<a name="line-789"></a>then we represent it as (HsForAll Implicit [] [] Int#).  And this must
<a name="line-790"></a>be legal!  We can't drop the empty forall until *after* typechecking
<a name="line-791"></a>the body because of kind polymorphism:
<a name="line-792"></a>   Typeable :: forall k. k -&gt; Constraint
<a name="line-793"></a>   data Apply f t = Apply (f t)
<a name="line-794"></a>   -- Apply :: forall k. (k -&gt; *) -&gt; k -&gt; *
<a name="line-795"></a>   instance Typeable Apply where ...
<a name="line-796"></a>Then the dfun has type
<a name="line-797"></a>   df :: forall k. Typeable ((k-&gt;*) -&gt; k -&gt; *) (Apply k)
<a name="line-798"></a>
<a name="line-799"></a>   f :: Typeable Apply
<a name="line-800"></a>
<a name="line-801"></a>   f :: forall (t:k-&gt;*) (a:k).  t a -&gt; t a
<a name="line-802"></a>
<a name="line-803"></a>   class C a b where
<a name="line-804"></a>      op :: a b -&gt; Typeable Apply
<a name="line-805"></a>
<a name="line-806"></a>   data T a = MkT (Typeable Apply)
<a name="line-807"></a>            | T2 a
<a name="line-808"></a>      T :: * -&gt; *
<a name="line-809"></a>      MkT :: forall k. (Typeable ((k-&gt;*) -&gt; k -&gt; *) (Apply k)) -&gt; T a
<a name="line-810"></a>
<a name="line-811"></a>   f :: (forall (k:BOX). forall (t:: k-&gt;*) (a:k). t a -&gt; t a) -&gt; Int
<a name="line-812"></a>   f :: (forall a. a -&gt; Typeable Apply) -&gt; Int
<a name="line-813"></a>
<a name="line-814"></a>So we *must* keep the HsForAll on the instance type
<a name="line-815"></a>   HsForAll Implicit [] [] (Typeable Apply)
<a name="line-816"></a>so that we do kind generalisation on it.
<a name="line-817"></a>
<a name="line-818"></a>Really we should check that it's a type of value kind
<a name="line-819"></a>{*, Constraint, #}, but I'm not doing that yet
<a name="line-820"></a>Example that should be rejected:
<a name="line-821"></a>         f :: (forall (a:*-&gt;*). a) Int
<a name="line-822"></a>
<a name="line-823"></a>Note [Inferring tuple kinds]
<a name="line-824"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-825"></a>Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
<a name="line-826"></a>we try to figure out whether it's a tuple of kind * or Constraint.
<a name="line-827"></a>  Step 1: look at the expected kind
<a name="line-828"></a>  Step 2: infer argument kinds
<a name="line-829"></a>
<a name="line-830"></a>If after Step 2 it's not clear from the arguments that it's
<a name="line-831"></a>Constraint, then it must be *.  Once having decided that we re-check
<a name="line-832"></a>the Check the arguments again to give good error messages
<a name="line-833"></a>in eg. `(Maybe, Maybe)`
<a name="line-834"></a>
<a name="line-835"></a>Note that we will still fail to infer the correct kind in this case:
<a name="line-836"></a>
<a name="line-837"></a>  type T a = ((a,a), D a)
<a name="line-838"></a>  type family D :: Constraint -&gt; Constraint
<a name="line-839"></a>
<a name="line-840"></a>While kind checking T, we do not yet know the kind of D, so we will default the
<a name="line-841"></a>kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.
<a name="line-842"></a>
<a name="line-843"></a>Note [Desugaring types]
<a name="line-844"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-845"></a>The type desugarer is phase 2 of dealing with HsTypes.  Specifically:
<a name="line-846"></a>
<a name="line-847"></a>  * It transforms from HsType to Type
<a name="line-848"></a>
<a name="line-849"></a>  * It zonks any kinds.  The returned type should have no mutable kind
<a name="line-850"></a>    or type variables (hence returning Type not TcType):
<a name="line-851"></a>      - any unconstrained kind variables are defaulted to AnyK just
<a name="line-852"></a>        as in TcHsSyn.
<a name="line-853"></a>      - there are no mutable type variables because we are
<a name="line-854"></a>        kind-checking a type
<a name="line-855"></a>    Reason: the returned type may be put in a TyCon or DataCon where
<a name="line-856"></a>    it will never subsequently be zonked.
<a name="line-857"></a>
<a name="line-858"></a>You might worry about nested scopes:
<a name="line-859"></a>        ..a:kappa in scope..
<a name="line-860"></a>            let f :: forall b. T '[a,b] -&gt; Int
<a name="line-861"></a>In this case, f's type could have a mutable kind variable kappa in it;
<a name="line-862"></a>and we might then default it to AnyK when dealing with f's type
<a name="line-863"></a>signature.  But we don't expect this to happen because we can't get a
<a name="line-864"></a>lexically scoped type variable with a mutable kind variable in it.  A
<a name="line-865"></a>delicate point, this.  If it becomes an issue we might need to
<a name="line-866"></a>distinguish top-level from nested uses.
<a name="line-867"></a>
<a name="line-868"></a>Moreover
<a name="line-869"></a>  * it cannot fail,
<a name="line-870"></a>  * it does no unifications
<a name="line-871"></a>  * it does no validity checking, except for structural matters, such as
<a name="line-872"></a>        (a) spurious ! annotations.
<a name="line-873"></a>        (b) a class used as a type
<a name="line-874"></a>
<a name="line-875"></a>Note [Kind of a type splice]
<a name="line-876"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-877"></a>Consider these terms, each with TH type splice inside:
<a name="line-878"></a>     [| e1 :: Maybe $(..blah..) |]
<a name="line-879"></a>     [| e2 :: $(..blah..) |]
<a name="line-880"></a>When kind-checking the type signature, we'll kind-check the splice
<a name="line-881"></a>$(..blah..); we want to give it a kind that can fit in any context,
<a name="line-882"></a>as if $(..blah..) :: forall k. k.
<a name="line-883"></a>
<a name="line-884"></a>In the e1 example, the context of the splice fixes kappa to *.  But
<a name="line-885"></a>in the e2 example, we'll desugar the type, zonking the kind unification
<a name="line-886"></a>variables as we go.  When we encounter the unconstrained kappa, we
<a name="line-887"></a>want to default it to '*', not to AnyK.
<a name="line-888"></a>
<a name="line-889"></a>
<a name="line-890"></a>Help functions for type applications
<a name="line-891"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-892"></a>-}</span>
<a name="line-893"></a>
<a name="line-894"></a><a name="addTypeCtxt"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-895"></a>        <span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.</span>
<a name="line-896"></a>        <span class='hs-comment'>-- Omit invisble ones and ones user's won't grok</span>
<a name="line-897"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-898"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>thing</span>
<a name="line-899"></a>  <span class='hs-keyword'>where</span>
<a name="line-900"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-901"></a>
<a name="line-902"></a><span class='hs-comment'>{-
<a name="line-903"></a>************************************************************************
<a name="line-904"></a>*                                                                      *
<a name="line-905"></a>                Type-variable binders
<a name="line-906"></a>*                                                                      *
<a name="line-907"></a>************************************************************************
<a name="line-908"></a>-}</span>
<a name="line-909"></a>
<a name="line-910"></a><a name="mkKindSigVar"></a><span class='hs-definition'>mkKindSigVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>KindVar</span>
<a name="line-911"></a><span class='hs-comment'>-- Use the specified name; don't clone it</span>
<a name="line-912"></a><span class='hs-definition'>mkKindSigVar</span> <span class='hs-varid'>n</span>
<a name="line-913"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-914"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-915"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-916"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>k</span>
<a name="line-917"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kvar</span>
<a name="line-918"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-919"></a>
<a name="line-920"></a><a name="kcScopedKindVars"></a><span class='hs-definition'>kcScopedKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-921"></a><span class='hs-comment'>-- Given some tyvar binders like [a (b :: k -&gt; *) (c :: k)]</span>
<a name="line-922"></a><span class='hs-comment'>-- bind each scoped kind variable (k in this case) to a fresh</span>
<a name="line-923"></a><span class='hs-comment'>-- kind skolem variable</span>
<a name="line-924"></a><span class='hs-definition'>kcScopedKindVars</span> <span class='hs-varid'>kv_ns</span> <span class='hs-varid'>thing_inside</span>
<a name="line-925"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span>
<a name="line-926"></a>                     <span class='hs-comment'>-- NB: use mutable signature variables</span>
<a name="line-927"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-928"></a>
<a name="line-929"></a><a name="kcHsTyVarBndrs"></a><span class='hs-comment'>-- | Kind-check a 'LHsTyVarBndrs'. If the decl under consideration has a complete,</span>
<a name="line-930"></a><span class='hs-comment'>-- user-supplied kind signature (CUSK), generalise the result. Used in 'getInitialKind'</span>
<a name="line-931"></a><span class='hs-comment'>-- and in kind-checking. See also Note [Complete user-supplied kind signatures] in</span>
<a name="line-932"></a><span class='hs-comment'>-- HsDecls.</span>
<a name="line-933"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- ^ True &lt;=&gt; the decl being checked has a CUSK</span>
<a name="line-934"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span>
<a name="line-935"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ the result kind, possibly with other info</span>
<a name="line-936"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ The full kind of the thing being declared,</span>
<a name="line-937"></a>                                  <span class='hs-comment'>-- with the other info</span>
<a name="line-938"></a><span class='hs-definition'>kcHsTyVarBndrs</span> <span class='hs-varid'>cusk</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-939"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cusk</span>
<a name="line-940"></a>                <span class='hs-keyword'>then</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mkKindSigVar</span> <span class='hs-varid'>kv_ns</span>
<a name="line-941"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>superKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv_ns</span>
<a name="line-942"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_ns</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-943"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>kc_hs_tv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-944"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-varid'>nks</span> <span class='hs-varid'>thing_inside</span>
<a name="line-945"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>full_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkArrowKinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>nks</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span>
<a name="line-946"></a>             <span class='hs-varid'>kvs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isMetaTyVar</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-947"></a>                         <span class='hs-varid'>varSetElems</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>full_kind</span>
<a name="line-948"></a>             <span class='hs-varid'>gen_kind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>cusk</span>
<a name="line-949"></a>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>full_kind</span>
<a name="line-950"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>full_kind</span>
<a name="line-951"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>gen_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-952"></a>  <span class='hs-keyword'>where</span>
<a name="line-953"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-954"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-955"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-956"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-957"></a>                       <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-958"></a>                       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cusk</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-959"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-960"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-961"></a>    <span class='hs-varid'>kc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-962"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>k</span>
<a name="line-963"></a>               <span class='hs-comment'>-- In an associated type decl, the type variable may already</span>
<a name="line-964"></a>               <span class='hs-comment'>-- be in scope; in that case we want to make sure its kind</span>
<a name="line-965"></a>               <span class='hs-comment'>-- matches the one declared here</span>
<a name="line-966"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>n</span>
<a name="line-967"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_thing</span> <span class='hs-keyword'>of</span>
<a name="line-968"></a>               <span class='hs-conid'>Nothing</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-969"></a>               <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>ks</span>
<a name="line-970"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>thing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"check_in_scope"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-971"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-972"></a>
<a name="line-973"></a><a name="tcHsTyVarBndrs"></a><span class='hs-definition'>tcHsTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span>
<a name="line-974"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-975"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>r</span>
<a name="line-976"></a><span class='hs-comment'>-- Bind the kind variables to fresh skolem variables</span>
<a name="line-977"></a><span class='hs-comment'>-- and type variables to skolems, each with a meta-kind variable kind</span>
<a name="line-978"></a><span class='hs-definition'>tcHsTyVarBndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-979"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>mkKindSigVar</span> <span class='hs-varid'>kv_ns</span>
<a name="line-980"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-981"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tcHsTyVarBndr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-982"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsTyVarBndrs {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-983"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-984"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs</span>
<a name="line-985"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-986"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-987"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsTyVarBndrs }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-988"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hs type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-989"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs</span>
<a name="line-990"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type vars:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-991"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span>  <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-992"></a>
<a name="line-993"></a><a name="tcHsTyVarBndr"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-994"></a><span class='hs-comment'>-- Return a type variable</span>
<a name="line-995"></a><span class='hs-comment'>-- initialised with a kind variable.</span>
<a name="line-996"></a><span class='hs-comment'>-- Typically the Kind inside the HsTyVarBndr will be a tyvar with a mutable kind</span>
<a name="line-997"></a><span class='hs-comment'>-- in it.</span>
<a name="line-998"></a><span class='hs-comment'>--</span>
<a name="line-999"></a><span class='hs-comment'>-- If the variable is already in scope return it, instead of introducing a new</span>
<a name="line-1000"></a><span class='hs-comment'>-- one. This can occur in</span>
<a name="line-1001"></a><span class='hs-comment'>--   instance C (a,b) where</span>
<a name="line-1002"></a><span class='hs-comment'>--     type F (a,b) c = ...</span>
<a name="line-1003"></a><span class='hs-comment'>-- Here a,b will be in scope when processing the associated type instance for F.</span>
<a name="line-1004"></a><span class='hs-comment'>-- See Note [Associated type tyvar names] in Class</span>
<a name="line-1005"></a><span class='hs-definition'>tcHsTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span><span class='hs-layout'>)</span>
<a name="line-1006"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>hs_tv</span>
<a name="line-1007"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupLcl_maybe</span> <span class='hs-varid'>name</span>
<a name="line-1008"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_tv</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1009"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>;</span>
<a name="line-1010"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1011"></a>       <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hs_tv</span> <span class='hs-keyword'>of</span>
<a name="line-1012"></a>                   <span class='hs-conid'>UserTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1013"></a>                   <span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>kind</span>
<a name="line-1014"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1015"></a>
<a name="line-1016"></a><a name="kindGeneralize"></a><span class='hs-comment'>------------------</span>
<a name="line-1017"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1018"></a><span class='hs-definition'>kindGeneralize</span> <span class='hs-varid'>tkvs</span>
<a name="line-1019"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetGlobalTyVars</span> <span class='hs-comment'>-- Already zonked</span>
<a name="line-1020"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>gbl_tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isKindVar</span> <span class='hs-varid'>tkvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1021"></a>                <span class='hs-comment'>-- ToDo: remove the (filter isKindVar)</span>
<a name="line-1022"></a>                <span class='hs-comment'>-- Any type variables in tkvs will be in scope,</span>
<a name="line-1023"></a>                <span class='hs-comment'>-- and hence in gbl_tvs, so after removing gbl_tvs</span>
<a name="line-1024"></a>                <span class='hs-comment'>-- we should only have kind variables left</span>
<a name="line-1025"></a>                <span class='hs-comment'>--</span>
<a name="line-1026"></a>                <span class='hs-comment'>-- BUT there is a smelly case (to be fixed when TH is reorganised)</span>
<a name="line-1027"></a>                <span class='hs-comment'>--     f t = [| e :: $t |]</span>
<a name="line-1028"></a>                <span class='hs-comment'>-- When typechecking the body of the bracket, we typecheck $t to a</span>
<a name="line-1029"></a>                <span class='hs-comment'>-- unification variable 'alpha', with no biding forall.  We don't</span>
<a name="line-1030"></a>                <span class='hs-comment'>-- want to kind-quantify it!</span>
<a name="line-1031"></a>
<a name="line-1032"></a><span class='hs-comment'>{-
<a name="line-1033"></a>Note [Kind generalisation]
<a name="line-1034"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1035"></a>We do kind generalisation only at the outer level of a type signature.
<a name="line-1036"></a>For example, consider
<a name="line-1037"></a>  T :: forall k. k -&gt; *
<a name="line-1038"></a>  f :: (forall a. T a -&gt; Int) -&gt; Int
<a name="line-1039"></a>When kind-checking f's type signature we generalise the kind at
<a name="line-1040"></a>the outermost level, thus:
<a name="line-1041"></a>  f1 :: forall k. (forall (a:k). T k a -&gt; Int) -&gt; Int  -- YES!
<a name="line-1042"></a>and *not* at the inner forall:
<a name="line-1043"></a>  f2 :: (forall k. forall (a:k). T k a -&gt; Int) -&gt; Int  -- NO!
<a name="line-1044"></a>Reason: same as for HM inference on value level declarations,
<a name="line-1045"></a>we want to infer the most general type.  The f2 type signature
<a name="line-1046"></a>would be *less applicable* than f1, because it requires a more
<a name="line-1047"></a>polymorphic argument.
<a name="line-1048"></a>
<a name="line-1049"></a>Note [Kinds of quantified type variables]
<a name="line-1050"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1051"></a>tcTyVarBndrsGen quantifies over a specified list of type variables,
<a name="line-1052"></a>*and* over the kind variables mentioned in the kinds of those tyvars.
<a name="line-1053"></a>
<a name="line-1054"></a>Note that we must zonk those kinds (obviously) but less obviously, we
<a name="line-1055"></a>must return type variables whose kinds are zonked too. Example
<a name="line-1056"></a>    (a :: k7)  where  k7 := k9 -&gt; k9
<a name="line-1057"></a>We must return
<a name="line-1058"></a>    [k9, a:k9-&gt;k9]
<a name="line-1059"></a>and NOT
<a name="line-1060"></a>    [k9, a:k7]
<a name="line-1061"></a>Reason: we're going to turn this into a for-all type,
<a name="line-1062"></a>   forall k9. forall (a:k7). blah
<a name="line-1063"></a>which the type checker will then instantiate, and instantiate does not
<a name="line-1064"></a>look through unification variables!
<a name="line-1065"></a>
<a name="line-1066"></a>Hence using zonked_kinds when forming tvs'.
<a name="line-1067"></a>-}</span>
<a name="line-1068"></a>
<a name="line-1069"></a><a name="kcLookupKind"></a><span class='hs-comment'>--------------------</span>
<a name="line-1070"></a><span class='hs-comment'>-- getInitialKind has made a suitably-shaped kind for the type or class</span>
<a name="line-1071"></a><span class='hs-comment'>-- Unpack it, and attribute those kinds to the type variables</span>
<a name="line-1072"></a><span class='hs-comment'>-- Extend the env with bindings for the tyvars, taken from</span>
<a name="line-1073"></a><span class='hs-comment'>-- the kind of the tycon/class.  Give it to the thing inside, and</span>
<a name="line-1074"></a><span class='hs-comment'>-- check the result kind matches</span>
<a name="line-1075"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1076"></a><span class='hs-definition'>kcLookupKind</span> <span class='hs-varid'>nm</span>
<a name="line-1077"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>nm</span>
<a name="line-1078"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tc_ty_thing</span> <span class='hs-keyword'>of</span>
<a name="line-1079"></a>           <span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-1080"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1081"></a>           <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kcLookupKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_ty_thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1082"></a>
<a name="line-1083"></a><a name="kcTyClTyVars"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1084"></a><span class='hs-comment'>-- Used for the type variables of a type or class decl,</span>
<a name="line-1085"></a><span class='hs-comment'>-- when doing the initial kind-check.</span>
<a name="line-1086"></a><span class='hs-definition'>kcTyClTyVars</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1087"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcScopedKindVars</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>$</span>
<a name="line-1088"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kcLookupKind</span> <span class='hs-varid'>name</span>
<a name="line-1089"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mono_kind</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>tc_kind</span>
<a name="line-1090"></a>                     <span class='hs-comment'>-- if we have a FullKindSignature, the tc_kind may already</span>
<a name="line-1091"></a>                     <span class='hs-comment'>-- be generalized. The kvs get matched up while kind-checking</span>
<a name="line-1092"></a>                     <span class='hs-comment'>-- the types in kc_tv, below</span>
<a name="line-1093"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>arg_ks</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>mono_kind</span>
<a name="line-1094"></a>                     <span class='hs-comment'>-- There should be enough arrows, because</span>
<a name="line-1095"></a>                     <span class='hs-comment'>-- getInitialKinds used the tcdTyVars</span>
<a name="line-1096"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>name_ks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>kc_tv</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>arg_ks</span>
<a name="line-1097"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendKindEnv</span> <span class='hs-varid'>name_ks</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-1098"></a>  <span class='hs-keyword'>where</span>
<a name="line-1099"></a>    <span class='hs-comment'>-- getInitialKind has already gotten the kinds of these type</span>
<a name="line-1100"></a>    <span class='hs-comment'>-- variables, but tiresomely we need to check them *again*</span>
<a name="line-1101"></a>    <span class='hs-comment'>-- to match the kind variables they mention against the ones</span>
<a name="line-1102"></a>    <span class='hs-comment'>-- we've freshly brought into scope</span>
<a name="line-1103"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-1104"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_k</span>
<a name="line-1105"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_k</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>    <span class='hs-varid'>kc_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_k</span>
<a name="line-1107"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>hs_k</span>
<a name="line-1108"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>k</span> <span class='hs-varid'>exp_k</span>
<a name="line-1109"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1110"></a>
<a name="line-1111"></a><a name="tcTyClTyVars"></a><span class='hs-comment'>-----------------------</span>
<a name="line-1112"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span>      <span class='hs-comment'>-- LHS of the type or class decl</span>
<a name="line-1113"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1114"></a><span class='hs-comment'>-- Used for the type variables of a type or class decl,</span>
<a name="line-1115"></a><span class='hs-comment'>-- on the second pass when constructing the final result</span>
<a name="line-1116"></a><span class='hs-comment'>-- (tcTyClTyVars T [a,b] thing_inside)</span>
<a name="line-1117"></a><span class='hs-comment'>--   where T : forall k1 k2 (a:k1 -&gt; *) (b:k1). k2 -&gt; *</span>
<a name="line-1118"></a><span class='hs-comment'>--   calls thing_inside with arguments</span>
<a name="line-1119"></a><span class='hs-comment'>--      [k1,k2,a,b] (k2 -&gt; *)</span>
<a name="line-1120"></a><span class='hs-comment'>--   having also extended the type environment with bindings</span>
<a name="line-1121"></a><span class='hs-comment'>--   for k1,k2,a,b</span>
<a name="line-1122"></a><span class='hs-comment'>--</span>
<a name="line-1123"></a><span class='hs-comment'>-- No need to freshen the k's because they are just skolem</span>
<a name="line-1124"></a><span class='hs-comment'>-- constants here, and we are at top level anyway.</span>
<a name="line-1125"></a><span class='hs-definition'>tcTyClTyVars</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-1126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcScopedKindVars</span> <span class='hs-varid'>hs_kvs</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- Bind scoped kind vars to fresh kind univ vars</span>
<a name="line-1127"></a>                              <span class='hs-comment'>-- There may be fewer of these than the kvs of</span>
<a name="line-1128"></a>                              <span class='hs-comment'>-- the type constructor, of course</span>
<a name="line-1129"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>tycon</span>
<a name="line-1130"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1131"></a>                        <span class='hs-conid'>AThing</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kind</span>
<a name="line-1132"></a>                        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcTyClTyVars"</span>
<a name="line-1133"></a>                     <span class='hs-comment'>-- We only call tcTyClTyVars during typechecking in</span>
<a name="line-1134"></a>                     <span class='hs-comment'>-- TcTyClDecls, where the local env is extended with</span>
<a name="line-1135"></a>                     <span class='hs-comment'>-- the generalized_env (mapping Names to AThings).</span>
<a name="line-1136"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys</span> <span class='hs-varid'>kind</span>
<a name="line-1137"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTysN</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span>
<a name="line-1138"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>tc_hs_tv</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>kinds</span>
<a name="line-1139"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendTyVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1140"></a>  <span class='hs-keyword'>where</span>
<a name="line-1141"></a>    <span class='hs-comment'>-- In the case of associated types, the renamer has</span>
<a name="line-1142"></a>    <span class='hs-comment'>-- ensured that the names are in commmon</span>
<a name="line-1143"></a>    <span class='hs-comment'>-- e.g.   class C a_29 where</span>
<a name="line-1144"></a>    <span class='hs-comment'>--           type T b_30 a_29 :: *</span>
<a name="line-1145"></a>    <span class='hs-comment'>-- Here the a_29 is shared</span>
<a name="line-1146"></a>    <span class='hs-varid'>tc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1147"></a>    <span class='hs-varid'>tc_hs_tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-1148"></a>                                        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKind</span> <span class='hs-varid'>hs_k</span>
<a name="line-1149"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>checkKind</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>tc_kind</span>
<a name="line-1150"></a>                                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1151"></a>
<a name="line-1152"></a><a name="tcDataKindSig"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-1153"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1154"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-1155"></a><span class='hs-comment'>--      e.g.  data T :: * -&gt; * -&gt; * where ...</span>
<a name="line-1156"></a><span class='hs-comment'>-- This function makes up suitable (kinded) type variables for</span>
<a name="line-1157"></a><span class='hs-comment'>-- the argument kinds, and checks that the result kind is indeed *.</span>
<a name="line-1158"></a><span class='hs-comment'>-- We use it also to make up argument type variables for for data instances.</span>
<a name="line-1159"></a><span class='hs-definition'>tcDataKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-1160"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badKindSig</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1161"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>span</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-1162"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>us</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-1163"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-1164"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>us</span>
<a name="line-1165"></a>              <span class='hs-varid'>occs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allNameStrings</span>
<a name="line-1166"></a>                            <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-1167"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1168"></a>                 <span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-1169"></a>
<a name="line-1170"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>span</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>kind</span>
<a name="line-1171"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>occs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>uniqs</span> <span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-1172"></a>  <span class='hs-keyword'>where</span>
<a name="line-1173"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>arg_kinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>kind</span>
<a name="line-1174"></a>    <span class='hs-varid'>mk_tv</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>kind</span>
<a name="line-1175"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-1176"></a>
<a name="line-1177"></a><a name="badKindSig"></a><span class='hs-definition'>badKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1178"></a><span class='hs-definition'>badKindSig</span> <span class='hs-varid'>kind</span>
<a name="line-1179"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind signature on data type declaration has non-* return kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1181"></a>
<a name="line-1182"></a><span class='hs-comment'>{-
<a name="line-1183"></a>Note [Avoid name clashes for associated data types]
<a name="line-1184"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1185"></a>Consider    class C a b where
<a name="line-1186"></a>               data D b :: * -&gt; *
<a name="line-1187"></a>When typechecking the decl for D, we'll invent an extra type variable
<a name="line-1188"></a>for D, to fill out its kind.  Ideally we don't want this type variable
<a name="line-1189"></a>to be 'a', because when pretty printing we'll get
<a name="line-1190"></a>            class C a b where
<a name="line-1191"></a>               data D b a0
<a name="line-1192"></a>(NB: the tidying happens in the conversion to IfaceSyn, which happens
<a name="line-1193"></a>as part of pretty-printing a TyThing.)
<a name="line-1194"></a>
<a name="line-1195"></a>That's why we look in the LocalRdrEnv to see what's in scope. This is
<a name="line-1196"></a>important only to get nice-looking output when doing ":info C" in GHCi.
<a name="line-1197"></a>It isn't essential for correctness.
<a name="line-1198"></a>
<a name="line-1199"></a>
<a name="line-1200"></a>************************************************************************
<a name="line-1201"></a>*                                                                      *
<a name="line-1202"></a>                Scoped type variables
<a name="line-1203"></a>*                                                                      *
<a name="line-1204"></a>************************************************************************
<a name="line-1205"></a>
<a name="line-1206"></a>
<a name="line-1207"></a>tcAddScopedTyVars is used for scoped type variables added by pattern
<a name="line-1208"></a>type signatures
<a name="line-1209"></a>        e.g.  \ ((x::a), (y::a)) -&gt; x+y
<a name="line-1210"></a>They never have explicit kinds (because this is source-code only)
<a name="line-1211"></a>They are mutable (because they can get bound to a more specific type).
<a name="line-1212"></a>
<a name="line-1213"></a>Usually we kind-infer and expand type splices, and then
<a name="line-1214"></a>tupecheck/desugar the type.  That doesn't work well for scoped type
<a name="line-1215"></a>variables, because they scope left-right in patterns.  (e.g. in the
<a name="line-1216"></a>example above, the 'a' in (y::a) is bound by the 'a' in (x::a).
<a name="line-1217"></a>
<a name="line-1218"></a>The current not-very-good plan is to
<a name="line-1219"></a>  * find all the types in the patterns
<a name="line-1220"></a>  * find their free tyvars
<a name="line-1221"></a>  * do kind inference
<a name="line-1222"></a>  * bring the kinded type vars into scope
<a name="line-1223"></a>  * BUT throw away the kind-checked type
<a name="line-1224"></a>        (we'll kind-check it again when we type-check the pattern)
<a name="line-1225"></a>
<a name="line-1226"></a>This is bad because throwing away the kind checked type throws away
<a name="line-1227"></a>its splices.  But too bad for now.  [July 03]
<a name="line-1228"></a>
<a name="line-1229"></a>Historical note:
<a name="line-1230"></a>    We no longer specify that these type variables must be univerally
<a name="line-1231"></a>    quantified (lots of email on the subject).  If you want to put that
<a name="line-1232"></a>    back in, you need to
<a name="line-1233"></a>        a) Do a checkSigTyVars after thing_inside
<a name="line-1234"></a>        b) More insidiously, don't pass in expected_ty, else
<a name="line-1235"></a>           we unify with it too early and checkSigTyVars barfs
<a name="line-1236"></a>           Instead you have to pass in a fresh ty var, and unify
<a name="line-1237"></a>           it with expected_ty afterwards
<a name="line-1238"></a>-}</span>
<a name="line-1239"></a>
<a name="line-1240"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-1241"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- The type signature</span>
<a name="line-1242"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span>                      <span class='hs-comment'>-- The signature</span>
<a name="line-1243"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-1244"></a>                                              <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-1245"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- The wildcards</span>
<a name="line-1246"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-1247"></a><span class='hs-comment'>-- (a) patterns           e.g  f (x::Int) = e</span>
<a name="line-1248"></a><span class='hs-comment'>-- (b) result signatures  e.g. g x :: Int = e</span>
<a name="line-1249"></a><span class='hs-comment'>-- (c) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-1250"></a>
<a name="line-1251"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_kvs</span><span class='hs-layout'>,</span>
<a name="line-1252"></a>                            <span class='hs-varid'>hswb_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1254"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_kv</span> <span class='hs-varid'>sig_kvs</span>
<a name="line-1255"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-1256"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>nwc_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newWildcardVarMetaKind</span> <span class='hs-varid'>sig_wcs</span>
<a name="line-1257"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nwc_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>nwc_tvs</span>
<a name="line-1258"></a>              <span class='hs-varid'>ktv_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_kvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_tvs</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1259"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendTyVarEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ktv_binds</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nwc_binds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1260"></a>                    <span class='hs-varid'>tcHsLiftedType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1261"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkSigType</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1262"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1263"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>emitWildcardHoleConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varid'>nwc_tvs</span><span class='hs-layout'>)</span>
<a name="line-1264"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ktv_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>nwc_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1265"></a>  <span class='hs-keyword'>where</span>
<a name="line-1266"></a>    <span class='hs-varid'>new_kv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>superKind</span>
<a name="line-1267"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1268"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1269"></a>
<a name="line-1270"></a>    <span class='hs-varid'>new_tkv</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>   <span class='hs-comment'>-- See Note [Pattern signature binders]</span>
<a name="line-1271"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-1272"></a>          <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1273"></a>          <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSigTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>  <span class='hs-comment'>-- See Note [Unifying SigTvs]</span>
<a name="line-1274"></a>
<a name="line-1275"></a><a name="tcPatSig"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>                    <span class='hs-comment'>-- True &lt;=&gt; pattern binding</span>
<a name="line-1276"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-1277"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcSigmaType</span>
<a name="line-1278"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- The type to use for "inside" the signature</span>
<a name="line-1279"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-1280"></a>                                    <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-1281"></a>                 <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The wildcards</span>
<a name="line-1282"></a>                 <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- Coercion due to unification with actual ty</span>
<a name="line-1283"></a>                                    <span class='hs-comment'>-- Of shape:  res_ty ~ sig_ty</span>
<a name="line-1284"></a><span class='hs-definition'>tcPatSig</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-varid'>sig</span> <span class='hs-varid'>res_ty</span>
<a name="line-1285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_nwcs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcHsPatSigType</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>sig</span>
<a name="line-1286"></a>        <span class='hs-comment'>-- sig_tvs are the type variables free in 'sig',</span>
<a name="line-1287"></a>        <span class='hs-comment'>-- and not already in scope. These are the ones</span>
<a name="line-1288"></a>        <span class='hs-comment'>-- that should be brought into scope</span>
<a name="line-1289"></a>
<a name="line-1290"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>sig_tvs</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>
<a name="line-1291"></a>                <span class='hs-comment'>-- Just do the subsumption check and return</span>
<a name="line-1292"></a>                  <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1293"></a>                          <span class='hs-varid'>tcSubType_NC</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1294"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-1295"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1296"></a>                <span class='hs-comment'>-- Type signature binds at least one scoped type variable</span>
<a name="line-1297"></a>
<a name="line-1298"></a>                <span class='hs-comment'>-- A pattern binding cannot bind scoped type variables</span>
<a name="line-1299"></a>                <span class='hs-comment'>-- It is more convenient to make the test here</span>
<a name="line-1300"></a>                <span class='hs-comment'>-- than in the renamer</span>
<a name="line-1301"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>when</span> <span class='hs-varid'>in_pat_bind</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1302"></a>
<a name="line-1303"></a>                <span class='hs-comment'>-- Check that all newly-in-scope tyvars are in fact</span>
<a name="line-1304"></a>                <span class='hs-comment'>-- constrained by the pattern.  This catches tiresome</span>
<a name="line-1305"></a>                <span class='hs-comment'>-- cases like</span>
<a name="line-1306"></a>                <span class='hs-comment'>--      type T a = Int</span>
<a name="line-1307"></a>                <span class='hs-comment'>--      f :: Int -&gt; Int</span>
<a name="line-1308"></a>                <span class='hs-comment'>--      f (x :: T a) = ...</span>
<a name="line-1309"></a>                <span class='hs-comment'>-- Here 'a' doesn't get a binding.  Sigh</span>
<a name="line-1310"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bad_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-1311"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>exactTyVarsOfType</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1312"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span>
<a name="line-1313"></a>
<a name="line-1314"></a>        <span class='hs-comment'>-- Now do a subsumption check of the pattern signature against res_ty</span>
<a name="line-1315"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxtM</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1316"></a>                  <span class='hs-varid'>tcSubType_NC</span> <span class='hs-conid'>PatSigCtxt</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1317"></a>
<a name="line-1318"></a>        <span class='hs-comment'>-- Phew!</span>
<a name="line-1319"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span>
<a name="line-1320"></a>        <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1321"></a>  <span class='hs-keyword'>where</span>
<a name="line-1322"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>tidy_env</span>
<a name="line-1323"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>sig_ty</span>
<a name="line-1324"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>res_ty</span>
<a name="line-1325"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"When checking that the pattern signature:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1326"></a>                                  <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-1327"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"fits the type of its context:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1328"></a>                                          <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>res_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1329"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1330"></a>
<a name="line-1331"></a><a name="patBindSigErr"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1332"></a><span class='hs-definition'>patBindSigErr</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-1333"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"You cannot bind scoped type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>sig_tvs</span>
<a name="line-1334"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>sig_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1335"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in a pattern binding signature"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1336"></a>
<a name="line-1337"></a><span class='hs-comment'>{-
<a name="line-1338"></a>Note [Pattern signature binders]
<a name="line-1339"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1340"></a>Consider
<a name="line-1341"></a>   data T = forall a. T a (a-&gt;Int)
<a name="line-1342"></a>   f (T x (f :: a-&gt;Int) = blah)
<a name="line-1343"></a>
<a name="line-1344"></a>Here
<a name="line-1345"></a> * The pattern (T p1 p2) creates a *skolem* type variable 'a_sk',
<a name="line-1346"></a>   It must be a skolem so that that it retains its identity, and
<a name="line-1347"></a>   TcErrors.getSkolemInfo can thereby find the binding site for the skolem.
<a name="line-1348"></a>
<a name="line-1349"></a> * The type signature pattern (f :: a-&gt;Int) binds "a" -&gt; a_sig in the envt
<a name="line-1350"></a>
<a name="line-1351"></a> * Then unificaiton makes a_sig := a_sk
<a name="line-1352"></a>
<a name="line-1353"></a>That's why we must make a_sig a MetaTv (albeit a SigTv),
<a name="line-1354"></a>not a SkolemTv, so that it can unify to a_sk.
<a name="line-1355"></a>
<a name="line-1356"></a>For RULE binders, though, things are a bit different (yuk).
<a name="line-1357"></a>  RULE "foo" forall (x::a) (y::[a]).  f x y = ...
<a name="line-1358"></a>Here this really is the binding site of the type variable so we'd like
<a name="line-1359"></a>to use a skolem, so that we get a complaint if we unify two of them
<a name="line-1360"></a>together.
<a name="line-1361"></a>
<a name="line-1362"></a>Note [Unifying SigTvs]
<a name="line-1363"></a>~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1364"></a>ALAS we have no decent way of avoiding two SigTvs getting unified.
<a name="line-1365"></a>Consider
<a name="line-1366"></a>  f (x::(a,b)) (y::c)) = [fst x, y]
<a name="line-1367"></a>Here we'd really like to complain that 'a' and 'c' are unified. But
<a name="line-1368"></a>for the reasons above we can't make a,b,c into skolems, so they
<a name="line-1369"></a>are just SigTvs that can unify.  And indeed, this would be ok,
<a name="line-1370"></a>  f x (y::c) = case x of
<a name="line-1371"></a>                 (x1 :: a1, True) -&gt; [x,y]
<a name="line-1372"></a>                 (x1 :: a2, False) -&gt; [x,y,y]
<a name="line-1373"></a>Here the type of x's first component is called 'a1' in one branch and
<a name="line-1374"></a>'a2' in the other.  We could try insisting on the same OccName, but
<a name="line-1375"></a>they definitely won't have the sane lexical Name.
<a name="line-1376"></a>
<a name="line-1377"></a>I think we could solve this by recording in a SigTv a list of all the
<a name="line-1378"></a>in-scope variables that it should not unify with, but it's fiddly.
<a name="line-1379"></a>
<a name="line-1380"></a>
<a name="line-1381"></a>************************************************************************
<a name="line-1382"></a>*                                                                      *
<a name="line-1383"></a>        Checking kinds
<a name="line-1384"></a>*                                                                      *
<a name="line-1385"></a>************************************************************************
<a name="line-1386"></a>
<a name="line-1387"></a>We would like to get a decent error message from
<a name="line-1388"></a>  (a) Under-applied type constructors
<a name="line-1389"></a>             f :: (Maybe, Maybe)
<a name="line-1390"></a>  (b) Over-applied type constructors
<a name="line-1391"></a>             f :: Int x -&gt; Int x
<a name="line-1392"></a>-}</span>
<a name="line-1393"></a>
<a name="line-1394"></a><a name="ExpKind"></a><span class='hs-comment'>-- The ExpKind datatype means "expected kind" and contains</span>
<a name="line-1395"></a><a name="ExpKind"></a><span class='hs-comment'>-- some info about just why that kind is expected, to improve</span>
<a name="line-1396"></a><a name="ExpKind"></a><span class='hs-comment'>-- the error message on a mis-match</span>
<a name="line-1397"></a><a name="ExpKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-conid'>TcKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-1398"></a>   <span class='hs-comment'>-- The second arg is function that takes a *tidied* version</span>
<a name="line-1399"></a>   <span class='hs-comment'>-- of the first arg, and produces something like</span>
<a name="line-1400"></a>   <span class='hs-comment'>--    "Expected kind k"</span>
<a name="line-1401"></a>   <span class='hs-comment'>--    "Expected a constraint"</span>
<a name="line-1402"></a>   <span class='hs-comment'>--    "The argument of Maybe should have kind k"</span>
<a name="line-1403"></a>
<a name="line-1404"></a><a name="instance%20Outputable%20ExpKind"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyword'>where</span>
<a name="line-1405"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>k</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>k</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="ekLifted"></a><span class='hs-definition'>ekLifted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekOpen</span><span class='hs-layout'>,</span> <span class='hs-varid'>ekConstraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExpKind</span>
<a name="line-1408"></a><span class='hs-definition'>ekLifted</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>expectedKindMsg</span>
<a name="line-1409"></a><a name="ekOpen"></a><span class='hs-definition'>ekOpen</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>openTypeKind</span>   <span class='hs-varid'>expectedKindMsg</span>
<a name="line-1410"></a><a name="ekConstraint"></a><span class='hs-definition'>ekConstraint</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>expectedKindMsg</span>
<a name="line-1411"></a>
<a name="line-1412"></a><a name="expectedKindMsg"></a><span class='hs-definition'>expectedKindMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1413"></a><span class='hs-definition'>expectedKindMsg</span> <span class='hs-varid'>pkind</span>
<a name="line-1414"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isConstraintKind</span> <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected a constraint"</span><span class='hs-layout'>)</span>
<a name="line-1415"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOpenTypeKind</span>   <span class='hs-varid'>pkind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected a type"</span><span class='hs-layout'>)</span>
<a name="line-1416"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expected kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span>
<a name="line-1417"></a>
<a name="line-1418"></a><a name="expArgKind"></a><span class='hs-comment'>-- Build an ExpKind for arguments</span>
<a name="line-1419"></a><span class='hs-definition'>expArgKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span>
<a name="line-1420"></a><span class='hs-definition'>expArgKind</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EK</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>msg_fn</span>
<a name="line-1421"></a>  <span class='hs-keyword'>where</span>
<a name="line-1422"></a>    <span class='hs-varid'>msg_fn</span> <span class='hs-varid'>pkind</span>
<a name="line-1423"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span>
<a name="line-1424"></a>              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>exp</span>
<a name="line-1425"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should have kind"</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>pkind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1427"></a>
<a name="line-1428"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcKind</span>
<a name="line-1429"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>act_kinds</span>
<a name="line-1430"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1431"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1432"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>expArgKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>)</span>
<a name="line-1433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>act_kinds</span><span class='hs-layout'>)</span>
<a name="line-1434"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-1435"></a>
<a name="line-1436"></a><a name="checkKind"></a><span class='hs-definition'>checkKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1437"></a><span class='hs-definition'>checkKind</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1438"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKindX</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1439"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyword'>of</span>
<a name="line-1440"></a>           <span class='hs-conid'>Just</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1441"></a>           <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unifyKindMisMatch</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1442"></a>
<a name="line-1443"></a><a name="checkExpectedKind"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExpKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1444"></a><span class='hs-comment'>-- A fancy wrapper for 'unifyKindX', which tries</span>
<a name="line-1445"></a><span class='hs-comment'>-- to give decent error messages.</span>
<a name="line-1446"></a><span class='hs-comment'>--      (checkExpectedKind ty act_kind exp_kind)</span>
<a name="line-1447"></a><span class='hs-comment'>-- checks that the actual kind act_kind is compatible</span>
<a name="line-1448"></a><span class='hs-comment'>--      with the expected kind exp_kind</span>
<a name="line-1449"></a><span class='hs-comment'>-- The first argument, ty, is used only in the error message generation</span>
<a name="line-1450"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EK</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varid'>ek_ctxt</span><span class='hs-layout'>)</span>
<a name="line-1451"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKindX</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1452"></a>
<a name="line-1453"></a>         <span class='hs-comment'>-- Kind unification only generates definite errors</span>
<a name="line-1454"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_subk</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-1455"></a>          <span class='hs-conid'>Just</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>    <span class='hs-comment'>-- act_kind is a sub-kind of exp_kind</span>
<a name="line-1456"></a>          <span class='hs-conid'>Just</span> <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>;</span>    <span class='hs-comment'>-- The two are equal</span>
<a name="line-1457"></a>          <span class='hs-sel'>_other</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1458"></a>
<a name="line-1459"></a>      <span class='hs-layout'>{</span>  <span class='hs-comment'>-- So there's an error</span>
<a name="line-1460"></a>         <span class='hs-comment'>-- Now to find out what sort</span>
<a name="line-1461"></a>        <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1462"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>act_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-1463"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1464"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-1465"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1466"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1467"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>act_as</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitKindFunTys</span> <span class='hs-varid'>act_kind</span>
<a name="line-1468"></a>            <span class='hs-varid'>n_exp_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>exp_as</span>
<a name="line-1469"></a>            <span class='hs-varid'>n_act_as</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>act_as</span>
<a name="line-1470"></a>            <span class='hs-varid'>n_diff_as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_act_as</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_exp_as</span>
<a name="line-1471"></a>
<a name="line-1472"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_exp_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1473"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenKind</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>act_kind</span>
<a name="line-1474"></a>
<a name="line-1475"></a>            <span class='hs-varid'>occurs_check</span>
<a name="line-1476"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>act_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>act_kind</span>
<a name="line-1477"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_occ</span> <span class='hs-varid'>act_tv</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1478"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>exp_tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1479"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_occ</span> <span class='hs-varid'>exp_tv</span> <span class='hs-varid'>act_kind</span>
<a name="line-1480"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1481"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1482"></a>
<a name="line-1483"></a>            <span class='hs-varid'>check_occ</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occurCheckExpand</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>of</span>
<a name="line-1484"></a>                                <span class='hs-conid'>OC_Occurs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1485"></a>                                <span class='hs-sel'>_bad</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1486"></a>
<a name="line-1487"></a>            <span class='hs-varid'>err</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-1488"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting a lifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1489"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is unlifted"</span><span class='hs-layout'>)</span>
<a name="line-1490"></a>
<a name="line-1491"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnliftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>act_kind</span>
<a name="line-1492"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting an unlifted type, but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1493"></a>                    <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is lifted"</span><span class='hs-layout'>)</span>
<a name="line-1494"></a>
<a name="line-1495"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>occurs_check</span>   <span class='hs-comment'>-- Must precede the "more args expected" check</span>
<a name="line-1496"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind occurs check"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>more_info</span>
<a name="line-1497"></a>
<a name="line-1498"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_exp_as</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_act_as</span>     <span class='hs-comment'>-- E.g. [Maybe]</span>
<a name="line-1499"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Expecting"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1500"></a>                         <span class='hs-varid'>speakN</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"more argument"</span><span class='hs-layout'>)</span>
<a name="line-1501"></a>                         <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>n_diff_as</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'s'</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-1502"></a>                         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1503"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>more_info</span> <span class='hs-keyglyph'>]</span>
<a name="line-1504"></a>
<a name="line-1505"></a>                  <span class='hs-comment'>-- Now n_exp_as &gt;= n_act_as. In the next two cases,</span>
<a name="line-1506"></a>                  <span class='hs-comment'>-- n_exp_as == 0, and hence so is n_act_as</span>
<a name="line-1507"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-comment'>-- E.g. Monad [Int]</span>
<a name="line-1508"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>more_info</span>
<a name="line-1509"></a>
<a name="line-1510"></a>            <span class='hs-varid'>more_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ek_ctxt</span> <span class='hs-varid'>tidy_exp_kind</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1511"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1512"></a>                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"has kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprKind</span> <span class='hs-varid'>tidy_act_kind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1513"></a>
<a name="line-1514"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind 1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_act_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_exp_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>env2</span><span class='hs-layout'>)</span>
<a name="line-1515"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1516"></a>
<a name="line-1517"></a><span class='hs-comment'>{-
<a name="line-1518"></a>************************************************************************
<a name="line-1519"></a>*                                                                      *
<a name="line-1520"></a>        Sort checking kinds
<a name="line-1521"></a>*                                                                      *
<a name="line-1522"></a>************************************************************************
<a name="line-1523"></a>
<a name="line-1524"></a>tcLHsKind converts a user-written kind to an internal, sort-checked kind.
<a name="line-1525"></a>It does sort checking and desugaring at the same time, in one single pass.
<a name="line-1526"></a>It fails when the kinds are not well-formed (eg. data A :: * Int), or if there
<a name="line-1527"></a>are non-promotable or non-fully applied kinds.
<a name="line-1528"></a>-}</span>
<a name="line-1529"></a>
<a name="line-1530"></a><a name="tcLHsKind"></a><span class='hs-definition'>tcLHsKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1531"></a><span class='hs-definition'>tcLHsKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the kind"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1532"></a>              <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>k</span>
<a name="line-1533"></a>
<a name="line-1534"></a><a name="tc_lhs_kind"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1535"></a><span class='hs-definition'>tc_lhs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_hs_kind</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-1536"></a>
<a name="line-1537"></a><a name="tc_hs_kind"></a><span class='hs-comment'>-- The main worker</span>
<a name="line-1538"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1539"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_var_app</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span>
<a name="line-1540"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_app</span> <span class='hs-varid'>k</span> <span class='hs-conid'>[]</span>
<a name="line-1541"></a>
<a name="line-1542"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-1543"></a>
<a name="line-1544"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1545"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki1</span>
<a name="line-1546"></a>     <span class='hs-varid'>kappa_ki2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki2</span>
<a name="line-1547"></a>     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkArrowKind</span> <span class='hs-varid'>kappa_ki1</span> <span class='hs-varid'>kappa_ki2</span><span class='hs-layout'>)</span>
<a name="line-1548"></a>
<a name="line-1549"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1550"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>ki</span>
<a name="line-1551"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-1552"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPromotedListTy</span> <span class='hs-varid'>kappa</span>
<a name="line-1553"></a>
<a name="line-1554"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1555"></a>  <span class='hs-keyword'>do</span> <span class='hs-varid'>kappas</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-1556"></a>     <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-1557"></a>     <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>kappas</span>
<a name="line-1558"></a>  <span class='hs-keyword'>where</span>
<a name="line-1559"></a>     <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleTyCon</span> <span class='hs-conid'>BoxedTuple</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-1560"></a>
<a name="line-1561"></a><span class='hs-comment'>-- Argument not kind-shaped</span>
<a name="line-1562"></a><span class='hs-definition'>tc_hs_kind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tc_hs_kind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-1563"></a>
<a name="line-1564"></a><a name="tc_kind_app"></a><span class='hs-comment'>-- Special case for kind application</span>
<a name="line-1565"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1566"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>)</span> <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ki1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki2</span><span class='hs-conop'>:</span><span class='hs-varid'>kis</span><span class='hs-layout'>)</span>
<a name="line-1567"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>      <span class='hs-varid'>kis</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kis</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>tc_lhs_kind</span> <span class='hs-varid'>kis</span>
<a name="line-1568"></a>                                       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_kind_var_app</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>arg_kis</span> <span class='hs-layout'>}</span>
<a name="line-1569"></a><span class='hs-definition'>tc_kind_app</span> <span class='hs-varid'>ki</span>                <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1570"></a>                                    <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is not a kind constructor"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>
<a name="line-1572"></a><a name="tc_kind_var_app"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-1573"></a><span class='hs-comment'>-- Special case for * and Constraint kinds</span>
<a name="line-1574"></a><span class='hs-comment'>-- They are kinds already, so we don't need to promote them</span>
<a name="line-1575"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span>
<a name="line-1576"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>liftedTypeKindTyConName</span>
<a name="line-1577"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>constraintKindTyConName</span>
<a name="line-1578"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-1579"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be applied"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1580"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-1581"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1582"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1583"></a>           <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tc_kind_var_app 1"</span> <span class='hs-layout'>}</span>
<a name="line-1584"></a>
<a name="line-1585"></a><span class='hs-comment'>-- General case</span>
<a name="line-1586"></a><span class='hs-definition'>tc_kind_var_app</span> <span class='hs-varid'>name</span> <span class='hs-varid'>arg_kis</span>
<a name="line-1587"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-1588"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1589"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1590"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-1591"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1592"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>promotableTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1593"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>prom_tc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arg_kis</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>prom_tc</span>
<a name="line-1594"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>prom_tc</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-1595"></a>                       <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-str'>"is not fully applied"</span>
<a name="line-1596"></a>                       <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-str'>"is not promotable"</span> <span class='hs-layout'>}</span>
<a name="line-1597"></a>
<a name="line-1598"></a>           <span class='hs-comment'>-- A lexically scoped kind variable</span>
<a name="line-1599"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind_var</span>
<a name="line-1600"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKindVar</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span>
<a name="line-1601"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span>
<a name="line-1602"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used as a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1603"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Kind variables always have kind BOX,</span>
<a name="line-1604"></a>                                  <span class='hs-comment'>-- so cannot be applied to anything</span>
<a name="line-1605"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1606"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot appear in a function position"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1607"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1608"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kind_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_kis</span><span class='hs-layout'>)</span>
<a name="line-1609"></a>
<a name="line-1610"></a>           <span class='hs-comment'>-- It is in scope, but not what we expected</span>
<a name="line-1611"></a>           <span class='hs-conid'>AThing</span> <span class='hs-keyword'>_</span>
<a name="line-1612"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVarName</span> <span class='hs-varid'>name</span>
<a name="line-1613"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1614"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1615"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1616"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1617"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"used in a kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1618"></a>                               <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside its own recursive group"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1619"></a>
<a name="line-1620"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-1621"></a>
<a name="line-1622"></a>           <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"promoted type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span>
<a name="line-1623"></a>                <span class='hs-comment'>-- This really should not happen</span>
<a name="line-1624"></a>     <span class='hs-layout'>}</span>
<a name="line-1625"></a>  <span class='hs-keyword'>where</span>
<a name="line-1626"></a>   <span class='hs-varid'>tycon_err</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of kind"</span><span class='hs-layout'>)</span>
<a name="line-1627"></a>                                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1628"></a>
<a name="line-1629"></a><a name="dataKindsErr"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1630"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-varid'>name</span>
<a name="line-1631"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal kind:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1632"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1633"></a>
<a name="line-1634"></a><a name="promotionErr"></a><span class='hs-definition'>promotionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1635"></a><span class='hs-definition'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-1636"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot be used here"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1637"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1638"></a>  <span class='hs-keyword'>where</span>
<a name="line-1639"></a>    <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-1640"></a>               <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"it comes from a data family instance"</span><span class='hs-layout'>)</span>
<a name="line-1641"></a>               <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span>
<a name="line-1642"></a>               <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"it is defined and used in the same recursive group"</span><span class='hs-layout'>)</span>
<a name="line-1643"></a>
<a name="line-1644"></a><span class='hs-comment'>{-
<a name="line-1645"></a>************************************************************************
<a name="line-1646"></a>*                                                                      *
<a name="line-1647"></a>                Scoped type variables
<a name="line-1648"></a>*                                                                      *
<a name="line-1649"></a>************************************************************************
<a name="line-1650"></a>-}</span>
<a name="line-1651"></a>
<a name="line-1652"></a><a name="badPatSigTvs"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1653"></a><span class='hs-definition'>badPatSigTvs</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varid'>bad_tvs</span>
<a name="line-1654"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>fsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>,</span>
<a name="line-1655"></a>                 <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bad_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1656"></a>                 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"should be bound by the pattern signature"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1657"></a>                 <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"but are actually discarded by a type synonym"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1658"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To fix this, expand the type synonym"</span><span class='hs-layout'>)</span>
<a name="line-1659"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[Note: I hope to lift this restriction in due course]"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1660"></a>
<a name="line-1661"></a><a name="unifyKindMisMatch"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1662"></a><span class='hs-definition'>unifyKindMisMatch</span> <span class='hs-varid'>ki1</span> <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1663"></a>    <span class='hs-varid'>ki1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki1</span>
<a name="line-1664"></a>    <span class='hs-varid'>ki2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcKind</span> <span class='hs-varid'>ki2</span>
<a name="line-1665"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match kind"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1666"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki1'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1667"></a>                      <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"against"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1668"></a>                      <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki2'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>    <span class='hs-varid'>failWithTc</span> <span class='hs-varid'>msg</span>
</pre></body>
</html>
