<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcRnTypes.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006-2012
<a name="line-3"></a>(c) The GRASP Project, Glasgow University, 1992-2002
<a name="line-4"></a>
<a name="line-5"></a>
<a name="line-6"></a>Various types used during typechecking, please see TcRnMonad as well for
<a name="line-7"></a>operations on these types. You probably want to import it, instead of this
<a name="line-8"></a>module.
<a name="line-9"></a>
<a name="line-10"></a>All the monads exported here are built on top of the same IOEnv monad. The
<a name="line-11"></a>monad functions like a Reader monad in the way it passes the environment
<a name="line-12"></a>around. This is done to allow the environment to be manipulated in a stack
<a name="line-13"></a>like fashion when entering expressions... ect.
<a name="line-14"></a>
<a name="line-15"></a>For state that is global and should be returned at the end (e.g not part
<a name="line-16"></a>of the stack mechanism), you should use an TcRef (= IORef) to store them.
<a name="line-17"></a>-}</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-comment'>{-# LANGUAGE CPP, ExistentialQuantification #-}</span>
<a name="line-20"></a>
<a name="line-21"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcRnTypes</span><span class='hs-layout'>(</span>
<a name="line-22"></a>        <span class='hs-conid'>TcRnIf</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRn</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcM</span><span class='hs-layout'>,</span> <span class='hs-conid'>RnM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfM</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfL</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The monad is opaque outside this module</span>
<a name="line-23"></a>        <span class='hs-conid'>TcRef</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-comment'>-- The environment types</span>
<a name="line-26"></a>        <span class='hs-conid'>Env</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>        <span class='hs-comment'>-- Ranamer types</span>
<a name="line-31"></a>        <span class='hs-conid'>ErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyImportAvails</span><span class='hs-layout'>,</span> <span class='hs-varid'>plusImportAvails</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-conid'>WhereFrom</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkModDeps</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-comment'>-- Typechecker types</span>
<a name="line-36"></a>        <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PromotionErr</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>pprTcTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPECategory</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-comment'>-- Desugaring types</span>
<a name="line-40"></a>        <span class='hs-conid'>DsM</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsLclEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsGblEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PArrBuiltin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-conid'>DsMetaEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>DsMetaVal</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-comment'>-- Template Haskell</span>
<a name="line-44"></a>        <span class='hs-conid'>ThStage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PendingStuff</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-conid'>ThLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>thLevel</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>        <span class='hs-comment'>-- Arrows</span>
<a name="line-48"></a>        <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-49"></a>
<a name="line-50"></a>        <span class='hs-comment'>-- Canonical constraints</span>
<a name="line-51"></a>        <span class='hs-conid'>Xi</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>andManyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCts</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>singleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>listToCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctsElts</span><span class='hs-layout'>,</span> <span class='hs-varid'>consCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>snocCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCtsList</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>isEmptyCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCTyEqCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>isCDictCan_Maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCFunEqCan_maybe</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>isCIrredEvCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerivedCt</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>isGivenCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isHoleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTypedHoleCt</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPartialTypeSigCt</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>ctEvidence</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctFlavour</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEqRel</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>mkNonCanonical</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNonCanonicalCt</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>ctEvPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvLoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvEqRel</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>ctEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvId</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvCheckDepth</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>insolubleWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWC</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>andWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>unionsWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>addImplics</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSimpleWC</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInsols</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>dropDerivedWC</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-conid'>Implication</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-67"></a>        <span class='hs-conid'>SubGoalCounter</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-conid'>SubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>initialSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxSubGoalDepth</span><span class='hs-layout'>,</span>
<a name="line-69"></a>        <span class='hs-varid'>bumpSubGoalDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>subGoalCounterValue</span><span class='hs-layout'>,</span> <span class='hs-varid'>subGoalDepthExceeded</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-conid'>CtLoc</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctLocOrigin</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>ctLocDepth</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpCtLocDepth</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>setCtLocOrigin</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLocEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCtLocSpan</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCtOrigin</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-varid'>pushErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pushErrCtxtSameOrigin</span><span class='hs-layout'>,</span>
<a name="line-75"></a>
<a name="line-76"></a>        <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>mkGivenLoc</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>isWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGiven</span><span class='hs-layout'>,</span> <span class='hs-varid'>isDerived</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>ctEvRole</span><span class='hs-layout'>,</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-comment'>-- Constraint solver plugins</span>
<a name="line-84"></a>        <span class='hs-conid'>TcPlugin</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcPluginSolver</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-conid'>TcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcPluginM</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeTcPluginTcM</span><span class='hs-layout'>,</span>
<a name="line-86"></a>
<a name="line-87"></a>        <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span><span class='hs-layout'>,</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-comment'>-- Pretty printing</span>
<a name="line-90"></a>        <span class='hs-varid'>pprEvVarTheta</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>pprEvVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprEvVarWithType</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>pprArising</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprArisingAt</span><span class='hs-layout'>,</span>
<a name="line-93"></a>
<a name="line-94"></a>        <span class='hs-comment'>-- Misc other types</span>
<a name="line-95"></a>        <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcIdSet</span><span class='hs-layout'>,</span> <span class='hs-conid'>HoleSort</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-96"></a>
<a name="line-97"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-98"></a>
<a name="line-99"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreSyn</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Role</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>Class</span> <span class='hs-layout'>)</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ConLike</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DataCon</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserType</span><span class='hs-layout'>,</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PatSyn</span>   <span class='hs-layout'>(</span> <span class='hs-conid'>PatSyn</span><span class='hs-layout'>,</span> <span class='hs-varid'>patSynType</span> <span class='hs-layout'>)</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysWiredIn</span> <span class='hs-layout'>(</span> <span class='hs-varid'>coercibleClass</span> <span class='hs-layout'>)</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Annotations</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IOEnv</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Avail</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC</span><span class='hs-varop'>.</span><span class='hs-conid'>Fingerprint</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>ap</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftM</span><span class='hs-layout'>)</span>
<a name="line-141"></a>
<a name="line-142"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span>      <span class='hs-layout'>(</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>)</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dynamic</span>  <span class='hs-layout'>(</span> <span class='hs-conid'>Dynamic</span> <span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TypeRep</span> <span class='hs-layout'>)</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TH</span>
<a name="line-148"></a><span class='hs-cpp'>#endif</span>
<a name="line-149"></a>
<a name="line-150"></a><span class='hs-comment'>{-
<a name="line-151"></a>************************************************************************
<a name="line-152"></a>*                                                                      *
<a name="line-153"></a>               Standard monad definition for TcRn
<a name="line-154"></a>    All the combinators for the monad can be found in TcRnMonad
<a name="line-155"></a>*                                                                      *
<a name="line-156"></a>************************************************************************
<a name="line-157"></a>
<a name="line-158"></a>The monad itself has to be defined here, because it is mentioned by ErrCtxt
<a name="line-159"></a>-}</span>
<a name="line-160"></a>
<a name="line-161"></a><a name="TcRnIf"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-162"></a><a name="TcRn"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRn</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span>    <span class='hs-comment'>-- Type inference</span>
<a name="line-163"></a><a name="IfM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfM</span> <span class='hs-varid'>lcl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-varid'>lcl</span>         <span class='hs-comment'>-- Iface stuff</span>
<a name="line-164"></a><a name="IfG"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfG</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>()</span>                      <span class='hs-comment'>--    Top level</span>
<a name="line-165"></a><a name="IfL"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>IfL</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfM</span> <span class='hs-conid'>IfLclEnv</span>                <span class='hs-comment'>--    Nested</span>
<a name="line-166"></a><a name="DsM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DsM</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRnIf</span> <span class='hs-conid'>DsGblEnv</span> <span class='hs-conid'>DsLclEnv</span>    <span class='hs-comment'>-- Desugaring</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-comment'>-- TcRn is the type-checking and renaming monad: the main monad that</span>
<a name="line-169"></a><span class='hs-comment'>-- most type-checking takes place in.  The global environment is</span>
<a name="line-170"></a><span class='hs-comment'>-- 'TcGblEnv', which tracks all of the top-level type-checking</span>
<a name="line-171"></a><span class='hs-comment'>-- information we've accumulated while checking a module, while the</span>
<a name="line-172"></a><span class='hs-comment'>-- local environment is 'TcLclEnv', which tracks local information as</span>
<a name="line-173"></a><span class='hs-comment'>-- we move inside expressions.</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="RnM"></a><span class='hs-comment'>-- | Historical "renaming monad" (now it's just 'TcRn').</span>
<a name="line-176"></a><a name="RnM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>RnM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="TcM"></a><span class='hs-comment'>-- | Historical "type-checking monad" (now it's just 'TcRn').</span>
<a name="line-179"></a><a name="TcM"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRn</span>
<a name="line-180"></a>
<a name="line-181"></a><a name="Env"></a><span class='hs-comment'>-- We 'stack' these envs through the Reader like monad infastructure</span>
<a name="line-182"></a><a name="Env"></a><span class='hs-comment'>-- as we move into an expression (although the change is focused in</span>
<a name="line-183"></a><a name="Env"></a><span class='hs-comment'>-- the lcl type).</span>
<a name="line-184"></a><a name="Env"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span>
<a name="line-185"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-186"></a>        <span class='hs-varid'>env_top</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- Top-level stuff that never changes</span>
<a name="line-187"></a>                             <span class='hs-comment'>-- Includes all info about imported things</span>
<a name="line-188"></a>
<a name="line-189"></a>        <span class='hs-varid'>env_us</span>   <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>UniqSupply</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-190"></a>                             <span class='hs-comment'>-- Unique supply for local varibles</span>
<a name="line-191"></a>
<a name="line-192"></a>        <span class='hs-varid'>env_gbl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>gbl</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Info about things defined at the top level</span>
<a name="line-193"></a>                             <span class='hs-comment'>-- of the module being compiled</span>
<a name="line-194"></a>
<a name="line-195"></a>        <span class='hs-varid'>env_lcl</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>lcl</span>      <span class='hs-comment'>-- Nested stuff; changes as we go into</span>
<a name="line-196"></a>    <span class='hs-layout'>}</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="instance%20ContainsDynFlags%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsDynFlags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-199"></a>    <span class='hs-varid'>extractDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-200"></a>    <span class='hs-varid'>replaceDynFlags</span> <span class='hs-varid'>env</span> <span class='hs-varid'>dflags</span>
<a name="line-201"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span><span class='hs-varid'>env_top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replaceDynFlags</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_top</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>}</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="instance%20ContainsModule%20(Env%20gbl%20lcl)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-varid'>gbl</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-varid'>gbl</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-204"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractModule</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_gbl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-205"></a>
<a name="line-206"></a>
<a name="line-207"></a><span class='hs-comment'>{-
<a name="line-208"></a>************************************************************************
<a name="line-209"></a>*                                                                      *
<a name="line-210"></a>                The interface environments
<a name="line-211"></a>              Used when dealing with IfaceDecls
<a name="line-212"></a>*                                                                      *
<a name="line-213"></a>************************************************************************
<a name="line-214"></a>-}</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="IfGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfGblEnv</span>
<a name="line-217"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-218"></a>        <span class='hs-comment'>-- The type environment for the module being compiled,</span>
<a name="line-219"></a>        <span class='hs-comment'>-- in case the interface refers back to it via a reference that</span>
<a name="line-220"></a>        <span class='hs-comment'>-- was originally a hi-boot file.</span>
<a name="line-221"></a>        <span class='hs-comment'>-- We need the module name so we can test when it's appropriate</span>
<a name="line-222"></a>        <span class='hs-comment'>-- to look in this env.</span>
<a name="line-223"></a>        <span class='hs-varid'>if_rec_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfG</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>)</span>
<a name="line-224"></a>                <span class='hs-comment'>-- Allows a read effect, so it can be in a mutable</span>
<a name="line-225"></a>                <span class='hs-comment'>-- variable; c.f. handling the external package type env</span>
<a name="line-226"></a>                <span class='hs-comment'>-- Nothing =&gt; interactive stuff, no loops possible</span>
<a name="line-227"></a>    <span class='hs-layout'>}</span>
<a name="line-228"></a>
<a name="line-229"></a><a name="IfLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>IfLclEnv</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IfLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-231"></a>        <span class='hs-comment'>-- The module for the current IfaceDecl</span>
<a name="line-232"></a>        <span class='hs-comment'>-- So if we see   f = \x -&gt; x</span>
<a name="line-233"></a>        <span class='hs-comment'>-- it means M.f = \x -&gt; x, where M is the if_mod</span>
<a name="line-234"></a>        <span class='hs-varid'>if_mod</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-235"></a>
<a name="line-236"></a>        <span class='hs-comment'>-- The field is used only for error reporting</span>
<a name="line-237"></a>        <span class='hs-comment'>-- if (say) there's a Lint error in it</span>
<a name="line-238"></a>        <span class='hs-varid'>if_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>,</span>
<a name="line-239"></a>                <span class='hs-comment'>-- Where the interface came from:</span>
<a name="line-240"></a>                <span class='hs-comment'>--      .hi file, or GHCi state, or ext core</span>
<a name="line-241"></a>                <span class='hs-comment'>-- plus which bit is currently being examined</span>
<a name="line-242"></a>
<a name="line-243"></a>        <span class='hs-varid'>if_tv_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Nested tyvar bindings</span>
<a name="line-244"></a>                                        <span class='hs-comment'>-- (and coercions)</span>
<a name="line-245"></a>        <span class='hs-varid'>if_id_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UniqFM</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Nested id binding</span>
<a name="line-246"></a>    <span class='hs-layout'>}</span>
<a name="line-247"></a>
<a name="line-248"></a><span class='hs-comment'>{-
<a name="line-249"></a>************************************************************************
<a name="line-250"></a>*                                                                      *
<a name="line-251"></a>                Desugarer monad
<a name="line-252"></a>*                                                                      *
<a name="line-253"></a>************************************************************************
<a name="line-254"></a>
<a name="line-255"></a>Now the mondo monad magic (yes, @DsM@ is a silly name)---carry around
<a name="line-256"></a>a @UniqueSupply@ and some annotations, which
<a name="line-257"></a>presumably include source-file location information:
<a name="line-258"></a>-}</span>
<a name="line-259"></a>
<a name="line-260"></a><a name="PArrBuiltin"></a><span class='hs-comment'>-- If '-XParallelArrays' is given, the desugarer populates this table with the corresponding</span>
<a name="line-261"></a><a name="PArrBuiltin"></a><span class='hs-comment'>-- variables found in 'Data.Array.Parallel'.</span>
<a name="line-262"></a><a name="PArrBuiltin"></a><span class='hs-comment'>--</span>
<a name="line-263"></a><a name="PArrBuiltin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PArrBuiltin</span>
<a name="line-264"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PArrBuiltin</span>
<a name="line-265"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>lengthPVar</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ lengthP</span>
<a name="line-266"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>replicatePVar</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ replicateP</span>
<a name="line-267"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>singletonPVar</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ singletonP</span>
<a name="line-268"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>mapPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ mapP</span>
<a name="line-269"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>filterPVar</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ filterP</span>
<a name="line-270"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>zipPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ zipP</span>
<a name="line-271"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>crossMapPVar</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ crossMapP</span>
<a name="line-272"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>indexPVar</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ (!:)</span>
<a name="line-273"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>emptyPVar</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ emptyP</span>
<a name="line-274"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>appPVar</span>            <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ (+:+)</span>
<a name="line-275"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>enumFromToPVar</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ enumFromToP</span>
<a name="line-276"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>enumFromThenToPVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span>     <span class='hs-comment'>-- ^ enumFromThenToP</span>
<a name="line-277"></a>        <span class='hs-layout'>}</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="DsGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsGblEnv</span>
<a name="line-280"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsGblEnv</span>
<a name="line-281"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>ds_mod</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span>             <span class='hs-comment'>-- For SCC profiling</span>
<a name="line-282"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span>         <span class='hs-comment'>-- Like tcg_fam_inst_env</span>
<a name="line-283"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_unqual</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrintUnqualified</span>
<a name="line-284"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_msgs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Messages</span>          <span class='hs-comment'>-- Warning messages</span>
<a name="line-285"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_if_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>IfGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>IfLclEnv</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Used for looking up global,</span>
<a name="line-286"></a>                                                <span class='hs-comment'>-- possibly-imported things</span>
<a name="line-287"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_dph_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span>            <span class='hs-comment'>-- exported entities of 'Data.Array.Parallel.Prim'</span>
<a name="line-288"></a>                                                <span class='hs-comment'>-- iff '-fvectorise' flag was given as well as</span>
<a name="line-289"></a>                                                <span class='hs-comment'>-- exported entities of 'Data.Array.Parallel' iff</span>
<a name="line-290"></a>                                                <span class='hs-comment'>-- '-XParallelArrays' was given; otherwise, empty</span>
<a name="line-291"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_parr_bi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PArrBuiltin</span>             <span class='hs-comment'>-- desugarar names for '-XParallelArrays'</span>
<a name="line-292"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ds_static_binds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span><span class='hs-conid'>CoreExpr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-293"></a>          <span class='hs-comment'>-- ^ Bindings resulted from floating static forms</span>
<a name="line-294"></a>        <span class='hs-layout'>}</span>
<a name="line-295"></a>
<a name="line-296"></a><a name="instance%20ContainsModule%20DsGblEnv"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>DsGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-297"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ds_mod</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="DsLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsLclEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-300"></a>        <span class='hs-varid'>dsl_meta</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DsMetaEnv</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Template Haskell bindings</span>
<a name="line-301"></a>        <span class='hs-varid'>dsl_loc</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SrcSpan</span>           <span class='hs-comment'>-- to put in pattern-matching error msgs</span>
<a name="line-302"></a>     <span class='hs-layout'>}</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="DsMetaEnv"></a><span class='hs-comment'>-- Inside [| |] brackets, the desugarer looks</span>
<a name="line-305"></a><a name="DsMetaEnv"></a><span class='hs-comment'>-- up variables in the DsMetaEnv</span>
<a name="line-306"></a><a name="DsMetaEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DsMetaEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>DsMetaVal</span>
<a name="line-307"></a>
<a name="line-308"></a><a name="DsMetaVal"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DsMetaVal</span>
<a name="line-309"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DsBound</span> <span class='hs-conid'>Id</span>         <span class='hs-comment'>-- Bound by a pattern inside the [| |].</span>
<a name="line-310"></a>                        <span class='hs-comment'>-- Will be dynamically alpha renamed.</span>
<a name="line-311"></a>                        <span class='hs-comment'>-- The Id has type THSyntax.Var</span>
<a name="line-312"></a>
<a name="line-313"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DsSplice</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Id</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- These bindings are introduced by</span>
<a name="line-314"></a>                          <span class='hs-comment'>-- the PendingSplices on a HsBracketOut</span>
<a name="line-315"></a>
<a name="line-316"></a>
<a name="line-317"></a><span class='hs-comment'>{-
<a name="line-318"></a>************************************************************************
<a name="line-319"></a>*                                                                      *
<a name="line-320"></a>                Global typechecker environment
<a name="line-321"></a>*                                                                      *
<a name="line-322"></a>************************************************************************
<a name="line-323"></a>-}</span>
<a name="line-324"></a>
<a name="line-325"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- | 'TcGblEnv' describes the top-level of the module at the</span>
<a name="line-326"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- point at which the typechecker is finished work.</span>
<a name="line-327"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- It is this structure that is handed on to the desugarer</span>
<a name="line-328"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- For state that needs to be updated during the typechecking</span>
<a name="line-329"></a><a name="TcGblEnv"></a><span class='hs-comment'>-- phase and returned at end, use a 'TcRef' (= 'IORef').</span>
<a name="line-330"></a><a name="TcGblEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-331"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-layout'>{</span>
<a name="line-332"></a>        <span class='hs-varid'>tcg_mod</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ Module being compiled</span>
<a name="line-333"></a>        <span class='hs-varid'>tcg_src</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscSource</span><span class='hs-layout'>,</span>
<a name="line-334"></a>          <span class='hs-comment'>-- ^ What kind of module (regular Haskell, hs-boot, ext-core)</span>
<a name="line-335"></a>        <span class='hs-varid'>tcg_sig_of</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Module</span><span class='hs-layout'>,</span>
<a name="line-336"></a>          <span class='hs-comment'>-- ^ Are we being compiled as a signature of an implementation?</span>
<a name="line-337"></a>        <span class='hs-varid'>tcg_impl_rdr_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>
<a name="line-338"></a>          <span class='hs-comment'>-- ^ Environment used only during -sig-of for resolving top level</span>
<a name="line-339"></a>          <span class='hs-comment'>-- bindings.  See Note [Signature parameters in TcGblEnv and DynFlags]</span>
<a name="line-340"></a>
<a name="line-341"></a>        <span class='hs-varid'>tcg_rdr_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Top level envt; used during renaming</span>
<a name="line-342"></a>        <span class='hs-varid'>tcg_default</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-343"></a>          <span class='hs-comment'>-- ^ Types used for defaulting. @Nothing@ =&gt; no @default@ decl</span>
<a name="line-344"></a>
<a name="line-345"></a>        <span class='hs-varid'>tcg_fix_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-346"></a>        <span class='hs-varid'>tcg_field_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecFieldEnv</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ Just for things in this module</span>
<a name="line-347"></a>                                        <span class='hs-comment'>-- See Note [The interactive package] in HscTypes</span>
<a name="line-348"></a>
<a name="line-349"></a>        <span class='hs-varid'>tcg_type_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-350"></a>          <span class='hs-comment'>-- ^ Global type env for the module we are compiling now.  All</span>
<a name="line-351"></a>          <span class='hs-comment'>-- TyCons and Classes (for this module) end up in here right away,</span>
<a name="line-352"></a>          <span class='hs-comment'>-- along with their derived constructors, selectors.</span>
<a name="line-353"></a>          <span class='hs-comment'>--</span>
<a name="line-354"></a>          <span class='hs-comment'>-- (Ids defined in this module start in the local envt, though they</span>
<a name="line-355"></a>          <span class='hs-comment'>--  move to the global envt during zonking)</span>
<a name="line-356"></a>          <span class='hs-comment'>--</span>
<a name="line-357"></a>          <span class='hs-comment'>-- NB: for what "things in this module" means, see</span>
<a name="line-358"></a>          <span class='hs-comment'>-- Note [The interactive package] in HscTypes</span>
<a name="line-359"></a>
<a name="line-360"></a>        <span class='hs-varid'>tcg_type_env_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TypeEnv</span><span class='hs-layout'>,</span>
<a name="line-361"></a>                <span class='hs-comment'>-- Used only to initialise the interface-file</span>
<a name="line-362"></a>                <span class='hs-comment'>-- typechecker in initIfaceTcRn, so that it can see stuff</span>
<a name="line-363"></a>                <span class='hs-comment'>-- bound in this module when dealing with hi-boot recursions</span>
<a name="line-364"></a>                <span class='hs-comment'>-- Updated at intervals (e.g. after dealing with types and classes)</span>
<a name="line-365"></a>
<a name="line-366"></a>        <span class='hs-varid'>tcg_inst_env</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InstEnv</span><span class='hs-layout'>,</span>
<a name="line-367"></a>          <span class='hs-comment'>-- ^ Instance envt for all /home-package/ modules;</span>
<a name="line-368"></a>          <span class='hs-comment'>-- Includes the dfuns in tcg_insts</span>
<a name="line-369"></a>        <span class='hs-varid'>tcg_fam_inst_env</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Ditto for family instances</span>
<a name="line-370"></a>        <span class='hs-varid'>tcg_ann_env</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnnEnv</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ And for annotations</span>
<a name="line-371"></a>
<a name="line-372"></a>        <span class='hs-varid'>tcg_visible_orphan_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleSet</span><span class='hs-layout'>,</span>
<a name="line-373"></a>          <span class='hs-comment'>-- ^ The set of orphan modules which transitively reachable from</span>
<a name="line-374"></a>          <span class='hs-comment'>-- direct imports.  We use this to figure out if an orphan instance</span>
<a name="line-375"></a>          <span class='hs-comment'>-- in the global InstEnv should be considered visible.</span>
<a name="line-376"></a>          <span class='hs-comment'>-- See Note [Instance lookup and orphan instances] in InstEnv</span>
<a name="line-377"></a>
<a name="line-378"></a>                <span class='hs-comment'>-- Now a bunch of things about this module that are simply</span>
<a name="line-379"></a>                <span class='hs-comment'>-- accumulated, but never consulted until the end.</span>
<a name="line-380"></a>                <span class='hs-comment'>-- Nevertheless, it's convenient to accumulate them along</span>
<a name="line-381"></a>                <span class='hs-comment'>-- with the rest of the info from this module.</span>
<a name="line-382"></a>        <span class='hs-varid'>tcg_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AvailInfo</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ^ What is exported</span>
<a name="line-383"></a>        <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span><span class='hs-layout'>,</span>
<a name="line-384"></a>          <span class='hs-comment'>-- ^ Information about what was imported from where, including</span>
<a name="line-385"></a>          <span class='hs-comment'>-- things bound in this module. Also store Safe Haskell info</span>
<a name="line-386"></a>          <span class='hs-comment'>-- here about transative trusted packaage requirements.</span>
<a name="line-387"></a>
<a name="line-388"></a>        <span class='hs-varid'>tcg_dus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DefUses</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- ^ What is defined in this module and what is used.</span>
<a name="line-389"></a>        <span class='hs-varid'>tcg_used_rdrnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-390"></a>          <span class='hs-comment'>-- See Note [Tracking unused binding and imports]</span>
<a name="line-391"></a>
<a name="line-392"></a>        <span class='hs-varid'>tcg_keep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-393"></a>          <span class='hs-comment'>-- ^ Locally-defined top-level names to keep alive.</span>
<a name="line-394"></a>          <span class='hs-comment'>--</span>
<a name="line-395"></a>          <span class='hs-comment'>-- "Keep alive" means give them an Exported flag, so that the</span>
<a name="line-396"></a>          <span class='hs-comment'>-- simplifier does not discard them as dead code, and so that they</span>
<a name="line-397"></a>          <span class='hs-comment'>-- are exposed in the interface file (but not to export to the</span>
<a name="line-398"></a>          <span class='hs-comment'>-- user).</span>
<a name="line-399"></a>          <span class='hs-comment'>--</span>
<a name="line-400"></a>          <span class='hs-comment'>-- Some things, like dict-fun Ids and default-method Ids are "born"</span>
<a name="line-401"></a>          <span class='hs-comment'>-- with the Exported flag on, for exactly the above reason, but some</span>
<a name="line-402"></a>          <span class='hs-comment'>-- we only discover as we go.  Specifically:</span>
<a name="line-403"></a>          <span class='hs-comment'>--</span>
<a name="line-404"></a>          <span class='hs-comment'>--   * The to/from functions for generic data types</span>
<a name="line-405"></a>          <span class='hs-comment'>--</span>
<a name="line-406"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in the RHS of an orphan</span>
<a name="line-407"></a>          <span class='hs-comment'>--     rule</span>
<a name="line-408"></a>          <span class='hs-comment'>--</span>
<a name="line-409"></a>          <span class='hs-comment'>--   * Top-level variables appearing free in a TH bracket</span>
<a name="line-410"></a>
<a name="line-411"></a>        <span class='hs-varid'>tcg_th_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-412"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; Template Haskell syntax used.</span>
<a name="line-413"></a>          <span class='hs-comment'>--</span>
<a name="line-414"></a>          <span class='hs-comment'>-- We need this so that we can generate a dependency on the</span>
<a name="line-415"></a>          <span class='hs-comment'>-- Template Haskell package, because the desugarer is going</span>
<a name="line-416"></a>          <span class='hs-comment'>-- to emit loads of references to TH symbols.  The reference</span>
<a name="line-417"></a>          <span class='hs-comment'>-- is implicit rather than explicit, so we have to zap a</span>
<a name="line-418"></a>          <span class='hs-comment'>-- mutable variable.</span>
<a name="line-419"></a>
<a name="line-420"></a>        <span class='hs-varid'>tcg_th_splice_used</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-421"></a>          <span class='hs-comment'>-- ^ @True@ &lt;=&gt; A Template Haskell splice was used.</span>
<a name="line-422"></a>          <span class='hs-comment'>--</span>
<a name="line-423"></a>          <span class='hs-comment'>-- Splices disable recompilation avoidance (see #481)</span>
<a name="line-424"></a>
<a name="line-425"></a>        <span class='hs-varid'>tcg_dfun_n</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>OccSet</span><span class='hs-layout'>,</span>
<a name="line-426"></a>          <span class='hs-comment'>-- ^ Allows us to choose unique DFun names.</span>
<a name="line-427"></a>
<a name="line-428"></a>        <span class='hs-comment'>-- The next fields accumulate the payload of the module</span>
<a name="line-429"></a>        <span class='hs-comment'>-- The binds, rules and foreign-decl fields are collected</span>
<a name="line-430"></a>        <span class='hs-comment'>-- initially in un-zonked form and are finally zonked in tcRnSrcDecls</span>
<a name="line-431"></a>
<a name="line-432"></a>        <span class='hs-varid'>tcg_rn_exports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-layout'>(</span><span class='hs-conid'>IE</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-433"></a>        <span class='hs-varid'>tcg_rn_imports</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-434"></a>                <span class='hs-comment'>-- Keep the renamed imports regardless.  They are not</span>
<a name="line-435"></a>                <span class='hs-comment'>-- voluminous and are needed if you want to report unused imports</span>
<a name="line-436"></a>
<a name="line-437"></a>        <span class='hs-varid'>tcg_rn_decls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsGroup</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-438"></a>          <span class='hs-comment'>-- ^ Renamed decls, maybe.  @Nothing@ &lt;=&gt; Don't retain renamed</span>
<a name="line-439"></a>          <span class='hs-comment'>-- decls.</span>
<a name="line-440"></a>
<a name="line-441"></a>        <span class='hs-varid'>tcg_dependent_files</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ dependencies from addDependentFile</span>
<a name="line-442"></a>
<a name="line-443"></a><span class='hs-cpp'>#ifdef GHCI</span>
<a name="line-444"></a>        <span class='hs-varid'>tcg_th_topdecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-445"></a>        <span class='hs-comment'>-- ^ Top-level declarations from addTopDecls</span>
<a name="line-446"></a>
<a name="line-447"></a>        <span class='hs-varid'>tcg_th_topnames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>
<a name="line-448"></a>        <span class='hs-comment'>-- ^ Exact names bound in top-level declarations in tcg_th_topdecls</span>
<a name="line-449"></a>
<a name="line-450"></a>        <span class='hs-varid'>tcg_th_modfinalizers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Q</span> <span class='hs-conid'>()</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-451"></a>        <span class='hs-comment'>-- ^ Template Haskell module finalizers</span>
<a name="line-452"></a>
<a name="line-453"></a>        <span class='hs-varid'>tcg_th_state</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span> <span class='hs-conid'>TypeRep</span> <span class='hs-conid'>Dynamic</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-454"></a>        <span class='hs-comment'>-- ^ Template Haskell state</span>
<a name="line-455"></a><span class='hs-cpp'>#endif /* GHCI */</span>
<a name="line-456"></a>
<a name="line-457"></a>        <span class='hs-varid'>tcg_ev_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- Top-level evidence bindings</span>
<a name="line-458"></a>
<a name="line-459"></a>        <span class='hs-comment'>-- Things defined in this module, or (in GHCi)</span>
<a name="line-460"></a>        <span class='hs-comment'>-- in the declarations for a single GHCi command.</span>
<a name="line-461"></a>        <span class='hs-comment'>-- For the latter, see Note [The interactive package] in HscTypes</span>
<a name="line-462"></a>        <span class='hs-varid'>tcg_binds</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsBinds</span> <span class='hs-conid'>Id</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Value bindings in this module</span>
<a name="line-463"></a>        <span class='hs-varid'>tcg_sigs</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameSet</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...Top-level names that *lack* a signature</span>
<a name="line-464"></a>        <span class='hs-varid'>tcg_imp_specs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LTcSpecPrag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- ...SPECIALISE prags for imported Ids</span>
<a name="line-465"></a>        <span class='hs-varid'>tcg_warns</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Warnings</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Warnings and deprecations</span>
<a name="line-466"></a>        <span class='hs-varid'>tcg_anns</span>      <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Annotation</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- ...Annotations</span>
<a name="line-467"></a>        <span class='hs-varid'>tcg_tcs</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- ...TyCons and Classes</span>
<a name="line-468"></a>        <span class='hs-varid'>tcg_insts</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ...Instances</span>
<a name="line-469"></a>        <span class='hs-varid'>tcg_fam_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ...Family instances</span>
<a name="line-470"></a>        <span class='hs-varid'>tcg_rules</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ...Rules</span>
<a name="line-471"></a>        <span class='hs-varid'>tcg_fords</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LForeignDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ...Foreign import &amp; exports</span>
<a name="line-472"></a>        <span class='hs-varid'>tcg_vects</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LVectDecl</span> <span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- ...Vectorisation declarations</span>
<a name="line-473"></a>        <span class='hs-varid'>tcg_patsyns</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PatSyn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- ...Pattern synonyms</span>
<a name="line-474"></a>
<a name="line-475"></a>        <span class='hs-varid'>tcg_doc_hdr</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LHsDocString</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- ^ Maybe Haddock header docs</span>
<a name="line-476"></a>        <span class='hs-varid'>tcg_hpc</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AnyHpcUsage</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- ^ @True@ if any part of the</span>
<a name="line-477"></a>                                             <span class='hs-comment'>--  prog uses hpc instrumentation.</span>
<a name="line-478"></a>
<a name="line-479"></a>        <span class='hs-varid'>tcg_main</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- ^ The Name of the main</span>
<a name="line-480"></a>                                             <span class='hs-comment'>-- function, if this module is</span>
<a name="line-481"></a>                                             <span class='hs-comment'>-- the main module.</span>
<a name="line-482"></a>        <span class='hs-varid'>tcg_safeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Has the typechecker</span>
<a name="line-483"></a>                                             <span class='hs-comment'>-- inferred this module</span>
<a name="line-484"></a>                                             <span class='hs-comment'>-- as -XSafe (Safe Haskell)</span>
<a name="line-485"></a>
<a name="line-486"></a>        <span class='hs-comment'>-- | A list of user-defined plugins for the constraint solver.</span>
<a name="line-487"></a>        <span class='hs-varid'>tcg_tc_plugins</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPluginSolver</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-488"></a>
<a name="line-489"></a>        <span class='hs-varid'>tcg_static_wc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-490"></a>          <span class='hs-comment'>-- ^ Wanted constraints of static forms.</span>
<a name="line-491"></a>    <span class='hs-layout'>}</span>
<a name="line-492"></a>
<a name="line-493"></a><span class='hs-comment'>-- Note [Signature parameters in TcGblEnv and DynFlags]</span>
<a name="line-494"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-495"></a><span class='hs-comment'>-- When compiling signature files, we need to know which implementation</span>
<a name="line-496"></a><span class='hs-comment'>-- we've actually linked against the signature.  There are three seemingly</span>
<a name="line-497"></a><span class='hs-comment'>-- redundant places where this information is stored: in DynFlags, there</span>
<a name="line-498"></a><span class='hs-comment'>-- is sigOf, and in TcGblEnv, there is tcg_sig_of and tcg_impl_rdr_env.</span>
<a name="line-499"></a><span class='hs-comment'>-- Here's the difference between each of them:</span>
<a name="line-500"></a><span class='hs-comment'>--</span>
<a name="line-501"></a><span class='hs-comment'>-- * DynFlags.sigOf is global per invocation of GHC.  If we are compiling</span>
<a name="line-502"></a><span class='hs-comment'>--   with --make, there may be multiple signature files being compiled; in</span>
<a name="line-503"></a><span class='hs-comment'>--   which case this parameter is a map from local module name to implementing</span>
<a name="line-504"></a><span class='hs-comment'>--   Module.</span>
<a name="line-505"></a><span class='hs-comment'>--</span>
<a name="line-506"></a><span class='hs-comment'>-- * HscEnv.tcg_sig_of is global per the compilation of a single file, so</span>
<a name="line-507"></a><span class='hs-comment'>--   it is simply the result of looking up tcg_mod in the DynFlags.sigOf</span>
<a name="line-508"></a><span class='hs-comment'>--   parameter.  It's setup in TcRnMonad.initTc.  This prevents us</span>
<a name="line-509"></a><span class='hs-comment'>--   from having to repeatedly do a lookup in DynFlags.sigOf.</span>
<a name="line-510"></a><span class='hs-comment'>--</span>
<a name="line-511"></a><span class='hs-comment'>-- * HscEnv.tcg_impl_rdr_env is a RdrEnv that lets us look up names</span>
<a name="line-512"></a><span class='hs-comment'>--   according to the sig-of module.  It's setup in TcRnDriver.tcRnSignature.</span>
<a name="line-513"></a><span class='hs-comment'>--   Here is an example showing why we need this map:</span>
<a name="line-514"></a><span class='hs-comment'>--</span>
<a name="line-515"></a><span class='hs-comment'>--  module A where</span>
<a name="line-516"></a><span class='hs-comment'>--      a = True</span>
<a name="line-517"></a><span class='hs-comment'>--</span>
<a name="line-518"></a><span class='hs-comment'>--  module ASig where</span>
<a name="line-519"></a><span class='hs-comment'>--      import B</span>
<a name="line-520"></a><span class='hs-comment'>--      a :: Bool</span>
<a name="line-521"></a><span class='hs-comment'>--</span>
<a name="line-522"></a><span class='hs-comment'>--  module B where</span>
<a name="line-523"></a><span class='hs-comment'>--      b = False</span>
<a name="line-524"></a><span class='hs-comment'>--</span>
<a name="line-525"></a><span class='hs-comment'>-- When we compile ASig --sig-of main:A, the default</span>
<a name="line-526"></a><span class='hs-comment'>-- global RdrEnv (tcg_rdr_env) has an entry for b, but not for a</span>
<a name="line-527"></a><span class='hs-comment'>-- (we never imported A).  So we have to look in a different environment</span>
<a name="line-528"></a><span class='hs-comment'>-- to actually get the original name.</span>
<a name="line-529"></a><span class='hs-comment'>--</span>
<a name="line-530"></a><span class='hs-comment'>-- By the way, why do we need to do the lookup; can't we just use A:a</span>
<a name="line-531"></a><span class='hs-comment'>-- as the name directly?  Well, if A is reexporting the entity from another</span>
<a name="line-532"></a><span class='hs-comment'>-- module, then the original name needs to be the real original name:</span>
<a name="line-533"></a><span class='hs-comment'>--</span>
<a name="line-534"></a><span class='hs-comment'>--  module C where</span>
<a name="line-535"></a><span class='hs-comment'>--      a = True</span>
<a name="line-536"></a><span class='hs-comment'>--</span>
<a name="line-537"></a><span class='hs-comment'>--  module A(a) where</span>
<a name="line-538"></a><span class='hs-comment'>--      import C</span>
<a name="line-539"></a>
<a name="line-540"></a><a name="instance%20ContainsModule%20TcGblEnv"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ContainsModule</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyword'>where</span>
<a name="line-541"></a>    <span class='hs-varid'>extractModule</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>env</span>
<a name="line-542"></a>
<a name="line-543"></a><a name="RecFieldEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RecFieldEnv</span>
<a name="line-544"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecFields</span> <span class='hs-layout'>(</span><span class='hs-conid'>NameEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Maps a constructor name *in this module*</span>
<a name="line-545"></a>                                <span class='hs-comment'>-- to the fields for that constructor</span>
<a name="line-546"></a>              <span class='hs-conid'>NameSet</span>           <span class='hs-comment'>-- Set of all fields declared *in this module*;</span>
<a name="line-547"></a>                                <span class='hs-comment'>-- used to suppress name-shadowing complaints</span>
<a name="line-548"></a>                                <span class='hs-comment'>-- when using record wild cards</span>
<a name="line-549"></a>                                <span class='hs-comment'>-- E.g.  let fld = e in C {..}</span>
<a name="line-550"></a>        <span class='hs-comment'>-- This is used when dealing with ".." notation in record</span>
<a name="line-551"></a>        <span class='hs-comment'>-- construction and pattern matching.</span>
<a name="line-552"></a>        <span class='hs-comment'>-- The FieldEnv deals *only* with constructors defined in *this*</span>
<a name="line-553"></a>        <span class='hs-comment'>-- module.  For imported modules, we get the same info from the</span>
<a name="line-554"></a>        <span class='hs-comment'>-- TypeEnv</span>
<a name="line-555"></a>
<a name="line-556"></a><span class='hs-comment'>{-
<a name="line-557"></a>Note [Tracking unused binding and imports]
<a name="line-558"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-559"></a>We gather two sorts of usage information
<a name="line-560"></a> * tcg_dus (defs/uses)
<a name="line-561"></a>      Records *defined* Names (local, top-level)
<a name="line-562"></a>          and *used*    Names (local or imported)
<a name="line-563"></a>
<a name="line-564"></a>      Used (a) to report "defined but not used"
<a name="line-565"></a>               (see RnNames.reportUnusedNames)
<a name="line-566"></a>           (b) to generate version-tracking usage info in interface
<a name="line-567"></a>               files (see MkIface.mkUsedNames)
<a name="line-568"></a>   This usage info is mainly gathered by the renamer's
<a name="line-569"></a>   gathering of free-variables
<a name="line-570"></a>
<a name="line-571"></a> * tcg_used_rdrnames
<a name="line-572"></a>      Records used *imported* (not locally-defined) RdrNames
<a name="line-573"></a>      Used only to report unused import declarations
<a name="line-574"></a>      Notice that they are RdrNames, not Names, so we can
<a name="line-575"></a>      tell whether the reference was qualified or unqualified, which
<a name="line-576"></a>      is esssential in deciding whether a particular import decl
<a name="line-577"></a>      is unnecessary.  This info isn't present in Names.
<a name="line-578"></a>
<a name="line-579"></a>
<a name="line-580"></a>************************************************************************
<a name="line-581"></a>*                                                                      *
<a name="line-582"></a>                The local typechecker environment
<a name="line-583"></a>*                                                                      *
<a name="line-584"></a>************************************************************************
<a name="line-585"></a>
<a name="line-586"></a>Note [The Global-Env/Local-Env story]
<a name="line-587"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-588"></a>During type checking, we keep in the tcg_type_env
<a name="line-589"></a>        * All types and classes
<a name="line-590"></a>        * All Ids derived from types and classes (constructors, selectors)
<a name="line-591"></a>
<a name="line-592"></a>At the end of type checking, we zonk the local bindings,
<a name="line-593"></a>and as we do so we add to the tcg_type_env
<a name="line-594"></a>        * Locally defined top-level Ids
<a name="line-595"></a>
<a name="line-596"></a>Why?  Because they are now Ids not TcIds.  This final GlobalEnv is
<a name="line-597"></a>        a) fed back (via the knot) to typechecking the
<a name="line-598"></a>           unfoldings of interface signatures
<a name="line-599"></a>        b) used in the ModDetails of this module
<a name="line-600"></a>-}</span>
<a name="line-601"></a>
<a name="line-602"></a><a name="TcLclEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcLclEnv</span>           <span class='hs-comment'>-- Changes as we move inside an expression</span>
<a name="line-603"></a>                        <span class='hs-comment'>-- Discarded after typecheck/rename; not passed on to desugarer</span>
<a name="line-604"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-layout'>{</span>
<a name="line-605"></a>        <span class='hs-varid'>tcl_loc</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RealSrcSpan</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Source span</span>
<a name="line-606"></a>        <span class='hs-varid'>tcl_ctxt</span>       <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ErrCtxt</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Error context, innermost on top</span>
<a name="line-607"></a>        <span class='hs-varid'>tcl_tclvl</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Birthplace for new unification variables</span>
<a name="line-608"></a>
<a name="line-609"></a>        <span class='hs-varid'>tcl_th_ctxt</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Template Haskell context</span>
<a name="line-610"></a>        <span class='hs-varid'>tcl_th_bndrs</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThBindEnv</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Binding level of in-scope Names</span>
<a name="line-611"></a>                                           <span class='hs-comment'>-- defined in this module (not imported)</span>
<a name="line-612"></a>
<a name="line-613"></a>        <span class='hs-varid'>tcl_arrow_ctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ArrowCtxt</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-614"></a>
<a name="line-615"></a>        <span class='hs-varid'>tcl_rdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- Local name envt</span>
<a name="line-616"></a>                <span class='hs-comment'>-- Maintained during renaming, of course, but also during</span>
<a name="line-617"></a>                <span class='hs-comment'>-- type checking, solely so that when renaming a Template-Haskell</span>
<a name="line-618"></a>                <span class='hs-comment'>-- splice we have the right environment for the renamer.</span>
<a name="line-619"></a>                <span class='hs-comment'>--</span>
<a name="line-620"></a>                <span class='hs-comment'>--   Does *not* include global name envt; may shadow it</span>
<a name="line-621"></a>                <span class='hs-comment'>--   Includes both ordinary variables and type variables;</span>
<a name="line-622"></a>                <span class='hs-comment'>--   they are kept distinct because tyvar have a different</span>
<a name="line-623"></a>                <span class='hs-comment'>--   occurrence contructor (Name.TvOcc)</span>
<a name="line-624"></a>                <span class='hs-comment'>-- We still need the unsullied global name env so that</span>
<a name="line-625"></a>                <span class='hs-comment'>--   we can look up record field names</span>
<a name="line-626"></a>
<a name="line-627"></a>        <span class='hs-varid'>tcl_env</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTypeEnv</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- The local type environment:</span>
<a name="line-628"></a>                                  <span class='hs-comment'>-- Ids and TyVars defined in this module</span>
<a name="line-629"></a>
<a name="line-630"></a>        <span class='hs-varid'>tcl_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcIdBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- Stack of locally-bound Ids, innermost on top</span>
<a name="line-631"></a>                                     <span class='hs-comment'>-- Used only for error reporting</span>
<a name="line-632"></a>
<a name="line-633"></a>        <span class='hs-varid'>tcl_tidy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Used for tidying types; contains all</span>
<a name="line-634"></a>                                  <span class='hs-comment'>-- in-scope type variables (but not term variables)</span>
<a name="line-635"></a>
<a name="line-636"></a>        <span class='hs-varid'>tcl_tyvars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>TcTyVarSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- The "global tyvars"</span>
<a name="line-637"></a>                        <span class='hs-comment'>-- Namely, the in-scope TyVars bound in tcl_env,</span>
<a name="line-638"></a>                        <span class='hs-comment'>-- plus the tyvars mentioned in the types of Ids bound</span>
<a name="line-639"></a>                        <span class='hs-comment'>-- in tcl_lenv.</span>
<a name="line-640"></a>                        <span class='hs-comment'>-- Why mutable? see notes with tcGetGlobalTyVars</span>
<a name="line-641"></a>
<a name="line-642"></a>        <span class='hs-varid'>tcl_lie</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Place to accumulate type constraints</span>
<a name="line-643"></a>        <span class='hs-varid'>tcl_errs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-conid'>Messages</span>              <span class='hs-comment'>-- Place to accumulate errors</span>
<a name="line-644"></a>    <span class='hs-layout'>}</span>
<a name="line-645"></a>
<a name="line-646"></a><a name="TcTypeEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcTypeEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-647"></a>
<a name="line-648"></a><a name="ThBindEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThBindEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TopLevelFlag</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThLevel</span><span class='hs-layout'>)</span>
<a name="line-649"></a>   <span class='hs-comment'>-- Domain = all Ids bound in this module (ie not imported)</span>
<a name="line-650"></a>   <span class='hs-comment'>-- The TopLevelFlag tells if the binding is syntactically top level.</span>
<a name="line-651"></a>   <span class='hs-comment'>-- We need to know this, because the cross-stage persistence story allows</span>
<a name="line-652"></a>   <span class='hs-comment'>-- cross-stage at arbitrary types if the Id is bound at top level.</span>
<a name="line-653"></a>   <span class='hs-comment'>--</span>
<a name="line-654"></a>   <span class='hs-comment'>-- Nota bene: a ThLevel of 'outerLevel' is *not* the same as being</span>
<a name="line-655"></a>   <span class='hs-comment'>-- bound at top level!  See Note [Template Haskell levels] in TcSplice</span>
<a name="line-656"></a>
<a name="line-657"></a><a name="TcIdBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcIdBinder</span>
<a name="line-658"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcIdBndr</span>
<a name="line-659"></a>       <span class='hs-conid'>TcId</span>
<a name="line-660"></a>       <span class='hs-conid'>TopLevelFlag</span>    <span class='hs-comment'>-- Tells whether the bindind is syntactically top-level</span>
<a name="line-661"></a>                       <span class='hs-comment'>-- (The monomorphic Ids for a recursive group count</span>
<a name="line-662"></a>                       <span class='hs-comment'>--  as not-top-level for this purpose.)</span>
<a name="line-663"></a>
<a name="line-664"></a><span class='hs-comment'>{- Note [Given Insts]
<a name="line-665"></a>   ~~~~~~~~~~~~~~~~~~
<a name="line-666"></a>Because of GADTs, we have to pass inwards the Insts provided by type signatures
<a name="line-667"></a>and existential contexts. Consider
<a name="line-668"></a>        data T a where { T1 :: b -&gt; b -&gt; T [b] }
<a name="line-669"></a>        f :: Eq a =&gt; T a -&gt; Bool
<a name="line-670"></a>        f (T1 x y) = [x]==[y]
<a name="line-671"></a>
<a name="line-672"></a>The constructor T1 binds an existential variable 'b', and we need Eq [b].
<a name="line-673"></a>Well, we have it, because Eq a refines to Eq [b], but we can only spot that if we
<a name="line-674"></a>pass it inwards.
<a name="line-675"></a>
<a name="line-676"></a>-}</span>
<a name="line-677"></a>
<a name="line-678"></a><a name="TcRef"></a><span class='hs-comment'>-- | Type alias for 'IORef'; the convention is we'll use this for mutable</span>
<a name="line-679"></a><a name="TcRef"></a><span class='hs-comment'>-- bits of data in 'TcGblEnv' which are updated during typechecking and</span>
<a name="line-680"></a><a name="TcRef"></a><span class='hs-comment'>-- returned at the end.</span>
<a name="line-681"></a><a name="TcRef"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IORef</span> <span class='hs-varid'>a</span>
<a name="line-682"></a><a name="TcId"></a><span class='hs-comment'>-- ToDo: when should I refer to it as a 'TcId' instead of an 'Id'?</span>
<a name="line-683"></a><a name="TcId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcId</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Id</span>
<a name="line-684"></a><a name="TcIdSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcIdSet</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IdSet</span>
<a name="line-685"></a>
<a name="line-686"></a><span class='hs-comment'>---------------------------</span>
<a name="line-687"></a><span class='hs-comment'>-- Template Haskell stages and levels</span>
<a name="line-688"></a><span class='hs-comment'>---------------------------</span>
<a name="line-689"></a>
<a name="line-690"></a><a name="ThStage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ThStage</span>    <span class='hs-comment'>-- See Note [Template Haskell state diagram] in TcSplice</span>
<a name="line-691"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span>      <span class='hs-comment'>-- Inside a top-level splice splice</span>
<a name="line-692"></a>                <span class='hs-comment'>-- This code will be run *at compile time*;</span>
<a name="line-693"></a>                <span class='hs-comment'>--   the result replaces the splice</span>
<a name="line-694"></a>                <span class='hs-comment'>-- Binding level = 0</span>
<a name="line-695"></a>      <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True if in a typed splice, False otherwise</span>
<a name="line-696"></a>
<a name="line-697"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Comp</span>        <span class='hs-comment'>-- Ordinary Haskell code</span>
<a name="line-698"></a>                <span class='hs-comment'>-- Binding level = 1</span>
<a name="line-699"></a>
<a name="line-700"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Brack</span>                       <span class='hs-comment'>-- Inside brackets</span>
<a name="line-701"></a>      <span class='hs-conid'>ThStage</span>                   <span class='hs-comment'>--   Enclosing stage</span>
<a name="line-702"></a>      <span class='hs-conid'>PendingStuff</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="PendingStuff"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PendingStuff</span>
<a name="line-705"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RnPendingUntyped</span>              <span class='hs-comment'>-- Renaming the inside of an *untyped* bracket</span>
<a name="line-706"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingRnSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Pending splices in here</span>
<a name="line-707"></a>
<a name="line-708"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RnPendingTyped</span>                <span class='hs-comment'>-- Renaming the inside of a *typed* bracket</span>
<a name="line-709"></a>
<a name="line-710"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPending</span>                     <span class='hs-comment'>-- Typechecking the inside of a typed bracket</span>
<a name="line-711"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PendingTcSplice</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--   Accumulate pending splices here</span>
<a name="line-712"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>   <span class='hs-comment'>--     and type constraints here</span>
<a name="line-713"></a>
<a name="line-714"></a><a name="topStage"></a><span class='hs-definition'>topStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topAnnStage</span><span class='hs-layout'>,</span> <span class='hs-varid'>topSpliceStage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span>
<a name="line-715"></a><span class='hs-definition'>topStage</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Comp</span>
<a name="line-716"></a><a name="topAnnStage"></a><span class='hs-definition'>topAnnStage</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span>
<a name="line-717"></a><a name="topSpliceStage"></a><span class='hs-definition'>topSpliceStage</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Splice</span> <span class='hs-conid'>False</span>
<a name="line-718"></a>
<a name="line-719"></a><a name="instance%20Outputable%20ThStage"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyword'>where</span>
<a name="line-720"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Splice"</span>
<a name="line-721"></a>   <span class='hs-varid'>ppr</span> <span class='hs-conid'>Comp</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Comp"</span>
<a name="line-722"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Brack"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="ThLevel"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int</span>
<a name="line-725"></a>    <span class='hs-comment'>-- NB: see Note [Template Haskell levels] in TcSplice</span>
<a name="line-726"></a>    <span class='hs-comment'>-- Incremented when going inside a bracket,</span>
<a name="line-727"></a>    <span class='hs-comment'>-- decremented when going inside a splice</span>
<a name="line-728"></a>    <span class='hs-comment'>-- NB: ThLevel is one greater than the 'n' in Fig 2 of the</span>
<a name="line-729"></a>    <span class='hs-comment'>--     original "Template meta-programming for Haskell" paper</span>
<a name="line-730"></a>
<a name="line-731"></a><a name="impLevel"></a><span class='hs-definition'>impLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>outerLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThLevel</span>
<a name="line-732"></a><span class='hs-definition'>impLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>    <span class='hs-comment'>-- Imported things; they can be used inside a top level splice</span>
<a name="line-733"></a><a name="outerLevel"></a><span class='hs-definition'>outerLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>  <span class='hs-comment'>-- Things defined outside brackets</span>
<a name="line-734"></a>
<a name="line-735"></a><a name="thLevel"></a><span class='hs-definition'>thLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThStage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThLevel</span>
<a name="line-736"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Splice</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-737"></a><span class='hs-definition'>thLevel</span> <span class='hs-conid'>Comp</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-738"></a><span class='hs-definition'>thLevel</span> <span class='hs-layout'>(</span><span class='hs-conid'>Brack</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thLevel</span> <span class='hs-varid'>s</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-739"></a>
<a name="line-740"></a><span class='hs-comment'>---------------------------</span>
<a name="line-741"></a><span class='hs-comment'>-- Arrow-notation context</span>
<a name="line-742"></a><span class='hs-comment'>---------------------------</span>
<a name="line-743"></a>
<a name="line-744"></a><span class='hs-comment'>{- Note [Escaping the arrow scope]
<a name="line-745"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-746"></a>In arrow notation, a variable bound by a proc (or enclosed let/kappa)
<a name="line-747"></a>is not in scope to the left of an arrow tail (-&lt;) or the head of (|..|).
<a name="line-748"></a>For example
<a name="line-749"></a>
<a name="line-750"></a>        proc x -&gt; (e1 -&lt; e2)
<a name="line-751"></a>
<a name="line-752"></a>Here, x is not in scope in e1, but it is in scope in e2.  This can get
<a name="line-753"></a>a bit complicated:
<a name="line-754"></a>
<a name="line-755"></a>        let x = 3 in
<a name="line-756"></a>        proc y -&gt; (proc z -&gt; e1) -&lt; e2
<a name="line-757"></a>
<a name="line-758"></a>Here, x and z are in scope in e1, but y is not.
<a name="line-759"></a>
<a name="line-760"></a>We implement this by
<a name="line-761"></a>recording the environment when passing a proc (using newArrowScope),
<a name="line-762"></a>and returning to that (using escapeArrowScope) on the left of -&lt; and the
<a name="line-763"></a>head of (|..|).
<a name="line-764"></a>
<a name="line-765"></a>All this can be dealt with by the *renamer*. But the type checker needs
<a name="line-766"></a>to be involved too.  Example (arrowfail001)
<a name="line-767"></a>  class Foo a where foo :: a -&gt; ()
<a name="line-768"></a>  data Bar = forall a. Foo a =&gt; Bar a
<a name="line-769"></a>  get :: Bar -&gt; ()
<a name="line-770"></a>  get = proc x -&gt; case x of Bar a -&gt; foo -&lt; a
<a name="line-771"></a>Here the call of 'foo' gives rise to a (Foo a) constraint that should not
<a name="line-772"></a>be captured by the pattern match on 'Bar'.  Rather it should join the
<a name="line-773"></a>constraints from further out.  So we must capture the constraint bag
<a name="line-774"></a>from further out in the ArrowCtxt that we push inwards.
<a name="line-775"></a>-}</span>
<a name="line-776"></a>
<a name="line-777"></a><a name="ArrowCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ArrowCtxt</span>   <span class='hs-comment'>-- Note [Escaping the arrow scope]</span>
<a name="line-778"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NoArrowCtxt</span>
<a name="line-779"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowCtxt</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>)</span>
<a name="line-780"></a>
<a name="line-781"></a>
<a name="line-782"></a><span class='hs-comment'>---------------------------</span>
<a name="line-783"></a><span class='hs-comment'>-- TcTyThing</span>
<a name="line-784"></a><span class='hs-comment'>---------------------------</span>
<a name="line-785"></a>
<a name="line-786"></a><a name="TcTyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyThing</span>
<a name="line-787"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AGlobal</span> <span class='hs-conid'>TyThing</span>             <span class='hs-comment'>-- Used only in the return type of a lookup</span>
<a name="line-788"></a>
<a name="line-789"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATcId</span>   <span class='hs-layout'>{</span>           <span class='hs-comment'>-- Ids defined in this module; may not be fully zonked</span>
<a name="line-790"></a>        <span class='hs-varid'>tct_id</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcId</span><span class='hs-layout'>,</span>
<a name="line-791"></a>        <span class='hs-varid'>tct_closed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TopLevelFlag</span> <span class='hs-layout'>}</span>   <span class='hs-comment'>-- See Note [Bindings with closed types]</span>
<a name="line-792"></a>
<a name="line-793"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyVar</span>  <span class='hs-conid'>Name</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The type variable to which the lexically scoped type</span>
<a name="line-794"></a>                                <span class='hs-comment'>-- variable is bound. We only need the Name</span>
<a name="line-795"></a>                                <span class='hs-comment'>-- for error-message purposes; it is the corresponding</span>
<a name="line-796"></a>                                <span class='hs-comment'>-- Name in the domain of the envt</span>
<a name="line-797"></a>
<a name="line-798"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AThing</span>  <span class='hs-conid'>TcKind</span>   <span class='hs-comment'>-- Used temporarily, during kind checking, for the</span>
<a name="line-799"></a>                     <span class='hs-comment'>-- tycons and clases in this recursive group</span>
<a name="line-800"></a>                     <span class='hs-comment'>-- Can be a mono-kind or a poly-kind; in TcTyClsDcls see</span>
<a name="line-801"></a>                     <span class='hs-comment'>-- Note [Type checking recursive type and class declarations]</span>
<a name="line-802"></a>
<a name="line-803"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>APromotionErr</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="PromotionErr"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>PromotionErr</span>
<a name="line-806"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConPE</span>          <span class='hs-comment'>-- TyCon used in a kind before we are ready</span>
<a name="line-807"></a>                     <span class='hs-comment'>--     data T :: T -&gt; * where ...</span>
<a name="line-808"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPE</span>          <span class='hs-comment'>-- Ditto Class</span>
<a name="line-809"></a>
<a name="line-810"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamDataConPE</span>     <span class='hs-comment'>-- Data constructor for a data family</span>
<a name="line-811"></a>                     <span class='hs-comment'>-- See Note [AFamDataCon: not promoting data family constructors] in TcRnDriver</span>
<a name="line-812"></a>
<a name="line-813"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecDataConPE</span>     <span class='hs-comment'>-- Data constructor in a recursive loop</span>
<a name="line-814"></a>                     <span class='hs-comment'>-- See Note [ARecDataCon: recusion and promoting data constructors] in TcTyClsDecls</span>
<a name="line-815"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NoDataKinds</span>      <span class='hs-comment'>-- -XDataKinds not enabled</span>
<a name="line-816"></a>
<a name="line-817"></a><a name="instance%20Outputable%20TcTyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyword'>where</span>     <span class='hs-comment'>-- Debugging only</span>
<a name="line-818"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThing</span> <span class='hs-varid'>g</span>
<a name="line-819"></a>   <span class='hs-varid'>ppr</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Identifier"</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-820"></a>                          <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-821"></a>                                 <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_id</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-822"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tct_closed</span> <span class='hs-varid'>elt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-823"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>n</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Type variable"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-824"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"AThing"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span>
<a name="line-825"></a>   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"APromotionErr"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>err</span>
<a name="line-826"></a>
<a name="line-827"></a><a name="instance%20Outputable%20PromotionErr"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyword'>where</span>
<a name="line-828"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ClassPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ClassPE"</span>
<a name="line-829"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>TyConPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TyConPE"</span>
<a name="line-830"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"FamDataConPE"</span>
<a name="line-831"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>RecDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RecDataConPE"</span>
<a name="line-832"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NoDataKinds"</span>
<a name="line-833"></a>
<a name="line-834"></a><a name="pprTcTyThingCategory"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-835"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AGlobal</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span>
<a name="line-836"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type variable"</span><span class='hs-layout'>)</span>
<a name="line-837"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Local identifier"</span><span class='hs-layout'>)</span>
<a name="line-838"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AThing</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kinded thing"</span><span class='hs-layout'>)</span>
<a name="line-839"></a><span class='hs-definition'>pprTcTyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>pe</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>pe</span>
<a name="line-840"></a>
<a name="line-841"></a><a name="pprPECategory"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-842"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>ClassPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Class"</span><span class='hs-layout'>)</span>
<a name="line-843"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>TyConPE</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type constructor"</span><span class='hs-layout'>)</span>
<a name="line-844"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>FamDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
<a name="line-845"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>RecDataConPE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
<a name="line-846"></a><span class='hs-definition'>pprPECategory</span> <span class='hs-conid'>NoDataKinds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Data constructor"</span><span class='hs-layout'>)</span>
<a name="line-847"></a>
<a name="line-848"></a><span class='hs-comment'>{-
<a name="line-849"></a>Note [Bindings with closed types]
<a name="line-850"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-851"></a>Consider
<a name="line-852"></a>
<a name="line-853"></a>  f x = let g ys = map not ys
<a name="line-854"></a>        in ...
<a name="line-855"></a>
<a name="line-856"></a>Can we generalise 'g' under the OutsideIn algorithm?  Yes,
<a name="line-857"></a>because all g's free variables are top-level; that is they themselves
<a name="line-858"></a>have no free type variables, and it is the type variables in the
<a name="line-859"></a>environment that makes things tricky for OutsideIn generalisation.
<a name="line-860"></a>
<a name="line-861"></a>Definition:
<a name="line-862"></a>
<a name="line-863"></a>   A variable is "closed", and has tct_closed set to TopLevel,
<a name="line-864"></a>      iff
<a name="line-865"></a>   a) all its free variables are imported, or are themselves closed
<a name="line-866"></a>   b) generalisation is not restricted by the monomorphism restriction
<a name="line-867"></a>
<a name="line-868"></a>Under OutsideIn we are free to generalise a closed let-binding.
<a name="line-869"></a>This is an extension compared to the JFP paper on OutsideIn, which
<a name="line-870"></a>used "top-level" as a proxy for "closed".  (It's not a good proxy
<a name="line-871"></a>anyway -- the MR can make a top-level binding with a free type
<a name="line-872"></a>variable.)
<a name="line-873"></a>
<a name="line-874"></a>Note that:
<a name="line-875"></a>  * A top-level binding may not be closed, if it suffer from the MR
<a name="line-876"></a>
<a name="line-877"></a>  * A nested binding may be closed (eg 'g' in the example we started with)
<a name="line-878"></a>    Indeed, that's the point; whether a function is defined at top level
<a name="line-879"></a>    or nested is orthogonal to the question of whether or not it is closed
<a name="line-880"></a>
<a name="line-881"></a>  * A binding may be non-closed because it mentions a lexically scoped
<a name="line-882"></a>    *type variable*  Eg
<a name="line-883"></a>        f :: forall a. blah
<a name="line-884"></a>        f x = let g y = ...(y::a)...
<a name="line-885"></a>-}</span>
<a name="line-886"></a>
<a name="line-887"></a><a name="ErrCtxt"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>MsgDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-888"></a>        <span class='hs-comment'>-- Monadic so that we have a chance</span>
<a name="line-889"></a>        <span class='hs-comment'>-- to deal with bound type variables just before error</span>
<a name="line-890"></a>        <span class='hs-comment'>-- message construction</span>
<a name="line-891"></a>
<a name="line-892"></a>        <span class='hs-comment'>-- Bool:  True &lt;=&gt; this is a landmark context; do not</span>
<a name="line-893"></a>        <span class='hs-comment'>--                 discard it when trimming for display</span>
<a name="line-894"></a>
<a name="line-895"></a><span class='hs-comment'>{-
<a name="line-896"></a>************************************************************************
<a name="line-897"></a>*                                                                      *
<a name="line-898"></a>        Operations over ImportAvails
<a name="line-899"></a>*                                                                      *
<a name="line-900"></a>************************************************************************
<a name="line-901"></a>-}</span>
<a name="line-902"></a>
<a name="line-903"></a><a name="ImportAvails"></a><span class='hs-comment'>-- | 'ImportAvails' summarises what was imported from where, irrespective of</span>
<a name="line-904"></a><a name="ImportAvails"></a><span class='hs-comment'>-- whether the imported things are actually used or not.  It is used:</span>
<a name="line-905"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-906"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when processing the export list,</span>
<a name="line-907"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-908"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when constructing usage info for the interface file,</span>
<a name="line-909"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-910"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * to identify the list of directly imported modules for initialisation</span>
<a name="line-911"></a><a name="ImportAvails"></a><span class='hs-comment'>--    purposes and for optimised overlap checking of family instances,</span>
<a name="line-912"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-913"></a><a name="ImportAvails"></a><span class='hs-comment'>--  * when figuring out what things are really unused</span>
<a name="line-914"></a><a name="ImportAvails"></a><span class='hs-comment'>--</span>
<a name="line-915"></a><a name="ImportAvails"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-916"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-917"></a>        <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportedMods</span><span class='hs-layout'>,</span>
<a name="line-918"></a>          <span class='hs-comment'>--      = ModuleEnv [(ModuleName, Bool, SrcSpan, Bool)],</span>
<a name="line-919"></a>          <span class='hs-comment'>-- ^ Domain is all directly-imported modules</span>
<a name="line-920"></a>          <span class='hs-comment'>-- The 'ModuleName' is what the module was imported as, e.g. in</span>
<a name="line-921"></a>          <span class='hs-comment'>-- @</span>
<a name="line-922"></a>          <span class='hs-comment'>--     import Foo as Bar</span>
<a name="line-923"></a>          <span class='hs-comment'>-- @</span>
<a name="line-924"></a>          <span class='hs-comment'>-- it is @Bar@.</span>
<a name="line-925"></a>          <span class='hs-comment'>--</span>
<a name="line-926"></a>          <span class='hs-comment'>-- The 'Bool' means:</span>
<a name="line-927"></a>          <span class='hs-comment'>--</span>
<a name="line-928"></a>          <span class='hs-comment'>--  - @True@ =&gt; import was @import Foo ()@</span>
<a name="line-929"></a>          <span class='hs-comment'>--</span>
<a name="line-930"></a>          <span class='hs-comment'>--  - @False@ =&gt; import was some other form</span>
<a name="line-931"></a>          <span class='hs-comment'>--</span>
<a name="line-932"></a>          <span class='hs-comment'>-- Used</span>
<a name="line-933"></a>          <span class='hs-comment'>--</span>
<a name="line-934"></a>          <span class='hs-comment'>--   (a) to help construct the usage information in the interface</span>
<a name="line-935"></a>          <span class='hs-comment'>--       file; if we import something we need to recompile if the</span>
<a name="line-936"></a>          <span class='hs-comment'>--       export version changes</span>
<a name="line-937"></a>          <span class='hs-comment'>--</span>
<a name="line-938"></a>          <span class='hs-comment'>--   (b) to specify what child modules to initialise</span>
<a name="line-939"></a>          <span class='hs-comment'>--</span>
<a name="line-940"></a>          <span class='hs-comment'>-- We need a full ModuleEnv rather than a ModuleNameEnv here,</span>
<a name="line-941"></a>          <span class='hs-comment'>-- because we might be importing modules of the same name from</span>
<a name="line-942"></a>          <span class='hs-comment'>-- different packages. (currently not the case, but might be in the</span>
<a name="line-943"></a>          <span class='hs-comment'>-- future).</span>
<a name="line-944"></a>
<a name="line-945"></a>        <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-946"></a>          <span class='hs-comment'>-- ^ Home-package modules needed by the module being compiled</span>
<a name="line-947"></a>          <span class='hs-comment'>--</span>
<a name="line-948"></a>          <span class='hs-comment'>-- It doesn't matter whether any of these dependencies</span>
<a name="line-949"></a>          <span class='hs-comment'>-- are actually /used/ when compiling the module; they</span>
<a name="line-950"></a>          <span class='hs-comment'>-- are listed if they are below it at all.  For</span>
<a name="line-951"></a>          <span class='hs-comment'>-- example, suppose M imports A which imports X.  Then</span>
<a name="line-952"></a>          <span class='hs-comment'>-- compiling M might not need to consult X.hi, but X</span>
<a name="line-953"></a>          <span class='hs-comment'>-- is still listed in M's dependencies.</span>
<a name="line-954"></a>
<a name="line-955"></a>        <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageKey</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-956"></a>          <span class='hs-comment'>-- ^ Packages needed by the module being compiled, whether directly,</span>
<a name="line-957"></a>          <span class='hs-comment'>-- or via other modules in this package, or via modules imported</span>
<a name="line-958"></a>          <span class='hs-comment'>-- from other packages.</span>
<a name="line-959"></a>
<a name="line-960"></a>        <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PackageKey</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-961"></a>          <span class='hs-comment'>-- ^ This is strictly a subset of imp_dep_pkgs and records the</span>
<a name="line-962"></a>          <span class='hs-comment'>-- packages the current module needs to trust for Safe Haskell</span>
<a name="line-963"></a>          <span class='hs-comment'>-- compilation to succeed. A package is required to be trusted if</span>
<a name="line-964"></a>          <span class='hs-comment'>-- we are dependent on a trustworthy module in that package.</span>
<a name="line-965"></a>          <span class='hs-comment'>-- While perhaps making imp_dep_pkgs a tuple of (PackageKey, Bool)</span>
<a name="line-966"></a>          <span class='hs-comment'>-- where True for the bool indicates the package is required to be</span>
<a name="line-967"></a>          <span class='hs-comment'>-- trusted is the more logical  design, doing so complicates a lot</span>
<a name="line-968"></a>          <span class='hs-comment'>-- of code not concerned with Safe Haskell.</span>
<a name="line-969"></a>          <span class='hs-comment'>-- See Note [RnNames . Tracking Trust Transitively]</span>
<a name="line-970"></a>
<a name="line-971"></a>        <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-972"></a>          <span class='hs-comment'>-- ^ Do we require that our own package is trusted?</span>
<a name="line-973"></a>          <span class='hs-comment'>-- This is to handle efficiently the case where a Safe module imports</span>
<a name="line-974"></a>          <span class='hs-comment'>-- a Trustworthy module that resides in the same package as it.</span>
<a name="line-975"></a>          <span class='hs-comment'>-- See Note [RnNames . Trust Own Package]</span>
<a name="line-976"></a>
<a name="line-977"></a>        <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>
<a name="line-978"></a>          <span class='hs-comment'>-- ^ Orphan modules below us in the import tree (and maybe including</span>
<a name="line-979"></a>          <span class='hs-comment'>-- us for imported modules)</span>
<a name="line-980"></a>
<a name="line-981"></a>        <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Module</span><span class='hs-keyglyph'>]</span>
<a name="line-982"></a>          <span class='hs-comment'>-- ^ Family instance modules below us in the import tree (and maybe</span>
<a name="line-983"></a>          <span class='hs-comment'>-- including us for imported modules)</span>
<a name="line-984"></a>      <span class='hs-layout'>}</span>
<a name="line-985"></a>
<a name="line-986"></a><a name="mkModDeps"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-987"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleNameEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsBootInterface</span><span class='hs-layout'>)</span>
<a name="line-988"></a><span class='hs-definition'>mkModDeps</span> <span class='hs-varid'>deps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyUFM</span> <span class='hs-varid'>deps</span>
<a name="line-989"></a>               <span class='hs-keyword'>where</span>
<a name="line-990"></a>                 <span class='hs-varid'>add</span> <span class='hs-varid'>env</span> <span class='hs-varid'>elt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>elt</span>
<a name="line-991"></a>
<a name="line-992"></a><a name="emptyImportAvails"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-993"></a><span class='hs-definition'>emptyImportAvails</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyModuleEnv</span><span class='hs-layout'>,</span>
<a name="line-994"></a>                                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span><span class='hs-layout'>,</span>
<a name="line-995"></a>                                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-996"></a>                                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-997"></a>                                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span>
<a name="line-998"></a>                                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span>
<a name="line-999"></a>                                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-1000"></a>
<a name="line-1001"></a><a name="plusImportAvails"></a><span class='hs-comment'>-- | Union two ImportAvails</span>
<a name="line-1002"></a><span class='hs-comment'>--</span>
<a name="line-1003"></a><span class='hs-comment'>-- This function is a key part of Import handling, basically</span>
<a name="line-1004"></a><span class='hs-comment'>-- for each import we create a separate ImportAvails structure</span>
<a name="line-1005"></a><span class='hs-comment'>-- and then union them all together with this function.</span>
<a name="line-1006"></a><span class='hs-definition'>plusImportAvails</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>ImportAvails</span>
<a name="line-1007"></a><span class='hs-definition'>plusImportAvails</span>
<a name="line-1008"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods1</span><span class='hs-layout'>,</span>
<a name="line-1009"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span><span class='hs-layout'>,</span>
<a name="line-1010"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span><span class='hs-layout'>,</span>
<a name="line-1011"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1012"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1013"></a>                  <span class='hs-varid'>imp_dep_mods</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1014"></a>                  <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1015"></a>                  <span class='hs-varid'>imp_orphs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>imp_finsts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1016"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_mods</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusModuleEnv_C</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>mods1</span> <span class='hs-varid'>mods2</span><span class='hs-layout'>,</span>
<a name="line-1017"></a>                   <span class='hs-varid'>imp_dep_mods</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plusUFM_C</span> <span class='hs-varid'>plus_mod_dep</span> <span class='hs-varid'>dmods1</span> <span class='hs-varid'>dmods2</span><span class='hs-layout'>,</span>
<a name="line-1018"></a>                   <span class='hs-varid'>imp_dep_pkgs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dpkgs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>dpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1019"></a>                   <span class='hs-varid'>imp_trust_pkgs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tpkgs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>tpkgs2</span><span class='hs-layout'>,</span>
<a name="line-1020"></a>                   <span class='hs-varid'>imp_trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tself1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tself2</span><span class='hs-layout'>,</span>
<a name="line-1021"></a>                   <span class='hs-varid'>imp_orphs</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orphs1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>orphs2</span><span class='hs-layout'>,</span>
<a name="line-1022"></a>                   <span class='hs-varid'>imp_finsts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finsts1</span> <span class='hs-varop'>`unionLists`</span> <span class='hs-varid'>finsts2</span> <span class='hs-layout'>}</span>
<a name="line-1023"></a>  <span class='hs-keyword'>where</span>
<a name="line-1024"></a>    <span class='hs-varid'>plus_mod_dep</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m2</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span>
<a name="line-1025"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>m1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1026"></a>                <span class='hs-comment'>-- Check mod-names match</span>
<a name="line-1027"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>m1</span><span class='hs-layout'>,</span> <span class='hs-varid'>boot1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>boot2</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- If either side can "see" a non-hi-boot interface, use that</span>
<a name="line-1028"></a>
<a name="line-1029"></a><span class='hs-comment'>{-
<a name="line-1030"></a>************************************************************************
<a name="line-1031"></a>*                                                                      *
<a name="line-1032"></a>\subsection{Where from}
<a name="line-1033"></a>*                                                                      *
<a name="line-1034"></a>************************************************************************
<a name="line-1035"></a>
<a name="line-1036"></a>The @WhereFrom@ type controls where the renamer looks for an interface file
<a name="line-1037"></a>-}</span>
<a name="line-1038"></a>
<a name="line-1039"></a><a name="WhereFrom"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WhereFrom</span>
<a name="line-1040"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ImportByUser</span> <span class='hs-conid'>IsBootInterface</span>        <span class='hs-comment'>-- Ordinary user import (perhaps {-# SOURCE #-})</span>
<a name="line-1041"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportBySystem</span>                      <span class='hs-comment'>-- Non user import.</span>
<a name="line-1042"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ImportByPlugin</span>                      <span class='hs-comment'>-- Importing a plugin;</span>
<a name="line-1043"></a>                                        <span class='hs-comment'>-- See Note [Care with plugin imports] in LoadIface</span>
<a name="line-1044"></a>
<a name="line-1045"></a><a name="instance%20Outputable%20WhereFrom"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WhereFrom</span> <span class='hs-keyword'>where</span>
<a name="line-1046"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportByUser</span> <span class='hs-varid'>is_boot</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_boot</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- SOURCE -}"</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1048"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportBySystem</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- SYSTEM -}"</span><span class='hs-layout'>)</span>
<a name="line-1049"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>ImportByPlugin</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"{- PLUGIN -}"</span><span class='hs-layout'>)</span>
<a name="line-1050"></a>
<a name="line-1051"></a><span class='hs-comment'>{-
<a name="line-1052"></a>************************************************************************
<a name="line-1053"></a>*                                                                      *
<a name="line-1054"></a>*                       Canonical constraints                          *
<a name="line-1055"></a>*                                                                      *
<a name="line-1056"></a>*   These are the constraints the low-level simplifier works with      *
<a name="line-1057"></a>*                                                                      *
<a name="line-1058"></a>************************************************************************
<a name="line-1059"></a>-}</span>
<a name="line-1060"></a>
<a name="line-1061"></a><span class='hs-comment'>-- The syntax of xi types:</span>
<a name="line-1062"></a><span class='hs-comment'>-- xi ::= a | T xis | xis -&gt; xis | ... | forall a. tau</span>
<a name="line-1063"></a><span class='hs-comment'>-- Two important notes:</span>
<a name="line-1064"></a><span class='hs-comment'>--      (i) No type families, unless we are under a ForAll</span>
<a name="line-1065"></a><span class='hs-comment'>--      (ii) Note that xi types can contain unexpanded type synonyms;</span>
<a name="line-1066"></a><span class='hs-comment'>--           however, the (transitive) expansions of those type synonyms</span>
<a name="line-1067"></a><span class='hs-comment'>--           will not contain any type functions, unless we are under a ForAll.</span>
<a name="line-1068"></a><span class='hs-comment'>-- We enforce the structure of Xi types when we flatten (TcCanonical)</span>
<a name="line-1069"></a>
<a name="line-1070"></a><a name="Xi"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- In many comments, "xi" ranges over Xi</span>
<a name="line-1071"></a>
<a name="line-1072"></a><a name="Cts"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span>
<a name="line-1073"></a>
<a name="line-1074"></a><a name="Ct"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Ct</span>
<a name="line-1075"></a>  <span class='hs-comment'>-- Atomic canonical constraints</span>
<a name="line-1076"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- e.g.  Num xi</span>
<a name="line-1077"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1078"></a>      <span class='hs-varid'>cc_class</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span>
<a name="line-1079"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- cc_tyargs are function-free, hence Xi</span>
<a name="line-1080"></a>    <span class='hs-layout'>}</span>
<a name="line-1081"></a>
<a name="line-1082"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- These stand for yet-unusable predicates</span>
<a name="line-1083"></a>      <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>   <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1084"></a>        <span class='hs-comment'>-- The ctev_pred of the evidence is</span>
<a name="line-1085"></a>        <span class='hs-comment'>-- of form   (tv xi1 xi2 ... xin)</span>
<a name="line-1086"></a>        <span class='hs-comment'>--      or   (tv1 ~ ty2)   where the CTyEqCan  kind invariant fails</span>
<a name="line-1087"></a>        <span class='hs-comment'>--      or   (F tys ~ ty)  where the CFunEqCan kind invariant fails</span>
<a name="line-1088"></a>        <span class='hs-comment'>-- See Note [CIrredEvCan constraints]</span>
<a name="line-1089"></a>    <span class='hs-layout'>}</span>
<a name="line-1090"></a>
<a name="line-1091"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- tv ~ rhs</span>
<a name="line-1092"></a>       <span class='hs-comment'>-- Invariants:</span>
<a name="line-1093"></a>       <span class='hs-comment'>--   * See Note [Applying the inert substitution] in TcFlatten</span>
<a name="line-1094"></a>       <span class='hs-comment'>--   * tv not in tvs(rhs)   (occurs check)</span>
<a name="line-1095"></a>       <span class='hs-comment'>--   * If tv is a TauTv, then rhs has no foralls</span>
<a name="line-1096"></a>       <span class='hs-comment'>--       (this avoids substituting a forall for the tyvar in other types)</span>
<a name="line-1097"></a>       <span class='hs-comment'>--   * typeKind ty `subKind` typeKind tv</span>
<a name="line-1098"></a>       <span class='hs-comment'>--       See Note [Kind orientation for CTyEqCan]</span>
<a name="line-1099"></a>       <span class='hs-comment'>--   * rhs is not necessarily function-free,</span>
<a name="line-1100"></a>       <span class='hs-comment'>--       but it has no top-level function.</span>
<a name="line-1101"></a>       <span class='hs-comment'>--     E.g. a ~ [F b]  is fine</span>
<a name="line-1102"></a>       <span class='hs-comment'>--     but  a ~ F b    is not</span>
<a name="line-1103"></a>       <span class='hs-comment'>--   * If the equality is representational, rhs has no top-level newtype</span>
<a name="line-1104"></a>       <span class='hs-comment'>--     See Note [No top-level newtypes on RHS of representational</span>
<a name="line-1105"></a>       <span class='hs-comment'>--     equalities] in TcCanonical</span>
<a name="line-1106"></a>       <span class='hs-comment'>--   * If rhs is also a tv, then it is oriented to give best chance of</span>
<a name="line-1107"></a>       <span class='hs-comment'>--     unification happening; eg if rhs is touchable then lhs is too</span>
<a name="line-1108"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1109"></a>      <span class='hs-varid'>cc_tyvar</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span>
<a name="line-1110"></a>      <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span>     <span class='hs-comment'>-- Not necessarily function-free (hence not Xi)</span>
<a name="line-1111"></a>                               <span class='hs-comment'>-- See invariants above</span>
<a name="line-1112"></a>      <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span>
<a name="line-1113"></a>    <span class='hs-layout'>}</span>
<a name="line-1114"></a>
<a name="line-1115"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- F xis ~ fsk</span>
<a name="line-1116"></a>       <span class='hs-comment'>-- Invariants:</span>
<a name="line-1117"></a>       <span class='hs-comment'>--   * isTypeFamilyTyCon cc_fun</span>
<a name="line-1118"></a>       <span class='hs-comment'>--   * typeKind (F xis) = tyVarKind fsk</span>
<a name="line-1119"></a>       <span class='hs-comment'>--   * always Nominal role</span>
<a name="line-1120"></a>       <span class='hs-comment'>--   * always Given or Wanted, never Derived</span>
<a name="line-1121"></a>      <span class='hs-varid'>cc_ev</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1122"></a>      <span class='hs-varid'>cc_fun</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- A type function</span>
<a name="line-1123"></a>
<a name="line-1124"></a>      <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Xi</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>        <span class='hs-comment'>-- cc_tyargs are function-free (hence Xi)</span>
<a name="line-1125"></a>        <span class='hs-comment'>-- Either under-saturated or exactly saturated</span>
<a name="line-1126"></a>        <span class='hs-comment'>--    *never* over-saturated (because if so</span>
<a name="line-1127"></a>        <span class='hs-comment'>--    we should have decomposed)</span>
<a name="line-1128"></a>
<a name="line-1129"></a>      <span class='hs-varid'>cc_fsk</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span>  <span class='hs-comment'>-- [Given]  always a FlatSkol skolem</span>
<a name="line-1130"></a>                            <span class='hs-comment'>-- [Wanted] always a FlatMetaTv unification variable</span>
<a name="line-1131"></a>        <span class='hs-comment'>-- See Note [The flattening story] in TcFlatten</span>
<a name="line-1132"></a>    <span class='hs-layout'>}</span>
<a name="line-1133"></a>
<a name="line-1134"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span>        <span class='hs-comment'>-- See Note [NonCanonical Semantics]</span>
<a name="line-1135"></a>      <span class='hs-varid'>cc_ev</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1136"></a>    <span class='hs-layout'>}</span>
<a name="line-1137"></a>
<a name="line-1138"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span>             <span class='hs-comment'>-- Treated as an "insoluble" constraint</span>
<a name="line-1139"></a>                           <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-1140"></a>      <span class='hs-varid'>cc_ev</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span>
<a name="line-1141"></a>      <span class='hs-varid'>cc_occ</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OccName</span><span class='hs-layout'>,</span>   <span class='hs-comment'>-- The name of this hole</span>
<a name="line-1142"></a>      <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HoleSort</span>   <span class='hs-comment'>-- The sort of this hole (expr, type, ...)</span>
<a name="line-1143"></a>    <span class='hs-layout'>}</span>
<a name="line-1144"></a>
<a name="line-1145"></a><a name="HoleSort"></a><span class='hs-comment'>-- | Used to indicate which sort of hole we have.</span>
<a name="line-1146"></a><a name="HoleSort"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HoleSort</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprHole</span>  <span class='hs-comment'>-- ^ A hole in an expression (TypedHoles)</span>
<a name="line-1147"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeHole</span>  <span class='hs-comment'>-- ^ A hole in a type (PartialTypeSignatures)</span>
<a name="line-1148"></a>
<a name="line-1149"></a><span class='hs-comment'>{-
<a name="line-1150"></a>Note [Kind orientation for CTyEqCan]
<a name="line-1151"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1152"></a>Given an equality (t:* ~ s:Open), we can't solve it by updating t:=s,
<a name="line-1153"></a>ragardless of how touchable 't' is, because the kinds don't work.
<a name="line-1154"></a>
<a name="line-1155"></a>Instead we absolutely must re-orient it. Reason: if that gets into the
<a name="line-1156"></a>inert set we'll start replacing t's by s's, and that might make a
<a name="line-1157"></a>kind-correct type into a kind error.  After re-orienting,
<a name="line-1158"></a>we may be able to solve by updating s:=t.
<a name="line-1159"></a>
<a name="line-1160"></a>Hence in a CTyEqCan, (t:k1 ~ xi:k2) we require that k2 is a subkind of k1.
<a name="line-1161"></a>
<a name="line-1162"></a>If the two have incompatible kinds, we just don't use a CTyEqCan at all.
<a name="line-1163"></a>See Note [Equalities with incompatible kinds] in TcCanonical
<a name="line-1164"></a>
<a name="line-1165"></a>We can't require *equal* kinds, because
<a name="line-1166"></a>     * wanted constraints don't necessarily have identical kinds
<a name="line-1167"></a>               eg   alpha::? ~ Int
<a name="line-1168"></a>     * a solved wanted constraint becomes a given
<a name="line-1169"></a>
<a name="line-1170"></a>Note [Kind orientation for CFunEqCan]
<a name="line-1171"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1172"></a>For (F xis ~ rhs) we require that kind(lhs) is a subkind of kind(rhs).
<a name="line-1173"></a>This really only maters when rhs is an Open type variable (since only type
<a name="line-1174"></a>variables have Open kinds):
<a name="line-1175"></a>   F ty ~ (a:Open)
<a name="line-1176"></a>which can happen, say, from
<a name="line-1177"></a>      f :: F a b
<a name="line-1178"></a>      f = undefined   -- The a:Open comes from instantiating 'undefined'
<a name="line-1179"></a>
<a name="line-1180"></a>Note that the kind invariant is maintained by rewriting.
<a name="line-1181"></a>Eg wanted1 rewrites wanted2; if both were compatible kinds before,
<a name="line-1182"></a>   wanted2 will be afterwards.  Similarly givens.
<a name="line-1183"></a>
<a name="line-1184"></a>Caveat:
<a name="line-1185"></a>  - Givens from higher-rank, such as:
<a name="line-1186"></a>          type family T b :: * -&gt; * -&gt; *
<a name="line-1187"></a>          type instance T Bool = (-&gt;)
<a name="line-1188"></a>
<a name="line-1189"></a>          f :: forall a. ((T a ~ (-&gt;)) =&gt; ...) -&gt; a -&gt; ...
<a name="line-1190"></a>          flop = f (...) True
<a name="line-1191"></a>     Whereas we would be able to apply the type instance, we would not be able to
<a name="line-1192"></a>     use the given (T Bool ~ (-&gt;)) in the body of 'flop'
<a name="line-1193"></a>
<a name="line-1194"></a>
<a name="line-1195"></a>Note [CIrredEvCan constraints]
<a name="line-1196"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1197"></a>CIrredEvCan constraints are used for constraints that are "stuck"
<a name="line-1198"></a>   - we can't solve them (yet)
<a name="line-1199"></a>   - we can't use them to solve other constraints
<a name="line-1200"></a>   - but they may become soluble if we substitute for some
<a name="line-1201"></a>     of the type variables in the constraint
<a name="line-1202"></a>
<a name="line-1203"></a>Example 1:  (c Int), where c :: * -&gt; Constraint.  We can't do anything
<a name="line-1204"></a>            with this yet, but if later c := Num, *then* we can solve it
<a name="line-1205"></a>
<a name="line-1206"></a>Example 2:  a ~ b, where a :: *, b :: k, where k is a kind variable
<a name="line-1207"></a>            We don't want to use this to substitute 'b' for 'a', in case
<a name="line-1208"></a>            'k' is subequently unifed with (say) *-&gt;*, because then
<a name="line-1209"></a>            we'd have ill-kinded types floating about.  Rather we want
<a name="line-1210"></a>            to defer using the equality altogether until 'k' get resolved.
<a name="line-1211"></a>
<a name="line-1212"></a>Note [Ct/evidence invariant]
<a name="line-1213"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1214"></a>If  ct :: Ct, then extra fields of 'ct' cache precisely the ctev_pred field
<a name="line-1215"></a>of (cc_ev ct), and is fully rewritten wrt the substitution.   Eg for CDictCan,
<a name="line-1216"></a>   ctev_pred (cc_ev ct) = (cc_class ct) (cc_tyargs ct)
<a name="line-1217"></a>This holds by construction; look at the unique place where CDictCan is
<a name="line-1218"></a>built (in TcCanonical).
<a name="line-1219"></a>
<a name="line-1220"></a>In contrast, the type of the evidence *term* (ccev_evtm or ctev_evar) in
<a name="line-1221"></a>the evidence may *not* be fully zonked; we are careful not to look at it
<a name="line-1222"></a>during constraint solving.  See Note [Evidence field of CtEvidence]
<a name="line-1223"></a>-}</span>
<a name="line-1224"></a>
<a name="line-1225"></a><a name="mkNonCanonical"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1226"></a><span class='hs-definition'>mkNonCanonical</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-1227"></a>
<a name="line-1228"></a><a name="mkNonCanonicalCt"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-1229"></a><span class='hs-definition'>mkNonCanonicalCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span>
<a name="line-1230"></a>
<a name="line-1231"></a><a name="ctEvidence"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1232"></a><span class='hs-definition'>ctEvidence</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1233"></a>
<a name="line-1234"></a><a name="ctLoc"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1235"></a><span class='hs-definition'>ctLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvLoc</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1236"></a>
<a name="line-1237"></a><a name="ctPred"></a><span class='hs-definition'>ctPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-1238"></a><span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1239"></a><span class='hs-definition'>ctPred</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1240"></a>
<a name="line-1241"></a><a name="ctFlavour"></a><span class='hs-comment'>-- | Get the flavour of the given 'Ct'</span>
<a name="line-1242"></a><span class='hs-definition'>ctFlavour</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span>
<a name="line-1243"></a><span class='hs-definition'>ctFlavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1244"></a>
<a name="line-1245"></a><a name="ctEqRel"></a><span class='hs-comment'>-- | Get the equality relation for the given 'Ct'</span>
<a name="line-1246"></a><span class='hs-definition'>ctEqRel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span>
<a name="line-1247"></a><span class='hs-definition'>ctEqRel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvEqRel</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span>
<a name="line-1248"></a>
<a name="line-1249"></a><a name="dropDerivedWC"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1250"></a><span class='hs-comment'>-- See Note [Dropping derived constraints]</span>
<a name="line-1251"></a><span class='hs-definition'>dropDerivedWC</span> <span class='hs-varid'>wc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simples</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1252"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>simples</span> <span class='hs-layout'>}</span>
<a name="line-1253"></a>    <span class='hs-comment'>-- The wc_impl implications are already (recursively) filtered</span>
<a name="line-1254"></a>
<a name="line-1255"></a><span class='hs-comment'>{-
<a name="line-1256"></a>Note [Dropping derived constraints]
<a name="line-1257"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1258"></a>In general we discard derived constraints at the end of constraint solving;
<a name="line-1259"></a>see dropDerivedWC.  For example
<a name="line-1260"></a> * If we have an unsolved (Ord a), we don't want to complain about
<a name="line-1261"></a>   an unsolved (Eq a) as well.
<a name="line-1262"></a>
<a name="line-1263"></a>But we keep Derived *insoluble* constraints because they indicate a solid,
<a name="line-1264"></a>comprehensible error.  Particularly:
<a name="line-1265"></a>
<a name="line-1266"></a> * Insolubles Givens indicate unreachable code
<a name="line-1267"></a>
<a name="line-1268"></a> * Insoluble kind equalities (e.g. [D] * ~ (* -&gt; *)) may arise from
<a name="line-1269"></a>   a type equality a ~ Int#, say
<a name="line-1270"></a>
<a name="line-1271"></a> * Insoluble derived wanted equalities (e.g. [D] Int ~ Bool) may
<a name="line-1272"></a>   arise from functional dependency interactions.  We are careful
<a name="line-1273"></a>   to keep a good CtOrigin on such constraints (FunDepOrigin1, FunDepOrigin2)
<a name="line-1274"></a>   so that we can produce a good error message (Trac #9612)
<a name="line-1275"></a>
<a name="line-1276"></a>Since we leave these Derived constraints in the residual WantedConstraints,
<a name="line-1277"></a>we must filter them out when we re-process the WantedConstraint,
<a name="line-1278"></a>in TcSimplify.solve_wanteds.
<a name="line-1279"></a>
<a name="line-1280"></a>
<a name="line-1281"></a>************************************************************************
<a name="line-1282"></a>*                                                                      *
<a name="line-1283"></a>                    CtEvidence
<a name="line-1284"></a>         The "flavor" of a canonical constraint
<a name="line-1285"></a>*                                                                      *
<a name="line-1286"></a>************************************************************************
<a name="line-1287"></a>-}</span>
<a name="line-1288"></a>
<a name="line-1289"></a><a name="isWantedCt"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1290"></a><span class='hs-definition'>isWantedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWanted</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1291"></a>
<a name="line-1292"></a><a name="isGivenCt"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1293"></a><span class='hs-definition'>isGivenCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isGiven</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1294"></a>
<a name="line-1295"></a><a name="isDerivedCt"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1296"></a><span class='hs-definition'>isDerivedCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDerived</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cc_ev</span>
<a name="line-1297"></a>
<a name="line-1298"></a><a name="isCTyEqCan"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1299"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1300"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1301"></a><span class='hs-definition'>isCTyEqCan</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1302"></a>
<a name="line-1303"></a><a name="isCDictCan_Maybe"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Class</span>
<a name="line-1304"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cls</span>
<a name="line-1305"></a><span class='hs-definition'>isCDictCan_Maybe</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1306"></a>
<a name="line-1307"></a><a name="isCIrredEvCan"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1308"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1309"></a><span class='hs-definition'>isCIrredEvCan</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1310"></a>
<a name="line-1311"></a><a name="isCFunEqCan_maybe"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1312"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>xis</span><span class='hs-layout'>)</span>
<a name="line-1313"></a><span class='hs-definition'>isCFunEqCan_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1314"></a>
<a name="line-1315"></a><a name="isCFunEqCan"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1316"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1317"></a><span class='hs-definition'>isCFunEqCan</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1318"></a>
<a name="line-1319"></a><a name="isCNonCanonical"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1320"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-layout'>(</span><span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1321"></a><span class='hs-definition'>isCNonCanonical</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1322"></a>
<a name="line-1323"></a><a name="isHoleCt"></a><span class='hs-definition'>isHoleCt</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1324"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1325"></a><span class='hs-definition'>isHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1326"></a>
<a name="line-1327"></a><a name="isTypedHoleCt"></a><span class='hs-definition'>isTypedHoleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1328"></a><span class='hs-definition'>isTypedHoleCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExprHole</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1329"></a><span class='hs-definition'>isTypedHoleCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1330"></a>
<a name="line-1331"></a><a name="isPartialTypeSigCt"></a><span class='hs-definition'>isPartialTypeSigCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1332"></a><span class='hs-definition'>isPartialTypeSigCt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_hole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeHole</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1333"></a><span class='hs-definition'>isPartialTypeSigCt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1334"></a>
<a name="line-1335"></a><a name="instance%20Outputable%20Ct"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Ct</span> <span class='hs-keyword'>where</span>
<a name="line-1336"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>ct_sort</span><span class='hs-layout'>)</span>
<a name="line-1337"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ct_sort</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-1338"></a>                           <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CTyEqCan"</span>
<a name="line-1339"></a>                           <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CFunEqCan"</span>
<a name="line-1340"></a>                           <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CNonCanonical"</span>
<a name="line-1341"></a>                           <span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CDictCan"</span>
<a name="line-1342"></a>                           <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CIrredEvCan"</span>
<a name="line-1343"></a>                           <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"CHoleCan"</span>
<a name="line-1344"></a>
<a name="line-1345"></a><a name="singleCt"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1346"></a><span class='hs-definition'>singleCt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span>
<a name="line-1347"></a>
<a name="line-1348"></a><a name="andCts"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1349"></a><span class='hs-definition'>andCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionBags</span>
<a name="line-1350"></a>
<a name="line-1351"></a><a name="listToCts"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1352"></a><span class='hs-definition'>listToCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span>
<a name="line-1353"></a>
<a name="line-1354"></a><a name="ctsElts"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1355"></a><span class='hs-definition'>ctsElts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span>
<a name="line-1356"></a>
<a name="line-1357"></a><a name="consCts"></a><span class='hs-definition'>consCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1358"></a><span class='hs-definition'>consCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>consBag</span>
<a name="line-1359"></a>
<a name="line-1360"></a><a name="snocCts"></a><span class='hs-definition'>snocCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1361"></a><span class='hs-definition'>snocCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snocBag</span>
<a name="line-1362"></a>
<a name="line-1363"></a><a name="extendCtsList"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1364"></a><span class='hs-definition'>extendCtsList</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>xs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-1365"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>xs</span>
<a name="line-1366"></a>
<a name="line-1367"></a><a name="andManyCts"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Cts</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-1368"></a><span class='hs-definition'>andManyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionManyBags</span>
<a name="line-1369"></a>
<a name="line-1370"></a><a name="emptyCts"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-1371"></a><span class='hs-definition'>emptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-1372"></a>
<a name="line-1373"></a><a name="isEmptyCts"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1374"></a><span class='hs-definition'>isEmptyCts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span>
<a name="line-1375"></a>
<a name="line-1376"></a><a name="pprCts"></a><span class='hs-definition'>pprCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1377"></a><span class='hs-definition'>pprCts</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1378"></a>
<a name="line-1379"></a><span class='hs-comment'>{-
<a name="line-1380"></a>************************************************************************
<a name="line-1381"></a>*                                                                      *
<a name="line-1382"></a>                Wanted constraints
<a name="line-1383"></a>     These are forced to be in TcRnTypes because
<a name="line-1384"></a>           TcLclEnv mentions WantedConstraints
<a name="line-1385"></a>           WantedConstraint mentions CtLoc
<a name="line-1386"></a>           CtLoc mentions ErrCtxt
<a name="line-1387"></a>           ErrCtxt mentions TcM
<a name="line-1388"></a>*                                                                      *
<a name="line-1389"></a>v%************************************************************************
<a name="line-1390"></a>-}</span>
<a name="line-1391"></a>
<a name="line-1392"></a><a name="WantedConstraints"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1393"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Unsolved constraints, all wanted</span>
<a name="line-1394"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-1395"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>              <span class='hs-comment'>-- Insoluble constraints, can be</span>
<a name="line-1396"></a>                                       <span class='hs-comment'>-- wanted, given, or derived</span>
<a name="line-1397"></a>                                       <span class='hs-comment'>-- See Note [Insoluble constraints]</span>
<a name="line-1398"></a>    <span class='hs-layout'>}</span>
<a name="line-1399"></a>
<a name="line-1400"></a><a name="emptyWC"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1401"></a><span class='hs-definition'>emptyWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-1402"></a>
<a name="line-1403"></a><a name="mkSimpleWC"></a><span class='hs-definition'>mkSimpleWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1404"></a><span class='hs-definition'>mkSimpleWC</span> <span class='hs-varid'>cts</span>
<a name="line-1405"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="isEmptyWC"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1408"></a><span class='hs-definition'>isEmptyWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1409"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>n</span>
<a name="line-1410"></a>
<a name="line-1411"></a><a name="insolubleWC"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1412"></a><span class='hs-comment'>-- True if there are any insoluble constraints in the wanted bag. Ignore</span>
<a name="line-1413"></a><span class='hs-comment'>-- constraints arising from PartialTypeSignatures to solve as much of the</span>
<a name="line-1414"></a><span class='hs-comment'>-- constraints as possible before reporting the holes.</span>
<a name="line-1415"></a><span class='hs-definition'>insolubleWC</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isPartialTypeSigCt</span><span class='hs-layout'>)</span>
<a name="line-1416"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1417"></a>               <span class='hs-varop'>||</span> <span class='hs-varid'>anyBag</span> <span class='hs-varid'>ic_insol</span> <span class='hs-layout'>(</span><span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-1418"></a>
<a name="line-1419"></a><a name="andWC"></a><span class='hs-definition'>andWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1420"></a><span class='hs-definition'>andWC</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1421"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>f2</span>
<a name="line-1423"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>i2</span>
<a name="line-1424"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>n2</span> <span class='hs-layout'>}</span>
<a name="line-1425"></a>
<a name="line-1426"></a><a name="unionsWC"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>WantedConstraints</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1427"></a><span class='hs-definition'>unionsWC</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>andWC</span> <span class='hs-varid'>emptyWC</span>
<a name="line-1428"></a>
<a name="line-1429"></a><a name="addSimples"></a><span class='hs-definition'>addSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1430"></a><span class='hs-definition'>addSimples</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-1431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_simple</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-1432"></a>
<a name="line-1433"></a><a name="addImplics"></a><span class='hs-definition'>addImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1434"></a><span class='hs-definition'>addImplics</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_impl</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>}</span>
<a name="line-1435"></a>
<a name="line-1436"></a><a name="addInsols"></a><span class='hs-definition'>addInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-1437"></a><span class='hs-definition'>addInsols</span> <span class='hs-varid'>wc</span> <span class='hs-varid'>cts</span>
<a name="line-1438"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_insol</span> <span class='hs-varid'>wc</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span>
<a name="line-1439"></a>
<a name="line-1440"></a><a name="instance%20Outputable%20WantedConstraints"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyword'>where</span>
<a name="line-1441"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span><span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1442"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"WC"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span>
<a name="line-1443"></a>        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_simple"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span>
<a name="line-1444"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_insol"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-1445"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_bag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"wc_impl"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1446"></a>
<a name="line-1447"></a><a name="ppr_bag"></a><span class='hs-definition'>ppr_bag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1448"></a><span class='hs-definition'>ppr_bag</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>bag</span>
<a name="line-1449"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1450"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>                       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>$$</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ppr</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span> <span class='hs-varid'>bag</span><span class='hs-layout'>)</span>
<a name="line-1452"></a>
<a name="line-1453"></a><span class='hs-comment'>{-
<a name="line-1454"></a>************************************************************************
<a name="line-1455"></a>*                                                                      *
<a name="line-1456"></a>                Implication constraints
<a name="line-1457"></a>*                                                                      *
<a name="line-1458"></a>************************************************************************
<a name="line-1459"></a>-}</span>
<a name="line-1460"></a>
<a name="line-1461"></a><a name="Implication"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Implication</span>
<a name="line-1462"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span>
<a name="line-1463"></a>      <span class='hs-varid'>ic_tclvl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- TcLevel: unification variables</span>
<a name="line-1464"></a>                                <span class='hs-comment'>-- free in the environment</span>
<a name="line-1465"></a>
<a name="line-1466"></a>      <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- Introduced skolems</span>
<a name="line-1467"></a>      <span class='hs-varid'>ic_info</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span><span class='hs-layout'>,</span>    <span class='hs-comment'>-- See Note [Skolems in an implication]</span>
<a name="line-1468"></a>                                 <span class='hs-comment'>-- See Note [Shadowing in a constraint]</span>
<a name="line-1469"></a>
<a name="line-1470"></a>      <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Given evidence variables</span>
<a name="line-1471"></a>                                 <span class='hs-comment'>--   (order does not matter)</span>
<a name="line-1472"></a>                                 <span class='hs-comment'>-- See Invariant (GivenInv) in TcType</span>
<a name="line-1473"></a>
<a name="line-1474"></a>      <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- True  &lt;=&gt; ic_givens have no equalities, for sure</span>
<a name="line-1475"></a>                                 <span class='hs-comment'>-- False &lt;=&gt; ic_givens might have equalities</span>
<a name="line-1476"></a>
<a name="line-1477"></a>      <span class='hs-varid'>ic_env</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Gives the source location and error context</span>
<a name="line-1478"></a>                                 <span class='hs-comment'>-- for the implicatdion, and hence for all the</span>
<a name="line-1479"></a>                                 <span class='hs-comment'>-- given evidence variables</span>
<a name="line-1480"></a>
<a name="line-1481"></a>      <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span><span class='hs-layout'>,</span>  <span class='hs-comment'>-- The wanted</span>
<a name="line-1482"></a>      <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- True iff insolubleWC ic_wanted is true</span>
<a name="line-1483"></a>
<a name="line-1484"></a>      <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>   <span class='hs-comment'>-- Points to the place to fill in the</span>
<a name="line-1485"></a>                                <span class='hs-comment'>-- abstraction and bindings</span>
<a name="line-1486"></a>    <span class='hs-layout'>}</span>
<a name="line-1487"></a>
<a name="line-1488"></a><a name="instance%20Outputable%20Implication"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Implication</span> <span class='hs-keyword'>where</span>
<a name="line-1489"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skols</span>
<a name="line-1490"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_eqs</span>
<a name="line-1491"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span>
<a name="line-1492"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1493"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Implic"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>lbrace</span><span class='hs-layout'>)</span>
<a name="line-1494"></a>        <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"TcLevel ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-1495"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Skolems ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTvBndrs</span> <span class='hs-varid'>skols</span>
<a name="line-1496"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No-eqs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>no_eqs</span>
<a name="line-1497"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Insol ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insol</span>
<a name="line-1498"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Given ="</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprEvVars</span> <span class='hs-varid'>given</span><span class='hs-layout'>)</span>
<a name="line-1499"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Wanted ="</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Binds ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span>
<a name="line-1501"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>pprSkolInfo</span> <span class='hs-varid'>info</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>rbrace</span><span class='hs-layout'>)</span>
<a name="line-1502"></a>
<a name="line-1503"></a><span class='hs-comment'>{-
<a name="line-1504"></a>Note [Shadowing in a constraint]
<a name="line-1505"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1506"></a>We assume NO SHADOWING in a constraint.  Specifically
<a name="line-1507"></a> * The unification variables are all implicitly quantified at top
<a name="line-1508"></a>   level, and are all unique
<a name="line-1509"></a> * The skolem varibles bound in ic_skols are all freah when the
<a name="line-1510"></a>   implication is created.
<a name="line-1511"></a>So we can safely substitute. For example, if we have
<a name="line-1512"></a>   forall a.  a~Int =&gt; ...(forall b. ...a...)...
<a name="line-1513"></a>we can push the (a~Int) constraint inwards in the "givens" without
<a name="line-1514"></a>worrying that 'b' might clash.
<a name="line-1515"></a>
<a name="line-1516"></a>Note [Skolems in an implication]
<a name="line-1517"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1518"></a>The skolems in an implication are not there to perform a skolem escape
<a name="line-1519"></a>check.  That happens because all the environment variables are in the
<a name="line-1520"></a>untouchables, and therefore cannot be unified with anything at all,
<a name="line-1521"></a>let alone the skolems.
<a name="line-1522"></a>
<a name="line-1523"></a>Instead, ic_skols is used only when considering floating a constraint
<a name="line-1524"></a>outside the implication in TcSimplify.floatEqualities or
<a name="line-1525"></a>TcSimplify.approximateImplications
<a name="line-1526"></a>
<a name="line-1527"></a>Note [Insoluble constraints]
<a name="line-1528"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1529"></a>Some of the errors that we get during canonicalization are best
<a name="line-1530"></a>reported when all constraints have been simplified as much as
<a name="line-1531"></a>possible. For instance, assume that during simplification the
<a name="line-1532"></a>following constraints arise:
<a name="line-1533"></a>
<a name="line-1534"></a> [Wanted]   F alpha ~  uf1
<a name="line-1535"></a> [Wanted]   beta ~ uf1 beta
<a name="line-1536"></a>
<a name="line-1537"></a>When canonicalizing the wanted (beta ~ uf1 beta), if we eagerly fail
<a name="line-1538"></a>we will simply see a message:
<a name="line-1539"></a>    'Can't construct the infinite type  beta ~ uf1 beta'
<a name="line-1540"></a>and the user has no idea what the uf1 variable is.
<a name="line-1541"></a>
<a name="line-1542"></a>Instead our plan is that we will NOT fail immediately, but:
<a name="line-1543"></a>    (1) Record the "frozen" error in the ic_insols field
<a name="line-1544"></a>    (2) Isolate the offending constraint from the rest of the inerts
<a name="line-1545"></a>    (3) Keep on simplifying/canonicalizing
<a name="line-1546"></a>
<a name="line-1547"></a>At the end, we will hopefully have substituted uf1 := F alpha, and we
<a name="line-1548"></a>will be able to report a more informative error:
<a name="line-1549"></a>    'Can't construct the infinite type beta ~ F alpha beta'
<a name="line-1550"></a>
<a name="line-1551"></a>Insoluble constraints *do* include Derived constraints. For example,
<a name="line-1552"></a>a functional dependency might give rise to [D] Int ~ Bool, and we must
<a name="line-1553"></a>report that.  If insolubles did not contain Deriveds, reportErrors would
<a name="line-1554"></a>never see it.
<a name="line-1555"></a>
<a name="line-1556"></a>
<a name="line-1557"></a>************************************************************************
<a name="line-1558"></a>*                                                                      *
<a name="line-1559"></a>            Pretty printing
<a name="line-1560"></a>*                                                                      *
<a name="line-1561"></a>************************************************************************
<a name="line-1562"></a>-}</span>
<a name="line-1563"></a>
<a name="line-1564"></a><a name="pprEvVars"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>    <span class='hs-comment'>-- Print with their types</span>
<a name="line-1565"></a><span class='hs-definition'>pprEvVars</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprEvVarWithType</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>
<a name="line-1567"></a><a name="pprEvVarTheta"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1568"></a><span class='hs-definition'>pprEvVarTheta</span> <span class='hs-varid'>ev_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTheta</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>ev_vars</span><span class='hs-layout'>)</span>
<a name="line-1569"></a>
<a name="line-1570"></a><a name="pprEvVarWithType"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1571"></a><span class='hs-definition'>pprEvVarWithType</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarPred</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1572"></a>
<a name="line-1573"></a><span class='hs-comment'>{-
<a name="line-1574"></a>************************************************************************
<a name="line-1575"></a>*                                                                      *
<a name="line-1576"></a>            CtEvidence
<a name="line-1577"></a>*                                                                      *
<a name="line-1578"></a>************************************************************************
<a name="line-1579"></a>
<a name="line-1580"></a>Note [Evidence field of CtEvidence]
<a name="line-1581"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1582"></a>During constraint solving we never look at the type of ctev_evtm, or
<a name="line-1583"></a>ctev_evar; instead we look at the cte_pred field.  The evtm/evar field
<a name="line-1584"></a>may be un-zonked.
<a name="line-1585"></a>-}</span>
<a name="line-1586"></a>
<a name="line-1587"></a><a name="CtEvidence"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1588"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>      <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1589"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span>          <span class='hs-comment'>-- See Note [Evidence field of CtEvidence]</span>
<a name="line-1590"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-1591"></a>    <span class='hs-comment'>-- Truly given, not depending on subgoals</span>
<a name="line-1592"></a>    <span class='hs-comment'>-- NB: Spontaneous unifications belong here</span>
<a name="line-1593"></a>
<a name="line-1594"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>     <span class='hs-comment'>-- See Note [Ct/evidence invariant]</span>
<a name="line-1595"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span>          <span class='hs-comment'>-- See Note [Evidence field of CtEvidence]</span>
<a name="line-1596"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-1597"></a>    <span class='hs-comment'>-- Wanted goal</span>
<a name="line-1598"></a>
<a name="line-1599"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span>
<a name="line-1600"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>}</span>
<a name="line-1601"></a>    <span class='hs-comment'>-- A goal that we don't really have to solve and can't immediately</span>
<a name="line-1602"></a>    <span class='hs-comment'>-- rewrite anything other than a derived (there's no evidence!)</span>
<a name="line-1603"></a>    <span class='hs-comment'>-- but if we do manage to solve it may help in solving other goals.</span>
<a name="line-1604"></a>
<a name="line-1605"></a><a name="ctEvPred"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span>
<a name="line-1606"></a><span class='hs-comment'>-- The predicate of a flavor</span>
<a name="line-1607"></a><span class='hs-definition'>ctEvPred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_pred</span>
<a name="line-1608"></a>
<a name="line-1609"></a><a name="ctEvLoc"></a><span class='hs-definition'>ctEvLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1610"></a><span class='hs-definition'>ctEvLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev_loc</span>
<a name="line-1611"></a>
<a name="line-1612"></a><a name="ctEvEqRel"></a><span class='hs-comment'>-- | Get the equality relation relevant for a 'CtEvidence'</span>
<a name="line-1613"></a><span class='hs-definition'>ctEvEqRel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span>
<a name="line-1614"></a><span class='hs-definition'>ctEvEqRel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>predTypeEqRel</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvPred</span>
<a name="line-1615"></a>
<a name="line-1616"></a><a name="ctEvRole"></a><span class='hs-comment'>-- | Get the role relevant for a 'CtEvidence'</span>
<a name="line-1617"></a><span class='hs-definition'>ctEvRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1618"></a><span class='hs-definition'>ctEvRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqRelRole</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvEqRel</span>
<a name="line-1619"></a>
<a name="line-1620"></a><a name="ctEvTerm"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-1621"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-1622"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>ev</span>
<a name="line-1623"></a><span class='hs-definition'>ctEvTerm</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvTerm: derived constraint cannot have id"</span>
<a name="line-1624"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-1625"></a>
<a name="line-1626"></a><a name="ctEvCoercion"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-1627"></a><span class='hs-comment'>-- ctEvCoercion ev = evTermCoercion (ctEvTerm ev)</span>
<a name="line-1628"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>tm</span>
<a name="line-1629"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>v</span>
<a name="line-1630"></a><span class='hs-definition'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvCoercion: derived constraint cannot have id"</span>
<a name="line-1631"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-1632"></a>
<a name="line-1633"></a><a name="ctEvId"></a><span class='hs-definition'>ctEvId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcId</span>
<a name="line-1634"></a><span class='hs-definition'>ctEvId</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-1635"></a><span class='hs-definition'>ctEvId</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ctEvId:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-1636"></a>
<a name="line-1637"></a><a name="instance%20Outputable%20CtEvidence"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyword'>where</span>
<a name="line-1638"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fl</span> <span class='hs-keyword'>of</span>
<a name="line-1639"></a>             <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[G]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_evtm</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-1640"></a>             <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[W]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev_evar</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-1641"></a>             <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[D]"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"_"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_pty</span>
<a name="line-1642"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>ppr_pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-1643"></a>
<a name="line-1644"></a><a name="isWanted"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1645"></a><span class='hs-definition'>isWanted</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1646"></a><span class='hs-definition'>isWanted</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1647"></a>
<a name="line-1648"></a><a name="isGiven"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1649"></a><span class='hs-definition'>isGiven</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1650"></a><span class='hs-definition'>isGiven</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1651"></a>
<a name="line-1652"></a><a name="isDerived"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1653"></a><span class='hs-definition'>isDerived</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1654"></a><span class='hs-definition'>isDerived</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1655"></a>
<a name="line-1656"></a><span class='hs-comment'>{-
<a name="line-1657"></a>%************************************************************************
<a name="line-1658"></a>%*                                                                      *
<a name="line-1659"></a>            CtFlavour
<a name="line-1660"></a>%*                                                                      *
<a name="line-1661"></a>%************************************************************************
<a name="line-1662"></a>
<a name="line-1663"></a>Just an enum type that tracks whether a constraint is wanted, derived,
<a name="line-1664"></a>or given, when we need to separate that info from the constraint itself.
<a name="line-1665"></a>
<a name="line-1666"></a>-}</span>
<a name="line-1667"></a>
<a name="line-1668"></a><a name="CtFlavour"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Wanted</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Derived</span>
<a name="line-1669"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-1670"></a>
<a name="line-1671"></a><a name="instance%20Outputable%20CtFlavour"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyword'>where</span>
<a name="line-1672"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Given</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[G]"</span>
<a name="line-1673"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Wanted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[W]"</span>
<a name="line-1674"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>Derived</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[D]"</span>
<a name="line-1675"></a>
<a name="line-1676"></a><a name="ctEvFlavour"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtFlavour</span>
<a name="line-1677"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Wanted</span>
<a name="line-1678"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Given</span>
<a name="line-1679"></a><span class='hs-definition'>ctEvFlavour</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Derived</span>
<a name="line-1680"></a>
<a name="line-1681"></a><span class='hs-comment'>{-
<a name="line-1682"></a>************************************************************************
<a name="line-1683"></a>*                                                                      *
<a name="line-1684"></a>            SubGoalDepth
<a name="line-1685"></a>*                                                                      *
<a name="line-1686"></a>************************************************************************
<a name="line-1687"></a>
<a name="line-1688"></a>Note [SubGoalDepth]
<a name="line-1689"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-1690"></a>The 'SubGoalCounter' takes care of stopping the constraint solver from looping.
<a name="line-1691"></a>Because of the different use-cases of regular constaints and type function
<a name="line-1692"></a>applications, there are two independent counters. Therefore, this datatype is
<a name="line-1693"></a>abstract. See Note [WorkList]
<a name="line-1694"></a>
<a name="line-1695"></a>Each counter starts at zero and increases.
<a name="line-1696"></a>
<a name="line-1697"></a>* The "dictionary constraint counter" counts the depth of type class
<a name="line-1698"></a>  instance declarations.  Example:
<a name="line-1699"></a>     [W] d{7} : Eq [Int]
<a name="line-1700"></a>  That is d's dictionary-constraint depth is 7.  If we use the instance
<a name="line-1701"></a>     $dfEqList :: Eq a =&gt; Eq [a]
<a name="line-1702"></a>  to simplify it, we get
<a name="line-1703"></a>     d{7} = $dfEqList d'{8}
<a name="line-1704"></a>  where d'{8} : Eq Int, and d' has dictionary-constraint depth 8.
<a name="line-1705"></a>
<a name="line-1706"></a>  For civilised (decidable) instance declarations, each increase of
<a name="line-1707"></a>  depth removes a type constructor from the type, so the depth never
<a name="line-1708"></a>  gets big; i.e. is bounded by the structural depth of the type.
<a name="line-1709"></a>
<a name="line-1710"></a>  The flag -fcontext-stack=n (not very well named!) fixes the maximium
<a name="line-1711"></a>  level.
<a name="line-1712"></a>
<a name="line-1713"></a>* The "type function reduction counter" does the same thing when resolving
<a name="line-1714"></a>* qualities involving type functions. Example:
<a name="line-1715"></a>  Assume we have a wanted at depth 7:
<a name="line-1716"></a>    [W] d{7} : F () ~ a
<a name="line-1717"></a>  If thre is an type function equation "F () = Int", this would be rewritten to
<a name="line-1718"></a>    [W] d{8} : Int ~ a
<a name="line-1719"></a>  and remembered as having depth 8.
<a name="line-1720"></a>
<a name="line-1721"></a>  Again, without UndecidableInstances, this counter is bounded, but without it
<a name="line-1722"></a>  can resolve things ad infinitum. Hence there is a maximum level. But we use a
<a name="line-1723"></a>  different maximum, as we expect possibly many more type function reductions
<a name="line-1724"></a>  in sensible programs than type class constraints.
<a name="line-1725"></a>
<a name="line-1726"></a>  The flag -ftype-function-depth=n fixes the maximium level.
<a name="line-1727"></a>-}</span>
<a name="line-1728"></a>
<a name="line-1729"></a><a name="SubGoalCounter"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CountTyFunApps</span>
<a name="line-1730"></a>
<a name="line-1731"></a><a name="SubGoalDepth"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SubGoalDepth</span>  <span class='hs-comment'>-- See Note [SubGoalDepth]</span>
<a name="line-1732"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-1733"></a>         <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>      <span class='hs-comment'>-- Dictionary constraints</span>
<a name="line-1734"></a>         <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>      <span class='hs-comment'>-- Type function reductions</span>
<a name="line-1735"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-1736"></a>
<a name="line-1737"></a><a name="instance%20Outputable%20SubGoalDepth"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyword'>where</span>
<a name="line-1738"></a> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>angleBrackets</span> <span class='hs-varop'>$</span>
<a name="line-1739"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'C'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-1740"></a>        <span class='hs-varid'>char</span> <span class='hs-chr'>'F'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>f</span>
<a name="line-1741"></a>
<a name="line-1742"></a><a name="initialSubGoalDepth"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-1743"></a><span class='hs-definition'>initialSubGoalDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<a name="line-1744"></a>
<a name="line-1745"></a><a name="maxSubGoalDepth"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-1746"></a><span class='hs-definition'>maxSubGoalDepth</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxtStkDepth</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyFunStkDepth</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1747"></a>
<a name="line-1748"></a><a name="bumpSubGoalDepth"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-1749"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-1750"></a><span class='hs-definition'>bumpSubGoalDepth</span> <span class='hs-conid'>CountTyFunApps</span>   <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1751"></a>
<a name="line-1752"></a><a name="subGoalCounterValue"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1753"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-conid'>CountConstraints</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-1754"></a><span class='hs-definition'>subGoalCounterValue</span> <span class='hs-conid'>CountTyFunApps</span>   <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-1755"></a>
<a name="line-1756"></a><a name="subGoalDepthExceeded"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SubGoalCounter</span>
<a name="line-1757"></a><span class='hs-definition'>subGoalDepthExceeded</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>mc</span> <span class='hs-varid'>mf</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-varid'>c</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-1758"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>CountConstraints</span>
<a name="line-1759"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>mf</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>CountTyFunApps</span>
<a name="line-1760"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1761"></a>
<a name="line-1762"></a><a name="ctEvCheckDepth"></a><span class='hs-comment'>-- | Checks whether the evidence can be used to solve a goal with the given minimum depth</span>
<a name="line-1763"></a><span class='hs-comment'>-- See Note [Preventing recursive dictionaries]</span>
<a name="line-1764"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1765"></a><span class='hs-definition'>ctEvCheckDepth</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>target</span> <span class='hs-varid'>ev</span>
<a name="line-1766"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWanted</span> <span class='hs-varid'>ev</span>
<a name="line-1767"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>==</span> <span class='hs-varid'>coercibleClass</span>  <span class='hs-comment'>-- The restriction applies only to Coercible</span>
<a name="line-1768"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocDepth</span> <span class='hs-varid'>target</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1769"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1770"></a>
<a name="line-1771"></a><span class='hs-comment'>{-
<a name="line-1772"></a>Note [Preventing recursive dictionaries]
<a name="line-1773"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1774"></a>NB: this will go away when we start treating Coercible as an equality.
<a name="line-1775"></a>
<a name="line-1776"></a>We have some classes where it is not very useful to build recursive
<a name="line-1777"></a>dictionaries (Coercible, at the moment). So we need the constraint solver to
<a name="line-1778"></a>prevent that. We conservatively ensure this property using the subgoal depth of
<a name="line-1779"></a>the constraints: When solving a Coercible constraint at depth d, we do not
<a name="line-1780"></a>consider evidence from a depth &lt;= d as suitable.
<a name="line-1781"></a>
<a name="line-1782"></a>Therefore we need to record the minimum depth allowed to solve a CtWanted. This
<a name="line-1783"></a>is done in the SubGoalDepth field of CtWanted. Most code now uses mkCtWanted,
<a name="line-1784"></a>which initializes it to initialSubGoalDepth (i.e. 0); but when requesting a
<a name="line-1785"></a>Coercible instance (requestCoercible in TcInteract), we bump the current depth
<a name="line-1786"></a>by one and use that.
<a name="line-1787"></a>
<a name="line-1788"></a>There are two spots where wanted contraints attempted to be solved
<a name="line-1789"></a>using existing constraints: lookupInertDict and lookupSolvedDict in
<a name="line-1790"></a>TcSMonad.  Both use ctEvCheckDepth to make the check. That function
<a name="line-1791"></a>ensures that a Given constraint can always be used to solve a goal
<a name="line-1792"></a>(i.e. they are at depth infinity, for our purposes)
<a name="line-1793"></a>
<a name="line-1794"></a>
<a name="line-1795"></a>************************************************************************
<a name="line-1796"></a>*                                                                      *
<a name="line-1797"></a>            CtLoc
<a name="line-1798"></a>*                                                                      *
<a name="line-1799"></a>************************************************************************
<a name="line-1800"></a>
<a name="line-1801"></a>The 'CtLoc' gives information about where a constraint came from.
<a name="line-1802"></a>This is important for decent error message reporting because
<a name="line-1803"></a>dictionaries don't appear in the original source code.
<a name="line-1804"></a>type will evolve...
<a name="line-1805"></a>-}</span>
<a name="line-1806"></a>
<a name="line-1807"></a><a name="CtLoc"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1808"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-1809"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>SubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-1810"></a>  <span class='hs-comment'>-- The TcLclEnv includes particularly</span>
<a name="line-1811"></a>  <span class='hs-comment'>--    source location:  tcl_loc   :: RealSrcSpan</span>
<a name="line-1812"></a>  <span class='hs-comment'>--    context:          tcl_ctxt  :: [ErrCtxt]</span>
<a name="line-1813"></a>  <span class='hs-comment'>--    binder stack:     tcl_bndrs :: [TcIdBinders]</span>
<a name="line-1814"></a>  <span class='hs-comment'>--    level:            tcl_tclvl :: TcLevel</span>
<a name="line-1815"></a>
<a name="line-1816"></a><a name="mkGivenLoc"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1817"></a><span class='hs-definition'>mkGivenLoc</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>env</span>
<a name="line-1818"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>skol_info</span>
<a name="line-1819"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tclvl</span> <span class='hs-layout'>}</span>
<a name="line-1820"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ctl_depth</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initialSubGoalDepth</span> <span class='hs-layout'>}</span>
<a name="line-1821"></a>
<a name="line-1822"></a><a name="ctLocEnv"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-1823"></a><span class='hs-definition'>ctLocEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_env</span>
<a name="line-1824"></a>
<a name="line-1825"></a><a name="ctLocDepth"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SubGoalDepth</span>
<a name="line-1826"></a><span class='hs-definition'>ctLocDepth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_depth</span>
<a name="line-1827"></a>
<a name="line-1828"></a><a name="ctLocOrigin"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1829"></a><span class='hs-definition'>ctLocOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl_origin</span>
<a name="line-1830"></a>
<a name="line-1831"></a><a name="ctLocSpan"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span>
<a name="line-1832"></a><span class='hs-definition'>ctLocSpan</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span>
<a name="line-1833"></a>
<a name="line-1834"></a><a name="setCtLocSpan"></a><span class='hs-definition'>setCtLocSpan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1835"></a><span class='hs-definition'>setCtLocSpan</span> <span class='hs-varid'>ctl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLocEnv</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1836"></a>
<a name="line-1837"></a><a name="bumpCtLocDepth"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SubGoalCounter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1838"></a><span class='hs-definition'>bumpCtLocDepth</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_depth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpSubGoalDepth</span> <span class='hs-varid'>cnt</span> <span class='hs-varid'>d</span> <span class='hs-layout'>}</span>
<a name="line-1839"></a>
<a name="line-1840"></a><a name="setCtLocOrigin"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1841"></a><span class='hs-definition'>setCtLocOrigin</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>}</span>
<a name="line-1842"></a>
<a name="line-1843"></a><a name="setCtLocEnv"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLclEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1844"></a><span class='hs-definition'>setCtLocEnv</span> <span class='hs-varid'>ctl</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>}</span>
<a name="line-1845"></a>
<a name="line-1846"></a><a name="pushErrCtxt"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1847"></a><span class='hs-definition'>pushErrCtxt</span> <span class='hs-varid'>o</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1848"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1849"></a>
<a name="line-1850"></a><a name="pushErrCtxtSameOrigin"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1851"></a><span class='hs-comment'>-- Just add information w/o updating the origin!</span>
<a name="line-1852"></a><span class='hs-definition'>pushErrCtxtSameOrigin</span> <span class='hs-varid'>err</span> <span class='hs-varid'>loc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1853"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tcl_ctxt</span> <span class='hs-varid'>lcl</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1854"></a>
<a name="line-1855"></a><a name="pprArising"></a><span class='hs-definition'>pprArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1856"></a><span class='hs-comment'>-- Used for the main, top-level error message</span>
<a name="line-1857"></a><span class='hs-comment'>-- We've done special processing for TypeEq and FunDep origins</span>
<a name="line-1858"></a><span class='hs-definition'>pprArising</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-1859"></a><span class='hs-definition'>pprArising</span> <span class='hs-varid'>orig</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>orig</span>
<a name="line-1860"></a>
<a name="line-1861"></a><a name="pprArisingAt"></a><span class='hs-definition'>pprArisingAt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1862"></a><span class='hs-definition'>pprArisingAt</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctl_origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctl_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1863"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-varid'>o</span>
<a name="line-1864"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_loc</span> <span class='hs-varid'>lcl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1865"></a>
<a name="line-1866"></a><span class='hs-comment'>{-
<a name="line-1867"></a>************************************************************************
<a name="line-1868"></a>*                                                                      *
<a name="line-1869"></a>                SkolemInfo
<a name="line-1870"></a>*                                                                      *
<a name="line-1871"></a>************************************************************************
<a name="line-1872"></a>-}</span>
<a name="line-1873"></a>
<a name="line-1874"></a><a name="SkolemInfo"></a><span class='hs-comment'>-- SkolemInfo gives the origin of *given* constraints</span>
<a name="line-1875"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   a) type variables are skolemised</span>
<a name="line-1876"></a><a name="SkolemInfo"></a><span class='hs-comment'>--   b) an implication constraint is generated</span>
<a name="line-1877"></a><a name="SkolemInfo"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-1878"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigSkol</span> <span class='hs-conid'>UserTypeCtxt</span>        <span class='hs-comment'>-- A skolem that is created by instantiating</span>
<a name="line-1879"></a>            <span class='hs-conid'>Type</span>                <span class='hs-comment'>-- a programmer-supplied type signature</span>
<a name="line-1880"></a>                                <span class='hs-comment'>-- Location of the binding site is on the TyVar</span>
<a name="line-1881"></a>
<a name="line-1882"></a>        <span class='hs-comment'>-- The rest are for non-scoped skolems</span>
<a name="line-1883"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClsSkol</span> <span class='hs-conid'>Class</span>       <span class='hs-comment'>-- Bound at a class decl</span>
<a name="line-1884"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstSkol</span>            <span class='hs-comment'>-- Bound at an instance decl</span>
<a name="line-1885"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataSkol</span>            <span class='hs-comment'>-- Bound at a data type declaration</span>
<a name="line-1886"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FamInstSkol</span>         <span class='hs-comment'>-- Bound at a family instance decl</span>
<a name="line-1887"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSkol</span>             <span class='hs-comment'>-- An existential type variable bound by a pattern for</span>
<a name="line-1888"></a>      <span class='hs-conid'>ConLike</span>           <span class='hs-comment'>-- a data constructor with an existential type.</span>
<a name="line-1889"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsMatchContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-1890"></a>             <span class='hs-comment'>-- e.g.   data T = forall a. Eq a =&gt; MkT a</span>
<a name="line-1891"></a>             <span class='hs-comment'>--        f (MkT x) = ...</span>
<a name="line-1892"></a>             <span class='hs-comment'>-- The pattern MkT x will allocate an existential type</span>
<a name="line-1893"></a>             <span class='hs-comment'>-- variable for 'a'.</span>
<a name="line-1894"></a>
<a name="line-1895"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArrowSkol</span>           <span class='hs-comment'>-- An arrow form (see TcArrows)</span>
<a name="line-1896"></a>
<a name="line-1897"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsIPName</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- Binding site of an implicit parameter</span>
<a name="line-1898"></a>
<a name="line-1899"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RuleSkol</span> <span class='hs-conid'>RuleName</span>   <span class='hs-comment'>-- The LHS of a RULE</span>
<a name="line-1900"></a>
<a name="line-1901"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InferSkol</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1902"></a>                        <span class='hs-comment'>-- We have inferred a type for these (mutually-recursivive)</span>
<a name="line-1903"></a>                        <span class='hs-comment'>-- polymorphic Ids, and are now checking that their RHS</span>
<a name="line-1904"></a>                        <span class='hs-comment'>-- constraints are satisfied.</span>
<a name="line-1905"></a>
<a name="line-1906"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span>         <span class='hs-comment'>-- Template Haskell bracket</span>
<a name="line-1907"></a>
<a name="line-1908"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnifyForAllSkol</span>     <span class='hs-comment'>-- We are unifying two for-all types</span>
<a name="line-1909"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- The instantiated skolem variables</span>
<a name="line-1910"></a>       <span class='hs-conid'>TcType</span>           <span class='hs-comment'>-- The instantiated type *inside* the forall</span>
<a name="line-1911"></a>
<a name="line-1912"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnkSkol</span>             <span class='hs-comment'>-- Unhelpful info (until I improve it)</span>
<a name="line-1913"></a>
<a name="line-1914"></a><a name="instance%20Outputable%20SkolemInfo"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyword'>where</span>
<a name="line-1915"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprSkolInfo</span>
<a name="line-1916"></a>
<a name="line-1917"></a><a name="pprSkolInfo"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1918"></a><span class='hs-comment'>-- Complete the sentence "is a rigid type variable bound by..."</span>
<a name="line-1919"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1920"></a>                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type signature for"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1921"></a>                                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1922"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigSkol</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>cx</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-1923"></a>                                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1924"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPSkol</span> <span class='hs-varid'>ips</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the implicit-parameter binding"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ips</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"for"</span><span class='hs-layout'>)</span>
<a name="line-1925"></a>                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ips</span>
<a name="line-1926"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClsSkol</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the class declaration for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span>
<a name="line-1927"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>InstSkol</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-1928"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>DataSkol</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the data type declaration"</span><span class='hs-layout'>)</span>
<a name="line-1929"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>FamInstSkol</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the family instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-1930"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>BracketSkol</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a Template Haskell bracket"</span><span class='hs-layout'>)</span>
<a name="line-1931"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>RuleSkol</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the RULE"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doubleQuotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ftext</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1932"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>ArrowSkol</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the arrow form"</span><span class='hs-layout'>)</span>
<a name="line-1933"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>mc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cl</span> <span class='hs-keyword'>of</span>
<a name="line-1934"></a>    <span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern with constructor"</span><span class='hs-layout'>)</span>
<a name="line-1935"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-1936"></a>                            <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConUserType</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1937"></a>                            <span class='hs-comment'>-- pprType prints forall's regardless of -fprint-explict-foralls</span>
<a name="line-1938"></a>                            <span class='hs-comment'>-- which is what we want here, since we might be saying</span>
<a name="line-1939"></a>                            <span class='hs-comment'>-- type variable 't' is bound by ...</span>
<a name="line-1940"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContext</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>]</span>
<a name="line-1941"></a>    <span class='hs-conid'>PatSynCon</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern with pattern synonym"</span><span class='hs-layout'>)</span>
<a name="line-1942"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span>
<a name="line-1943"></a>                          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>patSynType</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-1944"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprMatchContext</span> <span class='hs-varid'>mc</span> <span class='hs-keyglyph'>]</span>
<a name="line-1945"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InferSkol</span> <span class='hs-varid'>ids</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the inferred type of"</span><span class='hs-layout'>)</span>
<a name="line-1946"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-1947"></a>                                         <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1948"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1949"></a>
<a name="line-1950"></a><span class='hs-comment'>-- UnkSkol</span>
<a name="line-1951"></a><span class='hs-comment'>-- For type variables the others are dealt with by pprSkolTvBinding.</span>
<a name="line-1952"></a><span class='hs-comment'>-- For Insts, these cases should not happen</span>
<a name="line-1953"></a><span class='hs-definition'>pprSkolInfo</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"pprSkolInfo: UnkSkol"</span> <span class='hs-layout'>)</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"UnkSkol"</span><span class='hs-layout'>)</span>
<a name="line-1954"></a>
<a name="line-1955"></a><span class='hs-comment'>{-
<a name="line-1956"></a>************************************************************************
<a name="line-1957"></a>*                                                                      *
<a name="line-1958"></a>            CtOrigin
<a name="line-1959"></a>*                                                                      *
<a name="line-1960"></a>************************************************************************
<a name="line-1961"></a>-}</span>
<a name="line-1962"></a>
<a name="line-1963"></a><a name="CtOrigin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CtOrigin</span>
<a name="line-1964"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-1965"></a>
<a name="line-1966"></a>  <span class='hs-comment'>-- All the others are for *wanted* constraints</span>
<a name="line-1967"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-conid'>Name</span>           <span class='hs-comment'>-- Occurrence of an overloaded identifier</span>
<a name="line-1968"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppOrigin</span>                   <span class='hs-comment'>-- An application of some kind</span>
<a name="line-1969"></a>
<a name="line-1970"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SpecPragOrigin</span> <span class='hs-conid'>Name</span>         <span class='hs-comment'>-- Specialisation pragma for identifier</span>
<a name="line-1971"></a>
<a name="line-1972"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>
<a name="line-1973"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>}</span>
<a name="line-1974"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindEqOrigin</span>
<a name="line-1975"></a>      <span class='hs-conid'>TcType</span> <span class='hs-conid'>TcType</span>             <span class='hs-comment'>-- A kind equality arising from unifying these two types</span>
<a name="line-1976"></a>      <span class='hs-conid'>CtOrigin</span>                  <span class='hs-comment'>-- originally arising from this</span>
<a name="line-1977"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercibleOrigin</span> <span class='hs-conid'>TcType</span> <span class='hs-conid'>TcType</span>  <span class='hs-comment'>-- a Coercible constraint</span>
<a name="line-1978"></a>
<a name="line-1979"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IPOccOrigin</span>  <span class='hs-conid'>HsIPName</span>       <span class='hs-comment'>-- Occurrence of an implicit parameter</span>
<a name="line-1980"></a>
<a name="line-1981"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LiteralOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOverLit</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- Occurrence of a literal</span>
<a name="line-1982"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NegateOrigin</span>                        <span class='hs-comment'>-- Occurrence of syntactic negation</span>
<a name="line-1983"></a>
<a name="line-1984"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [x..], [x..y] etc</span>
<a name="line-1985"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PArrSeqOrigin</span>  <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqInfo</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- [:x..y:] and [:x,y..z:]</span>
<a name="line-1986"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SectionOrigin</span>
<a name="line-1987"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TupleOrigin</span>                        <span class='hs-comment'>-- (..,..)</span>
<a name="line-1988"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ExprSigOrigin</span>       <span class='hs-comment'>-- e :: ty</span>
<a name="line-1989"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatSigOrigin</span>        <span class='hs-comment'>-- p :: ty</span>
<a name="line-1990"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PatOrigin</span>           <span class='hs-comment'>-- Instantiating a polytyped pattern at a constructor</span>
<a name="line-1991"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecordUpdOrigin</span>
<a name="line-1992"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ViewPatOrigin</span>
<a name="line-1993"></a>
<a name="line-1994"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ScOrigin</span>            <span class='hs-comment'>-- Typechecking superclasses of an instance declaration</span>
<a name="line-1995"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOrigin</span>         <span class='hs-comment'>-- Typechecking deriving</span>
<a name="line-1996"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginDC</span> <span class='hs-conid'>DataCon</span> <span class='hs-conid'>Int</span>
<a name="line-1997"></a>                        <span class='hs-comment'>-- Checking constraints arising from this data con and field index</span>
<a name="line-1998"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-1999"></a>                        <span class='hs-comment'>-- DerivOriginCoerce id ty1 ty2: Trying to coerce class method `id` from</span>
<a name="line-2000"></a>                        <span class='hs-comment'>-- `ty1` to `ty2`.</span>
<a name="line-2001"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-comment'>-- Typechecking stand-alone deriving</span>
<a name="line-2002"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DefaultOrigin</span>       <span class='hs-comment'>-- Typechecking a default decl</span>
<a name="line-2003"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DoOrigin</span>            <span class='hs-comment'>-- Arising from a do expression</span>
<a name="line-2004"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MCompOrigin</span>         <span class='hs-comment'>-- Arising from a monad comprehension</span>
<a name="line-2005"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IfOrigin</span>            <span class='hs-comment'>-- Arising from an if statement</span>
<a name="line-2006"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProcOrigin</span>          <span class='hs-comment'>-- Arising from a proc expression</span>
<a name="line-2007"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnnOrigin</span>           <span class='hs-comment'>-- An annotation</span>
<a name="line-2008"></a>
<a name="line-2009"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunDepOrigin1</span>       <span class='hs-comment'>-- A functional dependency from combining</span>
<a name="line-2010"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtLoc</span>      <span class='hs-comment'>-- This constraint arising from ...</span>
<a name="line-2011"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtLoc</span>      <span class='hs-comment'>-- and this constraint arising from ...</span>
<a name="line-2012"></a>
<a name="line-2013"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunDepOrigin2</span>       <span class='hs-comment'>-- A functional dependency from combining</span>
<a name="line-2014"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>CtOrigin</span>   <span class='hs-comment'>-- This constraint arising from ...</span>
<a name="line-2015"></a>        <span class='hs-conid'>PredType</span> <span class='hs-conid'>SrcSpan</span>    <span class='hs-comment'>-- and this instance</span>
<a name="line-2016"></a>        <span class='hs-comment'>-- We only need a CtOrigin on the first, because the location</span>
<a name="line-2017"></a>        <span class='hs-comment'>-- is pinned on the entire error message</span>
<a name="line-2018"></a>
<a name="line-2019"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleOrigin</span>
<a name="line-2020"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-conid'>RdrName</span>
<a name="line-2021"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ListOrigin</span>          <span class='hs-comment'>-- An overloaded list</span>
<a name="line-2022"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StaticOrigin</span>        <span class='hs-comment'>-- A static form</span>
<a name="line-2023"></a>
<a name="line-2024"></a><a name="ctoHerald"></a><span class='hs-definition'>ctoHerald</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-2025"></a><span class='hs-definition'>ctoHerald</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"arising from"</span><span class='hs-layout'>)</span>
<a name="line-2026"></a>
<a name="line-2027"></a><a name="pprCtOrigin"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2028"></a>
<a name="line-2029"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>GivenOrigin</span> <span class='hs-varid'>sk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sk</span>
<a name="line-2030"></a>
<a name="line-2031"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin1</span> <span class='hs-varid'>pred1</span> <span class='hs-varid'>loc1</span> <span class='hs-varid'>pred2</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span>
<a name="line-2032"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a functional dependency between constraints:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2033"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-varid'>loc1</span><span class='hs-layout'>)</span>
<a name="line-2034"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2035"></a>
<a name="line-2036"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunDepOrigin2</span> <span class='hs-varid'>pred1</span> <span class='hs-varid'>orig1</span> <span class='hs-varid'>pred2</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span>
<a name="line-2037"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a functional dependency between:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2038"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"constraint"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2039"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig1</span> <span class='hs-layout'>)</span>
<a name="line-2040"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2041"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2042"></a>
<a name="line-2043"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-2044"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a kind equality arising from"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2045"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2046"></a>
<a name="line-2047"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnboundOccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-2048"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an undeclared identifier"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-2049"></a>
<a name="line-2050"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginDC</span> <span class='hs-varid'>dc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-2051"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>n</span>
<a name="line-2052"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"field of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2053"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2054"></a>  <span class='hs-keyword'>where</span>
<a name="line-2055"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConOrigArgTys</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-2056"></a>
<a name="line-2057"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivOriginCoerce</span> <span class='hs-varid'>meth</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2058"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the coercion of the method"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>meth</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2059"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"from type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-2060"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2061"></a>
<a name="line-2062"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercibleOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2063"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"trying to show that the representations of"</span><span class='hs-layout'>)</span>
<a name="line-2064"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"and"</span> <span class='hs-varop'>$$</span>
<a name="line-2065"></a>          <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"are the same"</span><span class='hs-layout'>)</span>
<a name="line-2066"></a>
<a name="line-2067"></a><span class='hs-definition'>pprCtOrigin</span> <span class='hs-varid'>simple_origin</span>
<a name="line-2068"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctoHerald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCtO</span> <span class='hs-varid'>simple_origin</span>
<a name="line-2069"></a>
<a name="line-2070"></a><a name="pprCtO"></a><span class='hs-comment'>----------------</span>
<a name="line-2071"></a><span class='hs-definition'>pprCtO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>  <span class='hs-comment'>-- Ones that are short one-liners</span>
<a name="line-2072"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>OccurrenceOf</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2073"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>AppOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an application"</span><span class='hs-layout'>)</span>
<a name="line-2074"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>SpecPragOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a specialisation pragma for"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2075"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IPOccOrigin</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of implicit parameter"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2076"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>RecordUpdOrigin</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a record update"</span><span class='hs-layout'>)</span>
<a name="line-2077"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ExprSigOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an expression type signature"</span><span class='hs-layout'>)</span>
<a name="line-2078"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>PatSigOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern type signature"</span><span class='hs-layout'>)</span>
<a name="line-2079"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>PatOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a pattern"</span><span class='hs-layout'>)</span>
<a name="line-2080"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ViewPatOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a view pattern"</span><span class='hs-layout'>)</span>
<a name="line-2081"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>IfOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an if statement"</span><span class='hs-layout'>)</span>
<a name="line-2082"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiteralOrigin</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the literal"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lit</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2083"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ArithSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the arithmetic sequence"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2084"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>PArrSeqOrigin</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the parallel array sequence"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>seq</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2085"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>SectionOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an operator section"</span><span class='hs-layout'>)</span>
<a name="line-2086"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>TupleOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a tuple"</span><span class='hs-layout'>)</span>
<a name="line-2087"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>NegateOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of syntactic negation"</span><span class='hs-layout'>)</span>
<a name="line-2088"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ScOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the superclasses of an instance declaration"</span><span class='hs-layout'>)</span>
<a name="line-2089"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DerivOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the 'deriving' clause of a data type declaration"</span><span class='hs-layout'>)</span>
<a name="line-2090"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>StandAloneDerivOrigin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a 'deriving' declaration"</span><span class='hs-layout'>)</span>
<a name="line-2091"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DefaultOrigin</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a 'default' declaration"</span><span class='hs-layout'>)</span>
<a name="line-2092"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>DoOrigin</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a do statement"</span><span class='hs-layout'>)</span>
<a name="line-2093"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>MCompOrigin</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a statement in a monad comprehension"</span><span class='hs-layout'>)</span>
<a name="line-2094"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ProcOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a proc expression"</span><span class='hs-layout'>)</span>
<a name="line-2095"></a><span class='hs-definition'>pprCtO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a type equality"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-2096"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>AnnOrigin</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an annotation"</span><span class='hs-layout'>)</span>
<a name="line-2097"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>HoleOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a use of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-2098"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>ListOrigin</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"an overloaded list"</span><span class='hs-layout'>)</span>
<a name="line-2099"></a><span class='hs-definition'>pprCtO</span> <span class='hs-conid'>StaticOrigin</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"a static form"</span><span class='hs-layout'>)</span>
<a name="line-2100"></a><span class='hs-definition'>pprCtO</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprCtOrigin"</span>
<a name="line-2101"></a>
<a name="line-2102"></a><span class='hs-comment'>{-
<a name="line-2103"></a>Constraint Solver Plugins
<a name="line-2104"></a>-------------------------
<a name="line-2105"></a>-}</span>
<a name="line-2106"></a>
<a name="line-2107"></a><a name="TcPluginSolver"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcPluginSolver</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- given</span>
<a name="line-2108"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- derived</span>
<a name="line-2109"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- wanted</span>
<a name="line-2110"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-2111"></a>
<a name="line-2112"></a><a name="TcPluginM"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2113"></a>
<a name="line-2114"></a><a name="instance%20Functor%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span>     <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-2115"></a>  <span class='hs-varid'>fmap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span>
<a name="line-2116"></a>
<a name="line-2117"></a><a name="instance%20Applicative%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-2118"></a>  <span class='hs-varid'>pure</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-2119"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-2120"></a>
<a name="line-2121"></a><a name="instance%20Monad%20TcPluginM"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-keyword'>where</span>
<a name="line-2122"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2123"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>x</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2124"></a>  <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span>
<a name="line-2125"></a>    <span class='hs-conid'>TcPluginM</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>m</span>
<a name="line-2126"></a>                  <span class='hs-keyword'>let</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span>
<a name="line-2127"></a>                  <span class='hs-varid'>m1</span><span class='hs-layout'>)</span>
<a name="line-2128"></a>
<a name="line-2129"></a><a name="runTcPluginM"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2130"></a><span class='hs-definition'>runTcPluginM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span>
<a name="line-2131"></a>
<a name="line-2132"></a><a name="unsafeTcPluginTcM"></a><span class='hs-comment'>-- | This function provides an escape for direct access to</span>
<a name="line-2133"></a><span class='hs-comment'>-- the 'TcM` monad.  It should not be used lightly, and</span>
<a name="line-2134"></a><span class='hs-comment'>-- the provided 'TcPluginM' API should be favoured instead.</span>
<a name="line-2135"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span>
<a name="line-2136"></a><span class='hs-definition'>unsafeTcPluginTcM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginM</span>
<a name="line-2137"></a>
<a name="line-2138"></a><a name="TcPlugin"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPlugin</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>s</span><span class='hs-varop'>.</span> <span class='hs-conid'>TcPlugin</span>
<a name="line-2139"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>tcPluginInit</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>s</span>
<a name="line-2140"></a>    <span class='hs-comment'>-- ^ Initialize plugin, when entering type-checker.</span>
<a name="line-2141"></a>
<a name="line-2142"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginSolver</span>
<a name="line-2143"></a>    <span class='hs-comment'>-- ^ Solve some constraints.</span>
<a name="line-2144"></a>    <span class='hs-comment'>-- TODO: WRITE MORE DETAILS ON HOW THIS WORKS.</span>
<a name="line-2145"></a>
<a name="line-2146"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tcPluginStop</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-conid'>()</span>
<a name="line-2147"></a>   <span class='hs-comment'>-- ^ Clean up after the plugin, when exiting the type-checker.</span>
<a name="line-2148"></a>  <span class='hs-layout'>}</span>
<a name="line-2149"></a>
<a name="line-2150"></a><a name="TcPluginResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcPluginResult</span>
<a name="line-2151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPluginContradiction</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2152"></a>    <span class='hs-comment'>-- ^ The plugin found a contradiction.</span>
<a name="line-2153"></a>    <span class='hs-comment'>-- The returned constraints are removed from the inert set,</span>
<a name="line-2154"></a>    <span class='hs-comment'>-- and recorded as insoluable.</span>
<a name="line-2155"></a>
<a name="line-2156"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPluginOk</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvTerm</span><span class='hs-layout'>,</span><span class='hs-conid'>Ct</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-2157"></a>    <span class='hs-comment'>-- ^ The first field is for constraints that were solved.</span>
<a name="line-2158"></a>    <span class='hs-comment'>-- These are removed from the inert set,</span>
<a name="line-2159"></a>    <span class='hs-comment'>-- and the evidence for them is recorded.</span>
<a name="line-2160"></a>    <span class='hs-comment'>-- The second field contains new work, that should be processed by</span>
<a name="line-2161"></a>    <span class='hs-comment'>-- the constraint solver.</span>
</pre></body>
</html>
