<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>rename/RnTypes.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-3"></a>
<a name="line-4"></a>\section[RnSource]{Main pass of renamer}
<a name="line-5"></a>-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>RnTypes</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>        <span class='hs-comment'>-- Type related stuff</span>
<a name="line-11"></a>        <span class='hs-varid'>rnHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnContext</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>rnHsKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsMaybeKind</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>rnHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnLHsInstType</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnConDeclFields</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-varid'>newTyVarNameRn</span><span class='hs-layout'>,</span>
<a name="line-15"></a>
<a name="line-16"></a>        <span class='hs-comment'>-- Precence related stuff</span>
<a name="line-17"></a>        <span class='hs-varid'>mkOpAppRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNegAppRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkOpFormRn</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkConOpPatRn</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>checkPrecMatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkSectionPrec</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>        <span class='hs-comment'>-- Binding related stuff</span>
<a name="line-21"></a>        <span class='hs-varid'>warnContextQuantification</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnUnusedForAlls</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>bindSigTyVarsFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindHsTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnHsBndrSig</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>extractHsTyRdrTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractHsTysRdrTyVars</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>extractRdrKindSigVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>extractDataDefnKindVars</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>extractWildcards</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterInScope</span>
<a name="line-26"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-27"></a>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>TcSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>runQuasiQuoteType</span> <span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>RnSplice</span><span class='hs-layout'>(</span> <span class='hs-varid'>rnSpliceType</span> <span class='hs-layout'>)</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HsSyn</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnHsDoc</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>rnLHsDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>rnMbLHsDoc</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TysPrim</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>funTyConName</span> <span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameSet</span>
<a name="line-42"></a>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>compareFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>funTyFixity</span><span class='hs-layout'>,</span> <span class='hs-varid'>negateFixity</span><span class='hs-layout'>,</span>
<a name="line-45"></a>                          <span class='hs-conid'>Fixity</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityDirection</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>nub</span><span class='hs-layout'>,</span> <span class='hs-varid'>nubBy</span> <span class='hs-layout'>)</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-comment'>{-
<a name="line-55"></a>These type renamers are in a separate module, rather than in (say) RnSource,
<a name="line-56"></a>to break several loop.
<a name="line-57"></a>
<a name="line-58"></a>*********************************************************
<a name="line-59"></a>*                                                      *
<a name="line-60"></a>\subsection{Renaming types}
<a name="line-61"></a>*                                                      *
<a name="line-62"></a>*********************************************************
<a name="line-63"></a>-}</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="rnHsSigType"></a><span class='hs-definition'>rnHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-66"></a>        <span class='hs-comment'>-- rnHsSigType is used for source-language type signatures,</span>
<a name="line-67"></a>        <span class='hs-comment'>-- which use *implicit* universal quantification.</span>
<a name="line-68"></a><span class='hs-definition'>rnHsSigType</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeSigCtx</span> <span class='hs-varid'>doc_str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="rnLHsInstType"></a><span class='hs-definition'>rnLHsInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-comment'>-- Rename the type in an instance or standalone deriving decl</span>
<a name="line-72"></a><span class='hs-definition'>rnLHsInstType</span> <span class='hs-varid'>doc_str</span> <span class='hs-varid'>ty</span>
<a name="line-73"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericCtx</span> <span class='hs-varid'>doc_str</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-74"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>good_inst_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErrAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>badInstTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-75"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-76"></a>  <span class='hs-keyword'>where</span>
<a name="line-77"></a>    <span class='hs-varid'>good_inst_ty</span>
<a name="line-78"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-79"></a>                        <span class='hs-varid'>splitLHsInstDeclTy_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenTopLevelLHsForAllTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-80"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isTcOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>rdrNameOcc</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-81"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-82"></a>
<a name="line-83"></a><a name="badInstTy"></a><span class='hs-definition'>badInstTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-84"></a><span class='hs-definition'>badInstTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Malformed instance:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-comment'>{-
<a name="line-87"></a>rnHsType is here because we call it from loadInstDecl, and I didn't
<a name="line-88"></a>want a gratuitous knot.
<a name="line-89"></a>
<a name="line-90"></a>Note [Context quantification]
<a name="line-91"></a>-----------------------------
<a name="line-92"></a>Variables in type signatures are implicitly quantified
<a name="line-93"></a>when (1) they are in a type signature not beginning
<a name="line-94"></a>with "forall" or (2) in any qualified type T =&gt; R.
<a name="line-95"></a>We are phasing out (2) since it leads to inconsistencies
<a name="line-96"></a>(Trac #4426):
<a name="line-97"></a>
<a name="line-98"></a>data A = A (a -&gt; a)           is an error
<a name="line-99"></a>data A = A (Eq a =&gt; a -&gt; a)   binds "a"
<a name="line-100"></a>data A = A (Eq a =&gt; a -&gt; b)   binds "a" and "b"
<a name="line-101"></a>data A = A (() =&gt; a -&gt; b)     binds "a" and "b"
<a name="line-102"></a>f :: forall a. a -&gt; b         is an error
<a name="line-103"></a>f :: forall a. () =&gt; a -&gt; b   is an error
<a name="line-104"></a>f :: forall a. a -&gt; (() =&gt; b) binds "a" and "b"
<a name="line-105"></a>
<a name="line-106"></a>The -fwarn-context-quantification flag warns about
<a name="line-107"></a>this situation. See rnHsTyKi for case HsForAllTy Qualified.
<a name="line-108"></a>-}</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="rnLHsTyKi"></a><span class='hs-definition'>rnLHsTyKi</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>--  True &lt;=&gt; renaming a type, False &lt;=&gt; a kind</span>
<a name="line-111"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-112"></a><span class='hs-definition'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-113"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-114"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-116"></a>
<a name="line-117"></a><a name="rnLHsType"></a><span class='hs-definition'>rnLHsType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-118"></a><span class='hs-definition'>rnLHsType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-conid'>True</span>
<a name="line-119"></a>
<a name="line-120"></a><a name="rnLHsKind"></a><span class='hs-definition'>rnLHsKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-121"></a><span class='hs-definition'>rnLHsKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-conid'>False</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="rnLHsMaybeKind"></a><span class='hs-definition'>rnLHsMaybeKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-124"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-definition'>rnLHsMaybeKind</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-definition'>rnLHsMaybeKind</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-128"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span>
<a name="line-129"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="rnHsType"></a><span class='hs-definition'>rnHsType</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-132"></a><span class='hs-definition'>rnHsType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-conid'>True</span>
<a name="line-133"></a><a name="rnHsKind"></a><span class='hs-definition'>rnHsKind</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsKind</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKind</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-definition'>rnHsKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-conid'>False</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="rnHsTyKi"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>HsForAllTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKiForAll</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>flattenTopLevelHsForAllTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-140"></a>
<a name="line-141"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTyVar</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>rdr_name</span>
<a name="line-143"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-144"></a>
<a name="line-145"></a><span class='hs-comment'>-- If we see (forall a . ty), without foralls on, the forall will give</span>
<a name="line-146"></a><span class='hs-comment'>-- a sensible error message, but we don't want to complain about the dot too</span>
<a name="line-147"></a><span class='hs-comment'>-- Hence the jiggery pokery with ty1</span>
<a name="line-148"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-150"></a>    <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ops_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_TypeOperators</span>
<a name="line-151"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>op'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ops_ok</span>
<a name="line-152"></a>                 <span class='hs-keyword'>then</span> <span class='hs-varid'>rnTyVar</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>op</span>
<a name="line-153"></a>                 <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>opTyErr</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-154"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnboundName</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- Avoid double complaint</span>
<a name="line-155"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>l_op'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>op'</span>
<a name="line-156"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>fix</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyFixityRn</span> <span class='hs-varid'>l_op'</span>
<a name="line-157"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-158"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-159"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>wrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>l_op'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                               <span class='hs-varid'>op'</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-161"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`addOneFV`</span> <span class='hs-varid'>op'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-166"></a>
<a name="line-167"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-169"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-170"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-171"></a>
<a name="line-172"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span><span class='hs-layout'>)</span>
<a name="line-173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Record syntax is illegal here:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-174"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-175"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnConDeclFields</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>flds</span>
<a name="line-176"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-180"></a>        <span class='hs-comment'>-- Might find a for-all as the arg of a function type</span>
<a name="line-181"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-182"></a>        <span class='hs-comment'>-- Or as the result.  This happens when reading Prelude.hi</span>
<a name="line-183"></a>        <span class='hs-comment'>-- when we find return :: forall m. Monad m -&gt; forall a. a -&gt; m a</span>
<a name="line-184"></a>
<a name="line-185"></a>        <span class='hs-comment'>-- Check for fixity rearrangements</span>
<a name="line-186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isType</span>
<a name="line-187"></a>                   <span class='hs-keyword'>then</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>funTyConName</span> <span class='hs-varid'>funTyFixity</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span>
<a name="line-188"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-189"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-190"></a>
<a name="line-191"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>listTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-193"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>listTy</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-194"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-195"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-196"></a>
<a name="line-197"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-199"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind_sigs_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_KindSignatures</span>
<a name="line-200"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>kind_sigs_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-201"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-202"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>k</span>
<a name="line-203"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-207"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-208"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-209"></a>
<a name="line-210"></a><span class='hs-comment'>-- Unboxed tuples are allowed to have poly-typed arguments.  These</span>
<a name="line-211"></a><span class='hs-comment'>-- sometimes crop up as a result of CPR worker-wrappering dictionaries.</span>
<a name="line-212"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tupleTy</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_con</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-213"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-214"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isType</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>tupleTy</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-215"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>tup_con</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-217"></a>
<a name="line-218"></a><span class='hs-comment'>-- Ensure that a type-level integer is nonnegative (#8306, #8412)</span>
<a name="line-219"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tyLit</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-220"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>tyLit</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-222"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>negLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-varid'>negLitErr</span><span class='hs-layout'>)</span>
<a name="line-223"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-224"></a>  <span class='hs-keyword'>where</span>
<a name="line-225"></a>    <span class='hs-varid'>negLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-226"></a>    <span class='hs-varid'>negLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>
<a name="line-227"></a>    <span class='hs-varid'>negLitErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal literal in type (type literals must not be negative):"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyLit</span>
<a name="line-228"></a>
<a name="line-229"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-231"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-232"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-233"></a>
<a name="line-234"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-236"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-237"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-238"></a>
<a name="line-239"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-241"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty1</span>
<a name="line-242"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty2</span>
<a name="line-243"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-244"></a>
<a name="line-245"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-246"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-247"></a>    <span class='hs-varid'>rnSpliceType</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>k</span>
<a name="line-248"></a>
<a name="line-249"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>haddock_doc</span><span class='hs-layout'>)</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-251"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-252"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>haddock_doc'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsDoc</span> <span class='hs-varid'>haddock_doc</span>
<a name="line-253"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>haddock_doc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-254"></a>
<a name="line-255"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-varid'>qq</span><span class='hs-layout'>)</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-257"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runQuasiQuoteType</span> <span class='hs-varid'>qq</span>
<a name="line-258"></a>         <span class='hs-comment'>-- Wrap the result of the quasi-quoter in parens so that we don't</span>
<a name="line-259"></a>         <span class='hs-comment'>-- lose the outermost location set by runQuasiQuote (#7918)</span>
<a name="line-260"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnHsType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-261"></a>
<a name="line-262"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-264"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCoreTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span>
<a name="line-265"></a>    <span class='hs-comment'>-- The emptyFVs probably isn't quite right</span>
<a name="line-266"></a>    <span class='hs-comment'>-- but I don't think it matters</span>
<a name="line-267"></a>
<a name="line-268"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWrapTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-269"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rnHsTyKi"</span>
<a name="line-270"></a>
<a name="line-271"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-273"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-274"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-275"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span>
<a name="line-276"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>k</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-277"></a>
<a name="line-278"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>kis</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-279"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-280"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_DataKinds</span>
<a name="line-281"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>data_kinds</span> <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataKindsErr</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-282"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span>
<a name="line-283"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>kis</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-284"></a>
<a name="line-285"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsWildcardTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"rnHsTyKi HsWildcardTy"</span>
<a name="line-286"></a>                            <span class='hs-comment'>-- Should be replaced by a HsNamedWildcardTy</span>
<a name="line-287"></a>
<a name="line-288"></a><span class='hs-definition'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-sel'>_doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-varid'>rdr_name</span><span class='hs-layout'>)</span>
<a name="line-289"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span>
<a name="line-290"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnTyVar</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>rdr_name</span>
<a name="line-291"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-292"></a>
<a name="line-293"></a><a name="rnHsTyKiForAll"></a><span class='hs-comment'>--------------</span>
<a name="line-294"></a><span class='hs-definition'>rnHsTyKiForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-295"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-296"></a><span class='hs-definition'>rnHsTyKiForAll</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Implicit</span> <span class='hs-varid'>extra</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lctxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-297"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-298"></a>        <span class='hs-comment'>-- Implicit quantifiction in source code (no kinds on tyvars)</span>
<a name="line-299"></a>        <span class='hs-comment'>-- Given the signature  C =&gt; T  we universally quantify</span>
<a name="line-300"></a>        <span class='hs-comment'>-- over FV(T) \ {in-scope-tyvars}</span>
<a name="line-301"></a>    <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-302"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-303"></a>    <span class='hs-keyword'>let</span>
<a name="line-304"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>forall_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>forall_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterInScope</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varop'>$</span>
<a name="line-305"></a>                                   <span class='hs-varid'>extractHsTysRdrTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-306"></a>           <span class='hs-comment'>-- In for-all types we don't bring in scope</span>
<a name="line-307"></a>           <span class='hs-comment'>-- kind variables mentioned in kind signatures</span>
<a name="line-308"></a>           <span class='hs-comment'>-- (Well, not yet anyway....)</span>
<a name="line-309"></a>           <span class='hs-comment'>--    f :: Int -&gt; T (a::k)    -- Not allowed</span>
<a name="line-310"></a>
<a name="line-311"></a>           <span class='hs-comment'>-- The filterInScope is to ensure that we don't quantify over</span>
<a name="line-312"></a>           <span class='hs-comment'>-- type variables that are in scope; when GlasgowExts is off,</span>
<a name="line-313"></a>           <span class='hs-comment'>-- there usually won't be any, except for class signatures:</span>
<a name="line-314"></a>           <span class='hs-comment'>--   class C a where { op :: a -&gt; a }</span>
<a name="line-315"></a>        <span class='hs-varid'>tyvar_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>userHsTyVarBndrs</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>forall_tvs</span>
<a name="line-316"></a>
<a name="line-317"></a>    <span class='hs-varid'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Implicit</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>forall_kvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsQTvs</span> <span class='hs-varid'>tyvar_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>lctxt</span> <span class='hs-varid'>ty</span>
<a name="line-318"></a>
<a name="line-319"></a><span class='hs-definition'>rnHsTyKiForAll</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span>
<a name="line-320"></a>               <span class='hs-varid'>fulltype</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Qualified</span> <span class='hs-varid'>extra</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>lctxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-321"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span>
<a name="line-322"></a>    <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-323"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-324"></a>    <span class='hs-keyword'>let</span>
<a name="line-325"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>forall_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>forall_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterInScope</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varop'>$</span>
<a name="line-326"></a>                                   <span class='hs-varid'>extractHsTysRdrTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-327"></a>        <span class='hs-varid'>tyvar_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>userHsTyVarBndrs</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>forall_tvs</span>
<a name="line-328"></a>        <span class='hs-varid'>in_type_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fulltype</span><span class='hs-layout'>)</span>
<a name="line-329"></a>
<a name="line-330"></a>    <span class='hs-comment'>-- See Note [Context quantification]</span>
<a name="line-331"></a>    <span class='hs-varid'>warnContextQuantification</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_type_doc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar_bndrs</span>
<a name="line-332"></a>    <span class='hs-varid'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Implicit</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>forall_kvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsQTvs</span> <span class='hs-varid'>tyvar_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varid'>lctxt</span> <span class='hs-varid'>ty</span>
<a name="line-333"></a>
<a name="line-334"></a><span class='hs-definition'>rnHsTyKiForAll</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span>
<a name="line-335"></a>               <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-conid'>Explicit</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>lctxt</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-336"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isType</span> <span class='hs-layout'>)</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>      <span class='hs-comment'>-- Explicit quantification.</span>
<a name="line-337"></a>         <span class='hs-comment'>-- Check that the forall'd tyvars are actually</span>
<a name="line-338"></a>         <span class='hs-comment'>-- mentioned in the type, and produce a warning if not</span>
<a name="line-339"></a>         <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mentioned</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTysRdrTyVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>tau</span><span class='hs-conop'>:</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-340"></a>             <span class='hs-varid'>in_type_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In the type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-341"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>warnUnusedForAlls</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_type_doc</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-342"></a>                           <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>mentioned</span>
<a name="line-343"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"rnHsTyKiForAll:Exlicit"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-344"></a>            <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>forall_tyvars</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lctxt</span><span class='hs-layout'>,</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-345"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Explicit</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>lctxt</span> <span class='hs-varid'>tau</span> <span class='hs-layout'>}</span>
<a name="line-346"></a>
<a name="line-347"></a><span class='hs-comment'>-- The following should never happen but keeps the completeness checker happy</span>
<a name="line-348"></a><span class='hs-definition'>rnHsTyKiForAll</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsTyKi</span> <span class='hs-varid'>isType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-349"></a><a name="rnTyVar"></a><span class='hs-comment'>--------------</span>
<a name="line-350"></a><span class='hs-definition'>rnTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>Name</span>
<a name="line-351"></a><span class='hs-definition'>rnTyVar</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>rdr_name</span>
<a name="line-352"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupTypeOccRn</span> <span class='hs-varid'>rdr_name</span>
<a name="line-353"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupKindOccRn</span> <span class='hs-varid'>rdr_name</span>
<a name="line-354"></a>
<a name="line-355"></a>
<a name="line-356"></a><a name="rnLHsTypes"></a><span class='hs-comment'>--------------</span>
<a name="line-357"></a><span class='hs-definition'>rnLHsTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-358"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-359"></a><span class='hs-definition'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-360"></a>
<a name="line-361"></a><a name="rnForAll"></a><span class='hs-definition'>rnForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExplicitFlag</span>
<a name="line-362"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SrcSpan</span>           <span class='hs-comment'>-- Location of an extra-constraints wildcard</span>
<a name="line-363"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- Kind variables</span>
<a name="line-364"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- Type variables</span>
<a name="line-365"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span>
<a name="line-366"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-367"></a>
<a name="line-368"></a><span class='hs-definition'>rnForAll</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-369"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsQTvBndrs</span> <span class='hs-varid'>forall_tyvars</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>extra</span>
<a name="line-370"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnHsType</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-371"></a>        <span class='hs-comment'>-- One reason for this case is that a type like Int#</span>
<a name="line-372"></a>        <span class='hs-comment'>-- starts off as (HsForAllTy Implicit Nothing [] Int), in case</span>
<a name="line-373"></a>        <span class='hs-comment'>-- there is some quantification.  Now that we have quantified</span>
<a name="line-374"></a>        <span class='hs-comment'>-- and discovered there are no type variables, it's nicer to turn</span>
<a name="line-375"></a>        <span class='hs-comment'>-- it into plain Int.  If it were Int# instead of Int, we'd actually</span>
<a name="line-376"></a>        <span class='hs-comment'>-- get an error, because the body of a genuine for-all is</span>
<a name="line-377"></a>        <span class='hs-comment'>-- of kind *.</span>
<a name="line-378"></a>
<a name="line-379"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-380"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindHsTyVars</span> <span class='hs-varid'>doc</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>forall_tyvars</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>new_tyvars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-381"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnContext</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ctxt</span>
<a name="line-382"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-383"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>new_tyvars</span> <span class='hs-varid'>new_ctxt</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-384"></a>        <span class='hs-comment'>-- Retain the same implicit/explicit flag as before</span>
<a name="line-385"></a>        <span class='hs-comment'>-- so that we can later print it correctly</span>
<a name="line-386"></a>
<a name="line-387"></a><a name="bindSigTyVarsFV"></a><span class='hs-comment'>---------------</span>
<a name="line-388"></a><span class='hs-definition'>bindSigTyVarsFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-389"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-390"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-391"></a><span class='hs-comment'>-- Used just before renaming the defn of a function</span>
<a name="line-392"></a><span class='hs-comment'>-- with a separate type signature, to bring its tyvars into scope</span>
<a name="line-393"></a><span class='hs-comment'>-- With no -XScopedTypeVariables, this is a no-op</span>
<a name="line-394"></a><span class='hs-definition'>bindSigTyVarsFV</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-395"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>scoped_tyvars</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ScopedTypeVariables</span>
<a name="line-396"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>scoped_tyvars</span> <span class='hs-keyword'>then</span>
<a name="line-397"></a>                <span class='hs-varid'>thing_inside</span>
<a name="line-398"></a>          <span class='hs-keyword'>else</span>
<a name="line-399"></a>                <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-400"></a>
<a name="line-401"></a><a name="bindHsTyVars"></a><span class='hs-comment'>---------------</span>
<a name="line-402"></a><span class='hs-definition'>bindHsTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span>
<a name="line-403"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>                 <span class='hs-comment'>-- Just _  =&gt; an associated type decl</span>
<a name="line-404"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>               <span class='hs-comment'>-- Kind variables from scope</span>
<a name="line-405"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span>   <span class='hs-comment'>-- Type variables</span>
<a name="line-406"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-407"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-408"></a><span class='hs-comment'>-- (a) Bring kind variables into scope</span>
<a name="line-409"></a><span class='hs-comment'>--     both (i)  passed in (kv_bndrs)</span>
<a name="line-410"></a><span class='hs-comment'>--     and  (ii) mentioned in the kinds of tv_bndrs</span>
<a name="line-411"></a><span class='hs-comment'>-- (b) Bring type variables into scope</span>
<a name="line-412"></a><span class='hs-definition'>bindHsTyVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>kv_bndrs</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-413"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-414"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsQTvBndrs</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-415"></a>             <span class='hs-varid'>kvs_from_tv_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span>
<a name="line-416"></a>                                 <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>kind</span>
<a name="line-417"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-418"></a>             <span class='hs-varid'>all_kvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_bndrs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>kvs_from_tv_bndrs</span><span class='hs-layout'>)</span>
<a name="line-419"></a>             <span class='hs-varid'>all_kvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-420"></a>
<a name="line-421"></a>             <span class='hs-varid'>overlap_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hsLTyVarName</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>]</span>
<a name="line-422"></a>                <span class='hs-comment'>-- These variables appear both as kind and type variables</span>
<a name="line-423"></a>                <span class='hs-comment'>-- in the same declaration; eg  type family  T (x :: *) (y :: x)</span>
<a name="line-424"></a>                <span class='hs-comment'>-- We disallow this: too confusing!</span>
<a name="line-425"></a>
<a name="line-426"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>poly_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_PolyKinds</span>
<a name="line-427"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>poly_kind</span> <span class='hs-varop'>||</span> <span class='hs-varid'>null</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>)</span>
<a name="line-428"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>badKindBndrs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-429"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>overlap_kvs</span><span class='hs-layout'>)</span>
<a name="line-430"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>addErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>overlappingKindVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>overlap_kvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-431"></a>
<a name="line-432"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newLocalBndrRn</span> <span class='hs-varop'>.</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs</span>
<a name="line-434"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>kv_names</span> <span class='hs-varop'>$</span>
<a name="line-435"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tv_names_w_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyVarLocNames</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-436"></a>
<a name="line-437"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-438"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-439"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-440"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyFVs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-441"></a>             <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>lv</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-442"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_KindSignatures</span>
<a name="line-443"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>sig_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>False</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-444"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-445"></a>                    <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kind'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsKind</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kind</span>
<a name="line-446"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>lv</span> <span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-447"></a>
<a name="line-448"></a>       <span class='hs-comment'>-- Check for duplicate or shadowed tyvar bindrs</span>
<a name="line-449"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkDupRdrNames</span> <span class='hs-varid'>tv_names_w_loc</span>
<a name="line-450"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span> <span class='hs-varid'>mb_assoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkShadowedRdrNames</span> <span class='hs-varid'>tv_names_w_loc</span><span class='hs-layout'>)</span>
<a name="line-451"></a>
<a name="line-452"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-varid'>rn_tv_bndr</span> <span class='hs-varid'>tvs</span>
<a name="line-453"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-454"></a>                        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-455"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>traceRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"bhtv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-456"></a>                                 <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kvs_from_tv_bndrs</span>
<a name="line-457"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-458"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rdrNameOcc</span><span class='hs-layout'>)</span> <span class='hs-varid'>all_kvs'</span>
<a name="line-459"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inner_rdr_env</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-460"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_bndrs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsq_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_names</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-461"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-462"></a>
<a name="line-463"></a><a name="newTyVarNameRn"></a><span class='hs-definition'>newTyVarNameRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>Name</span>
<a name="line-464"></a><span class='hs-definition'>newTyVarNameRn</span> <span class='hs-varid'>mb_assoc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span>
<a name="line-465"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_assoc</span>    <span class='hs-comment'>-- Use the same Name as the parent class decl</span>
<a name="line-466"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupLocalRdrEnv</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>rdr</span>
<a name="line-467"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n</span>
<a name="line-468"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-469"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newLocalBndrRn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>rdr</span><span class='hs-layout'>)</span>
<a name="line-470"></a>
<a name="line-471"></a><a name="rnHsBndrSig"></a><span class='hs-comment'>--------------------------------</span>
<a name="line-472"></a><span class='hs-definition'>rnHsBndrSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span>
<a name="line-473"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWithBndrs</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-474"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWithBndrs</span> <span class='hs-conid'>Name</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-475"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-476"></a><span class='hs-definition'>rnHsBndrSig</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing_inside</span>
<a name="line-477"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_ok</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>Opt_ScopedTypeVariables</span>
<a name="line-478"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>sig_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>badSigErr</span> <span class='hs-conid'>True</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-479"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extractHsTyRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-480"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>name_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-481"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalBndrsRn</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tv_bndrs</span>
<a name="line-482"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>name_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-483"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kv_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newLocalBndrsRn</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kv_bndrs</span>
<a name="line-484"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>kv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>name_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-485"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extractWildcards</span> <span class='hs-varid'>ty</span>
<a name="line-486"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>kv_names</span> <span class='hs-varop'>$</span>
<a name="line-487"></a>         <span class='hs-varid'>bindLocalNamesFV</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$</span>
<a name="line-488"></a>         <span class='hs-varid'>bindLocatedLocalsFV</span> <span class='hs-varid'>wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>wcs_new</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-489"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty''</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty'</span>
<a name="line-490"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWB</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswb_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty''</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_names</span><span class='hs-layout'>,</span>
<a name="line-491"></a>                                             <span class='hs-varid'>hswb_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_names</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswb_wcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wcs_new</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-492"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs1</span> <span class='hs-varop'>`plusFV`</span> <span class='hs-varid'>fvs2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-493"></a>
<a name="line-494"></a><a name="overlappingKindVars"></a><span class='hs-definition'>overlappingKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-495"></a><span class='hs-definition'>overlappingKindVars</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kvs</span>
<a name="line-496"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-497"></a>           <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"also used as type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span>
<a name="line-498"></a>           <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>kvs</span>
<a name="line-499"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-500"></a>
<a name="line-501"></a><a name="badKindBndrs"></a><span class='hs-definition'>badKindBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-502"></a><span class='hs-definition'>badKindBndrs</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>kvs</span>
<a name="line-503"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unexpected kind variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>kvs</span>
<a name="line-504"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>)</span>
<a name="line-505"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use PolyKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-506"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-507"></a>
<a name="line-508"></a><a name="badSigErr"></a><span class='hs-definition'>badSigErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-509"></a><span class='hs-definition'>badSigErr</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-510"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span>
<a name="line-511"></a>    <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span>
<a name="line-512"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"signature:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-513"></a>              <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-514"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>docOfHsDocContext</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-515"></a>  <span class='hs-keyword'>where</span>
<a name="line-516"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-517"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
<a name="line-518"></a>    <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"ScopedTypeVariables"</span><span class='hs-layout'>)</span>
<a name="line-519"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"KindSignatures"</span><span class='hs-layout'>)</span>
<a name="line-520"></a>
<a name="line-521"></a><a name="dataKindsErr"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-522"></a><span class='hs-definition'>dataKindsErr</span> <span class='hs-varid'>is_type</span> <span class='hs-varid'>thing</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-524"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Perhaps you intended to use DataKinds"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-525"></a>  <span class='hs-keyword'>where</span>
<a name="line-526"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_type</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-527"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
<a name="line-528"></a>
<a name="line-529"></a><span class='hs-comment'>{-
<a name="line-530"></a>*********************************************************
<a name="line-531"></a>*                                                      *
<a name="line-532"></a>\subsection{Contexts and predicates}
<a name="line-533"></a>*                                                      *
<a name="line-534"></a>*********************************************************
<a name="line-535"></a>-}</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="rnConDeclFields"></a><span class='hs-definition'>rnConDeclFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-538"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-539"></a><span class='hs-definition'>rnConDeclFields</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>fields</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapFvRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnField</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>fields</span>
<a name="line-540"></a>
<a name="line-541"></a><a name="rnField"></a><span class='hs-definition'>rnField</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>RdrName</span>
<a name="line-542"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConDeclField</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-543"></a><span class='hs-definition'>rnField</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>names</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>haddock_doc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-544"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_names</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>lookupLocatedTopBndrRn</span> <span class='hs-varid'>names</span>
<a name="line-545"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsType</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>ty</span>
<a name="line-546"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_haddock_doc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnMbLHsDoc</span> <span class='hs-varid'>haddock_doc</span>
<a name="line-547"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDeclField</span> <span class='hs-varid'>new_names</span> <span class='hs-varid'>new_ty</span> <span class='hs-varid'>new_haddock_doc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-548"></a>
<a name="line-549"></a><a name="rnContext"></a><span class='hs-definition'>rnContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDocContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>FreeVars</span><span class='hs-layout'>)</span>
<a name="line-550"></a><span class='hs-definition'>rnContext</span> <span class='hs-varid'>doc</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span>
<a name="line-551"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rnLHsTypes</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>cxt</span>
<a name="line-552"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-553"></a>
<a name="line-554"></a><span class='hs-comment'>{-
<a name="line-555"></a>************************************************************************
<a name="line-556"></a>*                                                                      *
<a name="line-557"></a>        Fixities and precedence parsing
<a name="line-558"></a>*                                                                      *
<a name="line-559"></a>************************************************************************
<a name="line-560"></a>
<a name="line-561"></a>@mkOpAppRn@ deals with operator fixities.  The argument expressions
<a name="line-562"></a>are assumed to be already correctly arranged.  It needs the fixities
<a name="line-563"></a>recorded in the OpApp nodes, because fixity info applies to the things
<a name="line-564"></a>the programmer actually wrote, so you can't find it out from the Name.
<a name="line-565"></a>
<a name="line-566"></a>Furthermore, the second argument is guaranteed not to be another
<a name="line-567"></a>operator application.  Why? Because the parser parses all
<a name="line-568"></a>operator appications left-associatively, EXCEPT negation, which
<a name="line-569"></a>we need to handle specially.
<a name="line-570"></a>Infix types are read in a *right-associative* way, so that
<a name="line-571"></a>        a `op` b `op` c
<a name="line-572"></a>is always read in as
<a name="line-573"></a>        a `op` (b `op` c)
<a name="line-574"></a>
<a name="line-575"></a>mkHsOpTyRn rearranges where necessary.  The two arguments
<a name="line-576"></a>have already been renamed and rearranged.  It's made rather tiresome
<a name="line-577"></a>by the presence of -&gt;, which is a separate syntactic construct.
<a name="line-578"></a>-}</span>
<a name="line-579"></a>
<a name="line-580"></a><a name="mkHsOpTyRn"></a><span class='hs-comment'>---------------</span>
<a name="line-581"></a><span class='hs-comment'>-- Building (ty1 `op1` (ty21 `op2` ty22))</span>
<a name="line-582"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-583"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>
<a name="line-584"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-585"></a>
<a name="line-586"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty21</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-587"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fix2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupTyFixityRn</span> <span class='hs-varid'>op2</span>
<a name="line-588"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-589"></a>                      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-590"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>}</span>
<a name="line-591"></a>
<a name="line-592"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-593"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>pp_op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-594"></a>                <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>funTyConName</span> <span class='hs-varid'>funTyFixity</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span>
<a name="line-595"></a>
<a name="line-596"></a><span class='hs-definition'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>              <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-597"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-598"></a>
<a name="line-599"></a><a name="mk_hs_op_ty"></a><span class='hs-comment'>---------------</span>
<a name="line-600"></a><span class='hs-definition'>mk_hs_op_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-601"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span>
<a name="line-602"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-603"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-604"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsType</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-605"></a><span class='hs-definition'>mk_hs_op_ty</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span>
<a name="line-606"></a>            <span class='hs-varid'>mk2</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span> <span class='hs-varid'>loc2</span>
<a name="line-607"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-608"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-609"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk1</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-610"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Rearrange to ((ty1 `op1` ty21) `op2` ty22)</span>
<a name="line-611"></a>                           <span class='hs-varid'>new_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHsOpTyRn</span> <span class='hs-varid'>mk1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty21</span>
<a name="line-612"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk2</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLoc</span> <span class='hs-varid'>new_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-613"></a>  <span class='hs-keyword'>where</span>
<a name="line-614"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-615"></a>
<a name="line-616"></a>
<a name="line-617"></a><a name="mkOpAppRn"></a><span class='hs-comment'>---------------------------</span>
<a name="line-618"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                       <span class='hs-comment'>-- Left operand; already rearranged</span>
<a name="line-619"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span>             <span class='hs-comment'>-- Operator and fixity</span>
<a name="line-620"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span>                       <span class='hs-comment'>-- Right operand (not an OpApp, but might</span>
<a name="line-621"></a>                                                <span class='hs-comment'>-- be a NegApp)</span>
<a name="line-622"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-623"></a>
<a name="line-624"></a><span class='hs-comment'>-- (e11 `op1` e12) `op2` e2</span>
<a name="line-625"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e11</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e12</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-626"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-627"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-628"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-629"></a>
<a name="line-630"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-631"></a>    <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>e12</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-632"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e11</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-633"></a>  <span class='hs-keyword'>where</span>
<a name="line-634"></a>    <span class='hs-varid'>loc'</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineLocs</span> <span class='hs-varid'>e12</span> <span class='hs-varid'>e2</span>
<a name="line-635"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-636"></a>
<a name="line-637"></a><span class='hs-comment'>---------------------------</span>
<a name="line-638"></a><span class='hs-comment'>--      (- neg_arg) `op` e2</span>
<a name="line-639"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-640"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-641"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>negateName</span><span class='hs-layout'>,</span><span class='hs-varid'>negateFixity</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-642"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-643"></a>
<a name="line-644"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span>
<a name="line-645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpAppRn</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>e2</span>
<a name="line-646"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc'</span> <span class='hs-varid'>new_e</span><span class='hs-layout'>)</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span>
<a name="line-647"></a>  <span class='hs-keyword'>where</span>
<a name="line-648"></a>    <span class='hs-varid'>loc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineLocs</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>e2</span>
<a name="line-649"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>negateFixity</span> <span class='hs-varid'>fix2</span>
<a name="line-650"></a>
<a name="line-651"></a><span class='hs-comment'>---------------------------</span>
<a name="line-652"></a><span class='hs-comment'>--      e1 `op` - neg_arg</span>
<a name="line-653"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-comment'>-- NegApp can occur on the right</span>
<a name="line-654"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>associate_right</span>                 <span class='hs-comment'>-- We *want* right association</span>
<a name="line-655"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>negateName</span><span class='hs-layout'>,</span> <span class='hs-varid'>negateFixity</span><span class='hs-layout'>)</span>
<a name="line-656"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op1</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-657"></a>  <span class='hs-keyword'>where</span>
<a name="line-658"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>negateFixity</span>
<a name="line-659"></a>
<a name="line-660"></a><span class='hs-comment'>---------------------------</span>
<a name="line-661"></a><span class='hs-comment'>--      Default case</span>
<a name="line-662"></a><span class='hs-definition'>mkOpAppRn</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>e2</span>                  <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-663"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>right_op_ok</span> <span class='hs-varid'>fix</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-664"></a>             <span class='hs-varid'>ppr</span> <span class='hs-varid'>e1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fix</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"---"</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e2</span>
<a name="line-665"></a>    <span class='hs-layout'>)</span>
<a name="line-666"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>e2</span><span class='hs-layout'>)</span>
<a name="line-667"></a>
<a name="line-668"></a><a name="get_op"></a><span class='hs-comment'>----------------------------</span>
<a name="line-669"></a><span class='hs-definition'>get_op</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-670"></a><span class='hs-definition'>get_op</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsVar</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-671"></a><span class='hs-definition'>get_op</span> <span class='hs-varid'>other</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"get_op"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>other</span><span class='hs-layout'>)</span>
<a name="line-672"></a>
<a name="line-673"></a><a name="right_op_ok"></a><span class='hs-comment'>-- Parser left-associates everything, but</span>
<a name="line-674"></a><span class='hs-comment'>-- derived instances may have correctly-associated things to</span>
<a name="line-675"></a><span class='hs-comment'>-- in the right operarand.  So we just check that the right operand is OK</span>
<a name="line-676"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-677"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-varid'>fix1</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>fix2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-678"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>error_please</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>associate_right</span>
<a name="line-679"></a>  <span class='hs-keyword'>where</span>
<a name="line-680"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>error_please</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-681"></a><span class='hs-definition'>right_op_ok</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-683"></a>
<a name="line-684"></a><a name="mkNegAppRn"></a><span class='hs-comment'>-- Parser initially makes negation bind more tightly than any other operator</span>
<a name="line-685"></a><span class='hs-comment'>-- And "deriving" code should respect this (use HsPar if not)</span>
<a name="line-686"></a><span class='hs-definition'>mkNegAppRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SyntaxExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-687"></a><span class='hs-definition'>mkNegAppRn</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span>
<a name="line-688"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not_op_app</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>neg_arg</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-689"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>NegApp</span> <span class='hs-varid'>neg_arg</span> <span class='hs-varid'>neg_name</span><span class='hs-layout'>)</span>
<a name="line-690"></a>
<a name="line-691"></a><a name="not_op_app"></a><span class='hs-definition'>not_op_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsExpr</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-692"></a><span class='hs-definition'>not_op_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-693"></a><span class='hs-definition'>not_op_app</span> <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-694"></a>
<a name="line-695"></a><a name="mkOpFormRn"></a><span class='hs-comment'>---------------------------</span>
<a name="line-696"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span>            <span class='hs-comment'>-- Left operand; already rearranged</span>
<a name="line-697"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span>     <span class='hs-comment'>-- Operator and fixity</span>
<a name="line-698"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsCmdTop</span> <span class='hs-conid'>Name</span>             <span class='hs-comment'>-- Right operand (not an infix)</span>
<a name="line-699"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmd</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-700"></a>
<a name="line-701"></a><span class='hs-comment'>-- (e11 `op1` e12) `op2` e2</span>
<a name="line-702"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span><span class='hs-varid'>a12</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-703"></a>        <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>a2</span>
<a name="line-704"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nofix_error</span>
<a name="line-705"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-706"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-707"></a>
<a name="line-708"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>associate_right</span>
<a name="line-709"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>new_c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkOpFormRn</span> <span class='hs-varid'>a12</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>a2</span>
<a name="line-710"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix1</span><span class='hs-layout'>)</span>
<a name="line-711"></a>               <span class='hs-keyglyph'>[</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdTop</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_c</span><span class='hs-layout'>)</span>
<a name="line-712"></a>               <span class='hs-varid'>placeHolderType</span> <span class='hs-varid'>placeHolderType</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-713"></a>        <span class='hs-comment'>-- TODO: locs are wrong</span>
<a name="line-714"></a>  <span class='hs-keyword'>where</span>
<a name="line-715"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-716"></a>
<a name="line-717"></a><span class='hs-comment'>--      Default case</span>
<a name="line-718"></a><span class='hs-definition'>mkOpFormRn</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-varid'>arg2</span>                     <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-719"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCmdArrForm</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fix</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-720"></a>
<a name="line-721"></a>
<a name="line-722"></a><a name="mkConOpPatRn"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-723"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Located</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Fixity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LPat</span> <span class='hs-conid'>Name</span>
<a name="line-724"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-725"></a>
<a name="line-726"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>p1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p11</span> <span class='hs-varid'>p12</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>p2</span>
<a name="line-727"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>fix1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>)</span>
<a name="line-728"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>nofix_error</span><span class='hs-layout'>,</span> <span class='hs-varid'>associate_right</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compareFixity</span> <span class='hs-varid'>fix1</span> <span class='hs-varid'>fix2</span>
<a name="line-729"></a>
<a name="line-730"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>nofix_error</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-731"></a>                <span class='hs-layout'>{</span> <span class='hs-varid'>precParseErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span><span class='hs-varid'>fix1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span><span class='hs-varid'>fix2</span><span class='hs-layout'>)</span>
<a name="line-732"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-733"></a>
<a name="line-734"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>associate_right</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-735"></a>                <span class='hs-layout'>{</span> <span class='hs-varid'>new_p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkConOpPatRn</span> <span class='hs-varid'>op2</span> <span class='hs-varid'>fix2</span> <span class='hs-varid'>p12</span> <span class='hs-varid'>p2</span>
<a name="line-736"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p11</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- XXX loc right?</span>
<a name="line-737"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op2</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-738"></a>
<a name="line-739"></a><span class='hs-definition'>mkConOpPatRn</span> <span class='hs-varid'>op</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span>                         <span class='hs-comment'>-- Default case, no rearrangment</span>
<a name="line-740"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not_op_pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-741"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-varid'>p1</span> <span class='hs-varid'>p2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="not_op_pat"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-744"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-745"></a><span class='hs-definition'>not_op_pat</span> <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-746"></a>
<a name="line-747"></a><a name="checkPrecMatch"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-748"></a><span class='hs-definition'>checkPrecMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MatchGroup</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>body</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-749"></a>  <span class='hs-comment'>-- Check precedence of a function binding written infix</span>
<a name="line-750"></a>  <span class='hs-comment'>--   eg  a `op` b `C` c = ...</span>
<a name="line-751"></a>  <span class='hs-comment'>-- See comments with rnExpr (OpApp ...) about "deriving"</span>
<a name="line-752"></a>
<a name="line-753"></a><span class='hs-definition'>checkPrecMatch</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>MG</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mg_alts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-754"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check</span> <span class='hs-varid'>ms</span>
<a name="line-755"></a>  <span class='hs-keyword'>where</span>
<a name="line-756"></a>    <span class='hs-varid'>check</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Match</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>p1</span> <span class='hs-conop'>:</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l2</span> <span class='hs-varid'>p2</span> <span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-757"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineSrcSpans</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-758"></a>        <span class='hs-keyword'>do</span> <span class='hs-varid'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-varid'>p1</span> <span class='hs-conid'>False</span>
<a name="line-759"></a>           <span class='hs-varid'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-varid'>p2</span> <span class='hs-conid'>True</span>
<a name="line-760"></a>
<a name="line-761"></a>    <span class='hs-varid'>check</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-762"></a>        <span class='hs-comment'>-- This can happen.  Consider</span>
<a name="line-763"></a>        <span class='hs-comment'>--      a `op` True = ...</span>
<a name="line-764"></a>        <span class='hs-comment'>--      op          = ...</span>
<a name="line-765"></a>        <span class='hs-comment'>-- The infix flag comes from the first binding of the group</span>
<a name="line-766"></a>        <span class='hs-comment'>-- but the second eqn has no args (an error, but not discovered</span>
<a name="line-767"></a>        <span class='hs-comment'>-- until the type checker).  So we don't want to crash on the</span>
<a name="line-768"></a>        <span class='hs-comment'>-- second eqn.</span>
<a name="line-769"></a>
<a name="line-770"></a><a name="checkPrec"></a><span class='hs-definition'>checkPrec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pat</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Env</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-conid'>TcLclEnv</span><span class='hs-layout'>)</span> <span class='hs-conid'>()</span>
<a name="line-771"></a><span class='hs-definition'>checkPrec</span> <span class='hs-varid'>op</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConPatIn</span> <span class='hs-varid'>op1</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfixCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>right</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-772"></a>    <span class='hs-varid'>op_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op_prec</span>  <span class='hs-varid'>op_dir</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op</span>
<a name="line-773"></a>    <span class='hs-varid'>op1_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op1_prec</span> <span class='hs-varid'>op1_dir</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>)</span>
<a name="line-774"></a>    <span class='hs-keyword'>let</span>
<a name="line-775"></a>        <span class='hs-varid'>inf_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>op1_prec</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>op_prec</span> <span class='hs-varop'>||</span>
<a name="line-776"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>op1_prec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>op_prec</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-777"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>op1_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>op_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>right</span> <span class='hs-varop'>||</span>
<a name="line-778"></a>                   <span class='hs-varid'>op1_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixL</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>op_dir</span> <span class='hs-varop'>==</span> <span class='hs-conid'>InfixL</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>right</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-779"></a>
<a name="line-780"></a>        <span class='hs-varid'>info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span>        <span class='hs-varid'>op_fix</span><span class='hs-layout'>)</span>
<a name="line-781"></a>        <span class='hs-varid'>info1</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>op1_fix</span><span class='hs-layout'>)</span>
<a name="line-782"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>infol</span><span class='hs-layout'>,</span> <span class='hs-varid'>infor</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>right</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>info1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>info1</span><span class='hs-layout'>,</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span>
<a name="line-783"></a>    <span class='hs-varid'>unless</span> <span class='hs-varid'>inf_ok</span> <span class='hs-layout'>(</span><span class='hs-varid'>precParseErr</span> <span class='hs-varid'>infol</span> <span class='hs-varid'>infor</span><span class='hs-layout'>)</span>
<a name="line-784"></a>
<a name="line-785"></a><span class='hs-definition'>checkPrec</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-786"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-787"></a>
<a name="line-788"></a><a name="checkSectionPrec"></a><span class='hs-comment'>-- Check precedence of (arg op) or (op arg) respectively</span>
<a name="line-789"></a><span class='hs-comment'>-- If arg is itself an operator application, then either</span>
<a name="line-790"></a><span class='hs-comment'>--   (a) its precedence must be higher than that of op</span>
<a name="line-791"></a><span class='hs-comment'>--   (b) its precedency &amp; associativity must be the same as that of op</span>
<a name="line-792"></a><span class='hs-definition'>checkSectionPrec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FixityDirection</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span>
<a name="line-793"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-794"></a><span class='hs-definition'>checkSectionPrec</span> <span class='hs-varid'>direction</span> <span class='hs-varid'>section</span> <span class='hs-varid'>op</span> <span class='hs-varid'>arg</span>
<a name="line-795"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>arg</span> <span class='hs-keyword'>of</span>
<a name="line-796"></a>        <span class='hs-conid'>OpApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span> <span class='hs-varid'>fix</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_op</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>fix</span>
<a name="line-797"></a>        <span class='hs-conid'>NegApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go_for_it</span> <span class='hs-varid'>negateName</span>  <span class='hs-varid'>negateFixity</span>
<a name="line-798"></a>        <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-799"></a>  <span class='hs-keyword'>where</span>
<a name="line-800"></a>    <span class='hs-varid'>op_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>get_op</span> <span class='hs-varid'>op</span>
<a name="line-801"></a>    <span class='hs-varid'>go_for_it</span> <span class='hs-varid'>arg_op</span> <span class='hs-varid'>arg_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>arg_prec</span> <span class='hs-varid'>assoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-802"></a>          <span class='hs-varid'>op_fix</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span> <span class='hs-varid'>op_prec</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupFixityRn</span> <span class='hs-varid'>op_name</span>
<a name="line-803"></a>          <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_prec</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>arg_prec</span>
<a name="line-804"></a>                  <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_prec</span> <span class='hs-varop'>==</span> <span class='hs-varid'>arg_prec</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>direction</span> <span class='hs-varop'>==</span> <span class='hs-varid'>assoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-805"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>sectionPrecErr</span> <span class='hs-layout'>(</span><span class='hs-varid'>op_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_fix</span><span class='hs-layout'>)</span>
<a name="line-806"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>arg_op</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_fix</span><span class='hs-layout'>)</span> <span class='hs-varid'>section</span><span class='hs-layout'>)</span>
<a name="line-807"></a>
<a name="line-808"></a><span class='hs-comment'>-- Precedence-related error messages</span>
<a name="line-809"></a>
<a name="line-810"></a><a name="precParseErr"></a><span class='hs-definition'>precParseErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-811"></a><span class='hs-definition'>precParseErr</span> <span class='hs-varid'>op1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>op2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n2</span>
<a name="line-813"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Avoid error cascade</span>
<a name="line-814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-815"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Precedence parsing error"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-816"></a>      <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"cannot mix"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"and"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-817"></a>               <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op2</span><span class='hs-layout'>,</span>
<a name="line-818"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the same infix expression"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-819"></a>
<a name="line-820"></a><a name="sectionPrecErr"></a><span class='hs-definition'>sectionPrecErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsExpr</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-conid'>()</span>
<a name="line-821"></a><span class='hs-definition'>sectionPrecErr</span> <span class='hs-varid'>op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n1</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n2</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>section</span>
<a name="line-822"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isUnboundName</span> <span class='hs-varid'>n2</span>
<a name="line-823"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- Avoid error cascade</span>
<a name="line-824"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-825"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The operator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>op</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"of a section"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-826"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"must have lower precedence than that of the operand,"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-827"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"namely"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_opfix</span> <span class='hs-varid'>arg_op</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-828"></a>         <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in the section:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>section</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-829"></a>
<a name="line-830"></a><a name="ppr_opfix"></a><span class='hs-definition'>ppr_opfix</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-831"></a><span class='hs-definition'>ppr_opfix</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span><span class='hs-layout'>,</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pp_op</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fixity</span><span class='hs-layout'>)</span>
<a name="line-832"></a>   <span class='hs-keyword'>where</span>
<a name="line-833"></a>     <span class='hs-varid'>pp_op</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>==</span> <span class='hs-varid'>negateName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"prefix `-'"</span><span class='hs-layout'>)</span>
<a name="line-834"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-835"></a>
<a name="line-836"></a><span class='hs-comment'>{-
<a name="line-837"></a>*********************************************************
<a name="line-838"></a>*                                                      *
<a name="line-839"></a>\subsection{Errors}
<a name="line-840"></a>*                                                      *
<a name="line-841"></a>*********************************************************
<a name="line-842"></a>-}</span>
<a name="line-843"></a>
<a name="line-844"></a><a name="warnUnusedForAlls"></a><span class='hs-definition'>warnUnusedForAlls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-845"></a><span class='hs-definition'>warnUnusedForAlls</span> <span class='hs-varid'>in_doc</span> <span class='hs-varid'>bound</span> <span class='hs-varid'>mentioned_rdrs</span>
<a name="line-846"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnUnusedMatches</span> <span class='hs-varop'>$</span>
<a name="line-847"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-varid'>add_warn</span> <span class='hs-varid'>bound_but_not_used</span>
<a name="line-848"></a>  <span class='hs-keyword'>where</span>
<a name="line-849"></a>    <span class='hs-varid'>bound_names</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsLTyVarLocNames</span> <span class='hs-varid'>bound</span>
<a name="line-850"></a>    <span class='hs-varid'>bound_but_not_used</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>mentioned_rdrs</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>bound_names</span>
<a name="line-851"></a>
<a name="line-852"></a>    <span class='hs-varid'>add_warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-853"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-854"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unused quantified type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-855"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>in_doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-856"></a>
<a name="line-857"></a><a name="warnContextQuantification"></a><span class='hs-definition'>warnContextQuantification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-858"></a><span class='hs-definition'>warnContextQuantification</span> <span class='hs-varid'>in_doc</span> <span class='hs-varid'>tvs</span>
<a name="line-859"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>whenWOptM</span> <span class='hs-conid'>Opt_WarnContextQuantification</span> <span class='hs-varop'>$</span>
<a name="line-860"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-varid'>add_warn</span> <span class='hs-varid'>tvs</span>
<a name="line-861"></a>  <span class='hs-keyword'>where</span>
<a name="line-862"></a>    <span class='hs-varid'>add_warn</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-863"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addWarnAt</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-864"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-865"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is implicitly quantified due to a context"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-866"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use explicit forall syntax instead."</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-867"></a>               <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"This will become an error in GHC 7.12."</span><span class='hs-layout'>)</span>
<a name="line-868"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>in_doc</span> <span class='hs-keyglyph'>]</span>
<a name="line-869"></a>
<a name="line-870"></a><a name="opTyErr"></a><span class='hs-definition'>opTyErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-871"></a><span class='hs-definition'>opTyErr</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-872"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Illegal operator"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-873"></a>         <span class='hs-num'>2</span> <span class='hs-varid'>extra</span>
<a name="line-874"></a>  <span class='hs-keyword'>where</span>
<a name="line-875"></a>    <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>==</span> <span class='hs-varid'>dot_tv_RDR</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>forall_head</span> <span class='hs-varid'>ty1</span>
<a name="line-876"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>perhapsForallMsg</span>
<a name="line-877"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-878"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use TypeOperators to allow operators in types"</span><span class='hs-layout'>)</span>
<a name="line-879"></a>
<a name="line-880"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>forall_tv_RDR</span>
<a name="line-881"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>forall_head</span> <span class='hs-varid'>ty</span>
<a name="line-882"></a>    <span class='hs-varid'>forall_head</span> <span class='hs-sel'>_other</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-883"></a><span class='hs-definition'>opTyErr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"opTyErr: Not an op"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-884"></a>
<a name="line-885"></a><span class='hs-comment'>{-
<a name="line-886"></a>************************************************************************
<a name="line-887"></a>*                                                                      *
<a name="line-888"></a>      Finding the free type variables of a (HsType RdrName)
<a name="line-889"></a>*                                                                    *
<a name="line-890"></a>************************************************************************
<a name="line-891"></a>
<a name="line-892"></a>
<a name="line-893"></a>Note [Kind and type-variable binders]
<a name="line-894"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-895"></a>In a type signature we may implicitly bind type varaible and, more
<a name="line-896"></a>recently, kind variables.  For example:
<a name="line-897"></a>  *   f :: a -&gt; a
<a name="line-898"></a>      f = ...
<a name="line-899"></a>    Here we need to find the free type variables of (a -&gt; a),
<a name="line-900"></a>    so that we know what to quantify
<a name="line-901"></a>
<a name="line-902"></a>  *   class C (a :: k) where ...
<a name="line-903"></a>    This binds 'k' in ..., as well as 'a'
<a name="line-904"></a>
<a name="line-905"></a>  *   f (x :: a -&gt; [a]) = ....
<a name="line-906"></a>    Here we bind 'a' in ....
<a name="line-907"></a>
<a name="line-908"></a>  *   f (x :: T a -&gt; T (b :: k)) = ...
<a name="line-909"></a>    Here we bind both 'a' and the kind variable 'k'
<a name="line-910"></a>
<a name="line-911"></a>  *   type instance F (T (a :: Maybe k)) = ...a...k...
<a name="line-912"></a>    Here we want to constrain the kind of 'a', and bind 'k'.
<a name="line-913"></a>
<a name="line-914"></a>In general we want to walk over a type, and find
<a name="line-915"></a>  * Its free type variables
<a name="line-916"></a>  * The free kind variables of any kind signatures in the type
<a name="line-917"></a>
<a name="line-918"></a>Hence we returns a pair (kind-vars, type vars)
<a name="line-919"></a>See also Note [HsBSig binder lists] in HsTypes
<a name="line-920"></a>-}</span>
<a name="line-921"></a>
<a name="line-922"></a><a name="FreeKiTyVars"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-923"></a>
<a name="line-924"></a><a name="filterInScope"></a><span class='hs-definition'>filterInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LocalRdrEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-925"></a><span class='hs-definition'>filterInScope</span> <span class='hs-varid'>rdr_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-926"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-927"></a>  <span class='hs-keyword'>where</span>
<a name="line-928"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemLocalRdrEnv`</span> <span class='hs-varid'>rdr_env</span>
<a name="line-929"></a>
<a name="line-930"></a><a name="extractHsTyRdrTyVars"></a><span class='hs-definition'>extractHsTyRdrTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-931"></a><span class='hs-comment'>-- extractHsTyRdrNames finds the free (kind, type) variables of a HsType</span>
<a name="line-932"></a><span class='hs-comment'>--                        or the free (sort, kind) variables of a HsKind</span>
<a name="line-933"></a><span class='hs-comment'>-- It's used when making the for-alls explicit.</span>
<a name="line-934"></a><span class='hs-comment'>-- See Note [Kind and type-variable binders]</span>
<a name="line-935"></a><span class='hs-definition'>extractHsTyRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-936"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-937"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-938"></a>
<a name="line-939"></a><a name="extractHsTysRdrTyVars"></a><span class='hs-definition'>extractHsTysRdrTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-940"></a><span class='hs-comment'>-- See Note [Kind and type-variable binders]</span>
<a name="line-941"></a><span class='hs-definition'>extractHsTysRdrTyVars</span> <span class='hs-varid'>ty</span>
<a name="line-942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-943"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>nub</span> <span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-944"></a>
<a name="line-945"></a><a name="extractRdrKindSigVars"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-946"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-947"></a><span class='hs-definition'>extractRdrKindSigVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-948"></a>
<a name="line-949"></a><a name="extractDataDefnKindVars"></a><span class='hs-definition'>extractDataDefnKindVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsDataDefn</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span>
<a name="line-950"></a><span class='hs-comment'>-- Get the scoped kind variables mentioned free in the constructor decls</span>
<a name="line-951"></a><span class='hs-comment'>-- Eg    data T a = T1 (S (a :: k) | forall (b::k). T2 (S b)</span>
<a name="line-952"></a><span class='hs-comment'>-- Here k should scope over the whole definition</span>
<a name="line-953"></a><span class='hs-definition'>extractDataDefnKindVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDataDefn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dd_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>dd_kindSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ksig</span>
<a name="line-954"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>dd_cons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cons</span><span class='hs-layout'>,</span> <span class='hs-varid'>dd_derivs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derivs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-955"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-956"></a>          <span class='hs-varid'>extract_mb</span> <span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>ksig</span> <span class='hs-varop'>$</span>
<a name="line-957"></a>          <span class='hs-varid'>extract_mb</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_ltys</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>derivs</span> <span class='hs-varop'>$</span>
<a name="line-958"></a>          <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_con</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>cons</span>
<a name="line-959"></a>  <span class='hs-keyword'>where</span>
<a name="line-960"></a>    <span class='hs-varid'>extract_con</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyGADT</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-961"></a>    <span class='hs-varid'>extract_con</span> <span class='hs-layout'>(</span><span class='hs-conid'>ConDecl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>con_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ResTyH98</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_qvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qvs</span>
<a name="line-962"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>con_cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>con_details</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>details</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-963"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extract_hs_tv_bndrs</span> <span class='hs-varid'>qvs</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>$</span>
<a name="line-964"></a>        <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span>
<a name="line-965"></a>        <span class='hs-varid'>extract_ltys</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsConDeclArgTys</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-966"></a>
<a name="line-967"></a>
<a name="line-968"></a><a name="extract_lctxt"></a><span class='hs-definition'>extract_lctxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsContext</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-969"></a><span class='hs-definition'>extract_lctxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-970"></a>
<a name="line-971"></a><a name="extract_ltys"></a><span class='hs-definition'>extract_ltys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-972"></a><span class='hs-definition'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>tys</span>
<a name="line-973"></a>
<a name="line-974"></a><a name="extract_mb"></a><span class='hs-definition'>extract_mb</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-975"></a><span class='hs-definition'>extract_mb</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-976"></a><span class='hs-definition'>extract_mb</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varid'>acc</span>
<a name="line-977"></a>
<a name="line-978"></a><a name="extract_lkind"></a><span class='hs-definition'>extract_lkind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-979"></a><span class='hs-definition'>extract_lkind</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-980"></a>                                          <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>
<a name="line-981"></a>                                        <span class='hs-comment'>-- Kinds shouldn't have sort signatures!</span>
<a name="line-982"></a>
<a name="line-983"></a><a name="extract_lty"></a><span class='hs-definition'>extract_lty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-984"></a><span class='hs-definition'>extract_lty</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-985"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-986"></a>      <span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>tv</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>acc</span>
<a name="line-987"></a>      <span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-988"></a>      <span class='hs-conid'>HsRecTy</span> <span class='hs-varid'>flds</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varop'>.</span> <span class='hs-varid'>cd_fld_type</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-989"></a>                                         <span class='hs-varid'>flds</span>
<a name="line-990"></a>      <span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-991"></a>      <span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-992"></a>      <span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-993"></a>      <span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-994"></a>      <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-995"></a>      <span class='hs-conid'>HsIParamTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-996"></a>      <span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-997"></a>      <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-998"></a>      <span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-999"></a>      <span class='hs-conid'>HsCoreTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- The type is closed</span>
<a name="line-1000"></a>      <span class='hs-conid'>HsQuasiQuoteTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- Quasi quotes mention no type variables</span>
<a name="line-1001"></a>      <span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>  <span class='hs-comment'>-- Type splices mention no type variables</span>
<a name="line-1002"></a>      <span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>acc</span>
<a name="line-1003"></a>      <span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-1004"></a>      <span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_ltys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>acc</span>
<a name="line-1005"></a>      <span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>
<a name="line-1006"></a>      <span class='hs-conid'>HsWrapTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"extract_lty"</span>
<a name="line-1007"></a>      <span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ki</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>extract_lkind</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1008"></a>      <span class='hs-conid'>HsForAllTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cx</span> <span class='hs-varid'>ty</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extract_hs_tv_bndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>acc</span> <span class='hs-varop'>$</span>
<a name="line-1009"></a>                                   <span class='hs-varid'>extract_lctxt</span> <span class='hs-varid'>cx</span>   <span class='hs-varop'>$</span>
<a name="line-1010"></a>                                   <span class='hs-varid'>extract_lty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1011"></a>      <span class='hs-comment'>-- We deal with these to in a later stage, because they need to be</span>
<a name="line-1012"></a>      <span class='hs-comment'>-- replaced by fresh HsTyVars.</span>
<a name="line-1013"></a>      <span class='hs-conid'>HsWildcardTy</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>
<a name="line-1014"></a>      <span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc</span>
<a name="line-1015"></a>
<a name="line-1016"></a><a name="extract_hs_tv_bndrs"></a><span class='hs-definition'>extract_hs_tv_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsTyVarBndrs</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-1017"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-1018"></a><span class='hs-definition'>extract_hs_tv_bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1019"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Note accumulator comes first</span>
<a name="line-1020"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>body_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_tvs</span><span class='hs-layout'>)</span>
<a name="line-1021"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tvs</span>
<a name="line-1022"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>body_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_tvs</span><span class='hs-layout'>)</span>
<a name="line-1023"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1024"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>local_kvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_kvs</span><span class='hs-layout'>,</span>
<a name="line-1025"></a>     <span class='hs-varid'>acc_tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-varid'>local_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_tvs</span><span class='hs-layout'>)</span>
<a name="line-1026"></a>  <span class='hs-keyword'>where</span>
<a name="line-1027"></a>    <span class='hs-varid'>local_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>hsLTyVarName</span> <span class='hs-varid'>tvs</span>
<a name="line-1028"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_kvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extract_lty</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tvs</span><span class='hs-keyglyph'>]</span>
<a name="line-1029"></a>       <span class='hs-comment'>-- These kind variables are bound here if not bound further out</span>
<a name="line-1030"></a>
<a name="line-1031"></a><a name="extract_tv"></a><span class='hs-definition'>extract_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FreeKiTyVars</span>
<a name="line-1032"></a><span class='hs-definition'>extract_tv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>acc</span>
<a name="line-1033"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isRdrTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>kvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1034"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1035"></a>
<a name="line-1036"></a><a name="extractWildcards"></a><span class='hs-comment'>-- | Replace all unnamed wildcards in the given type with named wildcards.</span>
<a name="line-1037"></a><span class='hs-comment'>-- These names are freshly generated, based on "_". Return a tuple of the</span>
<a name="line-1038"></a><span class='hs-comment'>-- named wildcards that weren't already in scope (amongst them the named</span>
<a name="line-1039"></a><span class='hs-comment'>-- wildcards the unnamed ones were converted into), and the type in which the</span>
<a name="line-1040"></a><span class='hs-comment'>-- unnamed wildcards are replaced by named wildcards.</span>
<a name="line-1041"></a><span class='hs-definition'>extractWildcards</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RnM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Located</span> <span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-1042"></a><span class='hs-definition'>extractWildcards</span> <span class='hs-varid'>ty</span>
<a name="line-1043"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-1044"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-1045"></a>       <span class='hs-comment'>-- Filter out named wildcards that are already in scope</span>
<a name="line-1046"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nwcs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nubBy</span> <span class='hs-varid'>eqLocated</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-layout'>(</span><span class='hs-varid'>elemLocalRdrEnv</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unLoc</span><span class='hs-layout'>)</span> <span class='hs-varid'>rdr_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>nwcs</span>
<a name="line-1047"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1048"></a>  <span class='hs-keyword'>where</span>
<a name="line-1049"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>orig</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1050"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>locCxt</span> <span class='hs-varid'>cxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1051"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cxt'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extList</span> <span class='hs-varid'>cxt</span>
<a name="line-1052"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>nwcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-1053"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nwcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>awcs2</span><span class='hs-layout'>,</span>
<a name="line-1054"></a>                   <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>extra</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>locCxt</span> <span class='hs-varid'>cxt'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1055"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go2</span> <span class='hs-conid'>HsAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1056"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go2</span> <span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1057"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-conid'>HsListTy</span> <span class='hs-varid'>ty</span>
<a name="line-1058"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-conid'>HsPArrTy</span> <span class='hs-varid'>ty</span>
<a name="line-1059"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>con</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>goList</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1060"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go2</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOpTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>op</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1061"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-conid'>HsParTy</span> <span class='hs-varid'>ty</span>
<a name="line-1062"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1063"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go2</span> <span class='hs-conid'>HsEqTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1064"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go2</span> <span class='hs-conid'>HsKindSig</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>
<a name="line-1065"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-conid'>HsDocTy</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1066"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1067"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>ptk</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>goList</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-varid'>ptk</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1068"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>ptk</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>goList</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-varid'>ptk</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1069"></a>      <span class='hs-conid'>HsWildcardTy</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1070"></a>        <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-1071"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarOcc</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span> <span class='hs-varid'>l</span>
<a name="line-1072"></a>            <span class='hs-varid'>rdrName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameRdrName</span> <span class='hs-varid'>name</span>
<a name="line-1073"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>rdrName</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-varid'>rdrName</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsNamedWildcardTy</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-1075"></a>      <span class='hs-comment'>-- HsQuasiQuoteTy, HsSpliceTy, HsRecTy, HsCoreTy, HsTyLit, HsWrapTy</span>
<a name="line-1076"></a>      <span class='hs-keyword'>_</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-1077"></a>      <span class='hs-keyword'>where</span>
<a name="line-1078"></a>        <span class='hs-varid'>go1</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t</span>
<a name="line-1079"></a>                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span>
<a name="line-1080"></a>        <span class='hs-varid'>go2</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span>
<a name="line-1081"></a>          <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t1</span>
<a name="line-1082"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>nwcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>t2</span>
<a name="line-1083"></a>             <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nwcs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs1</span> <span class='hs-varop'>++</span> <span class='hs-varid'>awcs2</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-varid'>f</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2'</span><span class='hs-layout'>)</span>
<a name="line-1084"></a>        <span class='hs-varid'>extList</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>rec_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>go</span> <span class='hs-varid'>l</span>
<a name="line-1085"></a>                       <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1086"></a>                             <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcss</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcss</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1087"></a>                                     <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nwcss</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>awcss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>                                   <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>rec_res</span>
<a name="line-1089"></a>                       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-1090"></a>        <span class='hs-varid'>goList</span> <span class='hs-varid'>f</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extList</span> <span class='hs-varid'>tys</span>
<a name="line-1091"></a>                          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>nwcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>awcs</span><span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>l</span> <span class='hs-varop'>$</span> <span class='hs-varid'>f</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
</pre></body>
</html>
