<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/Coercion.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The University of Glasgow 2006</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable #-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>-- | Module for (a) type kinds and (b) type coercions,</span>
<a name="line-6"></a><span class='hs-comment'>-- as used in System FC. See 'CoreSyn.Expr' for</span>
<a name="line-7"></a><span class='hs-comment'>-- more on System FC and how coercions fit into it.</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Coercion</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>        <span class='hs-comment'>-- * Main data type</span>
<a name="line-11"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltRole</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>        <span class='hs-comment'>-- ** Functions over coercions</span>
<a name="line-16"></a>        <span class='hs-varid'>coVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-varid'>coercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflCo</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>isReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKindRole</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-varid'>mkCoercionType</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>        <span class='hs-comment'>-- ** Constructing coercions</span>
<a name="line-22"></a>        <span class='hs-varid'>mkReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCo</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>mkAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>mkUnbranchedAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>mkPiCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoCast</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>mkSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCoRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLRCo</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>mkInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCoFlexible</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCo</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>mkForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnsafeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnivCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-varid'>mkNewTypeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>downgradeRole</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>mkAxiomRuleCo</span><span class='hs-layout'>,</span>
<a name="line-31"></a>
<a name="line-32"></a>        <span class='hs-comment'>-- ** Decomposition</span>
<a name="line-33"></a>        <span class='hs-varid'>instNewTyCon_maybe</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-conid'>NormaliseStepper</span><span class='hs-layout'>,</span> <span class='hs-conid'>NormaliseStepResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeSteppers</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>modifyStepResultCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapNewTypeStepper</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>topNormaliseNewType_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>topNormaliseTypeX_maybe</span><span class='hs-layout'>,</span>
<a name="line-38"></a>
<a name="line-39"></a>        <span class='hs-varid'>decomposeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>splitAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>splitForAllCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>nthRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesX</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>setNominalRole_maybe</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>        <span class='hs-comment'>-- ** Coercion variables</span>
<a name="line-46"></a>        <span class='hs-varid'>mkCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVarType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarUnique</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- ** Free variables</span>
<a name="line-49"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span>
<a name="line-50"></a>
<a name="line-51"></a>        <span class='hs-comment'>-- ** Substitution</span>
<a name="line-52"></a>        <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-conid'>CvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>isEmptyCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCvInScope</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>substCoWithTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithTys</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>cvTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipOpenCvSubst</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>extendCvSubstAndInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- ** Lifting</span>
<a name="line-63"></a>        <span class='hs-varid'>liftCoMatch</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWith</span><span class='hs-layout'>,</span>
<a name="line-64"></a>
<a name="line-65"></a>        <span class='hs-comment'>-- ** Comparison</span>
<a name="line-66"></a>        <span class='hs-varid'>coreEqCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>coreEqCoercion2</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- ** Forcing evaluation of coercions</span>
<a name="line-69"></a>        <span class='hs-varid'>seqCo</span><span class='hs-layout'>,</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-72"></a>        <span class='hs-varid'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>pprCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranchHdr</span><span class='hs-layout'>,</span>
<a name="line-74"></a>
<a name="line-75"></a>        <span class='hs-comment'>-- * Tidying</span>
<a name="line-76"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-77"></a>
<a name="line-78"></a>        <span class='hs-comment'>-- * Other</span>
<a name="line-79"></a>        <span class='hs-varid'>applyCo</span><span class='hs-layout'>,</span>
<a name="line-80"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>MatchEnv</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Type</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>hiding</span><span class='hs-layout'>(</span> <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Binary</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span> <span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>     <span class='hs-layout'>(</span> <span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>NamedThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameUnique</span><span class='hs-layout'>,</span> <span class='hs-varid'>nameModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>OccName</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqPrimTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqReprPrimTyConKey</span> <span class='hs-layout'>)</span>
<a name="line-104"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 709</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span><span class='hs-layout'>,</span> <span class='hs-varid'>sequenceA</span><span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-cpp'>#endif</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ListSetOps</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span> <span class='hs-varid'>first</span> <span class='hs-layout'>)</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-comment'>{-
<a name="line-115"></a>************************************************************************
<a name="line-116"></a>*                                                                      *
<a name="line-117"></a>            Coercions
<a name="line-118"></a>*                                                                      *
<a name="line-119"></a>************************************************************************
<a name="line-120"></a>-}</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-comment'>-- | A 'Coercion' is concrete evidence of the equality/convertibility</span>
<a name="line-123"></a><span class='hs-comment'>-- of two types.</span>
<a name="line-124"></a>
<a name="line-125"></a><a name="Coercion"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-126"></a><a name="Coercion"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-127"></a><a name="Coercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Coercion</span>
<a name="line-128"></a>  <span class='hs-comment'>-- Each constructor has a "role signature", indicating the way roles are</span>
<a name="line-129"></a>  <span class='hs-comment'>-- propagated through coercions. P, N, and R stand for coercions of the</span>
<a name="line-130"></a>  <span class='hs-comment'>-- given role. e stands for a coercion of a specific unknown role (think</span>
<a name="line-131"></a>  <span class='hs-comment'>-- "role polymorphism"). "e" stands for an explicit role parameter</span>
<a name="line-132"></a>  <span class='hs-comment'>-- indicating role e. _ stands for a parameter that is not a Role or</span>
<a name="line-133"></a>  <span class='hs-comment'>-- Coercion.</span>
<a name="line-134"></a>
<a name="line-135"></a>  <span class='hs-comment'>-- These ones mirror the shape of types</span>
<a name="line-136"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Refl :: "e" -&gt; _ -&gt; e</span>
<a name="line-137"></a>    <span class='hs-conid'>Refl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-138"></a>          <span class='hs-comment'>-- Invariant: applications of (Refl T) to a bunch of identity coercions</span>
<a name="line-139"></a>          <span class='hs-comment'>--            always show up as Refl.</span>
<a name="line-140"></a>          <span class='hs-comment'>-- For example  (Refl T) (Refl a) (Refl b) shows up as (Refl (T a b)).</span>
<a name="line-141"></a>
<a name="line-142"></a>          <span class='hs-comment'>-- Applications of (Refl T) to some coercions, at least one of</span>
<a name="line-143"></a>          <span class='hs-comment'>-- which is NOT the identity, show up as TyConAppCo.</span>
<a name="line-144"></a>          <span class='hs-comment'>-- (They may not be fully saturated however.)</span>
<a name="line-145"></a>          <span class='hs-comment'>-- ConAppCo coercions (like all coercions other than Refl)</span>
<a name="line-146"></a>          <span class='hs-comment'>-- are NEVER the identity.</span>
<a name="line-147"></a>
<a name="line-148"></a>          <span class='hs-comment'>-- Use (Refl Representational _), not (SubCo (Refl Nominal _))</span>
<a name="line-149"></a>
<a name="line-150"></a>  <span class='hs-comment'>-- These ones simply lift the correspondingly-named</span>
<a name="line-151"></a>  <span class='hs-comment'>-- Type constructors into Coercions</span>
<a name="line-152"></a>
<a name="line-153"></a>  <span class='hs-comment'>-- TyConAppCo :: "e" -&gt; _ -&gt; ?? -&gt; e</span>
<a name="line-154"></a>  <span class='hs-comment'>-- See Note [TyConAppCo roles]</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- lift TyConApp</span>
<a name="line-156"></a>               <span class='hs-comment'>-- The TyCon is never a synonym;</span>
<a name="line-157"></a>               <span class='hs-comment'>-- we expand synonyms eagerly</span>
<a name="line-158"></a>               <span class='hs-comment'>-- But it can be a type function</span>
<a name="line-159"></a>
<a name="line-160"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>        <span class='hs-comment'>-- lift AppTy</span>
<a name="line-161"></a>          <span class='hs-comment'>-- AppCo :: e -&gt; N -&gt; e</span>
<a name="line-162"></a>
<a name="line-163"></a>  <span class='hs-comment'>-- See Note [Forall coercions]</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- forall a. g</span>
<a name="line-165"></a>         <span class='hs-comment'>-- :: _ -&gt; e -&gt; e</span>
<a name="line-166"></a>
<a name="line-167"></a>  <span class='hs-comment'>-- These are special</span>
<a name="line-168"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-conid'>CoVar</span>      <span class='hs-comment'>-- :: _ -&gt; (N or R)</span>
<a name="line-169"></a>                       <span class='hs-comment'>-- result role depends on the tycon of the variable's type</span>
<a name="line-170"></a>
<a name="line-171"></a>    <span class='hs-comment'>-- AxiomInstCo :: e -&gt; _ -&gt; [N] -&gt; e</span>
<a name="line-172"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-173"></a>     <span class='hs-comment'>-- See also [CoAxiom index]</span>
<a name="line-174"></a>     <span class='hs-comment'>-- The coercion arguments always *precisely* saturate</span>
<a name="line-175"></a>     <span class='hs-comment'>-- arity of (that branch of) the CoAxiom.  If there are</span>
<a name="line-176"></a>     <span class='hs-comment'>-- any left over, we use AppCo.  See</span>
<a name="line-177"></a>     <span class='hs-comment'>-- See [Coercion axioms applied to coercions]</span>
<a name="line-178"></a>
<a name="line-179"></a>         <span class='hs-comment'>-- see Note [UnivCo]</span>
<a name="line-180"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>FastString</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- :: "e" -&gt; _ -&gt; _ -&gt; e</span>
<a name="line-181"></a>                               <span class='hs-comment'>-- the FastString is just a note for provenance</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SymCo</span> <span class='hs-conid'>Coercion</span>             <span class='hs-comment'>-- :: e -&gt; e</span>
<a name="line-183"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TransCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- :: e -&gt; e -&gt; e</span>
<a name="line-184"></a>
<a name="line-185"></a>    <span class='hs-comment'>-- The number of types and coercions should match exactly the expectations</span>
<a name="line-186"></a>    <span class='hs-comment'>-- of the CoAxiomRule (i.e., the rule is fully saturated).</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-188"></a>
<a name="line-189"></a>  <span class='hs-comment'>-- These are destructors</span>
<a name="line-190"></a>
<a name="line-191"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NthCo</span>  <span class='hs-conid'>Int</span>         <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Zero-indexed; decomposes (T t0 ... tn)</span>
<a name="line-192"></a>    <span class='hs-comment'>-- :: _ -&gt; e -&gt; ?? (inverse of TyConAppCo, see Note [TyConAppCo roles])</span>
<a name="line-193"></a>    <span class='hs-comment'>-- See Note [NthCo and newtypes]</span>
<a name="line-194"></a>
<a name="line-195"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LRCo</span>   <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Decomposes (t_left t_right)</span>
<a name="line-196"></a>    <span class='hs-comment'>-- :: _ -&gt; N -&gt; N</span>
<a name="line-197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Type</span>
<a name="line-198"></a>    <span class='hs-comment'>-- :: e -&gt; _ -&gt; e</span>
<a name="line-199"></a>
<a name="line-200"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SubCo</span> <span class='hs-conid'>Coercion</span>                  <span class='hs-comment'>-- Turns a ~N into a ~R</span>
<a name="line-201"></a>    <span class='hs-comment'>-- :: N -&gt; R</span>
<a name="line-202"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-205"></a><a name="LeftOrRight"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.lhs</span>
<a name="line-206"></a><a name="LeftOrRight"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CLeft</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CRight</span>
<a name="line-207"></a>                 <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-208"></a>
<a name="line-209"></a><a name="instance%20Binary%20LeftOrRight"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Binary</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-210"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CLeft</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>0</span>
<a name="line-211"></a>   <span class='hs-varid'>put_</span> <span class='hs-varid'>bh</span> <span class='hs-conid'>CRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putByte</span> <span class='hs-varid'>bh</span> <span class='hs-num'>1</span>
<a name="line-212"></a>
<a name="line-213"></a>   <span class='hs-varid'>get</span> <span class='hs-varid'>bh</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getByte</span> <span class='hs-varid'>bh</span>
<a name="line-214"></a>               <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-215"></a>                   <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CLeft</span>
<a name="line-216"></a>                   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>}</span>
<a name="line-217"></a>
<a name="line-218"></a><a name="pickLR"></a><span class='hs-definition'>pickLR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-219"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CLeft</span>  <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l</span>
<a name="line-220"></a><span class='hs-definition'>pickLR</span> <span class='hs-conid'>CRight</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-221"></a>
<a name="line-222"></a><span class='hs-comment'>{-
<a name="line-223"></a>Note [Refl invariant]
<a name="line-224"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-225"></a>Coercions have the following invariant
<a name="line-226"></a>     Refl is always lifted as far as possible.
<a name="line-227"></a>
<a name="line-228"></a>You might think that a consequencs is:
<a name="line-229"></a>     Every identity coercions has Refl at the root
<a name="line-230"></a>
<a name="line-231"></a>But that's not quite true because of coercion variables.  Consider
<a name="line-232"></a>     g         where g :: Int~Int
<a name="line-233"></a>     Left h    where h :: Maybe Int ~ Maybe Int
<a name="line-234"></a>etc.  So the consequence is only true of coercions that
<a name="line-235"></a>have no coercion variables.
<a name="line-236"></a>
<a name="line-237"></a>Note [Coercion axioms applied to coercions]
<a name="line-238"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-239"></a>The reason coercion axioms can be applied to coercions and not just
<a name="line-240"></a>types is to allow for better optimization.  There are some cases where
<a name="line-241"></a>we need to be able to "push transitivity inside" an axiom in order to
<a name="line-242"></a>expose further opportunities for optimization.
<a name="line-243"></a>
<a name="line-244"></a>For example, suppose we have
<a name="line-245"></a>
<a name="line-246"></a>  C a : t[a] ~ F a
<a name="line-247"></a>  g   : b ~ c
<a name="line-248"></a>
<a name="line-249"></a>and we want to optimize
<a name="line-250"></a>
<a name="line-251"></a>  sym (C b) ; t[g] ; C c
<a name="line-252"></a>
<a name="line-253"></a>which has the kind
<a name="line-254"></a>
<a name="line-255"></a>  F b ~ F c
<a name="line-256"></a>
<a name="line-257"></a>(stopping through t[b] and t[c] along the way).
<a name="line-258"></a>
<a name="line-259"></a>We'd like to optimize this to just F g -- but how?  The key is
<a name="line-260"></a>that we need to allow axioms to be instantiated by *coercions*,
<a name="line-261"></a>not just by types.  Then we can (in certain cases) push
<a name="line-262"></a>transitivity inside the axiom instantiations, and then react
<a name="line-263"></a>opposite-polarity instantiations of the same axiom.  In this
<a name="line-264"></a>case, e.g., we match t[g] against the LHS of (C c)'s kind, to
<a name="line-265"></a>obtain the substitution  a |-&gt; g  (note this operation is sort
<a name="line-266"></a>of the dual of lifting!) and hence end up with
<a name="line-267"></a>
<a name="line-268"></a>  C g : t[b] ~ F c
<a name="line-269"></a>
<a name="line-270"></a>which indeed has the same kind as  t[g] ; C c.
<a name="line-271"></a>
<a name="line-272"></a>Now we have
<a name="line-273"></a>
<a name="line-274"></a>  sym (C b) ; C g
<a name="line-275"></a>
<a name="line-276"></a>which can be optimized to F g.
<a name="line-277"></a>
<a name="line-278"></a>Note [CoAxiom index]
<a name="line-279"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-280"></a>A CoAxiom has 1 or more branches. Each branch has contains a list
<a name="line-281"></a>of the free type variables in that branch, the LHS type patterns,
<a name="line-282"></a>and the RHS type for that branch. When we apply an axiom to a list
<a name="line-283"></a>of coercions, we must choose which branch of the axiom we wish to
<a name="line-284"></a>use, as the different branches may have different numbers of free
<a name="line-285"></a>type variables. (The number of type patterns is always the same
<a name="line-286"></a>among branches, but that doesn't quite concern us here.)
<a name="line-287"></a>
<a name="line-288"></a>The Int in the AxiomInstCo constructor is the 0-indexed number
<a name="line-289"></a>of the chosen branch.
<a name="line-290"></a>
<a name="line-291"></a>Note [Forall coercions]
<a name="line-292"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-293"></a>Constructing coercions between forall-types can be a bit tricky.
<a name="line-294"></a>Currently, the situation is as follows:
<a name="line-295"></a>
<a name="line-296"></a>  ForAllCo TyVar Coercion
<a name="line-297"></a>
<a name="line-298"></a>represents a coercion between polymorphic types, with the rule
<a name="line-299"></a>
<a name="line-300"></a>           v : k       g : t1 ~ t2
<a name="line-301"></a>  ----------------------------------------------
<a name="line-302"></a>  ForAllCo v g : (all v:k . t1) ~ (all v:k . t2)
<a name="line-303"></a>
<a name="line-304"></a>Note that it's only necessary to coerce between polymorphic types
<a name="line-305"></a>where the type variables have identical kinds, because equality on
<a name="line-306"></a>kinds is trivial.
<a name="line-307"></a>
<a name="line-308"></a>Note [Predicate coercions]
<a name="line-309"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-310"></a>Suppose we have
<a name="line-311"></a>   g :: a~b
<a name="line-312"></a>How can we coerce between types
<a name="line-313"></a>   ([c]~a) =&gt; [a] -&gt; c
<a name="line-314"></a>and
<a name="line-315"></a>   ([c]~b) =&gt; [b] -&gt; c
<a name="line-316"></a>where the equality predicate *itself* differs?
<a name="line-317"></a>
<a name="line-318"></a>Answer: we simply treat (~) as an ordinary type constructor, so these
<a name="line-319"></a>types really look like
<a name="line-320"></a>
<a name="line-321"></a>   ((~) [c] a) -&gt; [a] -&gt; c
<a name="line-322"></a>   ((~) [c] b) -&gt; [b] -&gt; c
<a name="line-323"></a>
<a name="line-324"></a>So the coercion between the two is obviously
<a name="line-325"></a>
<a name="line-326"></a>   ((~) [c] g) -&gt; [g] -&gt; c
<a name="line-327"></a>
<a name="line-328"></a>Another way to see this to say that we simply collapse predicates to
<a name="line-329"></a>their representation type (see Type.coreView and Type.predTypeRep).
<a name="line-330"></a>
<a name="line-331"></a>This collapse is done by mkPredCo; there is no PredCo constructor
<a name="line-332"></a>in Coercion.  This is important because we need Nth to work on
<a name="line-333"></a>predicates too:
<a name="line-334"></a>    Nth 1 ((~) [c] g) = g
<a name="line-335"></a>See Simplify.simplCoercionF, which generates such selections.
<a name="line-336"></a>
<a name="line-337"></a>Note [Kind coercions]
<a name="line-338"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-339"></a>Suppose T :: * -&gt; *, and g :: A ~ B
<a name="line-340"></a>Then the coercion
<a name="line-341"></a>   TyConAppCo T [g]      T g : T A ~ T B
<a name="line-342"></a>
<a name="line-343"></a>Now suppose S :: forall k. k -&gt; *, and g :: A ~ B
<a name="line-344"></a>Then the coercion
<a name="line-345"></a>   TyConAppCo S [Refl *, g]   T &lt;*&gt; g : T * A ~ T * B
<a name="line-346"></a>
<a name="line-347"></a>Notice that the arguments to TyConAppCo are coercions, but the first
<a name="line-348"></a>represents a *kind* coercion. Now, we don't allow any non-trivial kind
<a name="line-349"></a>coercions, so it's an invariant that any such kind coercions are Refl.
<a name="line-350"></a>Lint checks this.
<a name="line-351"></a>
<a name="line-352"></a>However it's inconvenient to insist that these kind coercions are always
<a name="line-353"></a>*structurally* (Refl k), because the key function exprIsConApp_maybe
<a name="line-354"></a>pushes coercions into constructor arguments, so
<a name="line-355"></a>       C k ty e |&gt; g
<a name="line-356"></a>may turn into
<a name="line-357"></a>       C (Nth 0 g) ....
<a name="line-358"></a>Now (Nth 0 g) will optimise to Refl, but perhaps not instantly.
<a name="line-359"></a>
<a name="line-360"></a>Note [Roles]
<a name="line-361"></a>~~~~~~~~~~~~
<a name="line-362"></a>Roles are a solution to the GeneralizedNewtypeDeriving problem, articulated
<a name="line-363"></a>in Trac #1496. The full story is in docs/core-spec/core-spec.pdf. Also, see
<a name="line-364"></a><a href="http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation">http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation</a>
<a name="line-365"></a>
<a name="line-366"></a>Here is one way to phrase the problem:
<a name="line-367"></a>
<a name="line-368"></a>Given:
<a name="line-369"></a>newtype Age = MkAge Int
<a name="line-370"></a>type family F x
<a name="line-371"></a>type instance F Age = Bool
<a name="line-372"></a>type instance F Int = Char
<a name="line-373"></a>
<a name="line-374"></a>This compiles down to:
<a name="line-375"></a>axAge :: Age ~ Int
<a name="line-376"></a>axF1 :: F Age ~ Bool
<a name="line-377"></a>axF2 :: F Int ~ Char
<a name="line-378"></a>
<a name="line-379"></a>Then, we can make:
<a name="line-380"></a>(sym (axF1) ; F axAge ; axF2) :: Bool ~ Char
<a name="line-381"></a>
<a name="line-382"></a>Yikes!
<a name="line-383"></a>
<a name="line-384"></a>The solution is _roles_, as articulated in "Generative Type Abstraction and
<a name="line-385"></a>Type-level Computation" (POPL 2010), available at
<a name="line-386"></a><a href="http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf">http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf</a>
<a name="line-387"></a>
<a name="line-388"></a>The specification for roles has evolved somewhat since that paper. For the
<a name="line-389"></a>current full details, see the documentation in docs/core-spec. Here are some
<a name="line-390"></a>highlights.
<a name="line-391"></a>
<a name="line-392"></a>We label every equality with a notion of type equivalence, of which there are
<a name="line-393"></a>three options: Nominal, Representational, and Phantom. A ground type is
<a name="line-394"></a>nominally equivalent only with itself. A newtype (which is considered a ground
<a name="line-395"></a>type in Haskell) is representationally equivalent to its representation.
<a name="line-396"></a>Anything is "phantomly" equivalent to anything else. We use "N", "R", and "P"
<a name="line-397"></a>to denote the equivalences.
<a name="line-398"></a>
<a name="line-399"></a>The axioms above would be:
<a name="line-400"></a>axAge :: Age ~R Int
<a name="line-401"></a>axF1 :: F Age ~N Bool
<a name="line-402"></a>axF2 :: F Age ~N Char
<a name="line-403"></a>
<a name="line-404"></a>Then, because transitivity applies only to coercions proving the same notion
<a name="line-405"></a>of equivalence, the above construction is impossible.
<a name="line-406"></a>
<a name="line-407"></a>However, there is still an escape hatch: we know that any two types that are
<a name="line-408"></a>nominally equivalent are representationally equivalent as well. This is what
<a name="line-409"></a>the form SubCo proves -- it "demotes" a nominal equivalence into a
<a name="line-410"></a>representational equivalence. So, it would seem the following is possible:
<a name="line-411"></a>
<a name="line-412"></a>sub (sym axF1) ; F axAge ; sub axF2 :: Bool ~R Char   -- WRONG
<a name="line-413"></a>
<a name="line-414"></a>What saves us here is that the arguments to a type function F, lifted into a
<a name="line-415"></a>coercion, *must* prove nominal equivalence. So, (F axAge) is ill-formed, and
<a name="line-416"></a>we are safe.
<a name="line-417"></a>
<a name="line-418"></a>Roles are attached to parameters to TyCons. When lifting a TyCon into a
<a name="line-419"></a>coercion (through TyConAppCo), we need to ensure that the arguments to the
<a name="line-420"></a>TyCon respect their roles. For example:
<a name="line-421"></a>
<a name="line-422"></a>data T a b = MkT a (F b)
<a name="line-423"></a>
<a name="line-424"></a>If we know that a1 ~R a2, then we know (T a1 b) ~R (T a2 b). But, if we know
<a name="line-425"></a>that b1 ~R b2, we know nothing about (T a b1) and (T a b2)! This is because
<a name="line-426"></a>the type function F branches on b's *name*, not representation. So, we say
<a name="line-427"></a>that 'a' has role Representational and 'b' has role Nominal. The third role,
<a name="line-428"></a>Phantom, is for parameters not used in the type's definition. Given the
<a name="line-429"></a>following definition
<a name="line-430"></a>
<a name="line-431"></a>data Q a = MkQ Int
<a name="line-432"></a>
<a name="line-433"></a>the Phantom role allows us to say that (Q Bool) ~R (Q Char), because we
<a name="line-434"></a>can construct the coercion Bool ~P Char (using UnivCo).
<a name="line-435"></a>
<a name="line-436"></a>See the paper cited above for more examples and information.
<a name="line-437"></a>
<a name="line-438"></a>Note [UnivCo]
<a name="line-439"></a>~~~~~~~~~~~~~
<a name="line-440"></a>The UnivCo ("universal coercion") serves two rather separate functions:
<a name="line-441"></a> - the implementation for unsafeCoerce#
<a name="line-442"></a> - placeholder for phantom parameters in a TyConAppCo
<a name="line-443"></a>
<a name="line-444"></a>At Representational, it asserts that two (possibly unrelated)
<a name="line-445"></a>types have the same representation and can be casted to one another.
<a name="line-446"></a>This form is necessary for unsafeCoerce#.
<a name="line-447"></a>
<a name="line-448"></a>For optimisation purposes, it is convenient to allow UnivCo to appear
<a name="line-449"></a>at Nominal role. If we have
<a name="line-450"></a>
<a name="line-451"></a>data Foo a = MkFoo (F a)   -- F is a type family
<a name="line-452"></a>
<a name="line-453"></a>and we want an unsafe coercion from Foo Int to Foo Bool, then it would
<a name="line-454"></a>be nice to have (TyConAppCo Foo (UnivCo Nominal Int Bool)). So, we allow
<a name="line-455"></a>Nominal UnivCo's.
<a name="line-456"></a>
<a name="line-457"></a>At Phantom role, it is used as an argument to TyConAppCo in the place
<a name="line-458"></a>of a phantom parameter (a type parameter unused in the type definition).
<a name="line-459"></a>
<a name="line-460"></a>For example:
<a name="line-461"></a>
<a name="line-462"></a>data Q a = MkQ Int
<a name="line-463"></a>
<a name="line-464"></a>We want a coercion for (Q Bool) ~R (Q Char).
<a name="line-465"></a>
<a name="line-466"></a>(TyConAppCo Representational Q [UnivCo Phantom Bool Char]) does the trick.
<a name="line-467"></a>
<a name="line-468"></a>Note [TyConAppCo roles]
<a name="line-469"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-470"></a>The TyConAppCo constructor has a role parameter, indicating the role at
<a name="line-471"></a>which the coercion proves equality. The choice of this parameter affects
<a name="line-472"></a>the required roles of the arguments of the TyConAppCo. To help explain
<a name="line-473"></a>it, assume the following definition:
<a name="line-474"></a>
<a name="line-475"></a>newtype Age = MkAge Int
<a name="line-476"></a>
<a name="line-477"></a>Nominal: All arguments must have role Nominal. Why? So that Foo Age ~N Foo Int
<a name="line-478"></a>does *not* hold.
<a name="line-479"></a>
<a name="line-480"></a>Representational: All arguments must have the roles corresponding to the
<a name="line-481"></a>result of tyConRoles on the TyCon. This is the whole point of having
<a name="line-482"></a>roles on the TyCon to begin with. So, we can have Foo Age ~R Foo Int,
<a name="line-483"></a>if Foo's parameter has role R.
<a name="line-484"></a>
<a name="line-485"></a>If a Representational TyConAppCo is over-saturated (which is otherwise fine),
<a name="line-486"></a>the spill-over arguments must all be at Nominal. This corresponds to the
<a name="line-487"></a>behavior for AppCo.
<a name="line-488"></a>
<a name="line-489"></a>Phantom: All arguments must have role Phantom. This one isn't strictly
<a name="line-490"></a>necessary for soundness, but this choice removes ambiguity.
<a name="line-491"></a>
<a name="line-492"></a>
<a name="line-493"></a>
<a name="line-494"></a>The rules here also dictate what the parameters to mkTyConAppCo.
<a name="line-495"></a>
<a name="line-496"></a>Note [NthCo and newtypes]
<a name="line-497"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-498"></a>Suppose we have
<a name="line-499"></a>
<a name="line-500"></a>  newtype N a = MkN Int
<a name="line-501"></a>  type role N representational
<a name="line-502"></a>
<a name="line-503"></a>This yields axiom
<a name="line-504"></a>
<a name="line-505"></a>  NTCo:N :: forall a. N a ~R Int
<a name="line-506"></a>
<a name="line-507"></a>We can then build
<a name="line-508"></a>
<a name="line-509"></a>  co :: forall a b. N a ~R N b
<a name="line-510"></a>  co = NTCo:N a ; sym (NTCo:N b)
<a name="line-511"></a>
<a name="line-512"></a>for any `a` and `b`. Because of the role annotation on N, if we use
<a name="line-513"></a>NthCo, we'll get out a representational coercion. That is:
<a name="line-514"></a>
<a name="line-515"></a>  NthCo 0 co :: forall a b. a ~R b
<a name="line-516"></a>
<a name="line-517"></a>Yikes! Clearly, this is terrible. The solution is simple: forbid
<a name="line-518"></a>NthCo to be used on newtypes if the internal coercion is representational.
<a name="line-519"></a>
<a name="line-520"></a>This is not just some corner case discovered by a segfault somewhere;
<a name="line-521"></a>it was discovered in the proof of soundness of roles and described
<a name="line-522"></a>in the "Safe Coercions" paper (ICFP '14).
<a name="line-523"></a>
<a name="line-524"></a>************************************************************************
<a name="line-525"></a>*                                                                      *
<a name="line-526"></a>\subsection{Coercion variables}
<a name="line-527"></a>*                                                                      *
<a name="line-528"></a>************************************************************************
<a name="line-529"></a>-}</span>
<a name="line-530"></a>
<a name="line-531"></a><a name="coVarName"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-532"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span>
<a name="line-533"></a>
<a name="line-534"></a><a name="setCoVarUnique"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-535"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="setCoVarName"></a><span class='hs-definition'>setCoVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-538"></a><span class='hs-definition'>setCoVarName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarName</span>
<a name="line-539"></a>
<a name="line-540"></a><a name="isCoVar"></a><span class='hs-definition'>isCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-541"></a><span class='hs-definition'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isCoVarType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-542"></a>
<a name="line-543"></a><a name="isCoVarType"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-544"></a><span class='hs-definition'>isCoVarType</span> <span class='hs-varid'>ty</span>      <span class='hs-comment'>-- Tests for t1 ~# t2, the unboxed equality</span>
<a name="line-545"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-546"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-547"></a>                       <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthAtLeast`</span> <span class='hs-num'>2</span>
<a name="line-548"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-551"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-552"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-553"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-554"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-555"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-556"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-557"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-558"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span>
<a name="line-559"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-560"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-561"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-562"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-563"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-564"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-565"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cs</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-568"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>tyCoVarsOfCo</span>
<a name="line-569"></a>
<a name="line-570"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-571"></a><span class='hs-comment'>-- Extract *coerction* variables only.  Tiresome to repeat the code, but easy.</span>
<a name="line-572"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-573"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-574"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-575"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-576"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-577"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-578"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-579"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-580"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-581"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-582"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-583"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-584"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-585"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfCos</span> <span class='hs-varid'>cos</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-588"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>coVarsOfCo</span>
<a name="line-589"></a>
<a name="line-590"></a><a name="coercionSize"></a><span class='hs-definition'>coercionSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-591"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-592"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-593"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-594"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-595"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-596"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-597"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty2</span>
<a name="line-598"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-599"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-600"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-601"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-602"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-603"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-604"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-605"></a>                                         <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-606"></a>
<a name="line-607"></a><span class='hs-comment'>{-
<a name="line-608"></a>************************************************************************
<a name="line-609"></a>*                                                                      *
<a name="line-610"></a>                            Tidying coercions
<a name="line-611"></a>*                                                                      *
<a name="line-612"></a>************************************************************************
<a name="line-613"></a>-}</span>
<a name="line-614"></a>
<a name="line-615"></a><a name="tidyCo"></a><span class='hs-definition'>tidyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-616"></a><span class='hs-definition'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-617"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-618"></a>  <span class='hs-keyword'>where</span>
<a name="line-619"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-620"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-621"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-622"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-623"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tvp</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-624"></a>                                <span class='hs-keyword'>where</span>
<a name="line-625"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-626"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-627"></a>                                  <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-628"></a>                                  <span class='hs-conid'>Just</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv'</span>
<a name="line-629"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-630"></a>                                   <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span>
<a name="line-631"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty2</span>
<a name="line-632"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-633"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-634"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-635"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-636"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-637"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-638"></a>
<a name="line-639"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-640"></a>                                      <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-641"></a>                                  <span class='hs-keyword'>in</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>`seqList`</span>
<a name="line-642"></a>                                     <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>cos1</span>
<a name="line-643"></a>
<a name="line-644"></a>
<a name="line-645"></a><a name="tidyCos"></a><span class='hs-definition'>tidyCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-646"></a><span class='hs-definition'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-647"></a>
<a name="line-648"></a><span class='hs-comment'>{-
<a name="line-649"></a>************************************************************************
<a name="line-650"></a>*                                                                      *
<a name="line-651"></a>                   Pretty-printing coercions
<a name="line-652"></a>*                                                                      *
<a name="line-653"></a>************************************************************************
<a name="line-654"></a>
<a name="line-655"></a>@pprCo@ is the standard @Coercion@ printer; the overloaded @ppr@
<a name="line-656"></a>function is defined to use this.  @pprParendCo@ is the same, except it
<a name="line-657"></a>puts parens around the type, except for the atomic cases.
<a name="line-658"></a>@pprParendCo@ works just by setting the initial context precedence
<a name="line-659"></a>very high.
<a name="line-660"></a>-}</span>
<a name="line-661"></a>
<a name="line-662"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyword'>where</span>
<a name="line-663"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCo</span>
<a name="line-664"></a>
<a name="line-665"></a><a name="pprCo"></a><span class='hs-definition'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-666"></a><span class='hs-definition'>pprCo</span>       <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span>   <span class='hs-varid'>co</span>
<a name="line-667"></a><a name="pprParendCo"></a><span class='hs-definition'>pprParendCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="ppr_co"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-670"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-671"></a>
<a name="line-672"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-673"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-674"></a>
<a name="line-675"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcApp</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>ppr_co</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-676"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-677"></a>                                  <span class='hs-varid'>pprCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co2</span>
<a name="line-678"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-679"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-680"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>index</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-681"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>index</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-682"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-683"></a>
<a name="line-684"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-685"></a>                           <span class='hs-keyword'>case</span> <span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>of</span>
<a name="line-686"></a>                             <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"ppr_co"</span>
<a name="line-687"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co</span>
<a name="line-688"></a>                                             <span class='hs-conop'>:</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>';'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cos</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-689"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-690"></a>                          <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-691"></a>
<a name="line-692"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"UnivCo"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ftext</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-693"></a>                                           <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-694"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sym"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-695"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Nth:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-696"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>sel</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sel</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-697"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sub"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-698"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varop'>$</span>
<a name="line-699"></a>                                  <span class='hs-varid'>ppr_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span>
<a name="line-700"></a>
<a name="line-701"></a><a name="ppr_axiom_rule_co"></a><span class='hs-definition'>ppr_axiom_rule_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-702"></a><span class='hs-definition'>ppr_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppPs</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-703"></a>  <span class='hs-keyword'>where</span>
<a name="line-704"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-705"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>t</span>
<a name="line-706"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-707"></a>                <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-708"></a>
<a name="line-709"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-710"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-varid'>p</span>
<a name="line-711"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"("</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCo</span> <span class='hs-varid'>p</span> <span class='hs-varop'>$$</span>
<a name="line-712"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>","</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCo</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$$</span>
<a name="line-713"></a>                  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-714"></a>
<a name="line-715"></a>
<a name="line-716"></a>
<a name="line-717"></a><a name="ppr_role"></a><span class='hs-definition'>ppr_role</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-718"></a><span class='hs-definition'>ppr_role</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>underscore</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_role</span>
<a name="line-719"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>pp_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-720"></a>                    <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'N'</span>
<a name="line-721"></a>                    <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'R'</span>
<a name="line-722"></a>                    <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'P'</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="trans_co_list"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-725"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-varid'>trans_co_list</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-726"></a><span class='hs-definition'>trans_co_list</span> <span class='hs-varid'>co</span>                <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cos</span>
<a name="line-727"></a>
<a name="line-728"></a><a name="instance%20Outputable%20LeftOrRight"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyword'>where</span>
<a name="line-729"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CLeft</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Left"</span><span class='hs-layout'>)</span>
<a name="line-730"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CRight</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Right"</span><span class='hs-layout'>)</span>
<a name="line-731"></a>
<a name="line-732"></a><a name="ppr_fun_co"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-733"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>split</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-734"></a>  <span class='hs-keyword'>where</span>
<a name="line-735"></a>    <span class='hs-varid'>split</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-736"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-737"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-738"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span>
<a name="line-739"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-740"></a>
<a name="line-741"></a><a name="ppr_forall_co"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-742"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-743"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-744"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>rho</span><span class='hs-keyglyph'>]</span>
<a name="line-745"></a>  <span class='hs-keyword'>where</span>
<a name="line-746"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>  <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-747"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-748"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>               <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-749"></a>
<a name="line-750"></a><a name="pprCoAxiom"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-751"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-752"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"axiom"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>)</span>
<a name="line-753"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoAxBranch</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fromBranchList</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-754"></a>
<a name="line-755"></a><a name="pprCoAxBranch"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-756"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-757"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-758"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-759"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprUserForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-760"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-761"></a>
<a name="line-762"></a><a name="pprCoAxBranchHdr"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-763"></a><span class='hs-definition'>pprCoAxBranchHdr</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>index</span>
<a name="line-764"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-765"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTypeApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-766"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"-- Defined"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_loc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-767"></a>  <span class='hs-keyword'>where</span>
<a name="line-768"></a>        <span class='hs-varid'>ppr_loc</span> <span class='hs-varid'>loc</span>
<a name="line-769"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span>
<a name="line-770"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-771"></a>
<a name="line-772"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-773"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"in"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-774"></a>              <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameModule</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-775"></a>
<a name="line-776"></a><span class='hs-comment'>{-
<a name="line-777"></a>************************************************************************
<a name="line-778"></a>*                                                                      *
<a name="line-779"></a>        Functions over Kinds
<a name="line-780"></a>*                                                                      *
<a name="line-781"></a>************************************************************************
<a name="line-782"></a>-}</span>
<a name="line-783"></a>
<a name="line-784"></a><a name="decomposeCo"></a><span class='hs-comment'>-- | This breaks a 'Coercion' with type @T A B C ~ T D E F@ into</span>
<a name="line-785"></a><span class='hs-comment'>-- a list of 'Coercion's of kinds @A ~ D@, @B ~ E@ and @E ~ F@. Hence:</span>
<a name="line-786"></a><span class='hs-comment'>--</span>
<a name="line-787"></a><span class='hs-comment'>-- &gt; decomposeCo 3 c = [nth 0 c, nth 1 c, nth 2 c]</span>
<a name="line-788"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-789"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>co</span>
<a name="line-790"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-791"></a>           <span class='hs-comment'>-- Remember, Nth is zero-indexed</span>
<a name="line-792"></a>
<a name="line-793"></a><a name="getCoVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Coercion'</span>
<a name="line-794"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-795"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-796"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-797"></a>
<a name="line-798"></a><a name="splitAppCo_maybe"></a><span class='hs-comment'>-- first result has role equal to input; second result is Nominal</span>
<a name="line-799"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-800"></a><span class='hs-comment'>-- ^ Attempt to take a coercion application apart.</span>
<a name="line-801"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-802"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-803"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>||</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-804"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>cos</span>
<a name="line-805"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co'</span>
<a name="line-806"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co''</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-807"></a>       <span class='hs-comment'>-- Use mkTyConAppCo to preserve the invariant</span>
<a name="line-808"></a>       <span class='hs-comment'>--  that identity coercions are always represented by Refl</span>
<a name="line-809"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-811"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-812"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-813"></a>
<a name="line-814"></a><a name="splitForAllCo_maybe"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-815"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-816"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyword'>_</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-817"></a>
<a name="line-818"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-819"></a><span class='hs-comment'>-- and some coercion kind stuff</span>
<a name="line-820"></a>
<a name="line-821"></a><a name="coVarKind"></a><span class='hs-definition'>coVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-822"></a><span class='hs-definition'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-823"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-824"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span> <span class='hs-varop'>||</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span><span class='hs-layout'>)</span>
<a name="line-825"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-826"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coVarKind, non coercion variable"</span>
<a name="line-827"></a>
<a name="line-828"></a><a name="coVarRole"></a><span class='hs-definition'>coVarRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-829"></a><span class='hs-definition'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-830"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>
<a name="line-831"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-832"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-833"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-834"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-835"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: unknown tycon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-836"></a>
<a name="line-837"></a>  <span class='hs-keyword'>where</span>
<a name="line-838"></a>    <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-839"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>tc0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc0</span>
<a name="line-840"></a>           <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: not tyconapp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="mkCoercionType"></a><span class='hs-comment'>-- | Makes a coercion type from two types: the types whose equality</span>
<a name="line-843"></a><span class='hs-comment'>-- is proven by the relevant 'Coercion'</span>
<a name="line-844"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-845"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-846"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-847"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkCoercionType"</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="isReflCo"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-850"></a><span class='hs-definition'>isReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-851"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-852"></a>
<a name="line-853"></a><a name="isReflCo_maybe"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-854"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>
<a name="line-855"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyword'>_</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-856"></a>
<a name="line-857"></a><span class='hs-comment'>{-
<a name="line-858"></a>************************************************************************
<a name="line-859"></a>*                                                                      *
<a name="line-860"></a>            Building coercions
<a name="line-861"></a>*                                                                      *
<a name="line-862"></a>************************************************************************
<a name="line-863"></a>
<a name="line-864"></a>Note [Role twiddling functions]
<a name="line-865"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-866"></a>
<a name="line-867"></a>There are a plethora of functions for twiddling roles:
<a name="line-868"></a>
<a name="line-869"></a>mkSubCo: Requires a nominal input coercion and always produces a
<a name="line-870"></a>representational output. This is used when you (the programmer) are sure you
<a name="line-871"></a>know exactly that role you have and what you want.
<a name="line-872"></a>
<a name="line-873"></a>downgradeRole_maybe: This function takes both the input role and the output role
<a name="line-874"></a>as parameters. (The *output* role comes first!) It can only *downgrade* a
<a name="line-875"></a>role -- that is, change it from N to R or P, or from R to P. This one-way
<a name="line-876"></a>behavior is why there is the "_maybe". If an upgrade is requested, this
<a name="line-877"></a>function produces Nothing. This is used when you need to change the role of a
<a name="line-878"></a>coercion, but you're not sure (as you're writing the code) of which roles are
<a name="line-879"></a>involved.
<a name="line-880"></a>
<a name="line-881"></a>This function could have been written using coercionRole to ascertain the role
<a name="line-882"></a>of the input. But, that function is recursive, and the caller of downgradeRole_maybe
<a name="line-883"></a>often knows the input role. So, this is more efficient.
<a name="line-884"></a>
<a name="line-885"></a>downgradeRole: This is just like downgradeRole_maybe, but it panics if the conversion
<a name="line-886"></a>isn't a downgrade.
<a name="line-887"></a>
<a name="line-888"></a>setNominalRole_maybe: This is the only function that can *upgrade* a coercion. The result
<a name="line-889"></a>(if it exists) is always Nominal. The input can be at any role. It works on a
<a name="line-890"></a>"best effort" basis, as it should never be strictly necessary to upgrade a coercion
<a name="line-891"></a>during compilation. It is currently only used within GHC in splitAppCo_maybe. In order
<a name="line-892"></a>to be a proper inverse of mkAppCo, the second coercion that splitAppCo_maybe returns
<a name="line-893"></a>must be nominal. But, it's conceivable that splitAppCo_maybe is operating over a
<a name="line-894"></a>TyConAppCo that uses a representational coercion. Hence the need for setNominalRole_maybe.
<a name="line-895"></a>splitAppCo_maybe, in turn, is used only within coercion optimization -- thus, it is
<a name="line-896"></a>not absolutely critical that setNominalRole_maybe be complete.
<a name="line-897"></a>
<a name="line-898"></a>Note that setNominalRole_maybe will never upgrade a phantom UnivCo. Phantom
<a name="line-899"></a>UnivCos are perfectly type-safe, whereas representational and nominal ones are
<a name="line-900"></a>not. Indeed, `unsafeCoerce` is implemented via a representational UnivCo.
<a name="line-901"></a>(Nominal ones are no worse than representational ones, so this function *will*
<a name="line-902"></a>change a UnivCo Representational to a UnivCo Nominal.)
<a name="line-903"></a>
<a name="line-904"></a>Conal Elliott also came across a need for this function while working with the GHC
<a name="line-905"></a>API, as he was decomposing Core casts. The Core casts use representational coercions,
<a name="line-906"></a>as they must, but his use case required nominal coercions (he was building a GADT).
<a name="line-907"></a>So, that's why this function is exported from this module.
<a name="line-908"></a>
<a name="line-909"></a>One might ask: shouldn't downgradeRole_maybe just use setNominalRole_maybe as appropriate?
<a name="line-910"></a>I (Richard E.) have decided not to do this, because upgrading a role is bizarre and
<a name="line-911"></a>a caller should have to ask for this behavior explicitly.
<a name="line-912"></a>-}</span>
<a name="line-913"></a>
<a name="line-914"></a><a name="mkCoVarCo"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-915"></a><span class='hs-comment'>-- cv :: s ~# t</span>
<a name="line-916"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-917"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-918"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-919"></a>  <span class='hs-keyword'>where</span>
<a name="line-920"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-921"></a>
<a name="line-922"></a><a name="mkReflCo"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-923"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span>
<a name="line-924"></a>
<a name="line-925"></a><a name="mkAxInstCo"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-926"></a><span class='hs-comment'>-- mkAxInstCo can legitimately be called over-staturated;</span>
<a name="line-927"></a><span class='hs-comment'>-- i.e. with more type arguments than the coercion requires</span>
<a name="line-928"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-929"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-varid'>rtys</span>
<a name="line-930"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-931"></a>                     <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-932"></a>                     <span class='hs-varid'>foldl</span> <span class='hs-conid'>AppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-933"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span>
<a name="line-934"></a>  <span class='hs-keyword'>where</span>
<a name="line-935"></a>    <span class='hs-varid'>n_tys</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-936"></a>    <span class='hs-varid'>ax_br</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchedAxiom</span> <span class='hs-varid'>ax</span>
<a name="line-937"></a>    <span class='hs-varid'>branch</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-938"></a>    <span class='hs-varid'>arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-939"></a>    <span class='hs-varid'>arg_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRoles</span> <span class='hs-varid'>branch</span>
<a name="line-940"></a>    <span class='hs-varid'>rtys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_roles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-941"></a>    <span class='hs-varid'>ax_role</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="mkUnbranchedAxInstCo"></a><span class='hs-comment'>-- to be used only with unbranched axioms</span>
<a name="line-944"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-945"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-946"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span> <span class='hs-varid'>tys</span>
<a name="line-947"></a>
<a name="line-948"></a><a name="mkAxInstLHS"></a><span class='hs-definition'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-949"></a><span class='hs-comment'>-- Instantiate the axiom with specified types,</span>
<a name="line-950"></a><span class='hs-comment'>-- returning the instantiated RHS</span>
<a name="line-951"></a><span class='hs-comment'>-- A companion to mkAxInstCo:</span>
<a name="line-952"></a><span class='hs-comment'>--    mkAxInstRhs ax index tys = snd (coercionKind (mkAxInstCo ax index tys))</span>
<a name="line-953"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-954"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-955"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-956"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-957"></a>    <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-958"></a>
<a name="line-959"></a><a name="mkAxInstRHS"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-960"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-961"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-962"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-963"></a>    <span class='hs-varid'>mkAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys2</span>
<a name="line-964"></a>
<a name="line-965"></a><a name="mkUnbranchedAxInstRHS"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-966"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-967"></a>
<a name="line-968"></a><a name="mkAppCo"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-969"></a><span class='hs-comment'>-- The second coercion must be Nominal, unless the first is Phantom.</span>
<a name="line-970"></a><span class='hs-comment'>-- If the first is Phantom, then the second can be either Phantom or Nominal.</span>
<a name="line-971"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-972"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCoFlexible</span> <span class='hs-varid'>co1</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co2</span>
<a name="line-973"></a><span class='hs-comment'>-- Note, mkAppCo is careful to maintain invariants regarding</span>
<a name="line-974"></a><span class='hs-comment'>-- where Refl constructors appear; see the comments in the definition</span>
<a name="line-975"></a><span class='hs-comment'>-- of Coercion and the Note [Refl invariant] in types/TypeRep.lhs.</span>
<a name="line-976"></a>
<a name="line-977"></a><a name="mkAppCoFlexible"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-978"></a><span class='hs-comment'>-- The second 'Coercion's role is given, making this more flexible than</span>
<a name="line-979"></a><span class='hs-comment'>-- 'mkAppCo'.</span>
<a name="line-980"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-981"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-982"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-983"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span>
<a name="line-984"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-985"></a>    <span class='hs-comment'>-- Expand type synonyms; a TyConAppCo can't have a type synonym (Trac #9102)</span>
<a name="line-986"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-987"></a>  <span class='hs-keyword'>where</span>
<a name="line-988"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>[]</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-989"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zip_roles</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>tys</span>
<a name="line-990"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zip_roles"</span> <span class='hs-comment'>-- but the roles are infinite...</span>
<a name="line-991"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-992"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-993"></a>      <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-994"></a>                          <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-995"></a>      <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-996"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>new_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-997"></a>              <span class='hs-varid'>co'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>new_role</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-998"></a>      <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cos</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkPhantomCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-999"></a>
<a name="line-1000"></a><span class='hs-definition'>mkAppCoFlexible</span> <span class='hs-varid'>co1</span> <span class='hs-sel'>_r2</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-sel'>_r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-1001"></a>                              <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1002"></a>
<a name="line-1003"></a>
<a name="line-1004"></a><a name="mkAppCos"></a><span class='hs-comment'>-- | Applies multiple 'Coercion's to another 'Coercion', from left to right.</span>
<a name="line-1005"></a><span class='hs-comment'>-- See also 'mkAppCo'.</span>
<a name="line-1006"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1007"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span>
<a name="line-1008"></a>
<a name="line-1009"></a><a name="mkTyConAppCo"></a><span class='hs-comment'>-- | Apply a type constructor to a list of coercions. It is the</span>
<a name="line-1010"></a><span class='hs-comment'>-- caller's responsibility to get the roles correct on argument coercions.</span>
<a name="line-1011"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1012"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1013"></a>               <span class='hs-comment'>-- Expand type synonyms</span>
<a name="line-1014"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExpandTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1015"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv_co_prs</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>leftover_cos</span>
<a name="line-1016"></a>
<a name="line-1017"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-1018"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-1019"></a>
<a name="line-1020"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1021"></a>
<a name="line-1022"></a><a name="mkFunCo"></a><span class='hs-comment'>-- | Make a function 'Coercion' between two other 'Coercion's</span>
<a name="line-1023"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1024"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-1025"></a>
<a name="line-1026"></a><a name="mkForAllCo"></a><span class='hs-comment'>-- | Make a 'Coercion' which binds a variable within an inner 'Coercion'</span>
<a name="line-1027"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1028"></a><span class='hs-comment'>-- note that a TyVar should be used here, not a CoVar (nor a TcTyVar)</span>
<a name="line-1029"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1030"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>tv</span>  <span class='hs-varid'>co</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-1031"></a>
<a name="line-1032"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-1033"></a>
<a name="line-1034"></a><a name="mkSymCo"></a><span class='hs-comment'>-- | Create a symmetric version of the given 'Coercion' that asserts</span>
<a name="line-1035"></a><span class='hs-comment'>--   equality between the same types but in the other "direction", so</span>
<a name="line-1036"></a><span class='hs-comment'>--   a kind of @t1 ~ t2@ becomes the kind @t2 ~ t1@.</span>
<a name="line-1037"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1038"></a>
<a name="line-1039"></a><span class='hs-comment'>-- Do a few simple optimizations, but don't bother pushing occurrences</span>
<a name="line-1040"></a><span class='hs-comment'>-- of symmetry to the leaves; the optimizer will take care of that.</span>
<a name="line-1041"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1042"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span>
<a name="line-1043"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1044"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span>
<a name="line-1045"></a>
<a name="line-1046"></a><a name="mkTransCo"></a><span class='hs-comment'>-- | Create a new 'Coercion' by composing the two given 'Coercion's transitively.</span>
<a name="line-1047"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1048"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1049"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1050"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1051"></a>
<a name="line-1052"></a><a name="mkNthCoRole"></a><span class='hs-comment'>-- the Role is the desired one. It is the caller's responsibility to make</span>
<a name="line-1053"></a><span class='hs-comment'>-- sure this request is reasonable</span>
<a name="line-1054"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1055"></a><span class='hs-definition'>mkNthCoRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1056"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>nth_role</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nth_co</span>
<a name="line-1057"></a>  <span class='hs-keyword'>where</span>
<a name="line-1058"></a>    <span class='hs-varid'>nth_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1059"></a>    <span class='hs-varid'>nth_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>nth_co</span>
<a name="line-1060"></a>
<a name="line-1061"></a><a name="mkNthCo"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1062"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-1063"></a>                        <span class='hs-conid'>Refl</span> <span class='hs-varid'>r'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1064"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-1065"></a>        <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1066"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-sel'>_ty1</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-sel'>_ty2</span> <span class='hs-varid'>n</span> <span class='hs-layout'>)</span>
<a name="line-1067"></a>                      <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1068"></a>                    <span class='hs-keyword'>where</span>
<a name="line-1069"></a>                      <span class='hs-conid'>Pair</span> <span class='hs-sel'>_ty1</span> <span class='hs-sel'>_ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1070"></a>
<a name="line-1071"></a>
<a name="line-1072"></a><a name="mkLRCo"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1073"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1074"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-1075"></a>
<a name="line-1076"></a><a name="ok_tc_app"></a><span class='hs-definition'>ok_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1077"></a><span class='hs-definition'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-1078"></a>                   <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-1079"></a>                   <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1080"></a>
<a name="line-1081"></a><a name="mkInstCo"></a><span class='hs-comment'>-- | Instantiates a 'Coercion' with a 'Type' argument.</span>
<a name="line-1082"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1083"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span>
<a name="line-1084"></a>
<a name="line-1085"></a><a name="mkUnsafeCo"></a><span class='hs-comment'>-- | Manufacture an unsafe coercion from thin air.</span>
<a name="line-1086"></a><span class='hs-comment'>--   Currently (May 14) this is used only to implement the</span>
<a name="line-1087"></a><span class='hs-comment'>--   @unsafeCoerce#@ primitive.  Optimise by pushing</span>
<a name="line-1088"></a><span class='hs-comment'>--   down through type constructors.</span>
<a name="line-1089"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1090"></a><span class='hs-definition'>mkUnsafeCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"mkUnsafeCo"</span><span class='hs-layout'>)</span> <span class='hs-conid'>Representational</span>
<a name="line-1091"></a>
<a name="line-1092"></a><a name="mkUnivCo"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FastString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1093"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1094"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-1095"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1096"></a>
<a name="line-1097"></a><a name="mkAxiomRuleCo"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1098"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span>
<a name="line-1099"></a>
<a name="line-1100"></a><a name="mkSubCo"></a><span class='hs-comment'>-- input coercion is Nominal; see also Note [Role twiddling functions]</span>
<a name="line-1101"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1102"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span>
<a name="line-1103"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1105"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1106"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1107"></a>             <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-1108"></a>
<a name="line-1109"></a><a name="downgradeRole_maybe"></a><span class='hs-comment'>-- only *downgrades* a role. See Note [Role twiddling functions]</span>
<a name="line-1110"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- desired role</span>
<a name="line-1111"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- current role</span>
<a name="line-1112"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1113"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1114"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Nominal</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1115"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-conid'>Phantom</span>          <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1116"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span>                <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhantomCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1117"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Phantom</span>                <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1118"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                      <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1119"></a>
<a name="line-1120"></a><a name="downgradeRole"></a><span class='hs-comment'>-- panics if the requested conversion is not a downgrade.</span>
<a name="line-1121"></a><span class='hs-comment'>-- See also Note [Role twiddling functions]</span>
<a name="line-1122"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- desired role</span>
<a name="line-1123"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- current role</span>
<a name="line-1124"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1125"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-1126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1127"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1128"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"downgradeRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1129"></a>
<a name="line-1130"></a><a name="setNominalRole_maybe"></a><span class='hs-comment'>-- Converts a coercion to be nominal, if possible.</span>
<a name="line-1131"></a><span class='hs-comment'>-- See also Note [Role twiddling functions]</span>
<a name="line-1132"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1133"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1134"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1135"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1136"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span>
<a name="line-1137"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>coes</span><span class='hs-layout'>)</span>
<a name="line-1138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>coes</span>
<a name="line-1139"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span> <span class='hs-layout'>}</span>
<a name="line-1140"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1141"></a>  <span class='hs-comment'>-- We do *not* promote UnivCo Phantom, as that's unsafe.</span>
<a name="line-1142"></a>  <span class='hs-comment'>-- UnivCo Nominal is no more unsafe than UnivCo Representational</span>
<a name="line-1143"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-1145"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1146"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>co2</span>
<a name="line-1147"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1149"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1151"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>ty</span>
<a name="line-1153"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1154"></a>
<a name="line-1155"></a><a name="mkPhantomCo"></a><span class='hs-comment'>-- takes any coercion and turns it into a Phantom coercion</span>
<a name="line-1156"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1157"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-varid'>co</span>
<a name="line-1158"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>
<a name="line-1159"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"mkPhantomCo"</span><span class='hs-layout'>)</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1160"></a>  <span class='hs-comment'>-- don't optimise here... wait for OptCoercion</span>
<a name="line-1161"></a>
<a name="line-1162"></a><a name="applyRole"></a><span class='hs-comment'>-- All input coercions are assumed to be Nominal,</span>
<a name="line-1163"></a><span class='hs-comment'>-- or, if Role is Phantom, the Coercion can be Phantom, too.</span>
<a name="line-1164"></a><span class='hs-definition'>applyRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1165"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-1166"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span>
<a name="line-1167"></a><span class='hs-definition'>applyRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span>
<a name="line-1168"></a>
<a name="line-1169"></a><a name="applyRoles"></a><span class='hs-comment'>-- Convert args to a TyConAppCo Nominal to the same TyConAppCo Representational</span>
<a name="line-1170"></a><span class='hs-definition'>applyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1171"></a><span class='hs-definition'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>applyRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-1173"></a>
<a name="line-1174"></a><a name="tyConRolesX"></a><span class='hs-comment'>-- the Role parameter is the Role of the TyConAppCo</span>
<a name="line-1175"></a><span class='hs-comment'>-- defined here because this is intimiately concerned with the implementation</span>
<a name="line-1176"></a><span class='hs-comment'>-- of TyConAppCo</span>
<a name="line-1177"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1178"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span>
<a name="line-1179"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-varid'>role</span>             <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>role</span>
<a name="line-1180"></a>
<a name="line-1181"></a><a name="nthRole"></a><span class='hs-definition'>nthRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1182"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-1183"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phantom</span>
<a name="line-1184"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1185"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span>
<a name="line-1186"></a>
<a name="line-1187"></a><a name="ltRole"></a><span class='hs-definition'>ltRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1188"></a><span class='hs-comment'>-- Is one role "less" than another?</span>
<a name="line-1189"></a><span class='hs-comment'>--     Nominal &lt; Representational &lt; Phantom</span>
<a name="line-1190"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1191"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1192"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1193"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1194"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1195"></a>
<a name="line-1196"></a><a name="mkNewTypeCo"></a><span class='hs-comment'>-- See note [Newtype coercions] in TyCon</span>
<a name="line-1197"></a><span class='hs-comment'>-- | Create a coercion constructor (axiom) suitable for the given</span>
<a name="line-1198"></a><span class='hs-comment'>--   newtype 'TyCon'. The 'Name' should be that of a new coercion</span>
<a name="line-1199"></a><span class='hs-comment'>--   'CoAxiom', the 'TyVar's the arguments expected by the @newtype@ and</span>
<a name="line-1200"></a><span class='hs-comment'>--   the type the appropriate right hand side of the @newtype@, with</span>
<a name="line-1201"></a><span class='hs-comment'>--   the free variables a subset of those 'TyVar's.</span>
<a name="line-1202"></a><span class='hs-definition'>mkNewTypeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-1203"></a><span class='hs-definition'>mkNewTypeCo</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-1204"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_unique</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nameUnique</span> <span class='hs-varid'>name</span>
<a name="line-1205"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_name</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-1206"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_implicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- See Note [Implicit axioms] in TyCon</span>
<a name="line-1207"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_role</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-1208"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycon</span>
<a name="line-1209"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FirstBranch</span> <span class='hs-varid'>branch</span> <span class='hs-layout'>}</span>
<a name="line-1210"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_loc</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSrcSpan</span> <span class='hs-varid'>name</span>
<a name="line-1211"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_tvs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-1212"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>tvs</span>
<a name="line-1213"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_roles</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>roles</span>
<a name="line-1214"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-1215"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cab_incomps</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-1216"></a>
<a name="line-1217"></a><a name="mkPiCos"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1218"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-varid'>r</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiCo</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>vs</span>
<a name="line-1219"></a>
<a name="line-1220"></a><a name="mkPiCo"></a><span class='hs-definition'>mkPiCo</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1221"></a><span class='hs-definition'>mkPiCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-1222"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="mkCoCast"></a><span class='hs-comment'>-- The first coercion *must* be Nominal.</span>
<a name="line-1225"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1226"></a><span class='hs-comment'>-- (mkCoCast (c :: s1 ~# t1) (g :: (s1 ~# t1) ~# (s2 ~# t2)</span>
<a name="line-1227"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-varid'>c</span> <span class='hs-varid'>g</span>
<a name="line-1228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>g1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>g2</span>
<a name="line-1229"></a>  <span class='hs-keyword'>where</span>
<a name="line-1230"></a>       <span class='hs-comment'>-- g  :: (s1 ~# s2) ~# (t1 ~#  t2)</span>
<a name="line-1231"></a>       <span class='hs-comment'>-- g1 :: s1 ~# t1</span>
<a name="line-1232"></a>       <span class='hs-comment'>-- g2 :: s2 ~# t2</span>
<a name="line-1233"></a>    <span class='hs-keyglyph'>[</span><span class='hs-sel'>_reflk</span><span class='hs-layout'>,</span> <span class='hs-varid'>g1</span><span class='hs-layout'>,</span> <span class='hs-varid'>g2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeCo</span> <span class='hs-num'>3</span> <span class='hs-varid'>g</span>
<a name="line-1234"></a>            <span class='hs-comment'>-- Remember, (~#) :: forall k. k -&gt; k -&gt; *</span>
<a name="line-1235"></a>            <span class='hs-comment'>-- so it takes *three* arguments, not two</span>
<a name="line-1236"></a>
<a name="line-1237"></a><span class='hs-comment'>{-
<a name="line-1238"></a>************************************************************************
<a name="line-1239"></a>*                                                                      *
<a name="line-1240"></a>            Newtypes
<a name="line-1241"></a>*                                                                      *
<a name="line-1242"></a>************************************************************************
<a name="line-1243"></a>-}</span>
<a name="line-1244"></a>
<a name="line-1245"></a><a name="instNewTyCon_maybe"></a><span class='hs-comment'>-- | If @co :: T ts ~ rep_ty@ then:</span>
<a name="line-1246"></a><span class='hs-comment'>--</span>
<a name="line-1247"></a><span class='hs-comment'>-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span>
<a name="line-1248"></a><span class='hs-comment'>--</span>
<a name="line-1249"></a><span class='hs-comment'>-- Checks for a newtype, and for being saturated</span>
<a name="line-1250"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1251"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1252"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwrapNewTyConEtad_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Check for newtype</span>
<a name="line-1253"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`leLength`</span> <span class='hs-varid'>tys</span>                                    <span class='hs-comment'>-- Check saturated enough</span>
<a name="line-1254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span> <span class='hs-varid'>applyTysX</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-1255"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1256"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1257"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1258"></a>
<a name="line-1259"></a><span class='hs-comment'>{-
<a name="line-1260"></a>************************************************************************
<a name="line-1261"></a>*                                                                      *
<a name="line-1262"></a>         Type normalisation
<a name="line-1263"></a>*                                                                      *
<a name="line-1264"></a>************************************************************************
<a name="line-1265"></a>-}</span>
<a name="line-1266"></a>
<a name="line-1267"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- | A function to check if we can reduce a type by one step. Used</span>
<a name="line-1268"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- with 'topNormaliseTypeX_maybe'.</span>
<a name="line-1269"></a><a name="NormaliseStepper"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecTcChecker</span>
<a name="line-1270"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- tc</span>
<a name="line-1271"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- tys</span>
<a name="line-1272"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span>
<a name="line-1273"></a>
<a name="line-1274"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- | The result of stepping in a normalisation function.</span>
<a name="line-1275"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- See 'topNormaliseTypeX_maybe'.</span>
<a name="line-1276"></a><a name="NormaliseStepResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NormaliseStepResult</span>
<a name="line-1277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>   <span class='hs-comment'>-- ^ nothing more to do</span>
<a name="line-1278"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Abort</span>  <span class='hs-comment'>-- ^ utter failure. The outer function should fail too.</span>
<a name="line-1279"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Step</span> <span class='hs-conid'>RecTcChecker</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- ^ we stepped, yielding new bits;</span>
<a name="line-1280"></a>                                        <span class='hs-comment'>-- ^ co :: old type ~ new type</span>
<a name="line-1281"></a>
<a name="line-1282"></a><a name="modifyStepResultCo"></a><span class='hs-definition'>modifyStepResultCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1283"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span>
<a name="line-1284"></a><span class='hs-definition'>modifyStepResultCo</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1285"></a><span class='hs-definition'>modifyStepResultCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>result</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>result</span>
<a name="line-1286"></a>
<a name="line-1287"></a><a name="composeSteppers"></a><span class='hs-comment'>-- | Try one stepper and then try the next, if the first doesn't make</span>
<a name="line-1288"></a><span class='hs-comment'>-- progress.</span>
<a name="line-1289"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span>
<a name="line-1290"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span>
<a name="line-1291"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1293"></a>      <span class='hs-varid'>success</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>success</span>
<a name="line-1294"></a>      <span class='hs-conid'>NS_Done</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1295"></a>      <span class='hs-conid'>NS_Abort</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1296"></a>
<a name="line-1297"></a><a name="unwrapNewTypeStepper"></a><span class='hs-comment'>-- | A 'NormaliseStepper' that unwraps newtypes, careful not to fall into</span>
<a name="line-1298"></a><span class='hs-comment'>-- a loop. If it would fall into a loop, it produces 'NS_Abort'.</span>
<a name="line-1299"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span>
<a name="line-1300"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1301"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1303"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-1304"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1305"></a>
<a name="line-1306"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1307"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>
<a name="line-1308"></a>
<a name="line-1309"></a><a name="topNormaliseTypeX_maybe"></a><span class='hs-comment'>-- | A general function for normalising the top-level of a type. It continues</span>
<a name="line-1310"></a><span class='hs-comment'>-- to use the provided 'NormaliseStepper' until that function fails, and then</span>
<a name="line-1311"></a><span class='hs-comment'>-- this function returns. The roles of the coercions produced by the</span>
<a name="line-1312"></a><span class='hs-comment'>-- 'NormaliseStepper' must all be the same, which is the role returned from</span>
<a name="line-1313"></a><span class='hs-comment'>-- the call to 'topNormaliseTypeX_maybe'.</span>
<a name="line-1314"></a><span class='hs-definition'>topNormaliseTypeX_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1315"></a><span class='hs-definition'>topNormaliseTypeX_maybe</span> <span class='hs-varid'>stepper</span>
<a name="line-1316"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>initRecTc</span> <span class='hs-conid'>Nothing</span>
<a name="line-1317"></a>  <span class='hs-keyword'>where</span>
<a name="line-1318"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>mb_co1</span> <span class='hs-varid'>ty</span>
<a name="line-1319"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1320"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1321"></a>          <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co2</span>
<a name="line-1322"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_co1</span> <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-1323"></a>
<a name="line-1324"></a>          <span class='hs-conid'>NS_Done</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all_done</span>
<a name="line-1325"></a>          <span class='hs-conid'>NS_Abort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1326"></a>
<a name="line-1327"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1328"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all_done</span>
<a name="line-1329"></a>      <span class='hs-keyword'>where</span>
<a name="line-1330"></a>        <span class='hs-varid'>all_done</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1331"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1332"></a>
<a name="line-1333"></a>    <span class='hs-conid'>Nothing</span>    <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co2</span>
<a name="line-1334"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`trans`</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1335"></a>
<a name="line-1336"></a><a name="topNormaliseNewType_maybe"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1337"></a><span class='hs-comment'>-- ^ Sometimes we want to look through a @newtype@ and get its associated coercion.</span>
<a name="line-1338"></a><span class='hs-comment'>-- This function strips off @newtype@ layers enough to reveal something that isn't</span>
<a name="line-1339"></a><span class='hs-comment'>-- a @newtype@, or responds False to ok_tc.  Specifically, here's the invariant:</span>
<a name="line-1340"></a><span class='hs-comment'>--</span>
<a name="line-1341"></a><span class='hs-comment'>-- &gt; topNormaliseNewType_maybe ty = Just (co, ty')</span>
<a name="line-1342"></a><span class='hs-comment'>--</span>
<a name="line-1343"></a><span class='hs-comment'>-- then (a)  @co : ty0 ~ ty'@.</span>
<a name="line-1344"></a><span class='hs-comment'>--      (b)  ty' is not a newtype.</span>
<a name="line-1345"></a><span class='hs-comment'>--</span>
<a name="line-1346"></a><span class='hs-comment'>-- The function returns @Nothing@ for non-@newtypes@,</span>
<a name="line-1347"></a><span class='hs-comment'>-- or unsaturated applications</span>
<a name="line-1348"></a><span class='hs-comment'>--</span>
<a name="line-1349"></a><span class='hs-comment'>-- This function does *not* look through type families, because it has no access to</span>
<a name="line-1350"></a><span class='hs-comment'>-- the type family environment. If you do have that at hand, consider to use</span>
<a name="line-1351"></a><span class='hs-comment'>-- topNormaliseType_maybe, which should be a drop-in replacement for</span>
<a name="line-1352"></a><span class='hs-comment'>-- topNormaliseNewType_maybe</span>
<a name="line-1353"></a><span class='hs-comment'>--</span>
<a name="line-1354"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1355"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseTypeX_maybe</span> <span class='hs-varid'>unwrapNewTypeStepper</span> <span class='hs-varid'>ty</span>
<a name="line-1356"></a>
<a name="line-1357"></a><span class='hs-comment'>{-
<a name="line-1358"></a>************************************************************************
<a name="line-1359"></a>*                                                                      *
<a name="line-1360"></a>                   Equality of coercions
<a name="line-1361"></a>*                                                                      *
<a name="line-1362"></a>************************************************************************
<a name="line-1363"></a>-}</span>
<a name="line-1364"></a>
<a name="line-1365"></a><a name="coreEqCoercion"></a><span class='hs-comment'>-- | Determines syntactic equality of coercions</span>
<a name="line-1366"></a><span class='hs-definition'>coreEqCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1367"></a><span class='hs-definition'>coreEqCoercion</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1368"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1369"></a>
<a name="line-1370"></a><a name="coreEqCoercion2"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1371"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eq2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1372"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq1</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq2</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-1373"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>eq2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span>
<a name="line-1374"></a>
<a name="line-1375"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co21</span> <span class='hs-varid'>co22</span><span class='hs-layout'>)</span>
<a name="line-1376"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co12</span> <span class='hs-varid'>co22</span>
<a name="line-1377"></a>
<a name="line-1378"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1379"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-layout'>(</span><span class='hs-varid'>rnBndr2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span><span class='hs-layout'>)</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1380"></a>
<a name="line-1381"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv2</span><span class='hs-layout'>)</span>
<a name="line-1382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>rnOccR</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cv2</span>
<a name="line-1383"></a>
<a name="line-1384"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con1</span> <span class='hs-varid'>ind1</span> <span class='hs-varid'>cos1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con2</span> <span class='hs-varid'>ind2</span> <span class='hs-varid'>cos2</span><span class='hs-layout'>)</span>
<a name="line-1385"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>con2</span>
<a name="line-1386"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ind1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ind2</span>
<a name="line-1387"></a>    <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos1</span> <span class='hs-varid'>cos2</span>
<a name="line-1388"></a>
<a name="line-1389"></a><span class='hs-comment'>-- the provenance string is just a note, so don't use in comparisons</span>
<a name="line-1390"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty11</span> <span class='hs-varid'>ty12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>ty21</span> <span class='hs-varid'>ty22</span><span class='hs-layout'>)</span>
<a name="line-1391"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty11</span> <span class='hs-varid'>ty21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty12</span> <span class='hs-varid'>ty22</span>
<a name="line-1392"></a>
<a name="line-1393"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1394"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1395"></a>
<a name="line-1396"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co21</span> <span class='hs-varid'>co22</span><span class='hs-layout'>)</span>
<a name="line-1397"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co11</span> <span class='hs-varid'>co21</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co12</span> <span class='hs-varid'>co22</span>
<a name="line-1398"></a>
<a name="line-1399"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1400"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1401"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d1</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>d2</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1402"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>d2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1403"></a>
<a name="line-1404"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1405"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1406"></a>
<a name="line-1407"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1408"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1409"></a>
<a name="line-1410"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>cs1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>ts2</span> <span class='hs-varid'>cs2</span><span class='hs-layout'>)</span>
<a name="line-1411"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>a2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>ts2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coreEqCoercion2</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cs1</span> <span class='hs-varid'>cs2</span>
<a name="line-1412"></a>
<a name="line-1413"></a><span class='hs-definition'>coreEqCoercion2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1414"></a>
<a name="line-1415"></a><span class='hs-comment'>{-
<a name="line-1416"></a>************************************************************************
<a name="line-1417"></a>*                                                                      *
<a name="line-1418"></a>                   Substitution of coercions
<a name="line-1419"></a>*                                                                      *
<a name="line-1420"></a>************************************************************************
<a name="line-1421"></a>-}</span>
<a name="line-1422"></a>
<a name="line-1423"></a><a name="CvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Coercion's for 'CoVar's (OR 'TyVar's, when</span>
<a name="line-1424"></a><a name="CvSubstEnv"></a><span class='hs-comment'>--   doing a \"lifting\" substitution)</span>
<a name="line-1425"></a><a name="CvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1426"></a>
<a name="line-1427"></a><a name="emptyCvSubstEnv"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-1428"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1429"></a>
<a name="line-1430"></a><a name="CvSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-conid'>InScopeSet</span>  <span class='hs-comment'>-- The in-scope type variables</span>
<a name="line-1432"></a>            <span class='hs-conid'>TvSubstEnv</span>  <span class='hs-comment'>-- Substitution of types</span>
<a name="line-1433"></a>            <span class='hs-conid'>CvSubstEnv</span>  <span class='hs-comment'>-- Substitution of coercions</span>
<a name="line-1434"></a>
<a name="line-1435"></a><a name="instance%20Outputable%20CvSubst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-1436"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1437"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CvSubst"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1438"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"In scope:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1439"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type env:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-1440"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion env:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1441"></a>
<a name="line-1442"></a><a name="emptyCvSubst"></a><span class='hs-definition'>emptyCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1443"></a><span class='hs-definition'>emptyCvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="isEmptyCvSubst"></a><span class='hs-definition'>isEmptyCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1446"></a><span class='hs-definition'>isEmptyCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-1447"></a>
<a name="line-1448"></a><a name="getCvInScope"></a><span class='hs-definition'>getCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1449"></a><span class='hs-definition'>getCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-1450"></a>
<a name="line-1451"></a><a name="zapCvSubstEnv"></a><span class='hs-definition'>zapCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1452"></a><span class='hs-definition'>zapCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1453"></a>
<a name="line-1454"></a><a name="cvTvSubst"></a><span class='hs-definition'>cvTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span>
<a name="line-1455"></a><span class='hs-definition'>cvTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span>
<a name="line-1456"></a>
<a name="line-1457"></a><a name="tvCvSubst"></a><span class='hs-definition'>tvCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1458"></a><span class='hs-definition'>tvCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-1459"></a>
<a name="line-1460"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1461"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1462"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span>
<a name="line-1463"></a>
<a name="line-1464"></a><a name="extendTvSubstAndInScope"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1465"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1466"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1467"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1468"></a>            <span class='hs-varid'>cenv</span>
<a name="line-1469"></a>
<a name="line-1470"></a><a name="extendCvSubstAndInScope"></a><span class='hs-definition'>extendCvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1471"></a><span class='hs-comment'>-- Also extends the in-scope set</span>
<a name="line-1472"></a><span class='hs-definition'>extendCvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span>
<a name="line-1473"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1474"></a>            <span class='hs-varid'>tenv</span>
<a name="line-1475"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1476"></a>
<a name="line-1477"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-1478"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-1479"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-1480"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-1481"></a>  <span class='hs-keyword'>where</span>
<a name="line-1482"></a>    <span class='hs-comment'>-- When we substitute (co :: t1 ~ t2) we may get the identity (co :: t ~ t)</span>
<a name="line-1483"></a>    <span class='hs-comment'>-- In that case, mkCoVarCo will return a ReflCoercion, and</span>
<a name="line-1484"></a>    <span class='hs-comment'>-- we want to substitute that (not new_var) for old_var</span>
<a name="line-1485"></a>    <span class='hs-varid'>new_co</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-1486"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>new_co</span><span class='hs-layout'>)</span>
<a name="line-1487"></a>
<a name="line-1488"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-1489"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_co</span>
<a name="line-1490"></a>
<a name="line-1491"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_old_var</span>
<a name="line-1492"></a>    <span class='hs-varid'>subst_old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1493"></a>                  <span class='hs-comment'>-- It's important to do the substitution for coercions,</span>
<a name="line-1494"></a>                  <span class='hs-comment'>-- because they can have free type variables</span>
<a name="line-1495"></a>
<a name="line-1496"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-1497"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-1498"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span> <span class='hs-keyword'>of</span>
<a name="line-1499"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tenv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope'</span> <span class='hs-varid'>tenv'</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>
<a name="line-1501"></a><a name="mkCvSubst"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Var</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1502"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span>
<a name="line-1503"></a>
<a name="line-1504"></a><a name="zipOpenCvSubst"></a><span class='hs-definition'>zipOpenCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubst</span>
<a name="line-1505"></a><span class='hs-definition'>zipOpenCvSubst</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>cos</span>
<a name="line-1506"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1507"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"zipOpenCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyCvSubst</span>
<a name="line-1508"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1509"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipVarEnv</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1510"></a>
<a name="line-1511"></a><a name="substCoWithTy"></a><span class='hs-definition'>substCoWithTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1512"></a><span class='hs-definition'>substCoWithTy</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoWithTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-1513"></a>
<a name="line-1514"></a><a name="substCoWithTys"></a><span class='hs-definition'>substCoWithTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1515"></a><span class='hs-definition'>substCoWithTys</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>co</span>
<a name="line-1516"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1517"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTrace</span> <span class='hs-str'>"substCoWithTys"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1518"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1519"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>==</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-1520"></a>    <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipVarEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="substCo"></a><span class='hs-comment'>-- | Substitute within a 'Coercion'</span>
<a name="line-1523"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1524"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1525"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-1526"></a>
<a name="line-1527"></a><a name="substCos"></a><span class='hs-comment'>-- | Substitute within several 'Coercion's</span>
<a name="line-1528"></a><span class='hs-definition'>substCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1529"></a><span class='hs-definition'>substCos</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span>
<a name="line-1530"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-1531"></a>
<a name="line-1532"></a><a name="substTy"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1533"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>cvTvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-1534"></a>
<a name="line-1535"></a><a name="subst_co"></a><span class='hs-definition'>subst_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1536"></a><span class='hs-definition'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-1537"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1538"></a>  <span class='hs-keyword'>where</span>
<a name="line-1539"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1540"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span>
<a name="line-1541"></a>
<a name="line-1542"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1543"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-1544"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-1545"></a>                                  <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-1546"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-1547"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1548"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1549"></a>                                   <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span>
<a name="line-1550"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-1551"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-1552"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty2</span>
<a name="line-1553"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1554"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1555"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1556"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1557"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span>
<a name="line-1558"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1559"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ts1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>ts</span>
<a name="line-1560"></a>                                     <span class='hs-varid'>cs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-1561"></a>                                 <span class='hs-keyword'>in</span> <span class='hs-varid'>ts1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>cs1</span> <span class='hs-varop'>`seqList`</span>
<a name="line-1562"></a>                                    <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts1</span> <span class='hs-varid'>cs1</span>
<a name="line-1563"></a>
<a name="line-1564"></a>
<a name="line-1565"></a>
<a name="line-1566"></a><a name="substCoVar"></a><span class='hs-definition'>substCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1567"></a><span class='hs-definition'>substCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-1568"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1569"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv1</span> <span class='hs-layout'>)</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv1</span>
<a name="line-1570"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"substCoVar not in scope"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>                <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-1572"></a>
<a name="line-1573"></a><a name="substCoVars"></a><span class='hs-definition'>substCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1574"></a><span class='hs-definition'>substCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-1575"></a>
<a name="line-1576"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-1577"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-1578"></a>
<a name="line-1579"></a><a name="lookupCoVar"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1580"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>CvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span>
<a name="line-1581"></a>
<a name="line-1582"></a><span class='hs-comment'>{-
<a name="line-1583"></a>************************************************************************
<a name="line-1584"></a>*                                                                      *
<a name="line-1585"></a>                   "Lifting" substitution
<a name="line-1586"></a>           [(TyVar,Coercion)] -&gt; Type -&gt; Coercion
<a name="line-1587"></a>*                                                                      *
<a name="line-1588"></a>************************************************************************
<a name="line-1589"></a>
<a name="line-1590"></a>Note [Lifting coercions over types: liftCoSubst]
<a name="line-1591"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1592"></a>The KPUSH rule deals with this situation
<a name="line-1593"></a>   data T a = MkK (a -&gt; Maybe a)
<a name="line-1594"></a>   g :: T t1 ~ K t2
<a name="line-1595"></a>   x :: t1 -&gt; Maybe t1
<a name="line-1596"></a>
<a name="line-1597"></a>   case (K @t1 x) |&gt; g of
<a name="line-1598"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1599"></a>
<a name="line-1600"></a>We want to push the coercion inside the constructor application.
<a name="line-1601"></a>So we do this
<a name="line-1602"></a>
<a name="line-1603"></a>   g' :: t1~t2  =  Nth 0 g
<a name="line-1604"></a>
<a name="line-1605"></a>   case K @t2 (x |&gt; g' -&gt; Maybe g') of
<a name="line-1606"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1607"></a>
<a name="line-1608"></a>The crucial operation is that we
<a name="line-1609"></a>  * take the type of K's argument: a -&gt; Maybe a
<a name="line-1610"></a>  * and substitute g' for a
<a name="line-1611"></a>thus giving *coercion*.  This is what liftCoSubst does.
<a name="line-1612"></a>
<a name="line-1613"></a>Note [Substituting kinds in liftCoSubst]
<a name="line-1614"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1615"></a>We need to take care with kind polymorphism.  Suppose
<a name="line-1616"></a>  K :: forall k (a:k). (forall b:k. a -&gt; b) -&gt; T k a
<a name="line-1617"></a>
<a name="line-1618"></a>Now given  (K @kk1 @ty1 v) |&gt; g) where
<a name="line-1619"></a>  g :: T kk1 ty1 ~ T kk2 ty2
<a name="line-1620"></a>we want to compute
<a name="line-1621"></a>   (forall b:k a-&gt;b) [ Nth 0 g/k, Nth 1 g/a ]
<a name="line-1622"></a>Notice that we MUST substitute for 'k'; this happens in
<a name="line-1623"></a>liftCoSubstTyVarBndr.  But what should we substitute?
<a name="line-1624"></a>We need to take b's kind 'k' and return a Kind, not a Coercion!
<a name="line-1625"></a>
<a name="line-1626"></a>Happily we can do this because we know that all kind coercions
<a name="line-1627"></a>((Nth 0 g) in this case) are Refl.  So we need a special purpose
<a name="line-1628"></a>   subst_kind: LiftCoSubst -&gt; Kind -&gt; Kind
<a name="line-1629"></a>that expects a Refl coercion (or something equivalent to Refl)
<a name="line-1630"></a>when it looks up a kind variable.
<a name="line-1631"></a>-}</span>
<a name="line-1632"></a>
<a name="line-1633"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1634"></a><span class='hs-comment'>-- See Note [Lifting coercions over types: liftCoSubst]</span>
<a name="line-1635"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1636"></a>
<a name="line-1637"></a><a name="LiftCoSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LCS</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1638"></a>
<a name="line-1639"></a><a name="LiftCoEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1640"></a>     <span class='hs-comment'>-- Maps *type variables* to *coercions*</span>
<a name="line-1641"></a>     <span class='hs-comment'>-- That's the whole point of this function!</span>
<a name="line-1642"></a>
<a name="line-1643"></a><a name="liftCoSubstWith"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1644"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>ty</span>
<a name="line-1645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWith"</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1646"></a>
<a name="line-1647"></a><a name="liftCoSubst"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1648"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>prs</span> <span class='hs-varid'>ty</span>
<a name="line-1649"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>prs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1650"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1651"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1652"></a>
<a name="line-1653"></a><span class='hs-comment'>-- | The \"lifting\" operation which substitutes coercions for type</span>
<a name="line-1654"></a><span class='hs-comment'>--   variables in a type to produce a coercion.</span>
<a name="line-1655"></a><span class='hs-comment'>--</span>
<a name="line-1656"></a><span class='hs-comment'>--   For the inverse operation, see 'liftCoMatch'</span>
<a name="line-1657"></a>
<a name="line-1658"></a><a name="ty_co_subst"></a><span class='hs-comment'>-- The Role parameter is the _desired_ role</span>
<a name="line-1659"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1660"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-1661"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-1662"></a>  <span class='hs-keyword'>where</span>
<a name="line-1663"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span>
<a name="line-1664"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tv</span>
<a name="line-1665"></a>                                <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1666"></a>                             <span class='hs-comment'>-- A type variable from a non-cloned forall</span>
<a name="line-1667"></a>                             <span class='hs-comment'>-- won't be in the substitution</span>
<a name="line-1668"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1669"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span>
<a name="line-1670"></a>                                           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1671"></a>                           <span class='hs-comment'>-- IA0_NOTE: Do we need to do anything</span>
<a name="line-1672"></a>                           <span class='hs-comment'>-- about kind instantiations? I don't think</span>
<a name="line-1673"></a>                           <span class='hs-comment'>-- so.  see Note [Kind coercions]</span>
<a name="line-1674"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-1675"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v'</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1676"></a>                         <span class='hs-keyword'>where</span>
<a name="line-1677"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-1678"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>role</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-1679"></a>                                <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-1680"></a>
<a name="line-1681"></a>    <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"lift_phantom"</span><span class='hs-layout'>)</span>
<a name="line-1682"></a>                               <span class='hs-conid'>Phantom</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstLeft</span>  <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1683"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstRight</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1684"></a>
<a name="line-1685"></a><span class='hs-comment'>{-
<a name="line-1686"></a>Note [liftCoSubstTyVar]
<a name="line-1687"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1688"></a>This function can fail (i.e., return Nothing) for two separate reasons:
<a name="line-1689"></a> 1) The variable is not in the substutition
<a name="line-1690"></a> 2) The coercion found is of too low a role
<a name="line-1691"></a>
<a name="line-1692"></a>liftCoSubstTyVar is called from two places: in liftCoSubst (naturally), and
<a name="line-1693"></a>also in matchAxiom in OptCoercion. From liftCoSubst, the so-called lifting
<a name="line-1694"></a>lemma guarantees that the roles work out. If we fail for reason 2) in this
<a name="line-1695"></a>case, we really should panic -- something is deeply wrong. But, in matchAxiom,
<a name="line-1696"></a>failing for reason 2) is fine. matchAxiom is trying to find a set of coercions
<a name="line-1697"></a>that match, but it may fail, and this is healthy behavior. Bottom line: if
<a name="line-1698"></a>you find that liftCoSubst is doing weird things (like leaving out-of-scope
<a name="line-1699"></a>variables lying around), disable coercion optimization (bypassing matchAxiom)
<a name="line-1700"></a>and use downgradeRole instead of downgradeRole_maybe. The panic will then happen,
<a name="line-1701"></a>and you may learn something useful.
<a name="line-1702"></a>-}</span>
<a name="line-1703"></a>
<a name="line-1704"></a><a name="liftCoSubstTyVar"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1705"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv</span>
<a name="line-1706"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv</span>
<a name="line-1707"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span>   <span class='hs-comment'>-- could theoretically take this as</span>
<a name="line-1708"></a>                                         <span class='hs-comment'>-- a parameter, but painful</span>
<a name="line-1709"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co_role</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- see Note [liftCoSubstTyVar]</span>
<a name="line-1710"></a>
<a name="line-1711"></a><a name="liftCoSubstTyVarBndr"></a><span class='hs-definition'>liftCoSubstTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftCoSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-1712"></a><span class='hs-definition'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-1713"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-1714"></a>  <span class='hs-keyword'>where</span>
<a name="line-1715"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-1716"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1717"></a>
<a name="line-1718"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-1719"></a>
<a name="line-1720"></a>    <span class='hs-varid'>new_var1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-1721"></a>
<a name="line-1722"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-1723"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-1724"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var1</span>
<a name="line-1725"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>new_var1</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_kind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>
<a name="line-1727"></a><a name="liftCoSubstLeft"></a><span class='hs-comment'>-- map every variable to the type on the *left* of its mapped coercion</span>
<a name="line-1728"></a><span class='hs-definition'>liftCoSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1729"></a><span class='hs-definition'>liftCoSubstLeft</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1731"></a>
<a name="line-1732"></a><a name="liftCoSubstRight"></a><span class='hs-comment'>-- same, but to the type on the right</span>
<a name="line-1733"></a><span class='hs-definition'>liftCoSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1734"></a><span class='hs-definition'>liftCoSubstRight</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1736"></a>
<a name="line-1737"></a><a name="subst_kind"></a><span class='hs-definition'>subst_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-1738"></a><span class='hs-comment'>-- See Note [Substituting kinds in liftCoSubst]</span>
<a name="line-1739"></a><span class='hs-definition'>subst_kind</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span>
<a name="line-1740"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>kind</span>
<a name="line-1741"></a>  <span class='hs-keyword'>where</span>
<a name="line-1742"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-1743"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_kv</span> <span class='hs-varid'>kv</span>
<a name="line-1744"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-1745"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-1746"></a>
<a name="line-1747"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1748"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1749"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>liftCoSubstTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1750"></a>                              <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1751"></a>                                 <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv'</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_kind</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1752"></a>
<a name="line-1753"></a>    <span class='hs-varid'>subst_kv</span> <span class='hs-varid'>kv</span>
<a name="line-1754"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>kv</span>
<a name="line-1755"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1756"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>pFst</span> <span class='hs-varid'>co_kind</span> <span class='hs-varop'>`eqKind`</span> <span class='hs-varid'>pSnd</span> <span class='hs-varid'>co_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-layout'>)</span>
<a name="line-1757"></a>        <span class='hs-varid'>pFst</span> <span class='hs-varid'>co_kind</span>
<a name="line-1758"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1759"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>kv</span>
<a name="line-1760"></a>
<a name="line-1761"></a><a name="liftCoMatch"></a><span class='hs-comment'>-- | 'liftCoMatch' is sort of inverse to 'liftCoSubst'.  In particular, if</span>
<a name="line-1762"></a><span class='hs-comment'>--   @liftCoMatch vars ty co == Just s@, then @tyCoSubst s ty == co@.</span>
<a name="line-1763"></a><span class='hs-comment'>--   That is, it matches a type against a coercion of the same</span>
<a name="line-1764"></a><span class='hs-comment'>--   "shape", and returns a lifting substitution which could have been</span>
<a name="line-1765"></a><span class='hs-comment'>--   used to produce the given coercion from the given type.</span>
<a name="line-1766"></a><span class='hs-definition'>liftCoMatch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoSubst</span>
<a name="line-1767"></a><span class='hs-definition'>liftCoMatch</span> <span class='hs-varid'>tmpls</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1768"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1769"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCS</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-1770"></a>      <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1771"></a>  <span class='hs-keyword'>where</span>
<a name="line-1772"></a>    <span class='hs-varid'>menv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ME</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpls</span><span class='hs-layout'>,</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRnEnv2</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>}</span>
<a name="line-1773"></a>    <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpls</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1774"></a>    <span class='hs-comment'>-- Like tcMatchTy, assume all the interesting variables</span>
<a name="line-1775"></a>    <span class='hs-comment'>-- in ty are in tmpls</span>
<a name="line-1776"></a>
<a name="line-1777"></a><a name="ty_co_match"></a><span class='hs-comment'>-- | 'ty_co_match' does all the actual work for 'liftCoMatch'.</span>
<a name="line-1778"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1779"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1780"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-1781"></a>
<a name="line-1782"></a>  <span class='hs-comment'>-- Match a type variable against a non-refl coercion</span>
<a name="line-1783"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>cenv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1784"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv1'</span>      <span class='hs-comment'>-- tv1' is already bound to co1</span>
<a name="line-1785"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>coreEqCoercion2</span> <span class='hs-layout'>(</span><span class='hs-varid'>nukeRnEnvL</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co</span>
<a name="line-1786"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cenv</span>
<a name="line-1787"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>       <span class='hs-comment'>-- no match since tv1 matches two different coercions</span>
<a name="line-1788"></a>
<a name="line-1789"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv1'</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>me_tmpls</span> <span class='hs-varid'>menv</span>           <span class='hs-comment'>-- tv1' is a template var</span>
<a name="line-1790"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>inRnEnvR</span> <span class='hs-varid'>rn_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1791"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>      <span class='hs-comment'>-- occurs check failed</span>
<a name="line-1792"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>tv1'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1793"></a>        <span class='hs-comment'>-- BAY: I don't think we need to do any kind matching here yet</span>
<a name="line-1794"></a>        <span class='hs-comment'>-- (compare 'match'), but we probably will when moving to SHE.</span>
<a name="line-1795"></a>
<a name="line-1796"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-comment'>-- tv1 is not a template ty var, so the only thing it</span>
<a name="line-1797"></a>                 <span class='hs-comment'>-- can match is a reflexivity coercion for itself.</span>
<a name="line-1798"></a>                 <span class='hs-comment'>-- But that case is dealt with already</span>
<a name="line-1799"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1800"></a>
<a name="line-1801"></a>  <span class='hs-keyword'>where</span>
<a name="line-1802"></a>    <span class='hs-varid'>rn_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span>
<a name="line-1803"></a>    <span class='hs-varid'>tv1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnOccL</span> <span class='hs-varid'>rn_env</span> <span class='hs-varid'>tv1</span>
<a name="line-1804"></a>
<a name="line-1805"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1806"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co</span>      <span class='hs-comment'>-- c.f. Unify.match on AppTy</span>
<a name="line-1807"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>co1</span>
<a name="line-1808"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>co2</span> <span class='hs-layout'>}</span>
<a name="line-1809"></a>
<a name="line-1810"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1811"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1812"></a>
<a name="line-1813"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>==</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>cos</span>
<a name="line-1815"></a>
<a name="line-1816"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1817"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv'</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1818"></a>  <span class='hs-keyword'>where</span>
<a name="line-1819"></a>    <span class='hs-varid'>menv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>menv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>me_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnBndr2</span> <span class='hs-layout'>(</span><span class='hs-varid'>me_env</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>}</span>
<a name="line-1820"></a>
<a name="line-1821"></a><span class='hs-definition'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1822"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushRefl</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co'</span>
<a name="line-1823"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1824"></a>
<a name="line-1825"></a><a name="ty_co_matches"></a><span class='hs-definition'>ty_co_matches</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MatchEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1826"></a><span class='hs-definition'>ty_co_matches</span> <span class='hs-varid'>menv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matchList</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_match</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span>
<a name="line-1827"></a>
<a name="line-1828"></a><a name="pushRefl"></a><span class='hs-definition'>pushRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1829"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1830"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1831"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1833"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1834"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1835"></a><span class='hs-definition'>pushRefl</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1836"></a><span class='hs-definition'>pushRefl</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1837"></a>
<a name="line-1838"></a><span class='hs-comment'>{-
<a name="line-1839"></a>************************************************************************
<a name="line-1840"></a>*                                                                      *
<a name="line-1841"></a>            Sequencing on coercions
<a name="line-1842"></a>*                                                                      *
<a name="line-1843"></a>************************************************************************
<a name="line-1844"></a>-}</span>
<a name="line-1845"></a>
<a name="line-1846"></a><a name="seqCo"></a><span class='hs-definition'>seqCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1847"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-1848"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>eq</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1849"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1850"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1851"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-1852"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1853"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>s</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty2</span>
<a name="line-1854"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1855"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-1856"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1857"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1858"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-1859"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-1860"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqTypes</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cs</span>
<a name="line-1861"></a>
<a name="line-1862"></a><a name="seqCos"></a><span class='hs-definition'>seqCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-1863"></a><span class='hs-definition'>seqCos</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-1864"></a><span class='hs-definition'>seqCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-1865"></a>
<a name="line-1866"></a><span class='hs-comment'>{-
<a name="line-1867"></a>************************************************************************
<a name="line-1868"></a>*                                                                      *
<a name="line-1869"></a>             The kind of a type, and of a coercion
<a name="line-1870"></a>*                                                                      *
<a name="line-1871"></a>************************************************************************
<a name="line-1872"></a>
<a name="line-1873"></a>Note [Computing a coercion kind and role]
<a name="line-1874"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1875"></a>To compute a coercion's kind is straightforward: see coercionKind.
<a name="line-1876"></a>But to compute a coercion's role, in the case for NthCo we need
<a name="line-1877"></a>its kind as well.  So if we have two separate functions (one for kinds
<a name="line-1878"></a>and one for roles) we can get exponentially bad behaviour, since each
<a name="line-1879"></a>NthCo node makes a separate call to coercionKind, which traverses the
<a name="line-1880"></a>sub-tree again.  This was part of the problem in Trac #9233.
<a name="line-1881"></a>
<a name="line-1882"></a>Solution: compute both together; hence coercionKindRole.  We keep a
<a name="line-1883"></a>separate coercionKind function because it's a bit more efficient if
<a name="line-1884"></a>the kind is all you want.
<a name="line-1885"></a>-}</span>
<a name="line-1886"></a>
<a name="line-1887"></a><a name="coercionType"></a><span class='hs-definition'>coercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1888"></a><span class='hs-definition'>coercionType</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1889"></a>                    <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1890"></a>
<a name="line-1891"></a><span class='hs-comment'>------------------</span>
<a name="line-1892"></a><span class='hs-comment'>-- | If it is the case that</span>
<a name="line-1893"></a><span class='hs-comment'>--</span>
<a name="line-1894"></a><span class='hs-comment'>-- &gt; c :: (t1 ~ t2)</span>
<a name="line-1895"></a><span class='hs-comment'>--</span>
<a name="line-1896"></a><span class='hs-comment'>-- i.e. the kind of @c@ relates @t1@ and @t2@, then @coercionKind c = Pair t1 t2@.</span>
<a name="line-1897"></a>
<a name="line-1898"></a><a name="coercionKind"></a><span class='hs-definition'>coercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-1899"></a><span class='hs-definition'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1900"></a>  <span class='hs-keyword'>where</span>
<a name="line-1901"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-1902"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1903"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-1904"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1905"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toPair</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-1906"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1907"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-1908"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceA</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1909"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- Invariant of AxiomInstCo: cos should</span>
<a name="line-1910"></a>                                         <span class='hs-comment'>-- exactly saturate the axiom branch</span>
<a name="line-1911"></a>        <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1912"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys2</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1913"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1914"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1915"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1916"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1917"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitAppTy</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1918"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>aco</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>aco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-1919"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1920"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1921"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1922"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-1923"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"coercionKind: Malformed coercion"</span>
<a name="line-1924"></a>
<a name="line-1925"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-1926"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-1927"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-1928"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1929"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>             <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`applyTys`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1930"></a>
<a name="line-1931"></a><a name="coercionKinds"></a><span class='hs-comment'>-- | Apply 'coercionKind' to multiple 'Coercion's</span>
<a name="line-1932"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-1933"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>tys</span>
<a name="line-1934"></a>
<a name="line-1935"></a><a name="coercionKindRole"></a><span class='hs-comment'>-- | Get a coercion's kind and role.</span>
<a name="line-1936"></a><span class='hs-comment'>-- Why both at once?  See Note [Computing a coercion kind and role]</span>
<a name="line-1937"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-1938"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-1939"></a>  <span class='hs-keyword'>where</span>
<a name="line-1940"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1941"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1942"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1943"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1944"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>in</span>
<a name="line-1945"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r1</span><span class='hs-layout'>)</span>
<a name="line-1946"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1947"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>in</span>
<a name="line-1948"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1949"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>toPair</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>cv</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-1950"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-1951"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1952"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>first</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1953"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1954"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>in</span>
<a name="line-1955"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1956"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1957"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-1958"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>args1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>t1</span>
<a name="line-1959"></a>            <span class='hs-layout'>(</span><span class='hs-sel'>_tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>t2</span>
<a name="line-1960"></a>        <span class='hs-keyword'>in</span>
<a name="line-1961"></a>        <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-sel'>_tc2</span> <span class='hs-layout'>)</span>
<a name="line-1962"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`getNth`</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>args1</span> <span class='hs-varid'>args2</span><span class='hs-layout'>,</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-1963"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-1964"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-1965"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-1966"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span>
<a name="line-1967"></a>
<a name="line-1968"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-1969"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-1970"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-1971"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1972"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>             <span class='hs-varid'>tys</span>
<a name="line-1973"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>pair</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>in</span>
<a name="line-1974"></a>        <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>`applyTys`</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>pair</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-1975"></a>
<a name="line-1976"></a><a name="coercionRole"></a><span class='hs-comment'>-- | Retrieve the role from a coercion.</span>
<a name="line-1977"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1978"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>coercionKindRole</span>
<a name="line-1979"></a>  <span class='hs-comment'>-- There's not a better way to do this, because NthCo needs the *kind*</span>
<a name="line-1980"></a>  <span class='hs-comment'>-- and role of its argument. Luckily, laziness should generally avoid</span>
<a name="line-1981"></a>  <span class='hs-comment'>-- the need for computing kinds in other cases.</span>
<a name="line-1982"></a>
<a name="line-1983"></a><span class='hs-comment'>{-
<a name="line-1984"></a>Note [Nested InstCos]
<a name="line-1985"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1986"></a>In Trac #5631 we found that 70% of the entire compilation time was
<a name="line-1987"></a>being spent in coercionKind!  The reason was that we had
<a name="line-1988"></a>   (g @ ty1 @ ty2 .. @ ty100)    -- The "@s" are InstCos
<a name="line-1989"></a>where
<a name="line-1990"></a>   g :: forall a1 a2 .. a100. phi
<a name="line-1991"></a>If we deal with the InstCos one at a time, we'll do this:
<a name="line-1992"></a>   1.  Find the kind of (g @ ty1 .. @ ty99) : forall a100. phi'
<a name="line-1993"></a>   2.  Substitute phi'[ ty100/a100 ], a single tyvar-&gt;type subst
<a name="line-1994"></a>But this is a *quadratic* algorithm, and the blew up Trac #5631.
<a name="line-1995"></a>So it's very important to do the substitution simultaneously.
<a name="line-1996"></a>
<a name="line-1997"></a>cf Type.applyTys (which in fact we call here)
<a name="line-1998"></a>-}</span>
<a name="line-1999"></a>
<a name="line-2000"></a><a name="applyCo"></a><span class='hs-definition'>applyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2001"></a><span class='hs-comment'>-- Gives the type of (e co) where e :: (a~b) =&gt; ty</span>
<a name="line-2002"></a><span class='hs-definition'>applyCo</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>applyCo</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-2003"></a><span class='hs-definition'>applyCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2004"></a><span class='hs-definition'>applyCo</span> <span class='hs-keyword'>_</span>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"applyCo"</span>
<a name="line-2005"></a>
<a name="line-2006"></a><span class='hs-comment'>{-
<a name="line-2007"></a>Note [Kind coercions]
<a name="line-2008"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-2009"></a>Kind coercions are only of the form: Refl kind. They are only used to
<a name="line-2010"></a>instantiate kind polymorphic type constructors in TyConAppCo. Remember
<a name="line-2011"></a>that kind instantiation only happens with TyConApp, not AppTy.
<a name="line-2012"></a>-}</span>
</pre></body>
</html>
