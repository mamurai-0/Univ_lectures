<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSMonad.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- Type definitions for the constraint solver</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSMonad</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>
<a name="line-6"></a>    <span class='hs-comment'>-- The work list</span>
<a name="line-7"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span>
<a name="line-9"></a>    <span class='hs-varid'>extendWorkListCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>appendWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>selectWorkItem</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-varid'>workListSize</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS_return</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>runFlatten</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitFlatWork</span><span class='hs-layout'>,</span>
<a name="line-13"></a>
<a name="line-14"></a>    <span class='hs-comment'>-- The TcS monad</span>
<a name="line-15"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSWithEvBinds</span><span class='hs-layout'>,</span>
<a name="line-16"></a>    <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>recoverTcS</span><span class='hs-layout'>,</span>
<a name="line-17"></a>
<a name="line-18"></a>    <span class='hs-varid'>runTcPluginTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedRdrNamesTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>deferTcSForAllEq</span><span class='hs-layout'>,</span>
<a name="line-19"></a>
<a name="line-20"></a>    <span class='hs-comment'>-- Tracing etc</span>
<a name="line-21"></a>    <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span>
<a name="line-22"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>csTraceTcS</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>    <span class='hs-comment'>-- Evidence creation and transformation</span>
<a name="line-26"></a>    <span class='hs-conid'>XEvTerm</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>    <span class='hs-conid'>Freshness</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshGoals</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFresh</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>    <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVarNC</span><span class='hs-layout'>,</span>
<a name="line-30"></a>    <span class='hs-varid'>setWantedTyBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportUnifications</span><span class='hs-layout'>,</span>
<a name="line-31"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span>
<a name="line-32"></a>    <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVars</span><span class='hs-layout'>,</span>
<a name="line-33"></a>    <span class='hs-varid'>newDerived</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewDerived</span><span class='hs-layout'>,</span>
<a name="line-34"></a>    <span class='hs-varid'>instDFunConstraints</span><span class='hs-layout'>,</span>
<a name="line-35"></a>
<a name="line-36"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-37"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcLevel</span><span class='hs-layout'>,</span>
<a name="line-38"></a>    <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- Inerts</span>
<a name="line-41"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-42"></a>    <span class='hs-varid'>updInertTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertIrreds</span><span class='hs-layout'>,</span>
<a name="line-43"></a>    <span class='hs-varid'>getNoGivenEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>emptyInert</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcSInerts</span><span class='hs-layout'>,</span>
<a name="line-45"></a>    <span class='hs-varid'>getUnsolvedInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkAllSolved</span><span class='hs-layout'>,</span>
<a name="line-46"></a>    <span class='hs-varid'>splitInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeInertCts</span><span class='hs-layout'>,</span>
<a name="line-47"></a>    <span class='hs-varid'>prepareInertsForImplications</span><span class='hs-layout'>,</span>
<a name="line-48"></a>    <span class='hs-varid'>addInertCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertInertItemTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertFunEq</span><span class='hs-layout'>,</span>
<a name="line-49"></a>    <span class='hs-varid'>emitInsoluble</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWorkNC</span><span class='hs-layout'>,</span>
<a name="line-50"></a>    <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-comment'>-- Inert CDictCans</span>
<a name="line-53"></a>    <span class='hs-varid'>lookupInertDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>delDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionDicts</span><span class='hs-layout'>,</span>
<a name="line-54"></a>
<a name="line-55"></a>    <span class='hs-comment'>-- Inert CTyEqCans</span>
<a name="line-56"></a>    <span class='hs-varid'>findTyEqs</span><span class='hs-layout'>,</span>
<a name="line-57"></a>
<a name="line-58"></a>    <span class='hs-comment'>-- Inert solved dictionaries</span>
<a name="line-59"></a>    <span class='hs-varid'>addSolvedDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupSolvedDict</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-comment'>-- The flattening cache</span>
<a name="line-62"></a>    <span class='hs-varid'>lookupFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>newFlattenSkolem</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Flatten skolems</span>
<a name="line-63"></a>
<a name="line-64"></a>    <span class='hs-comment'>-- Inert CFunEqCans</span>
<a name="line-65"></a>    <span class='hs-varid'>updInertFunEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>findFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>sizeFunEqMap</span><span class='hs-layout'>,</span>
<a name="line-66"></a>    <span class='hs-varid'>findFunEqsByTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>findFunEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>partitionFunEqs</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>    <span class='hs-varid'>instDFunType</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-69"></a>
<a name="line-70"></a>    <span class='hs-comment'>-- MetaTyVars</span>
<a name="line-71"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiTcSHelperTcS</span><span class='hs-layout'>,</span>
<a name="line-72"></a>    <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>demoteUnfilledFmv</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>    <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTouchableMetaTyVarTcS</span><span class='hs-layout'>,</span>
<a name="line-75"></a>    <span class='hs-varid'>isFilledMetaTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-76"></a>    <span class='hs-varid'>zonkTyVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkSimples</span><span class='hs-layout'>,</span>
<a name="line-77"></a>
<a name="line-78"></a>    <span class='hs-comment'>-- References</span>
<a name="line-79"></a>    <span class='hs-varid'>newTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>updTcRef</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-comment'>-- Misc</span>
<a name="line-82"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGlobalRdrEnvTcS</span><span class='hs-layout'>,</span>
<a name="line-83"></a>    <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchFamTcM</span><span class='hs-layout'>,</span>
<a name="line-84"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span>
<a name="line-85"></a>    <span class='hs-varid'>pprEq</span>                                    <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-86"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the</span>
<a name="line-87"></a>                                             <span class='hs-comment'>-- instance matcher in TcSimplify. I am wondering</span>
<a name="line-88"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-89"></a>                                             <span class='hs-comment'>-- here</span>
<a name="line-90"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-104"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span> <span class='hs-layout'>)</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-109"></a>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span><span class='hs-conid'>RdrName</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>)</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RnEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>addUsedRdrNames</span><span class='hs-layout'>)</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-123"></a>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span> <span class='hs-layout'>(</span> <span class='hs-varid'>orElse</span><span class='hs-layout'>,</span> <span class='hs-varid'>firstJusts</span> <span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TrieMap</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span> <span class='hs-varid'>first</span> <span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-layout'>(</span> <span class='hs-varid'>ap</span><span class='hs-layout'>,</span> <span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadPlus</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldl'</span> <span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-142"></a><span class='hs-cpp'>#endif</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-comment'>{-
<a name="line-145"></a>************************************************************************
<a name="line-146"></a>*                                                                      *
<a name="line-147"></a>*                            Worklists                                *
<a name="line-148"></a>*  Canonical and non-canonical constraints that the simplifier has to  *
<a name="line-149"></a>*  work on. Including their simplification depths.                     *
<a name="line-150"></a>*                                                                      *
<a name="line-151"></a>*                                                                      *
<a name="line-152"></a>************************************************************************
<a name="line-153"></a>
<a name="line-154"></a>Note [WorkList priorities]
<a name="line-155"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-156"></a>A WorkList contains canonical and non-canonical items (of all flavors).
<a name="line-157"></a>Notice that each Ct now has a simplification depth. We may
<a name="line-158"></a>consider using this depth for prioritization as well in the future.
<a name="line-159"></a>
<a name="line-160"></a>As a simple form of priority queue, our worklist separates out
<a name="line-161"></a>equalities (wl_eqs) from the rest of the canonical constraints,
<a name="line-162"></a>so that it's easier to deal with them first, but the separation
<a name="line-163"></a>is not strictly necessary. Notice that non-canonical constraints
<a name="line-164"></a>are also parts of the worklist.
<a name="line-165"></a>
<a name="line-166"></a>Note [The flattening work list]
<a name="line-167"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-168"></a>The "flattening work list", held in the tcs_flat_work field of TcSEnv,
<a name="line-169"></a>is a list of CFunEqCans generated during flattening.  The key idea
<a name="line-170"></a>is this.  Consider flattening (Eq (F (G Int) (H Bool)):
<a name="line-171"></a>  * The flattener recursively calls itself on sub-terms before building
<a name="line-172"></a>    the main term, so it will encounter the terms in order
<a name="line-173"></a>              G Int
<a name="line-174"></a>              H Bool
<a name="line-175"></a>              F (G Int) (H Bool)
<a name="line-176"></a>    flattening to sub-goals
<a name="line-177"></a>              w1: G Int ~ fuv0
<a name="line-178"></a>              w2: H Bool ~ fuv1
<a name="line-179"></a>              w3: F fuv0 fuv1 ~ fuv2
<a name="line-180"></a>
<a name="line-181"></a>  * Processing w3 first is BAD, because we can't reduce i t,so it'll
<a name="line-182"></a>    get put into the inert set, and later kicked out when w1, w2 are
<a name="line-183"></a>    solved.  In Trac #9872 this led to inert sets containing hundreds
<a name="line-184"></a>    of suspended calls.
<a name="line-185"></a>
<a name="line-186"></a>  * So we want to process w1, w2 first.
<a name="line-187"></a>
<a name="line-188"></a>  * So you might think that we should just use a FIFO deque for the work-list,
<a name="line-189"></a>    so that putting adding goals in order w1,w2,w3 would mean we processed
<a name="line-190"></a>    w1 first.
<a name="line-191"></a>
<a name="line-192"></a>  * BUT suppose we have 'type instance G Int = H Char'.  Then processing
<a name="line-193"></a>    w1 leads to a new goal
<a name="line-194"></a>                w4: H Char ~ fuv0
<a name="line-195"></a>    We do NOT want to put that on the far end of a deque!  Instead we want
<a name="line-196"></a>    to put it at the *front* of the work-list so that we continue to work
<a name="line-197"></a>    on it.
<a name="line-198"></a>
<a name="line-199"></a>So the work-list structure is this:
<a name="line-200"></a>
<a name="line-201"></a>  * The wl_funeqs is a LIFO stack; we push new goals (such as w4) on
<a name="line-202"></a>    top (extendWorkListFunEq), and take new work from the top
<a name="line-203"></a>    (selectWorkItem).
<a name="line-204"></a>
<a name="line-205"></a>  * When flattening, emitFlatWork pushes new flattening goals (like
<a name="line-206"></a>    w1,w2,w3) onto the flattening work list, tcs_flat_work, another
<a name="line-207"></a>    push-down stack.
<a name="line-208"></a>
<a name="line-209"></a>  * When we finish flattening, we *reverse* the tcs_flat_work stack
<a name="line-210"></a>    onto the wl_funeqs stack (which brings w1 to the top).
<a name="line-211"></a>
<a name="line-212"></a>The function runFlatten initialised the tcs_flat_work stack, and reverses
<a name="line-213"></a>it onto wl_fun_eqs at the end.
<a name="line-214"></a>
<a name="line-215"></a>-}</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList priorities]</span>
<a name="line-218"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span>
<a name="line-219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-220"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- LIFO stack of goals</span>
<a name="line-221"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-222"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>  <span class='hs-comment'>-- See Note [Residual implications]</span>
<a name="line-223"></a>    <span class='hs-layout'>}</span>
<a name="line-224"></a>
<a name="line-225"></a><a name="appendWorkList"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-226"></a><span class='hs-definition'>appendWorkList</span>
<a name="line-227"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-228"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-229"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>eqs2</span>
<a name="line-230"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>funeqs2</span>
<a name="line-231"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>    <span class='hs-varop'>++</span> <span class='hs-varid'>rest2</span>
<a name="line-232"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-varop'>`unionBags`</span>   <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span>
<a name="line-233"></a>
<a name="line-234"></a>
<a name="line-235"></a><a name="workListSize"></a><span class='hs-definition'>workListSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-236"></a><span class='hs-definition'>workListSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-237"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rest</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-240"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-241"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="extendWorkListFunEq"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-244"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-248"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-249"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-250"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="extendWorkListImplic"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-253"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-varid'>implic</span> <span class='hs-varid'>wl</span>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-257"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-258"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-259"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-260"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-conid'>NomEq</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span>
<a name="line-261"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-262"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-263"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-264"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-265"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-266"></a>
<a name="line-267"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-268"></a>
<a name="line-269"></a><a name="extendWorkListCts"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-270"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-271"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-274"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span>
<a name="line-275"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-276"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-279"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-280"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-283"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-284"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs</span><span class='hs-layout'>,</span><span class='hs-varid'>feqs</span><span class='hs-layout'>,</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-285"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-286"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>fes</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fes</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-287"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-288"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-comment'>-- Pretty printing</span>
<a name="line-291"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span>
<a name="line-292"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span>
<a name="line-293"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-294"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WL"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span>
<a name="line-295"></a>     <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-296"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Eqs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-297"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-298"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Funeqs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span>
<a name="line-299"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-300"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Non-eqs ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-301"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-302"></a>            <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Implics ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-303"></a>          <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="emitFlatWork"></a><span class='hs-definition'>emitFlatWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-306"></a><span class='hs-comment'>-- See Note [The flattening work list]</span>
<a name="line-307"></a><span class='hs-definition'>emitFlatWork</span> <span class='hs-varid'>ct</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-309"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flat_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_flat_work</span> <span class='hs-varid'>env</span>
<a name="line-310"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-varid'>flat_ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-311"></a>
<a name="line-312"></a><a name="runFlatten"></a><span class='hs-definition'>runFlatten</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-313"></a><span class='hs-comment'>-- Run thing_inside (which does flattening), and put all</span>
<a name="line-314"></a><span class='hs-comment'>-- the work it generates onto the main work list</span>
<a name="line-315"></a><span class='hs-comment'>-- See Note [The flattening work list]</span>
<a name="line-316"></a><span class='hs-definition'>runFlatten</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-317"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-318"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>flat_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_flat_work</span> <span class='hs-varid'>env</span>
<a name="line-319"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>old_flats</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRefX</span> <span class='hs-varid'>flat_ref</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-320"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>env</span>
<a name="line-321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_flats</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRefX</span> <span class='hs-varid'>flat_ref</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>old_flats</span><span class='hs-layout'>)</span>
<a name="line-322"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_worklist</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_flats</span> <span class='hs-varid'>new_flats</span><span class='hs-layout'>)</span>
<a name="line-323"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-324"></a>  <span class='hs-keyword'>where</span>
<a name="line-325"></a>    <span class='hs-varid'>add_flats</span> <span class='hs-varid'>new_flats</span> <span class='hs-varid'>wl</span>
<a name="line-326"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_funeqs</span> <span class='hs-varid'>new_flats</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-327"></a>
<a name="line-328"></a>    <span class='hs-varid'>add_funeqs</span> <span class='hs-conid'>[]</span>     <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span>
<a name="line-329"></a>    <span class='hs-varid'>add_funeqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_funeqs</span> <span class='hs-varid'>fs</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>wl</span><span class='hs-layout'>)</span>
<a name="line-330"></a>      <span class='hs-comment'>-- add_funeqs fs ws = reverse fs ++ ws</span>
<a name="line-331"></a>      <span class='hs-comment'>-- e.g. add_funeqs [f1,f2,f3] [w1,w2,w3,w4]</span>
<a name="line-332"></a>      <span class='hs-comment'>--        = [f3,f2,f1,w1,w2,w3,w4]</span>
<a name="line-333"></a>
<a name="line-334"></a><span class='hs-comment'>{-
<a name="line-335"></a>************************************************************************
<a name="line-336"></a>*                                                                      *
<a name="line-337"></a>*                            Inert Sets                                *
<a name="line-338"></a>*                                                                      *
<a name="line-339"></a>*                                                                      *
<a name="line-340"></a>************************************************************************
<a name="line-341"></a>
<a name="line-342"></a>Note [Detailed InertCans Invariants]
<a name="line-343"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-344"></a>The InertCans represents a collection of constraints with the following properties:
<a name="line-345"></a>
<a name="line-346"></a>  * All canonical
<a name="line-347"></a>
<a name="line-348"></a>  * No two dictionaries with the same head
<a name="line-349"></a>  * No two CIrreds with the same type
<a name="line-350"></a>
<a name="line-351"></a>  * Family equations inert wrt top-level family axioms
<a name="line-352"></a>
<a name="line-353"></a>  * Dictionaries have no matching top-level instance
<a name="line-354"></a>
<a name="line-355"></a>  * Given family or dictionary constraints don't mention touchable
<a name="line-356"></a>    unification variables
<a name="line-357"></a>
<a name="line-358"></a>  * Non-CTyEqCan constraints are fully rewritten with respect
<a name="line-359"></a>    to the CTyEqCan equalities (modulo canRewrite of course;
<a name="line-360"></a>    eg a wanted cannot rewrite a given)
<a name="line-361"></a>
<a name="line-362"></a>  * CTyEqCan equalities: see Note [Applying the inert substitution]
<a name="line-363"></a>                         in TcFlatten
<a name="line-364"></a>
<a name="line-365"></a>Note [Type family equations]
<a name="line-366"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-367"></a>Type-family equations, of form (ev : F tys ~ ty), live in three places
<a name="line-368"></a>
<a name="line-369"></a>  * The work-list, of course
<a name="line-370"></a>
<a name="line-371"></a>  * The inert_flat_cache.  This is used when flattening, to get maximal
<a name="line-372"></a>    sharing.  It contains lots of things that are still in the work-list.
<a name="line-373"></a>    E.g Suppose we have (w1: F (G a) ~ Int), and (w2: H (G a) ~ Int) in the
<a name="line-374"></a>        work list.  Then we flatten w1, dumping (w3: G a ~ f1) in the work
<a name="line-375"></a>        list.  Now if we flatten w2 before we get to w3, we still want to
<a name="line-376"></a>        share that (G a).
<a name="line-377"></a>
<a name="line-378"></a>    Because it contains work-list things, DO NOT use the flat cache to solve
<a name="line-379"></a>    a top-level goal.  Eg in the above example we don't want to solve w3
<a name="line-380"></a>    using w3 itself!
<a name="line-381"></a>
<a name="line-382"></a>  * The inert_funeqs are un-solved but fully processed and in the InertCans.
<a name="line-383"></a>-}</span>
<a name="line-384"></a>
<a name="line-385"></a><a name="InertCans"></a><span class='hs-comment'>-- All Given (fully known) or Wanted or Derived</span>
<a name="line-386"></a><a name="InertCans"></a><span class='hs-comment'>-- See Note [Detailed InertCans Invariants] for more</span>
<a name="line-387"></a><a name="InertCans"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertCans</span>
<a name="line-388"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-389"></a>              <span class='hs-comment'>-- All CTyEqCans with NomEq; index is the LHS tyvar</span>
<a name="line-390"></a>
<a name="line-391"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span>
<a name="line-392"></a>              <span class='hs-comment'>-- All CFunEqCans; index is the whole family head type.</span>
<a name="line-393"></a>
<a name="line-394"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-395"></a>              <span class='hs-comment'>-- Dictionaries only, index is the class</span>
<a name="line-396"></a>              <span class='hs-comment'>-- NB: index is /not/ the whole type because FD reactions</span>
<a name="line-397"></a>              <span class='hs-comment'>-- need to match the class but not necessarily the whole type.</span>
<a name="line-398"></a>
<a name="line-399"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-400"></a>              <span class='hs-comment'>-- Irreducible predicates</span>
<a name="line-401"></a>
<a name="line-402"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-403"></a>              <span class='hs-comment'>-- Frozen errors (as non-canonicals)</span>
<a name="line-404"></a>       <span class='hs-layout'>}</span>
<a name="line-405"></a>
<a name="line-406"></a><a name="EqualCtList"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-407"></a><span class='hs-comment'>{-
<a name="line-408"></a>Note [EqualCtList invariants]
<a name="line-409"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-410"></a>    * All are equalities
<a name="line-411"></a>    * All these equalities have the same LHS
<a name="line-412"></a>    * The list is never empty
<a name="line-413"></a>    * No element of the list can rewrite any other
<a name="line-414"></a>
<a name="line-415"></a> From the fourth invariant it follows that the list is
<a name="line-416"></a>   - A single Given, or
<a name="line-417"></a>   - Any number of Wanteds and/or Deriveds
<a name="line-418"></a>-}</span>
<a name="line-419"></a>
<a name="line-420"></a><a name="InertSet"></a><span class='hs-comment'>-- The Inert Set</span>
<a name="line-421"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span>
<a name="line-422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-423"></a>              <span class='hs-comment'>-- Canonical Given, Wanted, Derived (no Solved)</span>
<a name="line-424"></a>              <span class='hs-comment'>-- Sometimes called "the inert set"</span>
<a name="line-425"></a>
<a name="line-426"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span>
<a name="line-427"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-428"></a>              <span class='hs-comment'>-- If    F tys :-&gt; (co, ty, ev),</span>
<a name="line-429"></a>              <span class='hs-comment'>-- then  co :: F tys ~ ty</span>
<a name="line-430"></a>              <span class='hs-comment'>--</span>
<a name="line-431"></a>              <span class='hs-comment'>-- Just a hash-cons cache for use when flattening only</span>
<a name="line-432"></a>              <span class='hs-comment'>-- These include entirely un-processed goals, so don't use</span>
<a name="line-433"></a>              <span class='hs-comment'>-- them to solve a top-level goal, else you may end up solving</span>
<a name="line-434"></a>              <span class='hs-comment'>-- (w:F ty ~ a) by setting w:=w!  We just use the flat-cache</span>
<a name="line-435"></a>              <span class='hs-comment'>-- when allocating a new flatten-skolem.</span>
<a name="line-436"></a>              <span class='hs-comment'>-- Not necessarily inert wrt top-level equations (or inert_cans)</span>
<a name="line-437"></a>
<a name="line-438"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-439"></a>              <span class='hs-comment'>-- Of form ev :: C t1 .. tn</span>
<a name="line-440"></a>              <span class='hs-comment'>-- Always the result of using a top-level instance declaration</span>
<a name="line-441"></a>              <span class='hs-comment'>-- - Used to avoid creating a new EvVar when we have a new goal</span>
<a name="line-442"></a>              <span class='hs-comment'>--   that we have solved in the past</span>
<a name="line-443"></a>              <span class='hs-comment'>-- - Stored not necessarily as fully rewritten</span>
<a name="line-444"></a>              <span class='hs-comment'>--   (ToDo: rewrite lazily when we lookup)</span>
<a name="line-445"></a>       <span class='hs-layout'>}</span>
<a name="line-446"></a>
<a name="line-447"></a><a name="instance%20Outputable%20InertCans"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyword'>where</span>
<a name="line-448"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Equalities:"</span><span class='hs-layout'>)</span>
<a name="line-449"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>eqs</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-450"></a>                                          <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-451"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Type-function equalities:"</span><span class='hs-layout'>)</span>
<a name="line-452"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>funEqsToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-453"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Dictionaries:"</span><span class='hs-layout'>)</span>
<a name="line-454"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-455"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Irreds:"</span><span class='hs-layout'>)</span>
<a name="line-456"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-457"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insolubles ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-comment'>-- Clearly print frozen errors</span>
<a name="line-458"></a>                    <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>bagToList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_insols</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-459"></a>                 <span class='hs-keyglyph'>]</span>
<a name="line-460"></a>
<a name="line-461"></a><a name="instance%20Outputable%20InertSet"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span>
<a name="line-462"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-463"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Solved dicts"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-464"></a>
<a name="line-465"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-466"></a><span class='hs-definition'>emptyInert</span>
<a name="line-467"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-468"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-469"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-470"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-471"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span>
<a name="line-472"></a>                         <span class='hs-layout'>}</span>
<a name="line-473"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-474"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDictMap</span> <span class='hs-layout'>}</span>
<a name="line-475"></a>
<a name="line-476"></a><a name="addInertCan"></a><span class='hs-comment'>---------------</span>
<a name="line-477"></a><span class='hs-definition'>addInertCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-478"></a><span class='hs-comment'>-- Precondition: item /is/ canonical</span>
<a name="line-479"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-480"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-481"></a>  <span class='hs-keyword'>where</span>
<a name="line-482"></a>    <span class='hs-varid'>add_eq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-483"></a>    <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_list</span> <span class='hs-varid'>it</span>
<a name="line-484"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv_C</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>old_eqs</span> <span class='hs-sel'>_new_eqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>it</span> <span class='hs-conop'>:</span> <span class='hs-varid'>old_eqs</span><span class='hs-layout'>)</span>
<a name="line-485"></a>                       <span class='hs-varid'>old_list</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyvar</span> <span class='hs-varid'>it</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span><span class='hs-keyglyph'>]</span>
<a name="line-486"></a>
<a name="line-487"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-488"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-489"></a>
<a name="line-490"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-491"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span> <span class='hs-varop'>`</span><span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>snocBag</span><span class='hs-varop'>`</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-492"></a>       <span class='hs-comment'>-- The 'False' is because the irreducible constraint might later instantiate</span>
<a name="line-493"></a>       <span class='hs-comment'>-- to an equality.</span>
<a name="line-494"></a>       <span class='hs-comment'>-- But since we try to simplify first, if there's a constraint function FC with</span>
<a name="line-495"></a>       <span class='hs-comment'>--    type instance FC Int = Show</span>
<a name="line-496"></a>       <span class='hs-comment'>-- we'll reduce a constraint (FC Int a) to Show a, and never add an inert irreducible</span>
<a name="line-497"></a>
<a name="line-498"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-499"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-500"></a>
<a name="line-501"></a><span class='hs-definition'>addInertCan</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-502"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"upd_inert set: can't happen! Inserting "</span> <span class='hs-varop'>$</span>
<a name="line-503"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Can't be CNonCanonical, CHoleCan,</span>
<a name="line-504"></a>               <span class='hs-comment'>-- because they only land in inert_insols</span>
<a name="line-505"></a>
<a name="line-506"></a><a name="insertInertItemTcS"></a><span class='hs-comment'>--------------</span>
<a name="line-507"></a><span class='hs-definition'>insertInertItemTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-508"></a><span class='hs-comment'>-- Add a new item in the inerts of the monad</span>
<a name="line-509"></a><span class='hs-definition'>insertInertItemTcS</span> <span class='hs-varid'>item</span>
<a name="line-510"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertItemTcS {"</span> <span class='hs-varop'>$</span>
<a name="line-511"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-512"></a>
<a name="line-513"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertCans</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addInertCan</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-514"></a>
<a name="line-515"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertItemTcS }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-516"></a>
<a name="line-517"></a><a name="addSolvedDict"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-518"></a><span class='hs-comment'>-- Add a new item in the solved set of the monad</span>
<a name="line-519"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-varid'>item</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-520"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never cache "solved" implicit parameters (not sure why!)</span>
<a name="line-521"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-522"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-523"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updSolvedSetTcs:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-524"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-525"></a>             <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-526"></a>
<a name="line-527"></a><a name="updInertTcS"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-528"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-529"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-varid'>upd_fn</span>
<a name="line-530"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-531"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-532"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>upd_fn</span> <span class='hs-varid'>curr_inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-533"></a>
<a name="line-534"></a><a name="getInertCans"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-535"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="setInertCans"></a><span class='hs-definition'>setInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-538"></a><span class='hs-definition'>setInertCans</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-539"></a>
<a name="line-540"></a><a name="updInertCans"></a><span class='hs-definition'>updInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-541"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-542"></a><span class='hs-definition'>updInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-543"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-544"></a>
<a name="line-545"></a><a name="updInertDicts"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-546"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-547"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-varid'>upd_fn</span>
<a name="line-548"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="updInertFunEqs"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-551"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-552"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-varid'>upd_fn</span>
<a name="line-553"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-554"></a>
<a name="line-555"></a><a name="updInertIrreds"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-556"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-557"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-varid'>upd_fn</span>
<a name="line-558"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-559"></a>
<a name="line-560"></a>
<a name="line-561"></a><a name="prepareInertsForImplications"></a><span class='hs-definition'>prepareInertsForImplications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-562"></a><span class='hs-comment'>-- See Note [Preparing inert set for implications]</span>
<a name="line-563"></a><span class='hs-definition'>prepareInertsForImplications</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cans</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getGivens</span> <span class='hs-varid'>cans</span>
<a name="line-565"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span> <span class='hs-layout'>}</span>  <span class='hs-comment'>-- See Note [Do not inherit the flat cache]</span>
<a name="line-566"></a>  <span class='hs-keyword'>where</span>
<a name="line-567"></a>    <span class='hs-varid'>getGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-568"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-569"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span>
<a name="line-570"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-571"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterVarEnv</span>  <span class='hs-varid'>is_given_ecl</span> <span class='hs-varid'>eqs</span>
<a name="line-572"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterFunEqs</span>  <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>funeqs</span>
<a name="line-573"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>irreds</span>
<a name="line-574"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterDicts</span>   <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>dicts</span>
<a name="line-575"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-576"></a>
<a name="line-577"></a>    <span class='hs-varid'>is_given_ecl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-578"></a>    <span class='hs-varid'>is_given_ecl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-579"></a>    <span class='hs-varid'>is_given_ecl</span> <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-580"></a>
<a name="line-581"></a><span class='hs-comment'>{-
<a name="line-582"></a>Note [Do not inherit the flat cache]
<a name="line-583"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-584"></a>We do not want to inherit the flat cache when processing nested
<a name="line-585"></a>implications.  Consider
<a name="line-586"></a>   a ~ F b, forall c. b~Int =&gt; blah
<a name="line-587"></a>If we have F b ~ fsk in the flat-cache, and we push that into the
<a name="line-588"></a>nested implication, we might miss that F b can be rewritten to F Int,
<a name="line-589"></a>and hence perhpas solve it.  Moreover, the fsk from outside is
<a name="line-590"></a>flattened out after solving the outer level, but and we don't
<a name="line-591"></a>do that flattening recursively.
<a name="line-592"></a>
<a name="line-593"></a>Note [Preparing inert set for implications]
<a name="line-594"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-595"></a>Before solving the nested implications, we trim the inert set,
<a name="line-596"></a>retaining only Givens.  These givens can be used when solving
<a name="line-597"></a>the inner implications.
<a name="line-598"></a>
<a name="line-599"></a>There might be cases where interactions between wanteds at different levels
<a name="line-600"></a>could help to solve a constraint. For example
<a name="line-601"></a>
<a name="line-602"></a>        class C a b | a -&gt; b
<a name="line-603"></a>        (C Int alpha), (forall d. C d blah =&gt; C Int a)
<a name="line-604"></a>
<a name="line-605"></a>If we pushed the (C Int alpha) inwards, as a given, it can produce a
<a name="line-606"></a>fundep (alpha~a) and this can float out again and be used to fix
<a name="line-607"></a>alpha.  (In general we can't float class constraints out just in case
<a name="line-608"></a>(C d blah) might help to solve (C Int a).)  But we ignore this possiblity.
<a name="line-609"></a>
<a name="line-610"></a>For Derived constraints we don't have evidence, so we do not turn
<a name="line-611"></a>them into Givens.  There can *be* deriving CFunEqCans; see Trac #8129.
<a name="line-612"></a>-}</span>
<a name="line-613"></a>
<a name="line-614"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-615"></a><span class='hs-definition'>getInertEqs</span>
<a name="line-616"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-617"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-618"></a>
<a name="line-619"></a><a name="getUnsolvedInerts"></a><span class='hs-definition'>getUnsolvedInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-620"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Tyvar eqs: a ~ ty</span>
<a name="line-621"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Fun eqs:   F a ~ ty</span>
<a name="line-622"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Insoluble</span>
<a name="line-623"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- All others</span>
<a name="line-624"></a><span class='hs-definition'>getUnsolvedInerts</span>
<a name="line-625"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-626"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_eqs</span>
<a name="line-627"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idicts</span>
<a name="line-628"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-629"></a>
<a name="line-630"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unsolved_tv_eqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cts</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-631"></a>                                             <span class='hs-varid'>foldr</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>rest</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-632"></a>                                          <span class='hs-varid'>emptyCts</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-633"></a>            <span class='hs-varid'>unsolved_fun_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-634"></a>            <span class='hs-varid'>unsolved_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>irreds</span>
<a name="line-635"></a>            <span class='hs-varid'>unsolved_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>idicts</span> <span class='hs-varid'>emptyCts</span>
<a name="line-636"></a>
<a name="line-637"></a>            <span class='hs-varid'>others</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved_irreds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_dicts</span>
<a name="line-638"></a>
<a name="line-639"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorkListImplics</span>
<a name="line-640"></a>
<a name="line-641"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_tv_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_fun_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-642"></a>              <span class='hs-comment'>-- Keep even the given insolubles</span>
<a name="line-643"></a>              <span class='hs-comment'>-- so that we can report dead GADT pattern match branches</span>
<a name="line-644"></a>  <span class='hs-keyword'>where</span>
<a name="line-645"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-646"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-647"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-648"></a>
<a name="line-649"></a>    <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Wanted or Derived</span>
<a name="line-650"></a>
<a name="line-651"></a><a name="getNoGivenEqs"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>     <span class='hs-comment'>-- TcLevel of this implication</span>
<a name="line-652"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Skolems of this implication</span>
<a name="line-653"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>        <span class='hs-comment'>-- True &lt;=&gt; definitely no residual given equalities</span>
<a name="line-654"></a><span class='hs-comment'>-- See Note [When does an implication have given equalities?]</span>
<a name="line-655"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-656"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ieqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iirreds</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-657"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-658"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>local_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>add_fsk</span> <span class='hs-varid'>funeqs</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-659"></a>
<a name="line-660"></a>             <span class='hs-varid'>has_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ev_given_here</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctEvidence</span><span class='hs-layout'>)</span>  <span class='hs-conid'>False</span> <span class='hs-varid'>iirreds</span>
<a name="line-661"></a>                          <span class='hs-varop'>||</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>eqs_given_here</span> <span class='hs-varid'>local_fsks</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ieqs</span>
<a name="line-662"></a>
<a name="line-663"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getNoGivenEqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>has_given_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-664"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>has_given_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-665"></a>  <span class='hs-keyword'>where</span>
<a name="line-666"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-667"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-varid'>local_fsks</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-keyglyph'>]</span>
<a name="line-668"></a>                              <span class='hs-comment'>-- Givens are always a sigleton</span>
<a name="line-669"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>local_fsks</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ev_given_here</span> <span class='hs-varid'>ev</span>
<a name="line-670"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-671"></a>
<a name="line-672"></a>    <span class='hs-varid'>ev_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-673"></a>    <span class='hs-comment'>-- True for a Given bound by the curent implication,</span>
<a name="line-674"></a>    <span class='hs-comment'>-- i.e. the current level</span>
<a name="line-675"></a>    <span class='hs-varid'>ev_given_here</span> <span class='hs-varid'>ev</span>
<a name="line-676"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span>
<a name="line-677"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tcl_tclvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctl_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-678"></a>
<a name="line-679"></a>    <span class='hs-varid'>add_fsk</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-680"></a>    <span class='hs-varid'>add_fsk</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>fsks</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fsk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-681"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>fsks</span> <span class='hs-varid'>tv</span>
<a name="line-682"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsks</span>
<a name="line-683"></a>
<a name="line-684"></a>    <span class='hs-varid'>skol_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-685"></a>    <span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>local_fsks</span> <span class='hs-varid'>tv</span> <span class='hs-comment'>-- See Note [Let-bound skolems]</span>
<a name="line-686"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-687"></a>          <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>skol_tv_set</span>
<a name="line-688"></a>          <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>local_fsks</span><span class='hs-layout'>)</span>
<a name="line-689"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-690"></a>
<a name="line-691"></a><span class='hs-comment'>{-
<a name="line-692"></a>Note [When does an implication have given equalities?]
<a name="line-693"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-694"></a>Consider an implication
<a name="line-695"></a>   beta =&gt; alpha ~ Int
<a name="line-696"></a>where beta is a unification variable that has already been unified
<a name="line-697"></a>to () in an outer scope.  Then we can float the (alpha ~ Int) out
<a name="line-698"></a>just fine. So when deciding whether the givens contain an equality,
<a name="line-699"></a>we should canonicalise first, rather than just looking at the original
<a name="line-700"></a>givens (Trac #8644).
<a name="line-701"></a>
<a name="line-702"></a>So we simply look at the inert, canonical Givens and see if there are
<a name="line-703"></a>any equalities among them, the calculation of has_given_eqs.  There
<a name="line-704"></a>are some wrinkles:
<a name="line-705"></a>
<a name="line-706"></a> * We must know which ones are bound in *this* implication and which
<a name="line-707"></a>   are bound further out.  We can find that out from the TcLevel
<a name="line-708"></a>   of the Given, which is itself recorded in the tcl_tclvl field
<a name="line-709"></a>   of the TcLclEnv stored in the Given (ev_given_here).
<a name="line-710"></a>
<a name="line-711"></a>   What about interactions between inner and outer givens?
<a name="line-712"></a>      - Outer given is rewritten by an inner given, then there must
<a name="line-713"></a>        have been an inner given equality, hence the given-eq flag
<a name="line-714"></a>        will be true anyway.
<a name="line-715"></a>
<a name="line-716"></a>      - Inner given rewritten by outer, retains its level (ie. The inner one)
<a name="line-717"></a>
<a name="line-718"></a> * We must take account of *potential* equalities, like the one above:
<a name="line-719"></a>      beta =&gt; ...blah...
<a name="line-720"></a>   If we still don't know what beta is, we conservatively treat it as potentially
<a name="line-721"></a>   becoming an equality. Hence including 'irreds' in the calculation or has_given_eqs.
<a name="line-722"></a>
<a name="line-723"></a> * When flattening givens, we generate Given equalities like
<a name="line-724"></a>     &lt;F [a]&gt; : F [a] ~ f,
<a name="line-725"></a>   with Refl evidence, and we *don't* want those to count as an equality
<a name="line-726"></a>   in the givens!  After all, the entire flattening business is just an
<a name="line-727"></a>   internal matter, and the evidence does not mention any of the 'givens'
<a name="line-728"></a>   of this implication.  So we do not treat inert_funeqs as a 'given equality'.
<a name="line-729"></a>
<a name="line-730"></a> * See Note [Let-bound skolems] for another wrinkle
<a name="line-731"></a>
<a name="line-732"></a> * We do *not* need to worry about representational equalities, because
<a name="line-733"></a>   these do not affect the ability to float constraints.
<a name="line-734"></a>
<a name="line-735"></a>Note [Let-bound skolems]
<a name="line-736"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-737"></a>If   * the inert set contains a canonical Given CTyEqCan (a ~ ty)
<a name="line-738"></a>and  * 'a' is a skolem bound in this very implication, b
<a name="line-739"></a>
<a name="line-740"></a>then:
<a name="line-741"></a>a) The Given is pretty much a let-binding, like
<a name="line-742"></a>      f :: (a ~ b-&gt;c) =&gt; a -&gt; a
<a name="line-743"></a>   Here the equality constraint is like saying
<a name="line-744"></a>      let a = b-&gt;c in ...
<a name="line-745"></a>   It is not adding any new, local equality  information,
<a name="line-746"></a>   and hence can be ignored by has_given_eqs
<a name="line-747"></a>
<a name="line-748"></a>b) 'a' will have been completely substituted out in the inert set,
<a name="line-749"></a>   so we can safely discard it.  Notably, it doesn't need to be
<a name="line-750"></a>   returned as part of 'fsks'
<a name="line-751"></a>
<a name="line-752"></a>For an example, see Trac #9211.
<a name="line-753"></a>-}</span>
<a name="line-754"></a>
<a name="line-755"></a><a name="splitInertCans"></a><span class='hs-definition'>splitInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-756"></a><span class='hs-comment'>-- ^ Extract the (given, derived, wanted) inert constraints</span>
<a name="line-757"></a><span class='hs-definition'>splitInertCans</span> <span class='hs-varid'>iCans</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>given</span><span class='hs-layout'>,</span><span class='hs-varid'>derived</span><span class='hs-layout'>,</span><span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-758"></a>  <span class='hs-keyword'>where</span>
<a name="line-759"></a>    <span class='hs-varid'>allCts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span>  <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>iCans</span><span class='hs-layout'>)</span>
<a name="line-760"></a>             <span class='hs-varop'>$</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>iCans</span><span class='hs-layout'>)</span>
<a name="line-761"></a>             <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>varEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>iCans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-762"></a>
<a name="line-763"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>derived</span><span class='hs-layout'>,</span><span class='hs-varid'>other</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isDerivedCt</span> <span class='hs-varid'>allCts</span>
<a name="line-764"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>wanted</span><span class='hs-layout'>,</span><span class='hs-varid'>given</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isWantedCt</span>  <span class='hs-varid'>other</span>
<a name="line-765"></a>
<a name="line-766"></a><a name="removeInertCts"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-767"></a><span class='hs-comment'>-- ^ Remove inert constraints from the 'InertCans', for use when a</span>
<a name="line-768"></a><span class='hs-comment'>-- typechecker plugin wishes to discard a given.</span>
<a name="line-769"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>removeInertCt</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>cts</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="removeInertCt"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-772"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-varid'>is</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span>
<a name="line-773"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-774"></a>
<a name="line-775"></a>    <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-776"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-777"></a>
<a name="line-778"></a>    <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-779"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-780"></a>
<a name="line-781"></a>    <span class='hs-conid'>CTyEqCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-782"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTyEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-783"></a>
<a name="line-784"></a>    <span class='hs-conid'>CIrredEvCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CIrredEvCan"</span>
<a name="line-785"></a>    <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CNonCanonical"</span>
<a name="line-786"></a>    <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CHoleCan"</span>
<a name="line-787"></a>
<a name="line-788"></a>
<a name="line-789"></a><a name="checkAllSolved"></a><span class='hs-definition'>checkAllSolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-790"></a><span class='hs-comment'>-- True if there are no unsolved wanteds</span>
<a name="line-791"></a><span class='hs-comment'>-- Ignore Derived for this purpose, unless in insolubles</span>
<a name="line-792"></a><span class='hs-definition'>checkAllSolved</span>
<a name="line-793"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-794"></a>
<a name="line-795"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>is</span>
<a name="line-796"></a>            <span class='hs-varid'>unsolved_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag</span><span class='hs-varop'>.</span><span class='hs-varid'>anyBag</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-797"></a>            <span class='hs-varid'>unsolved_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span>  <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span>  <span class='hs-varop'>.</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>)</span>
<a name="line-798"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>  <span class='hs-conid'>False</span>
<a name="line-799"></a>            <span class='hs-varid'>unsolved_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>)</span>
<a name="line-800"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-801"></a>            <span class='hs-varid'>unsolved_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isWantedCt</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span>
<a name="line-802"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span>
<a name="line-803"></a>
<a name="line-804"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsolved_eqs</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_irreds</span>
<a name="line-805"></a>                     <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_dicts</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unsolved_funeqs</span>
<a name="line-806"></a>                     <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_insols</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-807"></a>
<a name="line-808"></a><a name="lookupFlatCache"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-809"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span>
<a name="line-811"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-812"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>firstJusts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span><span class='hs-layout'>,</span>
<a name="line-813"></a>                             <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-814"></a>  <span class='hs-keyword'>where</span>
<a name="line-815"></a>    <span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span>
<a name="line-816"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_fsk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsk</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-817"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFunEqs</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-818"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-819"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-820"></a>
<a name="line-821"></a>    <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>flat_cache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-822"></a>
<a name="line-823"></a>
<a name="line-824"></a><a name="lookupInInerts"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-825"></a><span class='hs-comment'>-- Is this exact predicate type cached in the solved or canonicals of the InertSet?</span>
<a name="line-826"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-827"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span>
<a name="line-828"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-829"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSolvedDict</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mplus`</span>
<a name="line-830"></a>                 <span class='hs-varid'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-831"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- NB: No caching for equalities, IPs, holes, or errors</span>
<a name="line-832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-833"></a>
<a name="line-834"></a><a name="lookupInertDict"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-835"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-836"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-837"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-838"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ctEvCheckDepth</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev</span>
<a name="line-839"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span>
<a name="line-840"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="lookupSolvedDict"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-843"></a><span class='hs-comment'>-- Returns just if exactly this predicate type exists in the solved.</span>
<a name="line-844"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-845"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>solved</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-846"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ctEvCheckDepth</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span>
<a name="line-847"></a>      <span class='hs-keyword'>_</span>                                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-848"></a>
<a name="line-849"></a><span class='hs-comment'>{-
<a name="line-850"></a>************************************************************************
<a name="line-851"></a>*                                                                      *
<a name="line-852"></a>                   TyEqMap
<a name="line-853"></a>*                                                                      *
<a name="line-854"></a>************************************************************************
<a name="line-855"></a>-}</span>
<a name="line-856"></a>
<a name="line-857"></a><a name="TyEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TyEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-varid'>a</span>
<a name="line-858"></a>
<a name="line-859"></a><a name="findTyEqs"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-860"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-861"></a>
<a name="line-862"></a><a name="delTyEq"></a><span class='hs-definition'>delTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyEqMap</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyEqMap</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-863"></a><span class='hs-definition'>delTyEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isThisOne</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span>
<a name="line-864"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isThisOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t1</span>
<a name="line-865"></a>        <span class='hs-varid'>isThisOne</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-866"></a>
<a name="line-867"></a><span class='hs-comment'>{-
<a name="line-868"></a>************************************************************************
<a name="line-869"></a>*                                                                      *
<a name="line-870"></a>                   TcAppMap, DictMap, FunEqMap
<a name="line-871"></a>*                                                                      *
<a name="line-872"></a>************************************************************************
<a name="line-873"></a>-}</span>
<a name="line-874"></a>
<a name="line-875"></a><a name="TcAppMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>TypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-876"></a>    <span class='hs-comment'>-- Indexed by tycon then the arg types</span>
<a name="line-877"></a>    <span class='hs-comment'>-- Used for types and classes; hence UniqFM</span>
<a name="line-878"></a>
<a name="line-879"></a><a name="emptyTcAppMap"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-880"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-881"></a>
<a name="line-882"></a><a name="findTcApp"></a><span class='hs-definition'>findTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-883"></a><span class='hs-definition'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span>
<a name="line-884"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-885"></a>
<a name="line-886"></a><a name="delTcApp"></a><span class='hs-definition'>delTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-887"></a><span class='hs-definition'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjustUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>deleteTM</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-888"></a>
<a name="line-889"></a><a name="insertTcApp"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-890"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterUFM</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-891"></a>  <span class='hs-keyword'>where</span>
<a name="line-892"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-893"></a>
<a name="line-894"></a><span class='hs-comment'>-- mapTcApp :: (a-&gt;b) -&gt; TcAppMap a -&gt; TcAppMap b</span>
<a name="line-895"></a><span class='hs-comment'>-- mapTcApp f = mapUFM (mapTM f)</span>
<a name="line-896"></a>
<a name="line-897"></a><a name="filterTcAppMap"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span>
<a name="line-898"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-899"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUFM</span> <span class='hs-varid'>do_tm</span> <span class='hs-varid'>m</span>
<a name="line-900"></a>  <span class='hs-keyword'>where</span>
<a name="line-901"></a>    <span class='hs-varid'>do_tm</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyTM</span>
<a name="line-902"></a>    <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-903"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-904"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-905"></a>       <span class='hs-keyword'>where</span>
<a name="line-906"></a>         <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-907"></a>                <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-908"></a>                <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-909"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"filterTcAppMap"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-910"></a>
<a name="line-911"></a><a name="tcAppMapToBag"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-912"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-913"></a>
<a name="line-914"></a><a name="foldTcAppMap"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-915"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>
<a name="line-916"></a>
<a name="line-917"></a><a name="DictMap"></a><span class='hs-comment'>-------------------------</span>
<a name="line-918"></a><a name="DictMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-919"></a>
<a name="line-920"></a><a name="emptyDictMap"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-921"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-922"></a>
<a name="line-923"></a><span class='hs-comment'>-- sizeDictMap :: DictMap a -&gt; Int</span>
<a name="line-924"></a><span class='hs-comment'>-- sizeDictMap m = foldDicts (\ _ x -&gt; x+1) m 0</span>
<a name="line-925"></a>
<a name="line-926"></a><a name="findDict"></a><span class='hs-definition'>findDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-927"></a><span class='hs-definition'>findDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-928"></a>
<a name="line-929"></a><a name="findDictsByClass"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-930"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-931"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyBag</span>
<a name="line-932"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-933"></a>
<a name="line-934"></a><a name="delDict"></a><span class='hs-definition'>delDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-935"></a><span class='hs-definition'>delDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-936"></a>
<a name="line-937"></a><a name="addDict"></a><span class='hs-definition'>addDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-938"></a><span class='hs-definition'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-939"></a>
<a name="line-940"></a><a name="addDictsByClass"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-941"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>items</span>
<a name="line-942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyTM</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-943"></a>  <span class='hs-keyword'>where</span>
<a name="line-944"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-945"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addDictsByClass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-946"></a>
<a name="line-947"></a><a name="filterDicts"></a><span class='hs-definition'>filterDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-948"></a><span class='hs-definition'>filterDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-949"></a>
<a name="line-950"></a><a name="partitionDicts"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-951"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDicts</span><span class='hs-layout'>)</span>
<a name="line-952"></a>  <span class='hs-keyword'>where</span>
<a name="line-953"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-954"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span>              <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-955"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-956"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-957"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-958"></a>
<a name="line-959"></a><a name="dictsToBag"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-960"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAppMapToBag</span>
<a name="line-961"></a>
<a name="line-962"></a><a name="foldDicts"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-963"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-964"></a>
<a name="line-965"></a><a name="emptyDicts"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-966"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-967"></a>
<a name="line-968"></a><a name="FunEqMap"></a><span class='hs-comment'>------------------------</span>
<a name="line-969"></a><a name="FunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- A map whose key is a (TyCon, [Type]) pair</span>
<a name="line-970"></a>
<a name="line-971"></a><a name="emptyFunEqs"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-972"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-973"></a>
<a name="line-974"></a><a name="sizeFunEqMap"></a><span class='hs-definition'>sizeFunEqMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-975"></a><span class='hs-definition'>sizeFunEqMap</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span>
<a name="line-976"></a>
<a name="line-977"></a><a name="findFunEq"></a><span class='hs-definition'>findFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-978"></a><span class='hs-definition'>findFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-979"></a>
<a name="line-980"></a><a name="findFunEqs"></a><span class='hs-definition'>findFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-981"></a><span class='hs-definition'>findFunEqs</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-982"></a>
<a name="line-983"></a><a name="funEqsToBag"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-984"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-985"></a>
<a name="line-986"></a><a name="findFunEqsByTyCon"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-987"></a><span class='hs-comment'>-- Get inert function equation constraints that have the given tycon</span>
<a name="line-988"></a><span class='hs-comment'>-- in their head.  Not that the constraints remain in the inert set.</span>
<a name="line-989"></a><span class='hs-comment'>-- We use this to check for derived interactions with built-in type-function</span>
<a name="line-990"></a><span class='hs-comment'>-- constructors.</span>
<a name="line-991"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-992"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-conid'>[]</span>
<a name="line-993"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-994"></a>
<a name="line-995"></a><a name="foldFunEqs"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-996"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-997"></a>
<a name="line-998"></a><span class='hs-comment'>-- mapFunEqs :: (a -&gt; b) -&gt; FunEqMap a -&gt; FunEqMap b</span>
<a name="line-999"></a><span class='hs-comment'>-- mapFunEqs = mapTcApp</span>
<a name="line-1000"></a>
<a name="line-1001"></a><a name="filterFunEqs"></a><span class='hs-definition'>filterFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span>
<a name="line-1002"></a><span class='hs-definition'>filterFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span>
<a name="line-1003"></a>
<a name="line-1004"></a><a name="insertFunEq"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-1005"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span>
<a name="line-1006"></a>
<a name="line-1007"></a><span class='hs-comment'>-- insertFunEqCt :: FunEqMap Ct -&gt; Ct -&gt; FunEqMap Ct</span>
<a name="line-1008"></a><span class='hs-comment'>-- insertFunEqCt m ct@(CFunEqCan { cc_fun = tc, cc_tyargs = tys })</span>
<a name="line-1009"></a><span class='hs-comment'>--  = insertFunEq m tc tys ct</span>
<a name="line-1010"></a><span class='hs-comment'>-- insertFunEqCt _ ct = pprPanic "insertFunEqCt" (ppr ct)</span>
<a name="line-1011"></a>
<a name="line-1012"></a><a name="partitionFunEqs"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-1013"></a><span class='hs-comment'>-- Optimise for the case where the predicate is false</span>
<a name="line-1014"></a><span class='hs-comment'>-- partitionFunEqs is called only from kick-out, and kick-out usually</span>
<a name="line-1015"></a><span class='hs-comment'>-- kicks out very few equalities, so we want to optimise for that case</span>
<a name="line-1016"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>del</span> <span class='hs-varid'>m</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>
<a name="line-1017"></a>  <span class='hs-keyword'>where</span>
<a name="line-1018"></a>    <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span>
<a name="line-1019"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>yeses</span>
<a name="line-1020"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>yeses</span>
<a name="line-1021"></a>    <span class='hs-varid'>del</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-1022"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1023"></a>    <span class='hs-varid'>del</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionFunEqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1024"></a>
<a name="line-1025"></a><a name="delFunEq"></a><span class='hs-definition'>delFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-1026"></a><span class='hs-definition'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1027"></a>
<a name="line-1028"></a><span class='hs-comment'>{-
<a name="line-1029"></a>************************************************************************
<a name="line-1030"></a>*                                                                      *
<a name="line-1031"></a>*              The TcS solver monad                                    *
<a name="line-1032"></a>*                                                                      *
<a name="line-1033"></a>************************************************************************
<a name="line-1034"></a>
<a name="line-1035"></a>Note [The TcS monad]
<a name="line-1036"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-1037"></a>The TcS monad is a weak form of the main Tc monad
<a name="line-1038"></a>
<a name="line-1039"></a>All you can do is
<a name="line-1040"></a>    * fail
<a name="line-1041"></a>    * allocate new variables
<a name="line-1042"></a>    * fill in evidence variables
<a name="line-1043"></a>
<a name="line-1044"></a>Filling in a dictionary evidence variable means to create a binding
<a name="line-1045"></a>for it, so TcS carries a mutable location where the binding can be
<a name="line-1046"></a>added.  This is initialised from the innermost implication constraint.
<a name="line-1047"></a>-}</span>
<a name="line-1048"></a>
<a name="line-1049"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-1050"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span>
<a name="line-1051"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-1052"></a>
<a name="line-1053"></a>      <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span>
<a name="line-1054"></a>          <span class='hs-comment'>-- The "dirty-flag" Bool is set True when</span>
<a name="line-1055"></a>          <span class='hs-comment'>-- we unify a unification variable</span>
<a name="line-1056"></a>
<a name="line-1057"></a>      <span class='hs-varid'>tcs_count</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-1058"></a>
<a name="line-1059"></a>      <span class='hs-varid'>tcs_inerts</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-1060"></a>
<a name="line-1061"></a>      <span class='hs-comment'>-- The main work-list and the flattening worklist</span>
<a name="line-1062"></a>      <span class='hs-comment'>-- See Note [Work list priorities] and</span>
<a name="line-1063"></a>      <span class='hs-comment'>--     Note [The flattening work list]</span>
<a name="line-1064"></a>      <span class='hs-varid'>tcs_worklist</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current worklist</span>
<a name="line-1065"></a>      <span class='hs-varid'>tcs_flat_work</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Flattening worklist</span>
<a name="line-1066"></a>    <span class='hs-layout'>}</span>
<a name="line-1067"></a>
<a name="line-1068"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-1069"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-1070"></a>
<a name="line-1071"></a><a name="instance%20Functor%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-1072"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span>
<a name="line-1073"></a>
<a name="line-1074"></a><a name="instance%20Applicative%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-1075"></a>  <span class='hs-varid'>pure</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>
<a name="line-1076"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-1077"></a>
<a name="line-1078"></a><a name="instance%20Monad%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-1079"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1080"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-1081"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>
<a name="line-1083"></a><a name="instance%20MonadUnique%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-1084"></a>   <span class='hs-varid'>getUniqueSupplyM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-1085"></a>
<a name="line-1086"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality</span>
<a name="line-1087"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1088"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1089"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-1090"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-1091"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-1092"></a>
<a name="line-1093"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1094"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-1095"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-1096"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-1097"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-1098"></a>
<a name="line-1099"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1100"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-1101"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-1102"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-1103"></a>
<a name="line-1104"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1105"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>failWith</span>
<a name="line-1106"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcCanonical"</span> <span class='hs-varid'>doc</span>
<a name="line-1107"></a>
<a name="line-1108"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1109"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1110"></a>
<a name="line-1111"></a><a name="runTcPluginTcS"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1112"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runTcPluginM</span>
<a name="line-1113"></a>
<a name="line-1114"></a><a name="instance%20HasDynFlags%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-1115"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1116"></a>
<a name="line-1117"></a><a name="getGlobalRdrEnvTcS"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-1118"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGlobalRdrEnv</span>
<a name="line-1119"></a>
<a name="line-1120"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1121"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-1122"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-1123"></a>                                    <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1124"></a>
<a name="line-1125"></a><a name="csTraceTcS"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1126"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-varid'>doc</span>
<a name="line-1127"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1128"></a>
<a name="line-1129"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1130"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-1131"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>doc</span>
<a name="line-1132"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-num'>1</span> <span class='hs-varop'>$</span>
<a name="line-1133"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-1134"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-1135"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"U:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span>
<a name="line-1136"></a>                                          <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1137"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-1138"></a>                     <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1139"></a>
<a name="line-1140"></a><a name="csTraceTcM"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1141"></a><span class='hs-comment'>-- Constraint-solver tracing, -ddump-cs-trace</span>
<a name="line-1142"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-varid'>trace_level</span> <span class='hs-varid'>mk_doc</span>
<a name="line-1143"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1144"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>  <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1145"></a>              <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>trace_level</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>traceLevel</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1146"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_doc</span>
<a name="line-1147"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTcRn</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1148"></a>
<a name="line-1149"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>                <span class='hs-comment'>-- What to run</span>
<a name="line-1150"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-1151"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-1152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-1153"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-1154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1155"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1156"></a>
<a name="line-1157"></a><a name="runTcSWithEvBinds"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-1158"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1159"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-1160"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-1161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unified_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-conid'>False</span>
<a name="line-1162"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-num'>0</span>
<a name="line-1163"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>is</span>
<a name="line-1164"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-1165"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>fw_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"Flat work list"</span><span class='hs-layout'>)</span>
<a name="line-1166"></a>
<a name="line-1167"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1168"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-1169"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-1170"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-1171"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span>
<a name="line-1172"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_flat_work</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fw_var</span> <span class='hs-layout'>}</span>
<a name="line-1173"></a>
<a name="line-1174"></a>             <span class='hs-comment'>-- Run the computation</span>
<a name="line-1175"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-1176"></a>
<a name="line-1177"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-1178"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1179"></a>         <span class='hs-varid'>csTraceTcM</span> <span class='hs-num'>0</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Constraint solver steps ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>
<a name="line-1181"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-1182"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1184"></a><span class='hs-cpp'>#endif</span>
<a name="line-1185"></a>
<a name="line-1186"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-1187"></a>  <span class='hs-keyword'>where</span>
<a name="line-1188"></a>    <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInert</span>
<a name="line-1189"></a>
<a name="line-1190"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-1191"></a><a name="checkForCyclicBinds"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1192"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1193"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cycles</span>
<a name="line-1194"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1195"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-1196"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"Cycle in evidence binds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span>
<a name="line-1197"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Cycle in coercion bindings"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-1199"></a>  <span class='hs-keyword'>where</span>
<a name="line-1200"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-1201"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stronglyConnCompFromEdgedVertices</span> <span class='hs-varid'>edges</span><span class='hs-keyglyph'>]</span>
<a name="line-1202"></a>
<a name="line-1203"></a>    <span class='hs-varid'>coercion_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_co_bind</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-1204"></a>    <span class='hs-varid'>is_co_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqVar</span> <span class='hs-varid'>b</span>
<a name="line-1205"></a>
<a name="line-1206"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvVar</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1207"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>bind</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>ev_binds</span><span class='hs-keyglyph'>]</span>
<a name="line-1208"></a><span class='hs-cpp'>#endif</span>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1211"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-1212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-1213"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-1214"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1215"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-1216"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_inert</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span> <span class='hs-layout'>}</span>
<a name="line-1217"></a>                                   <span class='hs-comment'>-- See Note [Do not inherit the flat cache]</span>
<a name="line-1218"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>nest_inert</span>
<a name="line-1219"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-1220"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_fw_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>panic</span> <span class='hs-str'>"Flat work list"</span><span class='hs-layout'>)</span>
<a name="line-1221"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-1222"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-1223"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-1224"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-1225"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span>
<a name="line-1226"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_flat_work</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fw_var</span> <span class='hs-layout'>}</span>
<a name="line-1227"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setTcLevel</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-1228"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-1229"></a>
<a name="line-1230"></a><span class='hs-cpp'>#ifdef DEBUG</span>
<a name="line-1231"></a>       <span class='hs-comment'>-- Perform a check that the thing_inside did not cause cycles</span>
<a name="line-1232"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ref</span>
<a name="line-1233"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-1234"></a><span class='hs-cpp'>#endif</span>
<a name="line-1235"></a>
<a name="line-1236"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-1237"></a>
<a name="line-1238"></a><a name="recoverTcS"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1239"></a><span class='hs-definition'>recoverTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>recovery_code</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-1240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1241"></a>    <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>recoverM</span> <span class='hs-layout'>(</span><span class='hs-varid'>recovery_code</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing_inside</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-1242"></a>
<a name="line-1243"></a><a name="nestTcS"></a><span class='hs-definition'>nestTcS</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1244"></a><span class='hs-comment'>-- Use the current untouchables, augmenting the current</span>
<a name="line-1245"></a><span class='hs-comment'>-- evidence bindings, and solved dictionaries</span>
<a name="line-1246"></a><span class='hs-comment'>-- But have no effect on the InertCans, or on the inert_flat_cache</span>
<a name="line-1247"></a><span class='hs-comment'>--  (the latter because the thing inside a nestTcS does unflattening)</span>
<a name="line-1248"></a><span class='hs-definition'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-1249"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1250"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inerts_var</span>
<a name="line-1251"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-1252"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-1253"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-1254"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-1255"></a>
<a name="line-1256"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-1257"></a>
<a name="line-1258"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-1259"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>inerts_var</span>  <span class='hs-comment'>-- See Note [Propagate the solved dictionaries]</span>
<a name="line-1260"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>new_inerts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1261"></a>
<a name="line-1262"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-1263"></a>
<a name="line-1264"></a><a name="tryTcS"></a><span class='hs-definition'>tryTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1265"></a><span class='hs-comment'>-- Like runTcS, but from within the TcS monad</span>
<a name="line-1266"></a><span class='hs-comment'>-- Completely fresh inerts and worklist, be careful!</span>
<a name="line-1267"></a><span class='hs-comment'>-- Moreover, we will simply throw away all the evidence generated.</span>
<a name="line-1268"></a><span class='hs-definition'>tryTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-1269"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1270"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-1271"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unified_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-conid'>False</span>
<a name="line-1272"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-1273"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-1274"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1275"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-1276"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_var</span>
<a name="line-1277"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span>
<a name="line-1278"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span> <span class='hs-layout'>}</span>
<a name="line-1279"></a>
<a name="line-1280"></a><span class='hs-comment'>{-
<a name="line-1281"></a>Note [Propagate the solved dictionaries]
<a name="line-1282"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1283"></a>It's really quite important that nestTcS does not discard the solved
<a name="line-1284"></a>dictionaries from the thing_inside.
<a name="line-1285"></a>Consider
<a name="line-1286"></a>   Eq [a]
<a name="line-1287"></a>   forall b. empty =&gt;  Eq [a]
<a name="line-1288"></a>We solve the simple (Eq [a]), under nestTcS, and then turn our attention to
<a name="line-1289"></a>the implications.  It's definitely fine to use the solved dictionaries on
<a name="line-1290"></a>the inner implications, and it can make a signficant performance difference
<a name="line-1291"></a>if you do so.
<a name="line-1292"></a>-}</span>
<a name="line-1293"></a>
<a name="line-1294"></a><span class='hs-comment'>-- Getters and setters of TcEnv fields</span>
<a name="line-1295"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1296"></a>
<a name="line-1297"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-1298"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-1299"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-1300"></a>
<a name="line-1301"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-1302"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span>
<a name="line-1303"></a>
<a name="line-1304"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span>
<a name="line-1305"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span><span class='hs-layout'>)</span>
<a name="line-1306"></a>
<a name="line-1307"></a><a name="setTcSInerts"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1308"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span><span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1309"></a>
<a name="line-1310"></a><a name="getWorkListImplics"></a><span class='hs-definition'>getWorkListImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-1311"></a><span class='hs-definition'>getWorkListImplics</span>
<a name="line-1312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-1313"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-1314"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl_curr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1315"></a>
<a name="line-1316"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1317"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span>
<a name="line-1318"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-1319"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-1320"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_work</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-1321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1322"></a>
<a name="line-1323"></a><a name="updWorkListTcS_return"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1324"></a><span class='hs-comment'>-- Process the work list, returning a depleted work list,</span>
<a name="line-1325"></a><span class='hs-comment'>-- plus a value extracted from it (typically a work item removed from it)</span>
<a name="line-1326"></a><span class='hs-definition'>updWorkListTcS_return</span> <span class='hs-varid'>f</span>
<a name="line-1327"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-1328"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-1329"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updWorkList"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>wl_curr</span><span class='hs-layout'>)</span>
<a name="line-1330"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span><span class='hs-varid'>new_work</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>wl_curr</span>
<a name="line-1331"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_work</span><span class='hs-layout'>)</span>
<a name="line-1332"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-1333"></a>
<a name="line-1334"></a><a name="emitWorkNC"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1335"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-varid'>evs</span>
<a name="line-1336"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>evs</span>
<a name="line-1337"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1338"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1339"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting fresh work"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1340"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1341"></a>
<a name="line-1342"></a><a name="emitInsoluble"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1343"></a><span class='hs-comment'>-- Emits a non-canonical constraint that will stand for a frozen error in the inerts.</span>
<a name="line-1344"></a><span class='hs-definition'>emitInsoluble</span> <span class='hs-varid'>ct</span>
<a name="line-1345"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit insoluble"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1346"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varid'>add_insol</span> <span class='hs-layout'>}</span>
<a name="line-1347"></a>  <span class='hs-keyword'>where</span>
<a name="line-1348"></a>    <span class='hs-varid'>this_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-1349"></a>    <span class='hs-varid'>add_insol</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insols</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1350"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>already_there</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span>
<a name="line-1351"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insols</span> <span class='hs-varop'>`snocCts`</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1352"></a>      <span class='hs-keyword'>where</span>
<a name="line-1353"></a>        <span class='hs-varid'>already_there</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>anyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcEqType</span> <span class='hs-varid'>this_pred</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_insols</span>
<a name="line-1354"></a>             <span class='hs-comment'>-- See Note [Do not add duplicate derived insolubles]</span>
<a name="line-1355"></a>
<a name="line-1356"></a><a name="newTcRef"></a><span class='hs-definition'>newTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1357"></a><span class='hs-definition'>newTcRef</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1358"></a>
<a name="line-1359"></a><a name="readTcRef"></a><span class='hs-definition'>readTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1360"></a><span class='hs-definition'>readTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-1361"></a>
<a name="line-1362"></a><a name="updTcRef"></a><span class='hs-definition'>updTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1363"></a><span class='hs-definition'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span><span class='hs-layout'>)</span>
<a name="line-1364"></a>
<a name="line-1365"></a><a name="getTcEvBinds"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-1366"></a><span class='hs-definition'>getTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span>
<a name="line-1367"></a>
<a name="line-1368"></a><a name="getTcLevel"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLevel</span>
<a name="line-1369"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTcLevel</span>
<a name="line-1370"></a>
<a name="line-1371"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-1372"></a><span class='hs-definition'>getTcEvBindsMap</span>
<a name="line-1373"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-varid'>ev_ref</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span>
<a name="line-1374"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ev_ref</span> <span class='hs-layout'>}</span>
<a name="line-1375"></a>
<a name="line-1376"></a><a name="setWantedTyBind"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1377"></a><span class='hs-comment'>-- Add a type binding</span>
<a name="line-1378"></a><span class='hs-comment'>-- We never do this twice!</span>
<a name="line-1379"></a><span class='hs-definition'>setWantedTyBind</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1380"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1381"></a>    <span class='hs-varid'>isFmvTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1383"></a>    <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1384"></a>           <span class='hs-comment'>-- Write directly into the mutable tyvar</span>
<a name="line-1385"></a>           <span class='hs-comment'>-- Flatten meta-vars are born and die locally</span>
<a name="line-1386"></a>
<a name="line-1387"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1388"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1389"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>traceTc</span> <span class='hs-str'>"setWantedTyBind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1390"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-1391"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span>
<a name="line-1392"></a>
<a name="line-1393"></a><a name="reportUnifications"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1394"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-1395"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1396"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_unified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcRef</span> <span class='hs-conid'>False</span>
<a name="line-1397"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner_unified</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1398"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dirty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>inner_unified</span>
<a name="line-1399"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>dirty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1400"></a>
<a name="line-1401"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1402"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetDefaultTys</span>
<a name="line-1403"></a>
<a name="line-1404"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-1405"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InstEnvs</span>
<a name="line-1408"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Inst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-1409"></a>
<a name="line-1410"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-1411"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1412"></a>
<a name="line-1413"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1414"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getTopEnv</span>
<a name="line-1415"></a>
<a name="line-1416"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1417"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getGblEnv</span>
<a name="line-1418"></a>
<a name="line-1419"></a><a name="addUsedRdrNamesTcS"></a><span class='hs-comment'>-- Setting names as used (used in the deriving of Coercible evidence)</span>
<a name="line-1420"></a><span class='hs-comment'>-- Too hackish to expose it to TcS? In that case somehow extract the used</span>
<a name="line-1421"></a><span class='hs-comment'>-- constructors from the result of solveInteract</span>
<a name="line-1422"></a><span class='hs-definition'>addUsedRdrNamesTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RdrName</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1423"></a><span class='hs-definition'>addUsedRdrNamesTcS</span> <span class='hs-varid'>names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>addUsedRdrNames</span> <span class='hs-varid'>names</span>
<a name="line-1424"></a>
<a name="line-1425"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-1426"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1427"></a>
<a name="line-1428"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1429"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>loc</span>
<a name="line-1430"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-1431"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getStage</span>
<a name="line-1432"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1433"></a>  <span class='hs-keyword'>where</span>
<a name="line-1434"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"instance for"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-1435"></a>    <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-1436"></a>
<a name="line-1437"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1438"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span>
<a name="line-1439"></a>
<a name="line-1440"></a><a name="isTouchableMetaTyVarTcS"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-1441"></a><span class='hs-definition'>isTouchableMetaTyVarTcS</span> <span class='hs-varid'>tv</span>
<a name="line-1442"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1443"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isTouchableMetaTyVar</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="isFilledMetaTyVar_maybe"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1446"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span>
<a name="line-1447"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-1448"></a>   <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1449"></a>     <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-1450"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-1452"></a>                  <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1453"></a>                  <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-1454"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1455"></a>
<a name="line-1456"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-1457"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1458"></a>
<a name="line-1459"></a><a name="zonkTyVarsAndFV"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-1460"></a><span class='hs-definition'>zonkTyVarsAndFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTyVarsAndFV</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1461"></a>
<a name="line-1462"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-1463"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1464"></a>
<a name="line-1465"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-1466"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1467"></a>
<a name="line-1468"></a><a name="zonkSimples"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-1469"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>zonkSimples</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-1470"></a>
<a name="line-1471"></a><span class='hs-comment'>{-
<a name="line-1472"></a>Note [Do not add duplicate derived insolubles]
<a name="line-1473"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1474"></a>In general we *must* add an insoluble (Int ~ Bool) even if there is
<a name="line-1475"></a>one such there already, because they may come from distinct call
<a name="line-1476"></a>sites.  Not only do we want an error message for each, but with
<a name="line-1477"></a>-fdefer-type-errors we must generate evidence for each.  But for
<a name="line-1478"></a>*derived* insolubles, we only want to report each one once.  Why?
<a name="line-1479"></a>
<a name="line-1480"></a>(a) A constraint (C r s t) where r -&gt; s, say, may generate the same fundep
<a name="line-1481"></a>    equality many times, as the original constraint is sucessively rewritten.
<a name="line-1482"></a>
<a name="line-1483"></a>(b) Ditto the successive iterations of the main solver itself, as it traverses
<a name="line-1484"></a>    the constraint tree. See example below.
<a name="line-1485"></a>
<a name="line-1486"></a>Also for *given* insolubles we may get repeated errors, as we
<a name="line-1487"></a>repeatedly traverse the constraint tree.  These are relatively rare
<a name="line-1488"></a>anyway, so removing duplicates seems ok.  (Alternatively we could take
<a name="line-1489"></a>the SrcLoc into account.)
<a name="line-1490"></a>
<a name="line-1491"></a>Note that the test does not need to be particularly efficient because
<a name="line-1492"></a>it is only used if the program has a type error anyway.
<a name="line-1493"></a>
<a name="line-1494"></a>Example of (b): assume a top-level class and instance declaration:
<a name="line-1495"></a>
<a name="line-1496"></a>  class D a b | a -&gt; b
<a name="line-1497"></a>  instance D [a] [a]
<a name="line-1498"></a>
<a name="line-1499"></a>Assume we have started with an implication:
<a name="line-1500"></a>
<a name="line-1501"></a>  forall c. Eq c =&gt; { wc_simple = D [c] c [W] }
<a name="line-1502"></a>
<a name="line-1503"></a>which we have simplified to:
<a name="line-1504"></a>
<a name="line-1505"></a>  forall c. Eq c =&gt; { wc_simple = D [c] c [W]
<a name="line-1506"></a>                    , wc_insols = (c ~ [c]) [D] }
<a name="line-1507"></a>
<a name="line-1508"></a>For some reason, e.g. because we floated an equality somewhere else,
<a name="line-1509"></a>we might try to re-solve this implication. If we do not do a
<a name="line-1510"></a>dropDerivedWC, then we will end up trying to solve the following
<a name="line-1511"></a>constraints the second time:
<a name="line-1512"></a>
<a name="line-1513"></a>  (D [c] c) [W]
<a name="line-1514"></a>  (c ~ [c]) [D]
<a name="line-1515"></a>
<a name="line-1516"></a>which will result in two Deriveds to end up in the insoluble set:
<a name="line-1517"></a>
<a name="line-1518"></a>  wc_simple   = D [c] c [W]
<a name="line-1519"></a>  wc_insols = (c ~ [c]) [D], (c ~ [c]) [D]
<a name="line-1520"></a>-}</span>
<a name="line-1521"></a>
<a name="line-1522"></a><a name="newFlattenSkolem"></a><span class='hs-comment'>-- Flatten skolems</span>
<a name="line-1523"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1524"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-1525"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- F xis</span>
<a name="line-1526"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- [W] x:: F xis ~ fsk</span>
<a name="line-1527"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-conid'>Given</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fam_ty</span>
<a name="line-1528"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fsk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-1529"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-1530"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"fsk"</span><span class='hs-layout'>)</span>
<a name="line-1531"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>FlatSkol</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1532"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span>
<a name="line-1533"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-1534"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-1535"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1536"></a>
<a name="line-1537"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>fam_ty</span>  <span class='hs-comment'>-- Make a wanted</span>
<a name="line-1538"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fuv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-1539"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-1540"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>ref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMutVar</span> <span class='hs-conid'>Flexi</span>
<a name="line-1541"></a>                    <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_info</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FlatMetaTv</span>
<a name="line-1542"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>mtv_ref</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-1543"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>mtv_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fskTcLevel</span> <span class='hs-layout'>}</span>
<a name="line-1544"></a>                          <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>mkTcTyVarName</span> <span class='hs-varid'>uniq</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"s"</span><span class='hs-layout'>)</span>
<a name="line-1545"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1546"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fuv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1547"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>fuv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1548"></a>
<a name="line-1549"></a><a name="extendFlatCache"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1550"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span>
<a name="line-1551"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1552"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FlatCache</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1553"></a>         <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1554"></a>            <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFunEq</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1555"></a>
<a name="line-1556"></a><span class='hs-comment'>-- Instantiations</span>
<a name="line-1557"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1558"></a>
<a name="line-1559"></a><a name="instDFunType"></a><span class='hs-definition'>instDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-1560"></a><span class='hs-definition'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>mb_inst_tys</span>
<a name="line-1561"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>dfun_tvs</span> <span class='hs-varid'>mb_inst_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTopTvSubst</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1562"></a>  <span class='hs-keyword'>where</span>
<a name="line-1563"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dfun_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>dfun_phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>dfun_id</span><span class='hs-layout'>)</span>
<a name="line-1564"></a>
<a name="line-1565"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>dfun_phi</span><span class='hs-layout'>)</span>
<a name="line-1567"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mb_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-1568"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>mb_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1569"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1570"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span> <span class='hs-conop'>:</span> <span class='hs-varid'>mb_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-1571"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1572"></a>                         <span class='hs-comment'>-- Don't forget to instantiate the kind!</span>
<a name="line-1573"></a>                         <span class='hs-comment'>-- cf TcMType.tcInstTyVarX</span>
<a name="line-1574"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>mb_tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1575"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-conop'>:</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>phi</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1576"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"instDFunTypes"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>mb_inst_tys</span><span class='hs-layout'>)</span>
<a name="line-1577"></a>
<a name="line-1578"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-1579"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-varid'>knd</span><span class='hs-layout'>)</span>
<a name="line-1580"></a>
<a name="line-1581"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-1582"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1583"></a>
<a name="line-1584"></a><a name="demoteUnfilledFmv"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1585"></a><span class='hs-comment'>-- If a flatten-meta-var is still un-filled,</span>
<a name="line-1586"></a><span class='hs-comment'>-- turn it into an ordinary meta-var</span>
<a name="line-1587"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-varid'>fmv</span>
<a name="line-1588"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_filled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>isFilledMetaTyVar</span> <span class='hs-varid'>fmv</span>
<a name="line-1589"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>is_filled</span> <span class='hs-varop'>$</span>
<a name="line-1590"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-1591"></a>                      <span class='hs-layout'>;</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>writeMetaTyVar</span> <span class='hs-varid'>fmv</span> <span class='hs-varid'>tv_ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1592"></a>
<a name="line-1593"></a><a name="instFlexiTcS"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1594"></a><span class='hs-definition'>instFlexiTcS</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapAccumLM</span> <span class='hs-varid'>inst_one</span> <span class='hs-varid'>emptyTvSubst</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-1595"></a>  <span class='hs-keyword'>where</span>
<a name="line-1596"></a>     <span class='hs-varid'>inst_one</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-1597"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1598"></a>                                          <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1599"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1600"></a>
<a name="line-1601"></a><a name="instFlexiTcSHelper"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1602"></a><span class='hs-definition'>instFlexiTcSHelper</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>kind</span>
<a name="line-1603"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newUnique</span>
<a name="line-1604"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newMetaDetails</span> <span class='hs-layout'>(</span><span class='hs-conid'>TauTv</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1605"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-varid'>tvname</span> <span class='hs-varid'>uniq</span>
<a name="line-1606"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1607"></a>
<a name="line-1608"></a><a name="instFlexiTcSHelperTcS"></a><span class='hs-definition'>instFlexiTcSHelperTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-1609"></a><span class='hs-definition'>instFlexiTcSHelperTcS</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>instFlexiTcSHelper</span> <span class='hs-varid'>n</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-1610"></a>
<a name="line-1611"></a>
<a name="line-1612"></a><span class='hs-comment'>-- Creating and setting evidence variables and CtFlavors</span>
<a name="line-1613"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1614"></a>
<a name="line-1615"></a><a name="XEvTerm"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>XEvTerm</span>
<a name="line-1616"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>XEvTerm</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_preds</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- New predicate types</span>
<a name="line-1617"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ev_comp</span>   <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>   <span class='hs-comment'>-- How to compose evidence</span>
<a name="line-1618"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>ev_decomp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- How to decompose evidence</span>
<a name="line-1619"></a>            <span class='hs-comment'>-- In both ev_comp and ev_decomp, the [EvTerm] is 1-1 with ev_preds</span>
<a name="line-1620"></a>            <span class='hs-comment'>-- and each EvTerm has type of the corresponding EvPred</span>
<a name="line-1621"></a>            <span class='hs-layout'>}</span>
<a name="line-1622"></a>
<a name="line-1623"></a><a name="Freshness"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Freshness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Cached</span>
<a name="line-1624"></a>
<a name="line-1625"></a><a name="isFresh"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Freshness</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1626"></a><span class='hs-definition'>isFresh</span> <span class='hs-conid'>Fresh</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1627"></a><span class='hs-definition'>isFresh</span> <span class='hs-conid'>Cached</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1628"></a>
<a name="line-1629"></a><a name="freshGoals"></a><span class='hs-definition'>freshGoals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Freshness</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-1630"></a><span class='hs-definition'>freshGoals</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fresh</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>]</span>
<a name="line-1631"></a>
<a name="line-1632"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1633"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>the_ev</span> <span class='hs-varid'>tm</span>
<a name="line-1634"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBinds</span>
<a name="line-1635"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>tc_evbinds</span> <span class='hs-varid'>the_ev</span> <span class='hs-varid'>tm</span> <span class='hs-layout'>}</span>
<a name="line-1636"></a>
<a name="line-1637"></a><a name="newTcEvBinds"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-1638"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newTcEvBinds</span>
<a name="line-1639"></a>
<a name="line-1640"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-1641"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-1642"></a>
<a name="line-1643"></a><a name="newGivenEvVar"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1644"></a><span class='hs-comment'>-- Make a new variable of the given PredType,</span>
<a name="line-1645"></a><span class='hs-comment'>-- immediately bind it to the given term</span>
<a name="line-1646"></a><span class='hs-comment'>-- and return its CtEvidence</span>
<a name="line-1647"></a><span class='hs-comment'>-- Precondition: this is not a kind equality</span>
<a name="line-1648"></a><span class='hs-comment'>--               See Note [Do not create Given kind equalities]</span>
<a name="line-1649"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-1650"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKindEquality</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprCtOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1651"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-1652"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>rhs</span>
<a name="line-1653"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evtm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1654"></a>
<a name="line-1655"></a><a name="newGivenEvVars"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-1656"></a><span class='hs-comment'>-- Like newGivenEvVar, but automatically discard kind equalities</span>
<a name="line-1657"></a><span class='hs-comment'>-- See Note [Do not create Given kind equalities]</span>
<a name="line-1658"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterOut</span> <span class='hs-layout'>(</span><span class='hs-varid'>isKindEquality</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>pts</span><span class='hs-layout'>)</span>
<a name="line-1659"></a>
<a name="line-1660"></a><a name="isKindEquality"></a><span class='hs-definition'>isKindEquality</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1661"></a><span class='hs-comment'>-- See Note [Do not create Given kind equalities]</span>
<a name="line-1662"></a><span class='hs-definition'>isKindEquality</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-1663"></a>                        <span class='hs-conid'>EqPred</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>t1</span>
<a name="line-1664"></a>                        <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1665"></a>
<a name="line-1666"></a><span class='hs-comment'>{- Note [Do not create Given kind equalities]
<a name="line-1667"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1668"></a>We do not want to create a Given kind equality like
<a name="line-1669"></a>
<a name="line-1670"></a>   [G]  kv ~ k   -- kv is a skolem kind variable
<a name="line-1671"></a>                 -- Reason we don't yet support non-Refl kind equalities
<a name="line-1672"></a>
<a name="line-1673"></a>This showed up in Trac #8566, where we had a data type
<a name="line-1674"></a>   data I (u :: U *) (r :: [*]) :: * where
<a name="line-1675"></a>        A :: I (AA t as) r                  -- Existential k
<a name="line-1676"></a>so A has type
<a name="line-1677"></a>   A :: forall (u:U *) (r:[*])                  Universal
<a name="line-1678"></a>        (k:BOX) (t:k) (as:[U *]).        Existential
<a name="line-1679"></a>        (u ~ AA * k t as) =&gt; I u r
<a name="line-1680"></a>
<a name="line-1681"></a>There is no direct kind equality, but in a pattern match where 'u' is
<a name="line-1682"></a>instantiated to, say, (AA * kk (t1:kk) as1), we'd decompose to get
<a name="line-1683"></a>   k ~ kk, t ~ t1, as ~ as1
<a name="line-1684"></a>This is bad.  We "fix" this by simply ignoring the Given kind equality
<a name="line-1685"></a>But the Right Thing is to add kind equalities!
<a name="line-1686"></a>
<a name="line-1687"></a>But note (Trac #8705) that we *do* create Given (non-canonical) equalities
<a name="line-1688"></a>with un-equal kinds, e.g.
<a name="line-1689"></a>   [G]  t1::k1 ~ t2::k2   -- k1 and k2 are un-equal kinds
<a name="line-1690"></a>Reason: k1 or k2 might be unification variables that have already been
<a name="line-1691"></a>unified (at this point we have not canonicalised the types), so we want
<a name="line-1692"></a>to emit this t1~t2 as a (non-canonical) Given in the work-list. If k1/k2
<a name="line-1693"></a>have been unified, we'll find that when we canonicalise it, and the
<a name="line-1694"></a>t1~t2 information may be crucial (Trac #8705 is an example).
<a name="line-1695"></a>
<a name="line-1696"></a>If it turns out that k1 and k2 are really un-equal, then it'll end up
<a name="line-1697"></a>as an Irreducible (see Note [Equalities with incompatible kinds] in
<a name="line-1698"></a>TcCanonical), and will do no harm.
<a name="line-1699"></a>-}</span>
<a name="line-1700"></a>
<a name="line-1701"></a><a name="newWantedEvVarNC"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-1702"></a><span class='hs-comment'>-- Don't look up in the solved/inerts; we know it's not there</span>
<a name="line-1703"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-1704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-1705"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-1706"></a>
<a name="line-1707"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Freshness</span><span class='hs-layout'>)</span>
<a name="line-1708"></a><span class='hs-comment'>-- For anything except ClassPred, this is the same as newWantedEvVarNC</span>
<a name="line-1709"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-1710"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-1711"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-1712"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDerived</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-1713"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache hit"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-1714"></a>                            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cached</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1715"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-1716"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache miss"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-1717"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fresh</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1718"></a>
<a name="line-1719"></a><a name="emitNewDerived"></a><span class='hs-definition'>emitNewDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1720"></a><span class='hs-comment'>-- Create new Derived and put it in the work list</span>
<a name="line-1721"></a><span class='hs-definition'>emitNewDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-1722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-1723"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ev</span> <span class='hs-keyword'>of</span>
<a name="line-1724"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1725"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting [D]"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1727"></a>
<a name="line-1728"></a><a name="newDerived"></a><span class='hs-definition'>newDerived</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-1729"></a><span class='hs-comment'>-- Returns Nothing    if cached,</span>
<a name="line-1730"></a><span class='hs-comment'>--         Just pred  if not cached</span>
<a name="line-1731"></a><span class='hs-definition'>newDerived</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-1732"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-1733"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-1734"></a>                    <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1735"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1736"></a>
<a name="line-1737"></a><a name="instDFunConstraints"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Freshness</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1738"></a><span class='hs-definition'>instDFunConstraints</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-1739"></a>
<a name="line-1740"></a>
<a name="line-1741"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1742"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-1743"></a>
<a name="line-1744"></a><a name="matchFamTcM"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1745"></a><span class='hs-comment'>-- Given (F tys) return (ty, co), where co :: F tys ~ ty</span>
<a name="line-1746"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-1747"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>FamInst</span><span class='hs-varop'>.</span><span class='hs-varid'>tcGetFamInstEnvs</span>
<a name="line-1748"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1749"></a>         <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>fam_envs</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-1750"></a>
<a name="line-1751"></a><span class='hs-comment'>{-
<a name="line-1752"></a>Note [Residual implications]
<a name="line-1753"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1754"></a>The wl_implics in the WorkList are the residual implication
<a name="line-1755"></a>constraints that are generated while solving or canonicalising the
<a name="line-1756"></a>current worklist.  Specifically, when canonicalising
<a name="line-1757"></a>   (forall a. t1 ~ forall a. t2)
<a name="line-1758"></a>from which we get the implication
<a name="line-1759"></a>   (forall a. t1 ~ t2)
<a name="line-1760"></a>See TcSMonad.deferTcSForAllEq
<a name="line-1761"></a>-}</span>
<a name="line-1762"></a>
<a name="line-1763"></a><span class='hs-comment'>-- Deferring forall equalities as implications</span>
<a name="line-1764"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1765"></a>
<a name="line-1766"></a><a name="deferTcSForAllEq"></a><span class='hs-definition'>deferTcSForAllEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-comment'>-- Nominal or Representational</span>
<a name="line-1767"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>  <span class='hs-comment'>-- Original wanted equality flavor</span>
<a name="line-1768"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ForAll tvs1 body1</span>
<a name="line-1769"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ForAll tvs2 body2</span>
<a name="line-1770"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvTerm</span>
<a name="line-1771"></a><span class='hs-comment'>-- Some of this functionality is repeated from TcUnify,</span>
<a name="line-1772"></a><span class='hs-comment'>-- consider having a single place where we create fresh implications.</span>
<a name="line-1773"></a><span class='hs-definition'>deferTcSForAllEq</span> <span class='hs-varid'>role</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs1</span><span class='hs-layout'>,</span><span class='hs-varid'>body1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs2</span><span class='hs-layout'>,</span><span class='hs-varid'>body2</span><span class='hs-layout'>)</span>
<a name="line-1774"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst1</span><span class='hs-layout'>,</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>tcInstSkolTyVars</span> <span class='hs-varid'>tvs1</span>
<a name="line-1775"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1776"></a>            <span class='hs-varid'>phi1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>body1</span>
<a name="line-1777"></a>            <span class='hs-varid'>phi2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTopTvSubst</span> <span class='hs-varid'>tvs2</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>body2</span>
<a name="line-1778"></a>            <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnifyForAllSkol</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>phi1</span>
<a name="line-1779"></a>            <span class='hs-varid'>eq_pred</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>role</span> <span class='hs-keyword'>of</span>
<a name="line-1780"></a>                          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>-&gt;</span>          <span class='hs-varid'>mkTcEqPred</span>      <span class='hs-varid'>phi1</span> <span class='hs-varid'>phi2</span>
<a name="line-1781"></a>                          <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCoerciblePred</span> <span class='hs-varid'>phi1</span> <span class='hs-varid'>phi2</span>
<a name="line-1782"></a>                          <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>-&gt;</span>          <span class='hs-varid'>panic</span> <span class='hs-str'>"deferTcSForAllEq Phantom"</span>
<a name="line-1783"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshness</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>eq_pred</span>
<a name="line-1784"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>coe_inside</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>freshness</span> <span class='hs-keyword'>of</span>
<a name="line-1785"></a>            <span class='hs-conid'>Cached</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-1786"></a>            <span class='hs-conid'>Fresh</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-1787"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM</span><span class='hs-varop'>.</span><span class='hs-varid'>getLclEnv</span>
<a name="line-1788"></a>                         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1789"></a>                               <span class='hs-varid'>new_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ctev</span>
<a name="line-1790"></a>                               <span class='hs-varid'>new_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span>
<a name="line-1791"></a>                               <span class='hs-varid'>new_tclvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pushTcLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_tclvl</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-1792"></a>                         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>singleCt</span> <span class='hs-varid'>new_ct</span>
<a name="line-1793"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-1794"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-1795"></a>                               <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-1796"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-1797"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_no_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1798"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1799"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-1800"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1801"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-1802"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-1803"></a>                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-1804"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListImplic</span> <span class='hs-varid'>imp</span><span class='hs-layout'>)</span>
<a name="line-1805"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>ev_binds</span> <span class='hs-varid'>new_co</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1806"></a>
<a name="line-1807"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTcForAllCo</span> <span class='hs-varid'>coe_inside</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1808"></a>
</pre></body>
</html>
