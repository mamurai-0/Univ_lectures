<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcEvidence.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- (c) The University of Glasgow 2006</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable #-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcEvidence</span> <span class='hs-layout'>(</span>
<a name="line-6"></a>
<a name="line-7"></a>  <span class='hs-comment'>-- HsWrapper</span>
<a name="line-8"></a>  <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-9"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpEvVarApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpTyLams</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpLams</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpLet</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkWpCast</span><span class='hs-layout'>,</span>
<a name="line-10"></a>  <span class='hs-varid'>mkWpFun</span><span class='hs-layout'>,</span> <span class='hs-varid'>idHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>isIdHsWrapper</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprHsWrapper</span><span class='hs-layout'>,</span>
<a name="line-11"></a>
<a name="line-12"></a>  <span class='hs-comment'>-- Evidence bindings</span>
<a name="line-13"></a>  <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-14"></a>  <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyEvBindMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>evBindMapBinds</span><span class='hs-layout'>,</span>
<a name="line-15"></a>  <span class='hs-conid'>EvBind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTcEvBinds</span><span class='hs-layout'>,</span>
<a name="line-16"></a>  <span class='hs-conid'>EvTerm</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvCast</span><span class='hs-layout'>,</span> <span class='hs-varid'>evVarsOfTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvTupleSelectors</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEvScSelectors</span><span class='hs-layout'>,</span>
<a name="line-17"></a>  <span class='hs-conid'>EvLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>evTermCoercion</span><span class='hs-layout'>,</span>
<a name="line-18"></a>  <span class='hs-conid'>EvTypeable</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-19"></a>  <span class='hs-conid'>EvCallStack</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-comment'>-- TcCoercion</span>
<a name="line-22"></a>  <span class='hs-conid'>TcCoercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-23"></a>  <span class='hs-varid'>mkTcReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNomReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcRepReflCo</span><span class='hs-layout'>,</span>
<a name="line-24"></a>  <span class='hs-varid'>mkTcTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcAppCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcFunCo</span><span class='hs-layout'>,</span>
<a name="line-25"></a>  <span class='hs-varid'>mkTcAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcUnbranchedAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcForAllCos</span><span class='hs-layout'>,</span>
<a name="line-26"></a>  <span class='hs-varid'>mkTcSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTransCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcLRCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcSubCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeTcSubCo</span><span class='hs-layout'>,</span>
<a name="line-27"></a>  <span class='hs-varid'>tcDowngradeRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcTransAppCo</span><span class='hs-layout'>,</span>
<a name="line-28"></a>  <span class='hs-varid'>mkTcAxiomRuleCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-29"></a>  <span class='hs-varid'>tcCoercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTcCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEqVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTcCoVarCo</span><span class='hs-layout'>,</span>
<a name="line-30"></a>  <span class='hs-varid'>isTcReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-31"></a>  <span class='hs-varid'>tcCoercionRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqVarRole</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>unwrapIP</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapIP</span>
<a name="line-33"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-34"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PprCore</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- Instance OutputableBndr TyVar</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>      <span class='hs-comment'>-- Knows type representation</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span><span class='hs-layout'>(</span> <span class='hs-conid'>Class</span> <span class='hs-layout'>)</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-53"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 709</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-layout'>(</span><span class='hs-varid'>traverse</span><span class='hs-layout'>,</span> <span class='hs-varid'>sequenceA</span><span class='hs-layout'>)</span>
<a name="line-56"></a><span class='hs-cpp'>#endif</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span><span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-comment'>{-
<a name="line-64"></a>Note [TcCoercions]
<a name="line-65"></a>~~~~~~~~~~~~~~~~~~
<a name="line-66"></a>| TcCoercions are a hack used by the typechecker. Normally,
<a name="line-67"></a>Coercions have free variables of type (a ~# b): we call these
<a name="line-68"></a>CoVars. However, the type checker passes around equality evidence
<a name="line-69"></a>(boxed up) at type (a ~ b).
<a name="line-70"></a>
<a name="line-71"></a>An TcCoercion is simply a Coercion whose free variables have the
<a name="line-72"></a>boxed type (a ~ b). After we are done with typechecking the
<a name="line-73"></a>desugarer finds the free variables, unboxes them, and creates a
<a name="line-74"></a>resulting real Coercion with kosher free variables.
<a name="line-75"></a>
<a name="line-76"></a>We can use most of the Coercion "smart constructors" to build TcCoercions.
<a name="line-77"></a>However, mkCoVarCo will not work! The equivalent is mkTcCoVarCo.
<a name="line-78"></a>
<a name="line-79"></a>The data type is similar to Coercion.Coercion, with the following
<a name="line-80"></a>differences
<a name="line-81"></a>  * Most important, TcLetCo adds let-bindings for coercions.
<a name="line-82"></a>    This is what lets us unify two for-all types and generate
<a name="line-83"></a>    equality constraints underneath
<a name="line-84"></a>
<a name="line-85"></a>  * The kind of a TcCoercion is  t1 ~  t2  (resp. Coercible t1 t2)
<a name="line-86"></a>             of a Coercion   is  t1 ~# t2  (resp. t1 ~#R t2)
<a name="line-87"></a>
<a name="line-88"></a>  * UnsafeCo aren't required, but we do have TcPhantomCo
<a name="line-89"></a>
<a name="line-90"></a>  * Representation invariants are weaker:
<a name="line-91"></a>     - we are allowed to have type synonyms in TcTyConAppCo
<a name="line-92"></a>     - the first arg of a TcAppCo can be a TcTyConAppCo
<a name="line-93"></a>     - TcSubCo is not applied as deep as done with mkSubCo
<a name="line-94"></a>    Reason: they'll get established when we desugar to Coercion
<a name="line-95"></a>
<a name="line-96"></a>  * TcAxiomInstCo has a [TcCoercion] parameter, and not a [Type] parameter.
<a name="line-97"></a>    This differs from the formalism, but corresponds to AxiomInstCo (see
<a name="line-98"></a>    [Coercion axioms applied to coercions]).
<a name="line-99"></a>
<a name="line-100"></a>Note [mkTcTransAppCo]
<a name="line-101"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-102"></a>Suppose we have
<a name="line-103"></a>
<a name="line-104"></a>  co1 :: a ~R Maybe
<a name="line-105"></a>  co2 :: b ~R Int
<a name="line-106"></a>
<a name="line-107"></a>and we want
<a name="line-108"></a>
<a name="line-109"></a>  co3 :: a b ~R Maybe Int
<a name="line-110"></a>
<a name="line-111"></a>This seems sensible enough. But, we can't let (co3 = co1 co2), because
<a name="line-112"></a>that's ill-roled! Note that mkTcAppCo requires a *nominal* second coercion.
<a name="line-113"></a>
<a name="line-114"></a>The way around this is to use transitivity:
<a name="line-115"></a>
<a name="line-116"></a>  co3 = (co1 &lt;b&gt;_N) ; (Maybe co2) :: a b ~R Maybe Int
<a name="line-117"></a>
<a name="line-118"></a>Or, it's possible everything is the other way around:
<a name="line-119"></a>
<a name="line-120"></a>  co1' :: Maybe ~R a
<a name="line-121"></a>  co2' :: Int   ~R b
<a name="line-122"></a>
<a name="line-123"></a>and we want
<a name="line-124"></a>
<a name="line-125"></a>  co3' :: Maybe Int ~R a b
<a name="line-126"></a>
<a name="line-127"></a>then
<a name="line-128"></a>
<a name="line-129"></a>  co3' = (Maybe co2') ; (co1' &lt;b&gt;_N)
<a name="line-130"></a>
<a name="line-131"></a>This is exactly what `mkTcTransAppCo` builds for us. Information for all
<a name="line-132"></a>the arguments tends to be to hand at call sites, so it's quicker than
<a name="line-133"></a>using, say, tcCoercionKind.
<a name="line-134"></a>-}</span>
<a name="line-135"></a>
<a name="line-136"></a><a name="TcCoercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-137"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TcType</span>
<a name="line-138"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcTyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-conid'>TyVar</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-141"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcCoVarCo</span> <span class='hs-conid'>EqVar</span>
<a name="line-142"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Int specifies branch number</span>
<a name="line-143"></a>                                                      <span class='hs-comment'>-- See [CoAxiom Index] in Coercion.lhs</span>
<a name="line-144"></a>  <span class='hs-comment'>-- This is number of types and coercions are expected to match to CoAxiomRule</span>
<a name="line-145"></a>  <span class='hs-comment'>-- (i.e., the CoAxiomRules are always fully saturated)</span>
<a name="line-146"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcPhantomCo</span> <span class='hs-conid'>TcType</span> <span class='hs-conid'>TcType</span>
<a name="line-148"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcSymCo</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-149"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcTransCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-150"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcNthCo</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-151"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcLRCo</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcSubCo</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcCastCo</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>TcCoercion</span>     <span class='hs-comment'>-- co1 |&gt; co2</span>
<a name="line-154"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcLetCo</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-conid'>Coercion</span>            <span class='hs-comment'>-- embed a Core Coercion</span>
<a name="line-156"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="isEqVar"></a><span class='hs-definition'>isEqVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-159"></a><span class='hs-comment'>-- Is lifted coercion variable (only!)</span>
<a name="line-160"></a><span class='hs-definition'>isEqVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-161"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-162"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="isTcReflCo_maybe"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-165"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span>
<a name="line-166"></a><span class='hs-definition'>isTcReflCo_maybe</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="isTcReflCo"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-169"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-170"></a><span class='hs-definition'>isTcReflCo</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="getTcCoVar_maybe"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-173"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>
<a name="line-174"></a><span class='hs-definition'>getTcCoVar_maybe</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="mkTcReflCo"></a><span class='hs-definition'>mkTcReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-177"></a><span class='hs-definition'>mkTcReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span>
<a name="line-178"></a>
<a name="line-179"></a><a name="mkTcNomReflCo"></a><span class='hs-definition'>mkTcNomReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-180"></a><span class='hs-definition'>mkTcNomReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-conid'>Nominal</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="mkTcRepReflCo"></a><span class='hs-definition'>mkTcRepReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-183"></a><span class='hs-definition'>mkTcRepReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-conid'>Representational</span>
<a name="line-184"></a>
<a name="line-185"></a><a name="mkTcFunCo"></a><span class='hs-definition'>mkTcFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-186"></a><span class='hs-definition'>mkTcFunCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>funTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span>
<a name="line-187"></a>
<a name="line-188"></a><a name="mkTcTyConAppCo"></a><span class='hs-definition'>mkTcTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-189"></a><span class='hs-definition'>mkTcTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span> <span class='hs-comment'>-- No need to expand type synonyms</span>
<a name="line-190"></a>                           <span class='hs-comment'>-- See Note [TcCoercions]</span>
<a name="line-191"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isTcReflCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-192"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-193"></a>
<a name="line-194"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-195"></a>
<a name="line-196"></a><a name="mkTcSubCo"></a><span class='hs-comment'>-- input coercion is Nominal</span>
<a name="line-197"></a><span class='hs-comment'>-- mkSubCo will do some normalisation. We do not do it for TcCoercions, but</span>
<a name="line-198"></a><span class='hs-comment'>-- defer that to desugaring; just to reduce the code duplication a little bit</span>
<a name="line-199"></a><span class='hs-definition'>mkTcSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-200"></a><span class='hs-definition'>mkTcSubCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-201"></a>               <span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="tcDowngradeRole_maybe"></a><span class='hs-comment'>-- See Note [Role twiddling functions] in Coercion</span>
<a name="line-204"></a><span class='hs-comment'>-- | Change the role of a 'TcCoercion'. Returns 'Nothing' if this isn't</span>
<a name="line-205"></a><span class='hs-comment'>-- a downgrade.</span>
<a name="line-206"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- desired role</span>
<a name="line-207"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- current role</span>
<a name="line-208"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-209"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkTcSubCo</span>
<a name="line-210"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-conid'>Nominal</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-211"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span>
<a name="line-212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcDowngradeRole_maybe Phantom"</span>
<a name="line-213"></a>    <span class='hs-comment'>-- not supported (not needed at the moment)</span>
<a name="line-214"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Phantom</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-215"></a><span class='hs-definition'>tcDowngradeRole_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span>
<a name="line-216"></a>
<a name="line-217"></a><a name="tcDowngradeRole"></a><span class='hs-comment'>-- See Note [Role twiddling functions] in Coercion</span>
<a name="line-218"></a><span class='hs-comment'>-- | Change the role of a 'TcCoercion'. Panics if this isn't a downgrade.</span>
<a name="line-219"></a><span class='hs-definition'>tcDowngradeRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- ^ desired role</span>
<a name="line-220"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- ^ current role</span>
<a name="line-221"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-222"></a><span class='hs-definition'>tcDowngradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcDowngradeRole_maybe</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-224"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-225"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcDowngradeRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-226"></a>
<a name="line-227"></a><a name="maybeTcSubCo"></a><span class='hs-comment'>-- | If the EqRel is ReprEq, makes a TcSubCo; otherwise, does nothing.</span>
<a name="line-228"></a><span class='hs-comment'>-- Note that the input coercion should always be nominal.</span>
<a name="line-229"></a><span class='hs-definition'>maybeTcSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-230"></a><span class='hs-definition'>maybeTcSubCo</span> <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span>
<a name="line-231"></a><span class='hs-definition'>maybeTcSubCo</span> <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcSubCo</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="mkTcAxInstCo"></a><span class='hs-definition'>mkTcAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-234"></a><span class='hs-definition'>mkTcAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span>
<a name="line-235"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ax</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-236"></a>    <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcDowngradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-237"></a>                     <span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-varid'>rtys</span>
<a name="line-238"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-239"></a>                     <span class='hs-varid'>tcDowngradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-240"></a>                     <span class='hs-varid'>foldl</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-241"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span><span class='hs-layout'>)</span>
<a name="line-242"></a>  <span class='hs-keyword'>where</span>
<a name="line-243"></a>    <span class='hs-varid'>n_tys</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-244"></a>    <span class='hs-varid'>ax_br</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchedAxiom</span> <span class='hs-varid'>ax</span>
<a name="line-245"></a>    <span class='hs-varid'>branch</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-246"></a>    <span class='hs-varid'>arity</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-247"></a>    <span class='hs-varid'>ax_role</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-248"></a>    <span class='hs-varid'>arg_roles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRoles</span> <span class='hs-varid'>branch</span>
<a name="line-249"></a>    <span class='hs-varid'>rtys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_roles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-250"></a>
<a name="line-251"></a><a name="mkTcAxiomRuleCo"></a><span class='hs-definition'>mkTcAxiomRuleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-252"></a><span class='hs-definition'>mkTcAxiomRuleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAxiomRuleCo</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="mkTcUnbranchedAxInstCo"></a><span class='hs-definition'>mkTcUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-255"></a><span class='hs-definition'>mkTcUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span> <span class='hs-varid'>tys</span>
<a name="line-257"></a>
<a name="line-258"></a><a name="mkTcAppCo"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-259"></a><span class='hs-comment'>-- No need to deal with TyConApp on the left; see Note [TcCoercions]</span>
<a name="line-260"></a><span class='hs-comment'>-- Second coercion *must* be nominal</span>
<a name="line-261"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-262"></a><span class='hs-definition'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="mkTcTransAppCo"></a><span class='hs-comment'>-- | Like `mkTcAppCo`, but allows the second coercion to be other than</span>
<a name="line-265"></a><span class='hs-comment'>-- nominal. See Note [mkTcTransAppCo]. Role r3 cannot be more stringent</span>
<a name="line-266"></a><span class='hs-comment'>-- than either r1 or r2.</span>
<a name="line-267"></a><span class='hs-definition'>mkTcTransAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>           <span class='hs-comment'>-- ^ r1</span>
<a name="line-268"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>     <span class='hs-comment'>-- ^ co1 :: ty1a ~r1 ty1b</span>
<a name="line-269"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- ^ ty1a</span>
<a name="line-270"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- ^ ty1b</span>
<a name="line-271"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>           <span class='hs-comment'>-- ^ r2</span>
<a name="line-272"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>     <span class='hs-comment'>-- ^ co2 :: ty2a ~r2 ty2b</span>
<a name="line-273"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- ^ ty2a</span>
<a name="line-274"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>         <span class='hs-comment'>-- ^ ty2b</span>
<a name="line-275"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>           <span class='hs-comment'>-- ^ r3</span>
<a name="line-276"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>     <span class='hs-comment'>-- ^ :: ty1a ty2a ~r3 ty1b ty2b</span>
<a name="line-277"></a><span class='hs-definition'>mkTcTransAppCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span> <span class='hs-varid'>r3</span>
<a name="line-278"></a><span class='hs-comment'>-- How incredibly fiddly! Is there a better way??</span>
<a name="line-279"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r3</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-280"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Phantom</span><span class='hs-layout'>)</span>
<a name="line-281"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTcPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-282"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-283"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-284"></a>           <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-285"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-286"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTcSubCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-287"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-288"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>)</span>
<a name="line-289"></a>           <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-290"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span>          <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-291"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSubCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>
<a name="line-292"></a>      <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>               <span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span>                <span class='hs-conid'>Representational</span><span class='hs-layout'>)</span>
<a name="line-293"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>)</span>
<a name="line-294"></a>           <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-295"></a>  <span class='hs-keyword'>where</span>
<a name="line-296"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co1_repr</span>
<a name="line-297"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1b</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty1b</span>
<a name="line-298"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nextRole</span> <span class='hs-varid'>ty1b</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span>
<a name="line-299"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>co1_repr</span> <span class='hs-varop'>`mkTcAppCo`</span> <span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTcTransCo`</span>
<a name="line-300"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1b</span>
<a name="line-301"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1b</span>
<a name="line-302"></a>            <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-303"></a>
<a name="line-304"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty1a</span>
<a name="line-305"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>nextRole</span> <span class='hs-varid'>ty1a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span>
<a name="line-306"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1a</span>
<a name="line-307"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkTcReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc1a</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys1a</span>
<a name="line-308"></a>            <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-309"></a>        <span class='hs-varop'>`mkTcTransCo`</span>
<a name="line-310"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>co1_repr</span> <span class='hs-varop'>`mkTcAppCo`</span> <span class='hs-varid'>mkTcNomReflCo</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-311"></a>
<a name="line-312"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-313"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkTcTransAppCo"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1b</span>
<a name="line-314"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2b</span>
<a name="line-315"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r3</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-316"></a>
<a name="line-317"></a><a name="mkTcSymCo"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-318"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-319"></a><span class='hs-definition'>mkTcSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-320"></a><span class='hs-definition'>mkTcSymCo</span> <span class='hs-varid'>co</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="mkTcTransCo"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-323"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-324"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-325"></a><span class='hs-definition'>mkTcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="mkTcNthCo"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-328"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-329"></a><span class='hs-definition'>mkTcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="mkTcLRCo"></a><span class='hs-definition'>mkTcLRCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-332"></a><span class='hs-definition'>mkTcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSplitAppTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-333"></a><span class='hs-definition'>mkTcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-334"></a>
<a name="line-335"></a><a name="mkTcPhantomCo"></a><span class='hs-definition'>mkTcPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-336"></a><span class='hs-definition'>mkTcPhantomCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcPhantomCo</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="mkTcAppCos"></a><span class='hs-definition'>mkTcAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-339"></a><span class='hs-definition'>mkTcAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>mkTcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>tys</span>
<a name="line-340"></a>
<a name="line-341"></a><a name="mkTcForAllCo"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-342"></a><span class='hs-comment'>-- note that a TyVar should be used here, not a CoVar (nor a TcTyVar)</span>
<a name="line-343"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-344"></a><span class='hs-definition'>mkTcForAllCo</span> <span class='hs-varid'>tv</span>  <span class='hs-varid'>co</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-345"></a>
<a name="line-346"></a><a name="mkTcForAllCos"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-347"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span> <span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-348"></a><span class='hs-definition'>mkTcForAllCos</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>co</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>tvs</span>
<a name="line-349"></a>
<a name="line-350"></a><a name="mkTcCoVarCo"></a><span class='hs-definition'>mkTcCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-351"></a><span class='hs-comment'>-- ipv :: s ~ t  (the boxed equality type) or Coercible s t (the boxed representational equality type)</span>
<a name="line-352"></a><span class='hs-definition'>mkTcCoVarCo</span> <span class='hs-varid'>ipv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>ipv</span>
<a name="line-353"></a>  <span class='hs-comment'>-- Previously I checked for (ty ~ ty) and generated Refl,</span>
<a name="line-354"></a>  <span class='hs-comment'>-- but in fact ipv may not even (visibly) have a (t1 ~ t2) type, because</span>
<a name="line-355"></a>  <span class='hs-comment'>-- the constraint solver does not substitute in the types of</span>
<a name="line-356"></a>  <span class='hs-comment'>-- evidence variables as it goes.  In any case, the optimisation</span>
<a name="line-357"></a>  <span class='hs-comment'>-- will be done in the later zonking phase</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="tcCoercionKind"></a><span class='hs-definition'>tcCoercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-360"></a><span class='hs-definition'>tcCoercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-361"></a>  <span class='hs-keyword'>where</span>
<a name="line-362"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ty</span>
<a name="line-363"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-364"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-365"></a>                                   <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-366"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-367"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-368"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-369"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-370"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-371"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>branch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-372"></a>            <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-373"></a>            <span class='hs-conid'>Pair</span> <span class='hs-varid'>tys1</span> <span class='hs-varid'>tys2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-374"></a>        <span class='hs-keyword'>in</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>)</span>
<a name="line-375"></a>           <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxNthLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-376"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys2</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxBranchRHS</span> <span class='hs-varid'>branch</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-377"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-378"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-379"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>pSnd</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-380"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-381"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcSplitAppTy</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-382"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-383"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-384"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-385"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>res</span>
<a name="line-386"></a>         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"tcCoercionKind: malformed TcAxiomRuleCo"</span>
<a name="line-387"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-388"></a>
<a name="line-389"></a><a name="eqVarRole"></a><span class='hs-definition'>eqVarRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-390"></a><span class='hs-definition'>eqVarRole</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-391"></a>
<a name="line-392"></a><a name="eqVarKind"></a><span class='hs-definition'>eqVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-393"></a><span class='hs-definition'>eqVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-394"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-sel'>_kind</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-395"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span><span class='hs-layout'>)</span>
<a name="line-396"></a>   <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-397"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"eqVarKind, non coercion variable"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-398"></a>
<a name="line-399"></a><a name="tcCoercionRole"></a><span class='hs-definition'>tcCoercionRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-400"></a><span class='hs-definition'>tcCoercionRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-401"></a>  <span class='hs-keyword'>where</span>
<a name="line-402"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-403"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-404"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-405"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-406"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-407"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-408"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phantom</span>
<a name="line-409"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-410"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-comment'>-- same as go co2</span>
<a name="line-411"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcCoercionKind</span> <span class='hs-varid'>co</span>
<a name="line-412"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcSplitTyConApp</span> <span class='hs-varid'>ty1</span>
<a name="line-413"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>nthRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-414"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-415"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-416"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>c</span>
<a name="line-417"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>c</span>
<a name="line-418"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>c</span>
<a name="line-419"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span>
<a name="line-420"></a>
<a name="line-421"></a>
<a name="line-422"></a><a name="coVarsOfTcCo"></a><span class='hs-definition'>coVarsOfTcCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-423"></a><span class='hs-comment'>-- Only works on *zonked* coercions, because of TcLetCo</span>
<a name="line-424"></a><span class='hs-definition'>coVarsOfTcCo</span> <span class='hs-varid'>tc_co</span>
<a name="line-425"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tc_co</span>
<a name="line-426"></a>  <span class='hs-keyword'>where</span>
<a name="line-427"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-428"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-429"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-430"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-431"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-432"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-433"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-434"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-435"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-436"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-437"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-438"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-439"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-440"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>go_bind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span>
<a name="line-441"></a>                                   <span class='hs-varop'>`minusVarSet`</span> <span class='hs-varid'>get_bndrs</span> <span class='hs-varid'>bs</span>
<a name="line-442"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>    <span class='hs-comment'>-- Harumph. This does legitimately happen in the call</span>
<a name="line-443"></a>                                     <span class='hs-comment'>-- to evVarsOfTerm in the DEBUG check of setEvBind</span>
<a name="line-444"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-445"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- the use of coVarsOfTcCo in dsTcCoercion will</span>
<a name="line-446"></a>                                   <span class='hs-comment'>-- fail if there are any proper, unlifted covars</span>
<a name="line-447"></a>                                   <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-448"></a>                                   <span class='hs-varid'>emptyVarSet</span>
<a name="line-449"></a>
<a name="line-450"></a>    <span class='hs-comment'>-- We expect only coercion bindings, so use evTermCoercion</span>
<a name="line-451"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-452"></a>    <span class='hs-varid'>go_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-453"></a>
<a name="line-454"></a>    <span class='hs-varid'>get_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-455"></a>    <span class='hs-varid'>get_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-456"></a>
<a name="line-457"></a><span class='hs-comment'>-- Pretty printing</span>
<a name="line-458"></a>
<a name="line-459"></a><a name="instance%20Outputable%20TcCoercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyword'>where</span>
<a name="line-460"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcCo</span>
<a name="line-461"></a>
<a name="line-462"></a><a name="pprTcCo"></a><span class='hs-definition'>pprTcCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-463"></a><span class='hs-definition'>pprTcCo</span>       <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span>   <span class='hs-varid'>co</span>
<a name="line-464"></a><a name="pprParendTcCo"></a><span class='hs-definition'>pprParendTcCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co</span>
<a name="line-465"></a>
<a name="line-466"></a><a name="ppr_co"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-467"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-468"></a>
<a name="line-469"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-470"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-471"></a>
<a name="line-472"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTcApp</span>   <span class='hs-varid'>p</span> <span class='hs-varid'>ppr_co</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_role</span> <span class='hs-varid'>r</span>
<a name="line-473"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLetCo</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varop'>$</span>
<a name="line-474"></a>                                   <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-475"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varop'>$</span>
<a name="line-476"></a>                                   <span class='hs-varid'>pprTcCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TyConPrec</span> <span class='hs-varid'>co2</span>
<a name="line-477"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCastCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-478"></a>                                   <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"|&gt;"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co2</span>
<a name="line-479"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span>
<a name="line-480"></a>
<a name="line-481"></a><span class='hs-definition'>ppr_co</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parenSymOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-482"></a>
<a name="line-483"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-484"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>con</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-485"></a>
<a name="line-486"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-487"></a>                               <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co1</span>
<a name="line-488"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>";"</span><span class='hs-layout'>)</span>
<a name="line-489"></a>                               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>co2</span>
<a name="line-490"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPhantomCo</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"PhantomCo"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendType</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-491"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sym"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-492"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcNthCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Nth:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-493"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>lr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-494"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Sub"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-495"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcAxiomRuleCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>TopPrec</span>
<a name="line-496"></a>                                  <span class='hs-varop'>$</span> <span class='hs-varid'>ppr_tc_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ps</span>
<a name="line-497"></a><span class='hs-definition'>ppr_co</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrefixApp</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Core co:"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-498"></a>
<a name="line-499"></a><a name="ppr_tc_axiom_rule_co"></a><span class='hs-definition'>ppr_tc_axiom_rule_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcCoercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-500"></a><span class='hs-definition'>ppr_tc_axiom_rule_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coaxrName</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppPs</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-501"></a>  <span class='hs-keyword'>where</span>
<a name="line-502"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-503"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr_type</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>t</span>
<a name="line-504"></a>  <span class='hs-varid'>ppTs</span> <span class='hs-varid'>ts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-505"></a>                <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-varop'>$</span> <span class='hs-varid'>punctuate</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-506"></a>
<a name="line-507"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-conid'>[]</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Outputable</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-508"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>p</span><span class='hs-keyglyph'>]</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>p</span>
<a name="line-509"></a>  <span class='hs-varid'>ppPs</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"("</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTcCo</span> <span class='hs-varid'>p</span> <span class='hs-varop'>$$</span>
<a name="line-510"></a>                  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>","</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTcCo</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>]</span> <span class='hs-varop'>$$</span>
<a name="line-511"></a>                  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>")"</span><span class='hs-layout'>)</span>
<a name="line-512"></a>
<a name="line-513"></a><a name="ppr_role"></a><span class='hs-definition'>ppr_role</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-514"></a><span class='hs-definition'>ppr_role</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>underscore</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_role</span>
<a name="line-515"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>pp_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-516"></a>                    <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'N'</span>
<a name="line-517"></a>                    <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'R'</span>
<a name="line-518"></a>                    <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'P'</span>
<a name="line-519"></a>
<a name="line-520"></a><a name="ppr_fun_co"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-521"></a><span class='hs-definition'>ppr_fun_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprArrowChain</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>split</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-522"></a>  <span class='hs-keyword'>where</span>
<a name="line-523"></a>    <span class='hs-varid'>split</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-524"></a>    <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-525"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-526"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>split</span> <span class='hs-varid'>res</span>
<a name="line-527"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span>
<a name="line-528"></a>
<a name="line-529"></a><a name="ppr_forall_co"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-530"></a><span class='hs-definition'>ppr_forall_co</span> <span class='hs-varid'>p</span> <span class='hs-varid'>ty</span>
<a name="line-531"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>p</span> <span class='hs-conid'>FunPrec</span> <span class='hs-varop'>$</span>
<a name="line-532"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprForAll</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_co</span> <span class='hs-conid'>TopPrec</span> <span class='hs-varid'>rho</span><span class='hs-keyglyph'>]</span>
<a name="line-533"></a>  <span class='hs-keyword'>where</span>
<a name="line-534"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span>  <span class='hs-varid'>rho</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>ty</span>
<a name="line-535"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split1</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-536"></a>    <span class='hs-varid'>split1</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-537"></a>
<a name="line-538"></a><span class='hs-comment'>{-
<a name="line-539"></a>************************************************************************
<a name="line-540"></a>*                                                                      *
<a name="line-541"></a>                  HsWrapper
<a name="line-542"></a>*                                                                      *
<a name="line-543"></a>************************************************************************
<a name="line-544"></a>-}</span>
<a name="line-545"></a>
<a name="line-546"></a><a name="HsWrapper"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-547"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>                      <span class='hs-comment'>-- The identity coercion</span>
<a name="line-548"></a>
<a name="line-549"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCompose</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-550"></a>       <span class='hs-comment'>-- (wrap1 `WpCompose` wrap2)[e] = wrap1[ wrap2[ e ]]</span>
<a name="line-551"></a>       <span class='hs-comment'>--</span>
<a name="line-552"></a>       <span class='hs-comment'>-- Hence  (\a. []) `WpCompose` (\b. []) = (\a b. [])</span>
<a name="line-553"></a>       <span class='hs-comment'>-- But    ([] a)   `WpCompose` ([] b)   = ([] b a)</span>
<a name="line-554"></a>
<a name="line-555"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpFun</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-conid'>TcType</span> <span class='hs-conid'>TcType</span>
<a name="line-556"></a>       <span class='hs-comment'>-- (WpFun wrap1 wrap2 t1 t2)[e] = \(x:t1). wrap2[ e wrap1[x] ] :: t2</span>
<a name="line-557"></a>       <span class='hs-comment'>-- So note that if  wrap1 :: exp_arg &lt;= act_arg</span>
<a name="line-558"></a>       <span class='hs-comment'>--                  wrap2 :: act_res &lt;= exp_res</span>
<a name="line-559"></a>       <span class='hs-comment'>--           then   WpFun wrap1 wrap2 : (act_arg -&gt; arg_res) &lt;= (exp_arg -&gt; exp_res)</span>
<a name="line-560"></a>       <span class='hs-comment'>-- This isn't the same as for mkTcFunCo, but it has to be this way</span>
<a name="line-561"></a>       <span class='hs-comment'>-- because we can't use 'sym' to flip around these HsWrappers</span>
<a name="line-562"></a>
<a name="line-563"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpCast</span> <span class='hs-conid'>TcCoercion</span>         <span class='hs-comment'>-- A cast:  [] `cast` co</span>
<a name="line-564"></a>                              <span class='hs-comment'>-- Guaranteed not the identity coercion</span>
<a name="line-565"></a>                              <span class='hs-comment'>-- At role Representational</span>
<a name="line-566"></a>
<a name="line-567"></a>        <span class='hs-comment'>-- Evidence abstraction and application</span>
<a name="line-568"></a>        <span class='hs-comment'>-- (both dictionaries and coercions)</span>
<a name="line-569"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvLam</span>  <span class='hs-conid'>EvVar</span>               <span class='hs-comment'>-- \d. []       the 'd' is an evidence variable</span>
<a name="line-570"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpEvApp</span>  <span class='hs-conid'>EvTerm</span>              <span class='hs-comment'>-- [] d         the 'd' is evidence for a constraint</span>
<a name="line-571"></a>
<a name="line-572"></a>        <span class='hs-comment'>-- Kind and Type abstraction and application</span>
<a name="line-573"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-conid'>TyVar</span>       <span class='hs-comment'>-- \a. []  the 'a' is a type/kind variable (not coercion var)</span>
<a name="line-574"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-conid'>KindOrType</span>  <span class='hs-comment'>-- [] t    the 't' is a type (not coercion)</span>
<a name="line-575"></a>
<a name="line-576"></a>
<a name="line-577"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WpLet</span> <span class='hs-conid'>TcEvBinds</span>             <span class='hs-comment'>-- Non-empty (or possibly non-empty) evidence bindings,</span>
<a name="line-578"></a>                                <span class='hs-comment'>-- so that the identity coercion is always exactly WpHole</span>
<a name="line-579"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-580"></a>
<a name="line-581"></a>
<a name="line-582"></a><a name="%3c.%3e"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-583"></a><span class='hs-conid'>WpHole</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-584"></a><a name="c"></a><span class='hs-definition'>c</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span>
<a name="line-585"></a><a name="c1"></a><span class='hs-definition'>c1</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>c2</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>`WpCompose`</span> <span class='hs-varid'>c2</span>
<a name="line-586"></a>
<a name="line-587"></a><a name="mkWpFun"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-588"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-conid'>WpHole</span>       <span class='hs-conid'>WpHole</span>       <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-589"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-conid'>WpHole</span>       <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcRepReflCo</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-590"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span>       <span class='hs-keyword'>_</span>  <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcRepReflCo</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-591"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpCast</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcFunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcSymCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-592"></a><span class='hs-definition'>mkWpFun</span> <span class='hs-varid'>co1</span>          <span class='hs-varid'>co2</span>          <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpFun</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-593"></a>
<a name="line-594"></a><a name="mkWpCast"></a><span class='hs-definition'>mkWpCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-595"></a><span class='hs-definition'>mkWpCast</span> <span class='hs-varid'>co</span>
<a name="line-596"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-597"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-598"></a>                    <span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="mkWpTyApps"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-601"></a><span class='hs-definition'>mkWpTyApps</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>tys</span>
<a name="line-602"></a>
<a name="line-603"></a><a name="mkWpEvApps"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-604"></a><span class='hs-definition'>mkWpEvApps</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_app_fn</span> <span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>args</span>
<a name="line-605"></a>
<a name="line-606"></a><a name="mkWpEvVarApps"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-607"></a><span class='hs-definition'>mkWpEvVarApps</span> <span class='hs-varid'>vs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWpEvApps</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-conid'>EvId</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>
<a name="line-608"></a>
<a name="line-609"></a><a name="mkWpTyLams"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-610"></a><span class='hs-definition'>mkWpTyLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>ids</span>
<a name="line-611"></a>
<a name="line-612"></a><a name="mkWpLams"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-613"></a><span class='hs-definition'>mkWpLams</span> <span class='hs-varid'>ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mk_co_lam_fn</span> <span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>ids</span>
<a name="line-614"></a>
<a name="line-615"></a><a name="mkWpLet"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-616"></a><span class='hs-comment'>-- This no-op is a quite a common case</span>
<a name="line-617"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-618"></a><span class='hs-definition'>mkWpLet</span> <span class='hs-varid'>ev_binds</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpLet</span> <span class='hs-varid'>ev_binds</span>
<a name="line-619"></a>
<a name="line-620"></a><a name="mk_co_lam_fn"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-621"></a><span class='hs-definition'>mk_co_lam_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>wrap</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-622"></a>
<a name="line-623"></a><a name="mk_co_app_fn"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-624"></a><span class='hs-comment'>-- For applications, the *first* argument must</span>
<a name="line-625"></a><span class='hs-comment'>-- come *last* in the composition sequence</span>
<a name="line-626"></a><span class='hs-definition'>mk_co_app_fn</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>wrap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrap</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyword'>as</span>
<a name="line-627"></a>
<a name="line-628"></a><a name="idHsWrapper"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span>
<a name="line-629"></a><span class='hs-definition'>idHsWrapper</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WpHole</span>
<a name="line-630"></a>
<a name="line-631"></a><a name="isIdHsWrapper"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-632"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-conid'>WpHole</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-633"></a><span class='hs-definition'>isIdHsWrapper</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-634"></a>
<a name="line-635"></a><span class='hs-comment'>{-
<a name="line-636"></a>************************************************************************
<a name="line-637"></a>*                                                                      *
<a name="line-638"></a>                  Evidence bindings
<a name="line-639"></a>*                                                                      *
<a name="line-640"></a>************************************************************************
<a name="line-641"></a>-}</span>
<a name="line-642"></a>
<a name="line-643"></a><a name="TcEvBinds"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcEvBinds</span>           <span class='hs-comment'>-- Mutable evidence bindings</span>
<a name="line-645"></a>       <span class='hs-conid'>EvBindsVar</span>       <span class='hs-comment'>-- Mutable because they are updated "later"</span>
<a name="line-646"></a>                        <span class='hs-comment'>--    when an implication constraint is solved</span>
<a name="line-647"></a>
<a name="line-648"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvBinds</span>             <span class='hs-comment'>-- Immutable after zonking</span>
<a name="line-649"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-650"></a>
<a name="line-651"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-652"></a>
<a name="line-653"></a><a name="EvBindsVar"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>)</span> <span class='hs-conid'>Unique</span>
<a name="line-654"></a>     <span class='hs-comment'>-- The Unique is only for debug printing</span>
<a name="line-655"></a>
<a name="line-656"></a><a name="instance%20Data.Data%20TcEvBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-657"></a>  <span class='hs-comment'>-- Placeholder; we can't travers into TcEvBinds</span>
<a name="line-658"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-659"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-660"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"TcEvBinds"</span>
<a name="line-661"></a>
<a name="line-662"></a><a name="EvBindMap"></a><span class='hs-comment'>-----------------</span>
<a name="line-663"></a><a name="EvBindMap"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-664"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span>
<a name="line-665"></a>       <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>EvBind</span>
<a name="line-666"></a>    <span class='hs-layout'>}</span>       <span class='hs-comment'>-- Map from evidence variables to evidence terms</span>
<a name="line-667"></a>
<a name="line-668"></a><a name="emptyEvBindMap"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-669"></a><span class='hs-definition'>emptyEvBindMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-layout'>}</span>
<a name="line-670"></a>
<a name="line-671"></a><a name="extendEvBinds"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-672"></a><span class='hs-definition'>extendEvBinds</span> <span class='hs-varid'>bs</span> <span class='hs-varid'>v</span> <span class='hs-varid'>t</span>
<a name="line-673"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_bind_varenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-674"></a>
<a name="line-675"></a><a name="lookupEvBind"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBind</span>
<a name="line-676"></a><span class='hs-definition'>lookupEvBind</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-677"></a>
<a name="line-678"></a><a name="evBindMapBinds"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span>
<a name="line-679"></a><span class='hs-definition'>evBindMapBinds</span> <span class='hs-varid'>bs</span>
<a name="line-680"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldVarEnv</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev_bind_varenv</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>
<a name="line-681"></a>
<a name="line-682"></a><a name="EvBind"></a><span class='hs-comment'>-----------------</span>
<a name="line-683"></a><a name="EvBind"></a><span class='hs-comment'>-- All evidence is bound by EvBinds; no side effects</span>
<a name="line-684"></a><a name="EvBind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBind</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>EvTerm</span>
<a name="line-685"></a>
<a name="line-686"></a><a name="EvTerm"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvTerm</span>
<a name="line-687"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvId</span> <span class='hs-conid'>EvId</span>                    <span class='hs-comment'>-- Any sort of evidence Id, including coercions</span>
<a name="line-688"></a>
<a name="line-689"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCoercion</span> <span class='hs-conid'>TcCoercion</span>        <span class='hs-comment'>-- (Boxed) coercion bindings</span>
<a name="line-690"></a>                                 <span class='hs-comment'>-- See Note [Coercion evidence terms]</span>
<a name="line-691"></a>
<a name="line-692"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCast</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>TcCoercion</span>     <span class='hs-comment'>-- d |&gt; co, the coercion being at role representational</span>
<a name="line-693"></a>
<a name="line-694"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvDFunApp</span> <span class='hs-conid'>DFunId</span>             <span class='hs-comment'>-- Dictionary instance application</span>
<a name="line-695"></a>       <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>
<a name="line-696"></a>
<a name="line-697"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTupleSel</span> <span class='hs-conid'>EvTerm</span>  <span class='hs-conid'>Int</span>       <span class='hs-comment'>-- n'th component of the tuple, 0-indexed</span>
<a name="line-698"></a>
<a name="line-699"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTupleMk</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- tuple built from this stuff</span>
<a name="line-700"></a>
<a name="line-701"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvDelayedError</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>FastString</span>  <span class='hs-comment'>-- Used with Opt_DeferTypeErrors</span>
<a name="line-702"></a>                               <span class='hs-comment'>-- See Note [Deferring coercion errors to runtime]</span>
<a name="line-703"></a>                               <span class='hs-comment'>-- in TcSimplify</span>
<a name="line-704"></a>
<a name="line-705"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvSuperClass</span> <span class='hs-conid'>EvTerm</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- n'th superclass. Used for both equalities and</span>
<a name="line-706"></a>                                 <span class='hs-comment'>-- dictionaries, even though the former have no</span>
<a name="line-707"></a>                                 <span class='hs-comment'>-- selector Id.  We count up from _0_</span>
<a name="line-708"></a>
<a name="line-709"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvLit</span> <span class='hs-conid'>EvLit</span>       <span class='hs-comment'>-- Dictionary for KnownNat and KnownSymbol classes.</span>
<a name="line-710"></a>                      <span class='hs-comment'>-- Note [KnownNat &amp; KnownSymbol and EvLit]</span>
<a name="line-711"></a>
<a name="line-712"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-conid'>EvTypeable</span>   <span class='hs-comment'>-- Dictionary for `Typeable`</span>
<a name="line-713"></a>
<a name="line-714"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-comment'>-- Dictionary for CallStack implicit parameters</span>
<a name="line-715"></a>
<a name="line-716"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-717"></a>
<a name="line-718"></a><a name="EvTypeable"></a><span class='hs-comment'>-- | Instructions on how to make a 'Typeable' dictionary.</span>
<a name="line-719"></a><a name="EvTypeable"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvTypeable</span>
<a name="line-720"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span>
<a name="line-721"></a>    <span class='hs-comment'>-- ^ Dicitionary for concrete type constructors.</span>
<a name="line-722"></a>
<a name="line-723"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTerm</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTerm</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-724"></a>    <span class='hs-comment'>-- ^ Dictionary for type applications;  this is used when we have</span>
<a name="line-725"></a>    <span class='hs-comment'>-- a type expression starting with a type variable (e.g., @Typeable (f a)@)</span>
<a name="line-726"></a>
<a name="line-727"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-conid'>Type</span>
<a name="line-728"></a>    <span class='hs-comment'>-- ^ Dictionary for a type literal.</span>
<a name="line-729"></a>
<a name="line-730"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-731"></a>
<a name="line-732"></a><a name="EvLit"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvLit</span>
<a name="line-733"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvNum</span> <span class='hs-conid'>Integer</span>
<a name="line-734"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvStr</span> <span class='hs-conid'>FastString</span>
<a name="line-735"></a>    <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-736"></a>
<a name="line-737"></a><a name="EvCallStack"></a><span class='hs-comment'>-- | Evidence for @CallStack@ implicit parameters.</span>
<a name="line-738"></a><a name="EvCallStack"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvCallStack</span>
<a name="line-739"></a>  <span class='hs-comment'>-- See Note [Overview of implicit CallStacks]</span>
<a name="line-740"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCsEmpty</span>
<a name="line-741"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCsPushCall</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-conid'>EvTerm</span>
<a name="line-742"></a>    <span class='hs-comment'>-- ^ @EvCsPushCall name loc stk@ represents a call to @name@, occurring at</span>
<a name="line-743"></a>    <span class='hs-comment'>-- @loc@, in a calling context @stk@.</span>
<a name="line-744"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>EvCsTop</span> <span class='hs-conid'>FastString</span> <span class='hs-conid'>RealSrcSpan</span> <span class='hs-conid'>EvTerm</span>
<a name="line-745"></a>    <span class='hs-comment'>-- ^ @EvCsTop name loc stk@ represents a use of an implicit parameter</span>
<a name="line-746"></a>    <span class='hs-comment'>-- @?name@, occurring at @loc@, in a calling context @stk@.</span>
<a name="line-747"></a>  <span class='hs-keyword'>deriving</span><span class='hs-layout'>(</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span> <span class='hs-layout'>)</span>
<a name="line-748"></a>
<a name="line-749"></a><span class='hs-comment'>{-
<a name="line-750"></a>Note [Coercion evidence terms]
<a name="line-751"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-752"></a>A "coercion evidence term" takes one of these forms
<a name="line-753"></a>   co_tm ::= EvId v           where v :: t1 ~ t2
<a name="line-754"></a>           | EvCoercion co
<a name="line-755"></a>           | EvCast co_tm co
<a name="line-756"></a>
<a name="line-757"></a>We do quite often need to get a TcCoercion from an EvTerm; see
<a name="line-758"></a>'evTermCoercion'.
<a name="line-759"></a>
<a name="line-760"></a>INVARIANT: The evidence for any constraint with type (t1~t2) is
<a name="line-761"></a>a coercion evidence term.  Consider for example
<a name="line-762"></a>    [G] d :: F Int a
<a name="line-763"></a>If we have
<a name="line-764"></a>    ax7 a :: F Int a ~ (a ~ Bool)
<a name="line-765"></a>then we do NOT generate the constraint
<a name="line-766"></a>    [G] (d |&gt; ax7 a) :: a ~ Bool
<a name="line-767"></a>because that does not satisfy the invariant (d is not a coercion variable).
<a name="line-768"></a>Instead we make a binding
<a name="line-769"></a>    g1 :: a~Bool = g |&gt; ax7 a
<a name="line-770"></a>and the constraint
<a name="line-771"></a>    [G] g1 :: a~Bool
<a name="line-772"></a>See Trac [7238] and Note [Bind new Givens immediately] in TcSMonad
<a name="line-773"></a>
<a name="line-774"></a>Note [EvBinds/EvTerm]
<a name="line-775"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-776"></a>How evidence is created and updated. Bindings for dictionaries,
<a name="line-777"></a>and coercions and implicit parameters are carried around in TcEvBinds
<a name="line-778"></a>which during constraint generation and simplification is always of the
<a name="line-779"></a>form (TcEvBinds ref). After constraint simplification is finished it
<a name="line-780"></a>will be transformed to t an (EvBinds ev_bag).
<a name="line-781"></a>
<a name="line-782"></a>Evidence for coercions *SHOULD* be filled in using the TcEvBinds
<a name="line-783"></a>However, all EvVars that correspond to *wanted* coercion terms in
<a name="line-784"></a>an EvBind must be mutable variables so that they can be readily
<a name="line-785"></a>inlined (by zonking) after constraint simplification is finished.
<a name="line-786"></a>
<a name="line-787"></a>Conclusion: a new wanted coercion variable should be made mutable.
<a name="line-788"></a>[Notice though that evidence variables that bind coercion terms
<a name="line-789"></a> from super classes will be "given" and hence rigid]
<a name="line-790"></a>
<a name="line-791"></a>
<a name="line-792"></a>Note [KnownNat &amp; KnownSymbol and EvLit]
<a name="line-793"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-794"></a>A part of the type-level literals implementation are the classes
<a name="line-795"></a>"KnownNat" and "KnownSymbol", which provide a "smart" constructor for
<a name="line-796"></a>defining singleton values.  Here is the key stuff from GHC.TypeLits
<a name="line-797"></a>
<a name="line-798"></a>  class KnownNat (n :: Nat) where
<a name="line-799"></a>    natSing :: SNat n
<a name="line-800"></a>
<a name="line-801"></a>  newtype SNat (n :: Nat) = SNat Integer
<a name="line-802"></a>
<a name="line-803"></a>Conceptually, this class has infinitely many instances:
<a name="line-804"></a>
<a name="line-805"></a>  instance KnownNat 0       where natSing = SNat 0
<a name="line-806"></a>  instance KnownNat 1       where natSing = SNat 1
<a name="line-807"></a>  instance KnownNat 2       where natSing = SNat 2
<a name="line-808"></a>  ...
<a name="line-809"></a>
<a name="line-810"></a>In practice, we solve `KnownNat` predicates in the type-checker
<a name="line-811"></a>(see typecheck/TcInteract.hs) because we can't have infinately many instances.
<a name="line-812"></a>The evidence (aka "dictionary") for `KnownNat` is of the form `EvLit (EvNum n)`.
<a name="line-813"></a>
<a name="line-814"></a>We make the following assumptions about dictionaries in GHC:
<a name="line-815"></a>  1. The "dictionary" for classes with a single method---like `KnownNat`---is
<a name="line-816"></a>     a newtype for the type of the method, so using a evidence amounts
<a name="line-817"></a>     to a coercion, and
<a name="line-818"></a>  2. Newtypes use the same representation as their definition types.
<a name="line-819"></a>
<a name="line-820"></a>So, the evidence for `KnownNat` is just a value of the representation type,
<a name="line-821"></a>wrapped in two newtype constructors: one to make it into a `SNat` value,
<a name="line-822"></a>and another to make it into a `KnownNat` dictionary.
<a name="line-823"></a>
<a name="line-824"></a>Also note that `natSing` and `SNat` are never actually exposed from the
<a name="line-825"></a>library---they are just an implementation detail.  Instead, users see
<a name="line-826"></a>a more convenient function, defined in terms of `natSing`:
<a name="line-827"></a>
<a name="line-828"></a>  natVal :: KnownNat n =&gt; proxy n -&gt; Integer
<a name="line-829"></a>
<a name="line-830"></a>The reason we don't use this directly in the class is that it is simpler
<a name="line-831"></a>and more efficient to pass around an integer rather than an entier function,
<a name="line-832"></a>especialy when the `KnowNat` evidence is packaged up in an existential.
<a name="line-833"></a>
<a name="line-834"></a>The story for kind `Symbol` is analogous:
<a name="line-835"></a>  * class KnownSymbol
<a name="line-836"></a>  * newtype SSymbol
<a name="line-837"></a>  * Evidence: EvLit (EvStr n)
<a name="line-838"></a>
<a name="line-839"></a>
<a name="line-840"></a>Note [Overview of implicit CallStacks]
<a name="line-841"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-842"></a>(See https://ghc.haskell.org/trac/ghc/wiki/ExplicitCallStack/ImplicitLocations)
<a name="line-843"></a>
<a name="line-844"></a>The goal of CallStack evidence terms is to reify locations
<a name="line-845"></a>in the program source as runtime values, without any support
<a name="line-846"></a>from the RTS. We accomplish this by assigning a special meaning
<a name="line-847"></a>to implicit parameters of type GHC.Stack.CallStack. A use of
<a name="line-848"></a>a CallStack IP, e.g.
<a name="line-849"></a>
<a name="line-850"></a>  head []    = error (show (?loc :: CallStack))
<a name="line-851"></a>  head (x:_) = x
<a name="line-852"></a>
<a name="line-853"></a>will be solved with the source location that gave rise to the IP
<a name="line-854"></a>constraint (here, the use of ?loc). If there is already
<a name="line-855"></a>a CallStack IP in scope, e.g. passed-in as an argument
<a name="line-856"></a>
<a name="line-857"></a>  head :: (?loc :: CallStack) =&gt; [a] -&gt; a
<a name="line-858"></a>  head []    = error (show (?loc :: CallStack))
<a name="line-859"></a>  head (x:_) = x
<a name="line-860"></a>
<a name="line-861"></a>we will push the new location onto the CallStack that was passed
<a name="line-862"></a>in. These two cases are reflected by the EvCallStack evidence
<a name="line-863"></a>type. In the first case, we will create an evidence term
<a name="line-864"></a>
<a name="line-865"></a>  EvCsTop "?loc" &lt;?loc's location&gt; EvCsEmpty
<a name="line-866"></a>
<a name="line-867"></a>and in the second we'll have a given constraint
<a name="line-868"></a>
<a name="line-869"></a>  [G] d :: IP "loc" CallStack
<a name="line-870"></a>
<a name="line-871"></a>in scope, and will create an evidence term
<a name="line-872"></a>
<a name="line-873"></a>  EvCsTop "?loc" &lt;?loc's location&gt; d
<a name="line-874"></a>
<a name="line-875"></a>When we call a function that uses a CallStack IP, e.g.
<a name="line-876"></a>
<a name="line-877"></a>  f = head xs
<a name="line-878"></a>
<a name="line-879"></a>we create an evidence term
<a name="line-880"></a>
<a name="line-881"></a>  EvCsPushCall "head" &lt;head's location&gt; EvCsEmpty
<a name="line-882"></a>
<a name="line-883"></a>again pushing onto a given evidence term if one exists.
<a name="line-884"></a>
<a name="line-885"></a>This provides a lightweight mechanism for building up call-stacks
<a name="line-886"></a>explicitly, but is notably limited by the fact that the stack will
<a name="line-887"></a>stop at the first function whose type does not include a CallStack IP.
<a name="line-888"></a>For example, using the above definition of head:
<a name="line-889"></a>
<a name="line-890"></a>  f :: [a] -&gt; a
<a name="line-891"></a>  f = head
<a name="line-892"></a>
<a name="line-893"></a>  g = f []
<a name="line-894"></a>
<a name="line-895"></a>the resulting CallStack will include use of ?loc inside head and
<a name="line-896"></a>the call to head inside f, but NOT the call to f inside g, because f
<a name="line-897"></a>did not explicitly request a CallStack.
<a name="line-898"></a>
<a name="line-899"></a>Important Details:
<a name="line-900"></a>- GHC should NEVER report an insoluble CallStack constraint.
<a name="line-901"></a>
<a name="line-902"></a>- A CallStack (defined in GHC.Stack) is a [(String, SrcLoc)], where the String
<a name="line-903"></a>  is the name of the binder that is used at the SrcLoc. SrcLoc is defined in
<a name="line-904"></a>  GHC.SrcLoc and contains the package/module/file name, as well as the full
<a name="line-905"></a>  source-span. Both CallStack and SrcLoc are kept abstract so only GHC can
<a name="line-906"></a>  construct new values.
<a name="line-907"></a>
<a name="line-908"></a>- Consider the use of ?stk in:
<a name="line-909"></a>
<a name="line-910"></a>    head :: (?stk :: CallStack) =&gt; [a] -&gt; a
<a name="line-911"></a>    head [] = error (show ?stk)
<a name="line-912"></a>
<a name="line-913"></a>  When solving the use of ?stk we'll have a given
<a name="line-914"></a>
<a name="line-915"></a>   [G] d :: IP "stk" CallStack
<a name="line-916"></a>
<a name="line-917"></a>  in scope. In the interaction phase, GHC would normally solve the use of ?stk
<a name="line-918"></a>  directly from the given, i.e. re-using the dicionary. But this is NOT what we
<a name="line-919"></a>  want! We want to generate a *new* CallStack with ?loc's SrcLoc pushed onto
<a name="line-920"></a>  the given CallStack. So we must take care in TcInteract.interactDict to
<a name="line-921"></a>  prioritize solving wanted CallStacks.
<a name="line-922"></a>
<a name="line-923"></a>- We will automatically solve any wanted CallStack regardless of the name of the
<a name="line-924"></a>  IP, i.e.
<a name="line-925"></a>
<a name="line-926"></a>    f = show (?stk :: CallStack)
<a name="line-927"></a>    g = show (?loc :: CallStack)
<a name="line-928"></a>
<a name="line-929"></a>  are both valid. However, we will only push new SrcLocs onto existing
<a name="line-930"></a>  CallStacks when the IP names match, e.g. in
<a name="line-931"></a>
<a name="line-932"></a>    head :: (?loc :: CallStack) =&gt; [a] -&gt; a
<a name="line-933"></a>    head [] = error (show (?stk :: CallStack))
<a name="line-934"></a>
<a name="line-935"></a>  the printed CallStack will NOT include head's call-site. This reflects the
<a name="line-936"></a>  standard scoping rules of implicit-parameters. (See TcInteract.interactDict)
<a name="line-937"></a>
<a name="line-938"></a>- An EvCallStack term desugars to a CoreExpr of type `IP "some str" CallStack`.
<a name="line-939"></a>  The desugarer will need to unwrap the IP newtype before pushing a new
<a name="line-940"></a>  call-site onto a given stack (See DsBinds.dsEvCallStack)
<a name="line-941"></a>
<a name="line-942"></a>- We only want to intercept constraints that arose due to the use of an IP or a
<a name="line-943"></a>  function call. In particular, we do NOT want to intercept the
<a name="line-944"></a>
<a name="line-945"></a>    (?stk :: CallStack) =&gt; [a] -&gt; a
<a name="line-946"></a>      ~
<a name="line-947"></a>    (?stk :: CallStack) =&gt; [a] -&gt; a
<a name="line-948"></a>
<a name="line-949"></a>  constraint that arises from the ambiguity check on `head`s type signature.
<a name="line-950"></a>  (See TcEvidence.isCallStackIP)
<a name="line-951"></a>-}</span>
<a name="line-952"></a>
<a name="line-953"></a><a name="mkEvCast"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span>
<a name="line-954"></a><span class='hs-definition'>mkEvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-955"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span><span class='hs-varid'>tcCoercionRole</span> <span class='hs-varid'>lco</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Representational</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Coercion of wrong role passed to mkEvCast:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>lco</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-956"></a>    <span class='hs-varid'>isTcReflCo</span> <span class='hs-varid'>lco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span>
<a name="line-957"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvCast</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>lco</span>
<a name="line-958"></a>
<a name="line-959"></a><a name="mkEvTupleSelectors"></a><span class='hs-definition'>mkEvTupleSelectors</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-960"></a><span class='hs-definition'>mkEvTupleSelectors</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>preds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_pr</span> <span class='hs-varid'>preds</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-961"></a>  <span class='hs-keyword'>where</span>
<a name="line-962"></a>    <span class='hs-varid'>mk_pr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-963"></a>
<a name="line-964"></a><a name="mkEvScSelectors"></a><span class='hs-definition'>mkEvScSelectors</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-965"></a><span class='hs-definition'>mkEvScSelectors</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-966"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mk_pr</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-967"></a>  <span class='hs-keyword'>where</span>
<a name="line-968"></a>    <span class='hs-varid'>mk_pr</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-969"></a>
<a name="line-970"></a><a name="emptyTcEvBinds"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span>
<a name="line-971"></a><span class='hs-definition'>emptyTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvBinds</span> <span class='hs-varid'>emptyBag</span>
<a name="line-972"></a>
<a name="line-973"></a><a name="isEmptyTcEvBinds"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-974"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>b</span>
<a name="line-975"></a><span class='hs-definition'>isEmptyTcEvBinds</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"isEmptyTcEvBinds"</span>
<a name="line-976"></a>
<a name="line-977"></a>
<a name="line-978"></a><a name="evTermCoercion"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span>
<a name="line-979"></a><span class='hs-comment'>-- Applied only to EvTerms of type (s~t)</span>
<a name="line-980"></a><span class='hs-comment'>-- See Note [Coercion evidence terms]</span>
<a name="line-981"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>v</span>
<a name="line-982"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-983"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcCastCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>evTermCoercion</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-984"></a><span class='hs-definition'>evTermCoercion</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"evTermCoercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-985"></a>
<a name="line-986"></a><a name="evVarsOfTerm"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-987"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>v</span>
<a name="line-988"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarsOfTcCo</span> <span class='hs-varid'>co</span>
<a name="line-989"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerms</span> <span class='hs-varid'>evs</span>
<a name="line-990"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>v</span>
<a name="line-991"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>v</span>
<a name="line-992"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>tm</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>coVarsOfTcCo</span> <span class='hs-varid'>co</span>
<a name="line-993"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTerms</span> <span class='hs-varid'>evs</span>
<a name="line-994"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-995"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-996"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeable</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfTypeable</span> <span class='hs-varid'>ev</span>
<a name="line-997"></a><span class='hs-definition'>evVarsOfTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCallStack</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evVarsOfCallStack</span> <span class='hs-varid'>cs</span>
<a name="line-998"></a>
<a name="line-999"></a><a name="evVarsOfTerms"></a><span class='hs-definition'>evVarsOfTerms</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvTerm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1000"></a><span class='hs-definition'>evVarsOfTerms</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUnionVarSet</span> <span class='hs-varid'>evVarsOfTerm</span>
<a name="line-1001"></a>
<a name="line-1002"></a><a name="evVarsOfTypeable"></a><span class='hs-definition'>evVarsOfTypeable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1003"></a><span class='hs-definition'>evVarsOfTypeable</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span>
<a name="line-1004"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-1005"></a>    <span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1006"></a>    <span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-varid'>e1</span> <span class='hs-varid'>e2</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerms</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>e1</span><span class='hs-layout'>,</span><span class='hs-varid'>e2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1007"></a>    <span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1008"></a>
<a name="line-1009"></a><a name="evVarsOfCallStack"></a><span class='hs-definition'>evVarsOfCallStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-1010"></a><span class='hs-definition'>evVarsOfCallStack</span> <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cs</span> <span class='hs-keyword'>of</span>
<a name="line-1011"></a>  <span class='hs-conid'>EvCsEmpty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1012"></a>  <span class='hs-conid'>EvCsTop</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>tm</span>
<a name="line-1013"></a>  <span class='hs-conid'>EvCsPushCall</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>tm</span>
<a name="line-1014"></a>
<a name="line-1015"></a><span class='hs-comment'>{-
<a name="line-1016"></a>************************************************************************
<a name="line-1017"></a>*                                                                      *
<a name="line-1018"></a>                  Pretty printing
<a name="line-1019"></a>*                                                                      *
<a name="line-1020"></a>************************************************************************
<a name="line-1021"></a>-}</span>
<a name="line-1022"></a>
<a name="line-1023"></a><a name="instance%20Outputable%20HsWrapper"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyword'>where</span>
<a name="line-1024"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprHsWrapper</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"&lt;&gt;"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co_fn</span>
<a name="line-1025"></a>
<a name="line-1026"></a><a name="pprHsWrapper"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1027"></a><span class='hs-comment'>-- In debug mode, print the wrapper</span>
<a name="line-1028"></a><span class='hs-comment'>-- otherwise just print what's inside</span>
<a name="line-1029"></a><span class='hs-definition'>pprHsWrapper</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>wrap</span>
<a name="line-1030"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_parens</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span> <span class='hs-varid'>wrap</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-1031"></a>  <span class='hs-keyword'>where</span>
<a name="line-1032"></a>    <span class='hs-varid'>help</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsWrapper</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1033"></a>    <span class='hs-comment'>-- True  &lt;=&gt; appears in function application position</span>
<a name="line-1034"></a>    <span class='hs-comment'>-- False &lt;=&gt; appears as body of let or lambda</span>
<a name="line-1035"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-conid'>WpHole</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>it</span>
<a name="line-1036"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCompose</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-varid'>f2</span><span class='hs-layout'>)</span> <span class='hs-varid'>f1</span>
<a name="line-1037"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpFun</span> <span class='hs-varid'>f1</span> <span class='hs-varid'>f2</span> <span class='hs-varid'>t1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"\\(x"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>")."</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1038"></a>                                              <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>it</span> <span class='hs-conid'>True</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>help</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>f1</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>f2</span> <span class='hs-conid'>False</span>
<a name="line-1039"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpCast</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"|&gt;"</span><span class='hs-layout'>)</span>
<a name="line-1040"></a>                                              <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1041"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvApp</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1042"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyApp</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_parens</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>it</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"@"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-1043"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpEvLam</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"\\"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>id</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-1044"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpTyLam</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"/\\"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-1045"></a>    <span class='hs-varid'>help</span> <span class='hs-varid'>it</span> <span class='hs-layout'>(</span><span class='hs-conid'>WpLet</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"let"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>binds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>it</span> <span class='hs-conid'>False</span><span class='hs-keyglyph'>]</span>
<a name="line-1046"></a>
<a name="line-1047"></a>    <span class='hs-varid'>pp_bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprBndr</span> <span class='hs-conid'>LambdaBind</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dot</span>
<a name="line-1048"></a>
<a name="line-1049"></a>    <span class='hs-varid'>add_parens</span><span class='hs-layout'>,</span> <span class='hs-varid'>no_parens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-1050"></a>    <span class='hs-varid'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varid'>d</span>
<a name="line-1051"></a>    <span class='hs-varid'>add_parens</span> <span class='hs-varid'>d</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-1052"></a>    <span class='hs-varid'>no_parens</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span>
<a name="line-1053"></a>
<a name="line-1054"></a><a name="instance%20Outputable%20TcEvBinds"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-keyword'>where</span>
<a name="line-1055"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-1056"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBinds</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"EvBinds"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1057"></a>
<a name="line-1058"></a><a name="instance%20Outputable%20EvBindsVar"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>where</span>
<a name="line-1059"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBindsVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"EvBindsVar"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>
<a name="line-1061"></a><a name="instance%20Outputable%20EvBind"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyword'>where</span>
<a name="line-1062"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>]</span>
<a name="line-1063"></a>   <span class='hs-comment'>-- We cheat a bit and pretend EqVars are CoVars for the purposes of pretty printing</span>
<a name="line-1064"></a>
<a name="line-1065"></a><a name="instance%20Outputable%20EvTerm"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyword'>where</span>
<a name="line-1066"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvId</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-1067"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCast</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"`cast`"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendTcCo</span> <span class='hs-varid'>co</span>
<a name="line-1068"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"CO"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-1069"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleSel</span> <span class='hs-varid'>v</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tupsel"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1070"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTupleMk</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"tupmk"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>vs</span>
<a name="line-1071"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvSuperClass</span> <span class='hs-varid'>d</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"sc"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1072"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDFunApp</span> <span class='hs-varid'>df</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>df</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>]</span>
<a name="line-1073"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvLit</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span>
<a name="line-1074"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCallStack</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cs</span>
<a name="line-1075"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>     <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"error"</span><span class='hs-layout'>)</span>
<a name="line-1076"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>]</span>
<a name="line-1077"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvTypeable</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span>
<a name="line-1078"></a>
<a name="line-1079"></a><a name="instance%20Outputable%20EvLit"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvLit</span> <span class='hs-keyword'>where</span>
<a name="line-1080"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvNum</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>integer</span> <span class='hs-varid'>n</span>
<a name="line-1081"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvStr</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>
<a name="line-1083"></a><a name="instance%20Outputable%20EvTypeable"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvTypeable</span> <span class='hs-keyword'>where</span>
<a name="line-1084"></a>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span>
<a name="line-1085"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-1086"></a>      <span class='hs-conid'>EvTypeableTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>ks</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1087"></a>      <span class='hs-conid'>EvTypeableTyApp</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>      <span class='hs-conid'>EvTypeableTyLit</span> <span class='hs-varid'>x</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>x</span>
<a name="line-1089"></a>
<a name="line-1090"></a><a name="instance%20Outputable%20EvCallStack"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>EvCallStack</span> <span class='hs-keyword'>where</span>
<a name="line-1091"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>EvCsEmpty</span>
<a name="line-1092"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"[]"</span><span class='hs-layout'>)</span>
<a name="line-1093"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCsTop</span> <span class='hs-varid'>name</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-1094"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>":"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span>
<a name="line-1095"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvCsPushCall</span> <span class='hs-varid'>name</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>angleBrackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>":"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tm</span>
<a name="line-1097"></a>
<a name="line-1098"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-1099"></a><span class='hs-comment'>-- Helper functions for dealing with IP newtype-dictionaries</span>
<a name="line-1100"></a><span class='hs-comment'>----------------------------------------------------------------------</span>
<a name="line-1101"></a>
<a name="line-1102"></a><a name="unwrapIP"></a><span class='hs-comment'>-- | Create a 'Coercion' that unwraps an implicit-parameter dictionary</span>
<a name="line-1103"></a><span class='hs-comment'>-- to expose the underlying value. We expect the 'Type' to have the form</span>
<a name="line-1104"></a><span class='hs-comment'>-- `IP sym ty`, return a 'Coercion' `co :: IP sym ty ~ ty`.</span>
<a name="line-1105"></a><span class='hs-definition'>unwrapIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1106"></a><span class='hs-definition'>unwrapIP</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-1107"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>unwrapNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1108"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span>
<a name="line-1109"></a>    <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"unwrapIP"</span> <span class='hs-varop'>$</span>
<a name="line-1110"></a>                       <span class='hs-varid'>text</span> <span class='hs-str'>"The dictionary for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1111"></a>                         <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is not a newtype!"</span>
<a name="line-1112"></a>  <span class='hs-keyword'>where</span>
<a name="line-1113"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-varid'>ty</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="wrapIP"></a><span class='hs-comment'>-- | Create a 'Coercion' that wraps a value in an implicit-parameter</span>
<a name="line-1116"></a><span class='hs-comment'>-- dictionary. See 'unwrapIP'.</span>
<a name="line-1117"></a><span class='hs-definition'>wrapIP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1118"></a><span class='hs-definition'>wrapIP</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>unwrapIP</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
</pre></body>
</html>
